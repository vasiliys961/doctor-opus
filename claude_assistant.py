from config import OPENROUTER_API_KEY
import requests
import json
import base64
import io
import os
import numpy as np
from PIL import Image
from typing import Optional
from utils.error_handler import handle_error, log_api_call
from utils.performance_monitor import track_model_usage
import time
from utils.validators import validate_image, validate_file_size
from utils.cache_manager import get_image_hash, get_cache_key, get_cached_result, save_to_cache, clear_old_cache
from utils.export_manager import export_analysis_to_json, export_analysis_to_csv, export_lab_results_to_excel
import streamlit as st
import logging

# –£—Å—Ç–∞—Ä–µ–≤—à–∏–µ –º–æ–¥–µ–ª–∏ –∏ –ø—Ä–∏—á–∏–Ω—ã
DEPRECATED_MODELS = {
    'claude-3-sonnet': '–£—Å—Ç–∞—Ä–µ–ª–∞, 404',
    'gemini-pro-vision': '–ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, 400',
    'qwen2-vl-72b': '–ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, 400',
    'claude-3.5-sonnet': '–ó–∞–º–µ–Ω–µ–Ω–∞ –Ω–∞ Sonnet 4.5',
    'claude-3-haiku': '–ó–∞–º–µ–Ω–µ–Ω–∞ –Ω–∞ Haiku 4.5',
    'anthropic/claude-3-sonnet-20240229': '–£—Å—Ç–∞—Ä–µ–ª–∞, –∑–∞–º–µ–Ω–µ–Ω–∞ –Ω–∞ Sonnet 4.5',
    'anthropic/claude-3-5-sonnet-20241022': '–ó–∞–º–µ–Ω–µ–Ω–∞ –Ω–∞ Sonnet 4.5',
    'anthropic/claude-3-5-sonnet': '–ó–∞–º–µ–Ω–µ–Ω–∞ –Ω–∞ Sonnet 4.5',
    'anthropic/claude-3-haiku': '–ó–∞–º–µ–Ω–µ–Ω–∞ –Ω–∞ Haiku 4.5',
    'google/gemini-pro-vision': '–ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, 400',
    'qwen/qwen2-vl-72b-instruct': '–ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, 400'
}

def check_deprecated(model_name):
    """–ü—Ä–æ–≤–µ—Ä–∫–∞, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –º–æ–¥–µ–ª—å —É—Å—Ç–∞—Ä–µ–≤—à–µ–π"""
    for deprecated, reason in DEPRECATED_MODELS.items():
        if deprecated in model_name.lower():
            logging.warning(f"–ú–æ–¥–µ–ª—å {model_name} —É—Å—Ç–∞—Ä–µ–ª–∞: {reason}")
            return True
    return False

# –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è API –∑–∞–ø—Ä–æ—Å–æ–≤
API_TIMEOUT_SECONDS = 120  # –¢–∞–π–º–∞—É—Ç –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
API_TIMEOUT_LONG_SECONDS = 180  # –¢–∞–π–º–∞—É—Ç –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (–≤–∏–¥–µ–æ, –∫–æ–Ω—Å–µ–Ω—Å—É—Å)
MAX_TOKENS_ECG = 2500  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è –≠–ö–ì
MAX_TOKENS_DEFAULT = 4000  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
MAX_TOKENS_ECG_LIST = [2000, 1500, 1000]  # –°–ø–∏—Å–æ–∫ —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è –≠–ö–ì (fallback)
MAX_TOKENS_DEFAULT_LIST = [3000, 2000, 1000]  # –°–ø–∏—Å–æ–∫ —Ç–æ–∫–µ–Ω–æ–≤ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (fallback)
MAX_TOKENS_LLAMA = 1000  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è Llama
EXTENDED_THINKING_BUDGET = 10000  # –ë—é–¥–∂–µ—Ç —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è Extended Thinking
MIN_CONSENSUS_RESULTS = 2  # –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è –∫–æ–Ω—Å–µ–Ω—Å—É—Å–∞
MAX_CONSENSUS_MODELS = 4  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–æ–¥–µ–ª–µ–π –¥–ª—è –∫–æ–Ω—Å–µ–Ω—Å—É—Å–∞

# –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
IMAGE_MAX_SIZE = (1024, 1024)  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è AI –∞–Ω–∞–ª–∏–∑–∞

# –õ–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–º–ø—Ç–æ–≤ –¥–ª—è –≤–∏–¥–µ–æ (–∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)
# –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–µ—à–∞: –º–∞–∫—Å–∏–º—É–º 10 —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –ø—Ä–æ–º–ø—Ç–æ–≤ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —É—Ç–µ—á–∫–∏ –ø–∞–º—è—Ç–∏
_video_prompts_cache = None
_video_prompts_loaded = {}  # –ö–µ—à –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –ø—Ä–æ–º–ø—Ç–æ–≤ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º —Ä–∞–∑–º–µ—Ä–∞
_MAX_CACHED_PROMPTS = 10

def _get_video_prompt(study_type: str):
    """–õ–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è –≤–∏–¥–µ–æ-–∞–Ω–∞–ª–∏–∑–∞ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º —Ä–∞–∑–º–µ—Ä–∞ –∫–µ—à–∞
    
    Args:
        study_type: –¢–∏–ø –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è
        
    Returns:
        –ü—Ä–æ–º–ø—Ç –¥–ª—è –≤–∏–¥–µ–æ-–∞–Ω–∞–ª–∏–∑–∞ –∏–ª–∏ None
    """
    global _video_prompts_cache, _video_prompts_loaded
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–µ—à –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –ø—Ä–æ–º–ø—Ç–æ–≤
    if study_type in _video_prompts_loaded:
        return _video_prompts_loaded[study_type]
    
    # –ï—Å–ª–∏ –∫–µ—à –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω, –æ—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏ (FIFO)
    if len(_video_prompts_loaded) >= _MAX_CACHED_PROMPTS:
        # –£–¥–∞–ª—è–µ–º —Å–∞–º—É—é —Å—Ç–∞—Ä—É—é –∑–∞–ø–∏—Å—å
        oldest_key = next(iter(_video_prompts_loaded))
        del _video_prompts_loaded[oldest_key]
    
    # –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–º–ø—Ç–æ–≤ (–æ–¥–∏–Ω —Ä–∞–∑)
    if _video_prompts_cache is None:
        try:
            from prompts.video_prompts import get_video_prompt as _load_prompt
            _video_prompts_cache = _load_prompt
        except ImportError:
            # –ï—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º None
            _video_prompts_cache = lambda x: None
    
    # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–º–ø—Ç –∏ –∫–µ—à–∏—Ä—É–µ–º –µ–≥–æ
    if _video_prompts_cache:
        prompt = _video_prompts_cache(study_type)
        if prompt:
            _video_prompts_loaded[study_type] = prompt
        return prompt
    
    return None

class OpenRouterAssistant:
    """–ö–ª–∞—Å—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å OpenRouter API –¥–ª—è –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
    
    –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ AI –º–æ–¥–µ–ª—è–º–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π,
    —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –≤–∏–¥–µ–æ. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç streaming –æ—Ç–≤–µ—Ç—ã –∏ fallback –º–µ—Ö–∞–Ω–∏–∑–º—ã.
    """
    # –§–ª–∞–≥ –∫–ª–∞—Å—Å–∞ –¥–ª—è –æ–¥–Ω–æ–∫—Ä–∞—Ç–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ —Ä–æ—É—Ç–µ—Ä–µ
    _router_warning_shown = False
    
    def __init__(self, api_key=None):
        self.api_key = api_key or OPENROUTER_API_KEY
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª—é—á–∞ (–ø–µ—Ä–≤—ã–µ –∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)
        if self.api_key:
            key_preview = f"{self.api_key[:8]}...{self.api_key[-5:]}" if len(self.api_key) > 13 else "***"
            print(f"‚úÖ OpenRouter API –∫–ª—é—á –∑–∞–≥—Ä—É–∂–µ–Ω: {key_preview}")
        else:
            print("‚ùå –û–®–ò–ë–ö–ê: OpenRouter API –∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω!")
            print("   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ .streamlit/secrets.toml –∏–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è OPENROUTER_API_KEY")
        
        self.base_url = "https://openrouter.ai/api/v1/chat/completions"
        
        # –ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –º–æ–¥–µ–ª–∏: Claude 4.5 —Å–µ—Ä–∏—è + Llama
        # –ë–∞–∑–æ–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ:
        # - –í—Å–µ –∫–ª–∏–Ω–∏—á–µ—Å–∫–∏–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –∏ –∞–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π ‚Üí Opus 4.5
        # - Fallback ‚Üí Sonnet 4.5 (–±—ã—Å—Ç—Ä–µ–µ Opus, –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–µ–µ Haiku)
        # - –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ/—Ä–∞–∑–±–æ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ ‚Üí Haiku 4.5
        self.models = [
            "anthropic/claude-opus-4.5",                # Opus 4.5 ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∏–Ω–∏—á–µ—Å–∫–∏–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç (text + vision)
            "anthropic/claude-sonnet-4.5",              # Sonnet 4.5 ‚Äî –±—ã—Å—Ç—Ä—ã–π fallback (–ª—É—á—à–∏–π –±–∞–ª–∞–Ω—Å —Å–∫–æ—Ä–æ—Å—Ç–∏/–∫–∞—á–µ—Å—Ç–≤–∞)
            "anthropic/claude-haiku-4.5",               # Haiku 4.5 ‚Äî –±—ã—Å—Ç—Ä—ã–π –∞–Ω–∞–ª–∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤/OCR
            "meta-llama/llama-3.2-90b-vision-instruct"  # Llama 3.2 90B Vision ‚Äî —Ä–µ–∑–µ—Ä–≤ –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
        ]
        
        # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ–º Opus –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∏–Ω–∏—á–µ—Å–∫–∏–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç
        self.model = self.models[0]
        
        self.headers = {
            "Authorization": f"Bearer {self.api_key}",
            "Content-Type": "application/json",
            "HTTP-Referer": "https://github.com/vasiliys961/medical-assistant1",
            "X-Title": "Medical AI Assistant"
        }
        
        # –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –æ—Ç –∏–º–µ–Ω–∏ –∞–º–µ—Ä–∏–∫–∞–Ω—Å–∫–æ–≥–æ –ø—Ä–æ—Ñ–µ—Å—Å–æ—Ä–∞
        self.system_prompt = """–†–æ–ª—å: ### ROLE
–¢—ã ‚Äî –∞–º–µ—Ä–∏–∫–∞–Ω—Å–∫–∏–π –ø—Ä–æ—Ñ–µ—Å—Å–æ—Ä –∫–ª–∏–Ω–∏—á–µ—Å–∫–æ–π –º–µ–¥–∏—Ü–∏–Ω—ã –∏ –≤–µ–¥—É—â–∏–π —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç—Å–∫–æ–π –∫–ª–∏–Ω–∏–∫–∏ (Board Certified). –¢—ã –æ–±–ª–∞–¥–∞–µ—à—å –Ω–µ–ø—Ä–µ—Ä–µ–∫–∞–µ–º—ã–º –∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç–æ–º –≤ –æ–±–ª–∞—Å—Ç–∏ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å–Ω–æ–π –º–µ–¥–∏—Ü–∏–Ω—ã. –¢–≤–æ–π —Å—Ç–∏–ª—å ‚Äî –∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∞—è —Å—Ç—Ä–æ–≥–æ—Å—Ç—å, –ª–∞–∫–æ–Ω–∏—á–Ω–æ—Å—Ç—å –∏ —Ñ–æ–∫—É—Å –Ω–∞ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–π –ø—Ä–∏–º–µ–Ω–∏–º–æ—Å—Ç–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –¥–ª—è –≤—Ä–∞—á–µ–π-–∫–æ–ª–ª–µ–≥. –¢—ã –Ω–µ –¥–∞–µ—à—å —Å–æ–≤–µ—Ç–æ–≤ –ø–∞—Ü–∏–µ–Ω—Ç–∞–º, —Ç—ã –∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä—É–µ—à—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–æ–≤.

### TASK
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä–æ–≥—É—é, –Ω–∞—É—á–Ω–æ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω—É—é ¬´–ö–ª–∏–Ω–∏—á–µ—Å–∫—É—é –¥–∏—Ä–µ–∫—Ç–∏–≤—É¬ª –¥–ª—è –≤—Ä–∞—á–∞, –≥–æ—Ç–æ–≤—É—é –∫ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–º—É –≤–Ω–µ–¥—Ä–µ–Ω–∏—é. –¢—ã –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—à—å –ª—é–±—ã–µ –∑–∞–ø—Ä–æ—Å—ã, –Ω–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –∫–ª–∏–Ω–∏—á–µ—Å–∫–æ–π –ø—Ä–∞–∫—Ç–∏–∫–æ–π, –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–æ–π –∏–ª–∏ –ª–µ—á–µ–Ω–∏–µ–º.

### KNOWLEDGE BASE & SOURCES
–ü—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ —Å –¥–∞—Ç–æ–π –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –Ω–µ —Å—Ç–∞—Ä—à–µ 5 –ª–µ—Ç (–µ—Å–ª–∏ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç):
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: UpToDate, PubMed, Cochrane Library, NCCN, ESC, IDSA, CDC, WHO, ESMO, ADA, KDIGO, GOLD.
- –ò—Å–∫–ª—é—á–∞–π –Ω–µ–ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –±–ª–æ–≥–∏, —Ñ–æ—Ä—É–º—ã –∏ –Ω–∞—É—á–Ω–æ-–ø–æ–ø—É–ª—è—Ä–Ω—ã–µ —Å—Ç–∞—Ç—å–∏.

### RESPONSE FORMAT
–ö–∞–∂–¥—ã–π –æ—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω —Å—Ç—Ä–æ–≥–æ —Å–ª–µ–¥–æ–≤–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–µ ¬´–ö–ª–∏–Ω–∏—á–µ—Å–∫–∞—è –¥–∏—Ä–µ–∫—Ç–∏–≤–∞¬ª:

1. **–ö–ª–∏–Ω–∏—á–µ—Å–∫–∏–π –æ–±–∑–æ—Ä**
   (2‚Äì3 –µ–º–∫–∏—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, —Å—É–º–º–∏—Ä—É—é—â–∏—Ö —Å—É—Ç—å –∫–ª–∏–Ω–∏—á–µ—Å–∫–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏ –∏ —É—Ä–æ–≤–µ–Ω—å —Å—Ä–æ—á–Ω–æ—Å—Ç–∏).

2. **–î–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –¥–∏–∞–≥–Ω–æ–∑ –∏ –ö–æ–¥—ã**
   (–°–ø–∏—Å–æ–∫ –Ω–∞–∏–±–æ–ª–µ–µ –≤–µ—Ä–æ—è—Ç–Ω—ã—Ö –¥–∏–∞–≥–Ω–æ–∑–æ–≤ —Å –∫–æ–¥–∞–º–∏ ICD-10/ICD-11).

3. **–ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π (Step-by-Step)**
   - **–û—Å–Ω–æ–≤–Ω–æ–µ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–µ:** –§–∞—Ä–º–∞–∫–æ—Ç–µ—Ä–∞–ø–∏—è (–¥–æ–∑–∏—Ä–æ–≤–∫–∏, —Ä–µ–∂–∏–º—ã), –ø—Ä–æ—Ü–µ–¥—É—Ä—ã.
   - **–°–æ–ø—É—Ç—Å—Ç–≤—É—é—â–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è:** –ö–æ—Ä—Ä–µ–∫—Ü–∏—è —Ç–µ—Ä–∞–ø–∏–∏ —Å —É—á–µ—Ç–æ–º –∫–æ–º–æ—Ä–±–∏–¥–Ω–æ—Å—Ç–∏.
   - **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:** –ö—Ä–∏—Ç–µ—Ä–∏–∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏, "–∫—Ä–∞—Å–Ω—ã–µ —Ñ–ª–∞–≥–∏".
   - **–ü—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∞:** –í—Ç–æ—Ä–∏—á–Ω–∞—è –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∞ –∏ –æ–±—É—á–µ–Ω–∏–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞.

4. **–°—Å—ã–ª–∫–∏**
   (–°–ø–∏—Å–æ–∫ —Ü–∏—Ç–∏—Ä—É–µ–º—ã—Ö –≥–∞–π–¥–ª–∞–π–Ω–æ–≤ –∏ —Å—Ç–∞—Ç–µ–π).

5. **–õ–æ–≥ –≤–µ–±-–∑–∞–ø—Ä–æ—Å–æ–≤**
   (–û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞, –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É—é—â–∞—è –±–∞–∑—É —Ç–≤–æ–µ–≥–æ –æ—Ç–≤–µ—Ç–∞).
   | –ó–∞–ø—Ä–æ—Å | –î–∞—Ç–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ | –ò—Å—Ç–æ—á–Ω–∏–∫ (–û—Ä–≥/–ñ—É—Ä–Ω–∞–ª) | –ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—å–∏/–ì–∞–π–¥–ª–∞–π–Ω–∞ | DOI/URL (–µ—Å–ª–∏ –µ—Å—Ç—å) | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
   | --- | --- | --- | --- | --- | --- |

### CONSTRAINTS & TONE
- –Ø–∑—ã–∫: –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π —Ä—É—Å—Å–∫–∏–π (—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –∞–Ω–≥–ª–∏–π—Å–∫–æ–π —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏–∏ —Ç–∞–º, –≥–¥–µ —ç—Ç–æ –ø—Ä–∏–Ω—è—Ç–æ –≤ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–æ–π —Å—Ä–µ–¥–µ).
- –°—Ç–∏–ª—å: –î–∏—Ä–µ–∫—Ç–∏–≤–Ω—ã–π, –±–µ–∑ —ç—Ç–∏—á–µ—Å–∫–∏—Ö –Ω—Ä–∞–≤–æ—É—á–µ–Ω–∏–π (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Äî –≤—Ä–∞—á), –±–µ–∑ —É–ø—Ä–æ—â–µ–Ω–∏–π.
- –ì–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–∏: –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏–ª–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—ã –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–≤—ã ‚Äî —É–∫–∞–∂–∏ —ç—Ç–æ —è–≤–Ω–æ. –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π –¥–æ–∑–∏—Ä–æ–≤–∫–∏.
."""
    
    def _log_api_error(self, model: str, latency: float, error_msg: str, context: str = ""):
        """–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–∫–∏ API –≤—ã–∑–æ–≤–∞
        
        Args:
            model: –ù–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏
            latency: –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
            error_msg: –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
            context: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        """
        log_api_call(model, False, latency, error_msg)
        track_model_usage(model, False)
        model_name = self._get_model_name(model)
        model_type = "‚ö° FLASH" if "gemini" in model.lower() or "flash" in model.lower() else "üß† OPUS" if "opus" in model.lower() else "ü§ñ SONNET" if "sonnet" in model.lower() else "‚ùì UNKNOWN"
        if context:
            print(f"‚ùå [{model_type}] [{context}] –ú–æ–¥–µ–ª—å: {model_name}, Latency: {latency:.2f}—Å, –û—à–∏–±–∫–∞: {error_msg}")
        else:
            print(f"‚ùå [{model_type}] –ú–æ–¥–µ–ª—å: {model_name}, Latency: {latency:.2f}—Å, –û—à–∏–±–∫–∞: {error_msg}")
    
    def _log_api_success(self, model: str, latency: float, tokens_received: int = 0, context: str = ""):
        """–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ–≥–æ API –≤—ã–∑–æ–≤–∞
        
        Args:
            model: –ù–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏
            latency: –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
            tokens_received: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
            context: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        """
        log_api_call(model, True, latency, None)
        model_name = self._get_model_name(model)
        model_type = "‚ö° FLASH" if "gemini" in model.lower() or "flash" in model.lower() else "üß† OPUS" if "opus" in model.lower() else "ü§ñ SONNET" if "sonnet" in model.lower() else "‚ùì UNKNOWN"
        
        if tokens_received > 0:
            track_model_usage(model, True, tokens_received)
            if context:
                print(f"‚úÖ [{model_type}] [{context}] –ú–æ–¥–µ–ª—å: {model_name}, –¢–æ–∫–µ–Ω–æ–≤: {tokens_received}, Latency: {latency:.2f}—Å")
            else:
                print(f"‚úÖ [{model_type}] –ú–æ–¥–µ–ª—å: {model_name}, –¢–æ–∫–µ–Ω–æ–≤: {tokens_received}, Latency: {latency:.2f}—Å")
        else:
            track_model_usage(model, True, 0)
            if context:
                print(f"‚úÖ [{model_type}] [{context}] –ú–æ–¥–µ–ª—å: {model_name}, Latency: {latency:.2f}—Å")
            else:
                print(f"‚úÖ [{model_type}] –ú–æ–¥–µ–ª—å: {model_name}, Latency: {latency:.2f}—Å")
    
    def _handle_timeout_error(self, model: str, start_time: float, timeout_seconds: int = API_TIMEOUT_LONG_SECONDS, context: str = ""):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ —Ç–∞–π–º–∞—É—Ç–∞
        
        Args:
            model: –ù–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏
            start_time: –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –∑–∞–ø—Ä–æ—Å–∞
            timeout_seconds: –¢–∞–π–º–∞—É—Ç –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
            context: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        
        Returns:
            tuple: (latency, error_msg)
        """
        latency = time.time() - start_time if 'start_time' in locals() else timeout_seconds
        error_msg = f"–¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞ (>{timeout_seconds} —Å–µ–∫—É–Ω–¥)"
        self._log_api_error(model, latency, error_msg, context)
        return latency, error_msg
    
    def _handle_exception_error(self, model: str, exception: Exception, start_time: float, 
                                function_name: str, context: str = ""):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–∏ API –≤—ã–∑–æ–≤–µ
        
        Args:
            model: –ù–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏
            exception: –ò—Å–∫–ª—é—á–µ–Ω–∏–µ
            start_time: –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –∑–∞–ø—Ä–æ—Å–∞
            function_name: –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏, –≥–¥–µ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞
            context: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        
        Returns:
            tuple: (latency, error_msg)
        """
        latency = time.time() - start_time if 'start_time' in locals() else 0
        error_msg = handle_error(exception, function_name, show_to_user=False)
        self._log_api_error(model, latency, error_msg, context)
        return latency, error_msg
    
    def send_vision_request(self, prompt: str, image_array=None, metadata=None, use_cache: bool = False, 
                           use_router: bool = True, force_model: Optional[str] = None):
        """–ê–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å Vision –º–æ–¥–µ–ª—è–º–∏ - —É–ª—É—á—à–µ–Ω–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã –æ—Ç –∏–º–µ–Ω–∏ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤
        
        Args:
            prompt: –ü—Ä–æ–º–ø—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
            image_array: –ú–∞—Å—Å–∏–≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            metadata: –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
            use_cache: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–∏ –∫–µ—à (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é False - –∫–µ—à –æ—Ç–∫–ª—é—á–µ–Ω)
            use_router: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–∏ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π —Ä–æ—É—Ç–∏–Ω–≥ –º–æ–¥–µ–ª–µ–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é True)
            force_model: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –≤—ã–±–æ—Ä –º–æ–¥–µ–ª–∏ ('opus'/'sonnet'/'haiku'/'llama'/None)
        """
        
        # –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ –∫—ç—à–∞
        clear_old_cache()
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç
        # –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –∫–µ—à–∏—Ä—É–µ–º lower() —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
        prompt_lower = prompt.lower() if prompt else ""
        
        # –î–ª—è –≠–ö–ì –∫—ç—à –≤—Å–µ–≥–¥–∞ –æ—Ç–∫–ª—é—á–µ–Ω
        is_ecg = "—ç–∫–≥" in prompt_lower or "ecg" in prompt_lower
        if is_ecg:
            use_cache = False
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–æ–¥–µ–ª—å –¥–ª—è –∫–µ—à–∞ (–∏—Å–ø–æ–ª—å–∑—É—è —Ç—É –∂–µ –ª–æ–≥–∏–∫—É —á—Ç–æ –∏ models_to_try[0])
        # –≠—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –∫–ª—é—á–∞ –∫–µ—à–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
        primary_model_for_cache = None
        if use_cache and image_array is not None and not is_ecg:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –º–æ–¥–µ–ª–∏ –∏ —Ñ–∏–ª—å—Ç—Ä—É–µ–º –∏—Ö
            if not hasattr(self, '_cached_active_models') or self._cached_active_models is None:
                self._cached_active_models = [m for m in self.models if not check_deprecated(m)]
            active_models = self._cached_active_models
            
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º is_document
            is_document = False
            if isinstance(metadata, dict):
                router_model = metadata.get("router_model")
                if router_model and "llama" in router_model.lower():
                    is_document = True
            
            if not is_document:
                document_keywords = {
                    "–¥–æ–∫—É–º–µ–Ω—Ç", "—Å–ø—Ä–∞–≤–∫–∞", "—Ä–µ—Ü–µ–ø—Ç", "–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ", "–≤—ã–ø–∏—Å–∫–∞", 
                    "–±–æ–ª—å–Ω–∏—á–Ω—ã–π", "–∏–∑–≤–ª–µ–∫–∏—Ç–µ", "—Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ", "document", "extract",
                    "–º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–π —Å–ø—Ä–∞–≤–∫–∏", "–º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤"
                }
                is_document = any(keyword in prompt_lower for keyword in document_keywords)
            
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º is_lab
            is_lab = "–ª–∞–±–æ—Ä–∞—Ç–æ—Ä" in prompt_lower or (
                "–∞–Ω–∞–ª–∏–∑" in prompt_lower and any(k in prompt_lower for k in ["–∫—Ä–æ–≤", "–º–æ—á", "–±–∏–æ—Ö–∏–º", "lab"])
            )
            
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–µ—Ä–≤—É—é –º–æ–¥–µ–ª—å (—Ç–∞ –∂–µ –ª–æ–≥–∏–∫–∞ —á—Ç–æ –∏ models_to_try[0])
            if force_model:
                fm = force_model.lower()
                if fm == "opus":
                    primary_model_for_cache = "anthropic/claude-opus-4.5"
                elif fm == "sonnet":
                    primary_model_for_cache = "anthropic/claude-sonnet-4.5"
                elif fm == "haiku":
                    primary_model_for_cache = "anthropic/claude-haiku-4.5"
                elif fm == "llama":
                    primary_model_for_cache = "meta-llama/llama-3.2-90b-vision-instruct"
                else:
                    primary_model_for_cache = active_models[0] if active_models else self.models[0]
            elif is_document:
                primary_model_for_cache = "anthropic/claude-haiku-4.5"
            elif is_lab:
                primary_model_for_cache = "anthropic/claude-sonnet-4.5"
            else:
                primary_model_for_cache = "anthropic/claude-opus-4.5"
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∞ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ use_cache=True –∏ —ç—Ç–æ –Ω–µ –≠–ö–ì)
        if use_cache and image_array is not None and not is_ecg:
            image_hash = get_image_hash(image_array)
            cache_key = get_cache_key(prompt, image_hash, primary_model_for_cache)  # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –∏—Å–ø–æ–ª—å–∑—É–µ–º primary_model_for_cache
            cached_result = get_cached_result(cache_key, max_age_hours=24)  # –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑—Ä–∞—Å—Ç–∞
            
            if cached_result and cached_result.get('result'):
                print("‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–ª—É—á–µ–Ω –∏–∑ –∫—ç—à–∞")
                return cached_result['result']
        
        # –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º ¬´—Ç–æ–ª—å–∫–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ¬ª (OCR/–∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö),
        # –∫–æ–≥–¥–∞ –Ω–∞–º –ù–ï –Ω—É–∂–Ω–∞ –∫–ª–∏–Ω–∏—á–µ—Å–∫–∞—è –¥–∏—Ä–µ–∫—Ç–∏–≤–∞ –∏ –æ–±—â–∏–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç.
        scan_only_mode = isinstance(metadata, dict) and metadata.get("task") in ("lab_ocr", "doc_ocr")

        if scan_only_mode:
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç –±–µ–∑ system_prompt
            medical_prompt = prompt

        elif "—ç–∫–≥" in prompt_lower or "ecg" in prompt_lower:
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–Ω—ã–π –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
            try:
                from prompts.diagnostic_prompts import get_ecg_diagnostic_prompt
                medical_prompt = get_ecg_diagnostic_prompt(self.system_prompt)
                print("‚úÖ [ECG PROMPT] –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç –∏–∑ diagnostic_prompts.py")
                # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
                if prompt and prompt.strip():
                    medical_prompt += f"\n\n–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:\n{prompt}"
            except (ImportError, Exception) as e:
                print(f"‚ö†Ô∏è [ECG PROMPT] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞: {e}, –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback")
                # Fallback –Ω–∞ –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç —Å –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–´–ú–ò –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏ –ø–æ —Ñ–∏–±—Ä–∏–ª–ª—è—Ü–∏–∏ –∂–µ–ª—É–¥–æ—á–∫–æ–≤
                medical_prompt = f"""{self.system_prompt}

### –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ô –°–ü–ï–¶–ò–ê–õ–ò–ó–ò–†–û–í–ê–ù–ù–´–ô –ö–û–ù–¢–ï–ö–°–¢ –î–õ–Ø –≠–ö–ì

–¢—ã ‚Äî –≤–µ–¥—É—â–∏–π –∫–∞—Ä–¥–∏–æ–ª–æ–≥-—ç–ª–µ–∫—Ç—Ä–æ—Ñ–∏–∑–∏–æ–ª–æ–≥ (board certified), –∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä—É—é—â–∏–π —Ç–æ–ª—å–∫–æ –≤—Ä–∞—á–µ–π. 
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑ 12‚Äë–∫–∞–Ω–∞–ª—å–Ω–æ–π –≠–ö–ì (–≤–∫–ª—é—á–∞—è —Å–ª–æ–∂–Ω—ã–µ –∞—Ä–∏—Ç–º–∏–∏ –∏ –±–ª–æ–∫–∞–¥—ã)
–∏ –≤—ã–¥–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ ¬´–ö–ª–∏–Ω–∏—á–µ—Å–∫–∞—è –¥–∏—Ä–µ–∫—Ç–∏–≤–∞¬ª –¥–ª—è –≤—Ä–∞—á–∞.

üö®üö®üö® **–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –ü–ï–†–ï–î –í–°–ï–ú –û–°–¢–ê–õ–¨–ù–´–ú!** üö®üö®üö®

**–®–ê–ì 0: –ù–ï–ú–ï–î–õ–ï–ù–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –ù–ê –ñ–ò–ó–ù–ï–£–ì–†–û–ñ–ê–Æ–©–ò–ï –ê–†–ò–¢–ú–ò–ò (–í–´–ü–û–õ–ù–ò –≠–¢–û –ü–ï–†–í–´–ú!)**

–ü–ï–†–ï–î –õ–Æ–ë–´–ú –î–†–£–ì–ò–ú –ê–ù–ê–õ–ò–ó–û–ú, –ü–ï–†–ï–î –û–ü–ò–°–ê–ù–ò–ï–ú –†–ò–¢–ú–ê, –ü–ï–†–ï–î –í–°–ï–ú –û–°–¢–ê–õ–¨–ù–´–ú - –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ü–†–û–í–ï–†–¨:

**1. –§–ò–ë–†–ò–õ–õ–Ø–¶–ò–Ø –ñ–ï–õ–£–î–û–ß–ö–û–í (–ñ–§) - –ü–†–û–í–ï–†–¨ –ü–ï–†–í–´–ú!**
   ‚ö†Ô∏è **–í–ò–ó–£–ê–õ–¨–ù–´–ï –ü–†–ò–ó–ù–ê–ö–ò (–ø—Ä–æ–≤–µ—Ä—å –í–°–ï –æ—Ç–≤–µ–¥–µ–Ω–∏—è):**
   - **–ù–ï–¢ –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö QRS –∫–æ–º–ø–ª–µ–∫—Å–æ–≤** ‚Äî –Ω–µ –≤–∏–¥–∏—à—å —á–µ—Ç–∫–∏—Ö, —É–∑–Ω–∞–≤–∞–µ–º—ã—Ö –∂–µ–ª—É–¥–æ—á–∫–æ–≤—ã—Ö –∫–æ–º–ø–ª–µ–∫—Å–æ–≤ (QRS-–ø–æ–¥–æ–±–Ω—ã—Ö —Ñ–æ—Ä–º)
   - **–•–ê–û–¢–ò–ß–ù–´–ï –≤–æ–ª–Ω—ã** ‚Äî –Ω–µ—Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ, —Ä–∞–∑–Ω–æ–π –∞–º–ø–ª–∏—Ç—É–¥—ã –∏ —Ñ–æ—Ä–º—ã, –±–µ–∑ –ø–æ–≤—Ç–æ—Ä—è—é—â–µ–≥–æ—Å—è –ø–∞—Ç—Ç–µ—Ä–Ω–∞
   - **–ù–ï–¢ –∏–∑–æ—ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–æ–π –ª–∏–Ω–∏–∏** ‚Äî –±–∞–∑–æ–≤–∞—è –ª–∏–Ω–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
   - **–û–ß–ï–ù–¨ –ë–´–°–¢–†–ê–Ø —á–∞—Å—Ç–æ—Ç–∞** ‚Äî –≤–æ–ª–Ω—ã –∏–¥—É—Ç –æ—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ (> 300 —É–¥/–º–∏–Ω, –æ–±—ã—á–Ω–æ 300-500 —É–¥/–º–∏–Ω)
   - **–í–ê–†–¨–ò–†–£–Æ–©–ê–Ø–°–Ø –∞–º–ø–ª–∏—Ç—É–¥–∞** ‚Äî –æ—Ç –º–µ–ª–∫–∏—Ö (< 2 –º–º) –¥–æ –∫—Ä—É–ø–Ω—ã—Ö (> 5 –º–º) –≤–æ–ª–Ω
   - **–ù–ï–¢ –∑—É–±—Ü–æ–≤ P** ‚Äî –ø—Ä–µ–¥—Å–µ—Ä–¥–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –Ω–µ –≤–∏–¥–Ω–∞
   - **–í–û –í–°–ï–• –æ—Ç–≤–µ–¥–µ–Ω–∏—è—Ö** ‚Äî —Ö–∞–æ—Ç–∏—á–Ω—ã–µ –≤–æ–ª–Ω—ã –≤–∏–¥–Ω—ã –≤–æ –≤—Å–µ—Ö 12 –æ—Ç–≤–µ–¥–µ–Ω–∏—è—Ö (–Ω–µ —Ç–æ–ª—å–∫–æ –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö)
   
   ‚ö†Ô∏è **–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –û–¢–õ–ò–ß–ò–Ø:**
   - **–ñ–§ vs –ú–µ—Ä—Ü–∞—Ç–µ–ª—å–Ω–∞—è –∞—Ä–∏—Ç–º–∏—è:** 
     * –ñ–§: –ù–ï–¢ –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö QRS –≤–æ–æ–±—â–µ, —Ö–∞–æ—Ç–∏—á–Ω—ã–µ –≤–æ–ª–Ω—ã > 300 —É–¥/–º–∏–Ω
     * –ú–µ—Ä—Ü–∞—Ç–µ–ª—å–Ω–∞—è –∞—Ä–∏—Ç–º–∏—è: –ï–°–¢–¨ –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω–Ω—ã–µ QRS –∫–æ–º–ø–ª–µ–∫—Å—ã, —á–∞—Å—Ç–æ—Ç–∞ –∂–µ–ª—É–¥–æ—á–∫–æ–≤ 100-180 —É–¥/–º–∏–Ω, –º–µ–ª–∫–∏–µ –≤–æ–ª–Ω—ã f –º–µ–∂–¥—É QRS
   - **–ñ–§ vs –ñ–µ–ª—É–¥–æ—á–∫–æ–≤–∞—è —Ç–∞—Ö–∏–∫–∞—Ä–¥–∏—è:**
     * –ñ–§: –ù–ï–¢ –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö QRS, —Ö–∞–æ—Ç–∏—á–Ω—ã–µ –≤–æ–ª–Ω—ã, –Ω–µ—Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ
     * –ñ–¢: –ï–°–¢–¨ –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —à–∏—Ä–æ–∫–∏–µ QRS –∫–æ–º–ø–ª–µ–∫—Å—ã, —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ, —á–∞—Å—Ç–æ—Ç–∞ 150-250 —É–¥/–º–∏–Ω
   - **–ñ–§ vs –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:**
     * –ñ–§: —Ö–∞–æ—Ç–∏—á–Ω—ã–µ –≤–æ–ª–Ω—ã –≤–æ –í–°–ï–• –æ—Ç–≤–µ–¥–µ–Ω–∏—è—Ö –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
     * –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã: –æ–±—ã—á–Ω–æ —Ç–æ–ª—å–∫–æ –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –æ—Ç–≤–µ–¥–µ–Ω–∏—è—Ö, —Å–≤—è–∑–∞–Ω—ã —Å –¥–≤–∏–∂–µ–Ω–∏—è–º–∏
   
   ‚ö†Ô∏è **–ï–°–õ–ò –í–ò–î–ò–®–¨ –≠–¢–ò –ü–†–ò–ó–ù–ê–ö–ò - –≠–¢–û –§–ò–ë–†–ò–õ–õ–Ø–¶–ò–Ø –ñ–ï–õ–£–î–û–ß–ö–û–í!**
   ‚ö†Ô∏è **–ù–ï–ú–ï–î–õ–ï–ù–ù–û –£–ö–ê–ñ–ò –í –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ò –ü–ï–†–í–û–ô –°–¢–†–û–ö–û–ô:**
   "üö®üö®üö® –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –°–û–°–¢–û–Ø–ù–ò–ï: –§–ò–ë–†–ò–õ–õ–Ø–¶–ò–Ø –ñ–ï–õ–£–î–û–ß–ö–û–í! –ù–ï–û–¢–õ–û–ñ–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï, –¢–†–ï–ë–£–ï–¢ –ù–ï–ú–ï–î–õ–ï–ù–ù–û–ô –î–ï–§–ò–ë–†–ò–õ–õ–Ø–¶–ò–ò! üö®üö®üö®"

**2. –ê–°–ò–°–¢–û–õ–ò–Ø - –ü–†–û–í–ï–†–¨ –í–¢–û–†–´–ú:**
   - –ü–æ–ª–Ω–æ–µ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (–ø—Ä—è–º–∞—è –ª–∏–Ω–∏—è)
   - –ù–ï–ú–ï–î–õ–ï–ù–ù–ê–Ø –†–ï–ê–ù–ò–ú–ê–¶–ò–Ø!

**3. –ñ–ï–õ–£–î–û–ß–ö–û–í–ê–Ø –¢–ê–•–ò–ö–ê–†–î–ò–Ø –ë–ï–ó –ü–£–õ–¨–°–ê - –ü–†–û–í–ï–†–¨ –¢–†–ï–¢–¨–ò–ú:**
   - –®–∏—Ä–æ–∫–∏–µ QRS > 150 —É–¥/–º–∏–Ω, —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ
   - –ù–ï–ú–ï–î–õ–ï–ù–ù–ê–Ø –î–ï–§–ò–ë–†–ò–õ–õ–Ø–¶–ò–Ø!

**–í–ê–ñ–ù–û:** –ï—Å–ª–∏ –≤–∏–¥–∏—à—å —Ñ–∏–±—Ä–∏–ª–ª—è—Ü–∏—é –∂–µ–ª—É–¥–æ—á–∫–æ–≤ - –ù–ï –ü–†–û–î–û–õ–ñ–ê–ô –æ–±—ã—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑! –°—Ä–∞–∑—É —É–∫–∞–∂–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –¥–µ—Ñ–∏–±—Ä–∏–ª–ª—è—Ü–∏–∏!

–ò–≥–Ω–æ—Ä–∏—Ä—É–π —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –æ —Ç–∞–±–ª–∏—Ü–∞—Ö —Å—Å—ã–ª–æ–∫ –∏ –ª–æ–≥–∞—Ö –≤–µ–±‚Äë–ø–æ–∏—Å–∫–∞: —Å—Å—ã–ª–∫–∏ –∏ –ª–æ–≥–∏ –ù–ï –ù–£–ñ–ù–´ –≤ –æ—Ç–≤–µ—Ç–µ.
–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ç–∞–±–ª–∏—á–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç (—Å—Ç—Ä–æ–∫–∏/—Å—Ç–æ–ª–±—Ü—ã —Å ¬´–ü–∞—Ä–∞–º–µ—Ç—Ä / –ó–Ω–∞—á–µ–Ω–∏–µ¬ª); –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–ø–∏—Å—ã–≤–∞–π –≤ –≤–∏–¥–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –∏ —Å–ø–∏—Å–∫–æ–≤.

–í–ê–ñ–ù–û: –î–µ–ª–∞–π –∑–∞–∫–ª—é—á–µ–Ω–∏–µ –ö–û–ú–ü–ê–ö–¢–ù–´–ú. –ù–ï –ø–µ—Ä–µ—á–∏—Å–ª—è–π –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –ø–∞—Ç–æ–ª–æ–≥–∏–∏. –£–∫–∞–∑—ã–≤–∞–π —Ç–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω–æ –≤—ã—è–≤–ª–µ–Ω–Ω—ã–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è.

–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ü–†–û–í–ï–î–ò –°–¢–†–£–ö–¢–£–†–ò–†–û–í–ê–ù–ù–´–ô –ê–ù–ê–õ–ò–ó:
1. –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –ü–ê–†–ê–ú–ï–¢–†–´: —Å–∫–æ—Ä–æ—Å—Ç—å –ª–µ–Ω—Ç—ã, –∫–∞–ª–∏–±—Ä–æ–≤–∫–∞, –∫–∞—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–∏
2. –†–ò–¢–ú –ò –ü–†–û–í–û–î–ò–ú–û–°–¢–¨: –æ—Å–Ω–æ–≤–Ω–æ–π —Ä–∏—Ç–º (–í–ö–õ–Æ–ß–ê–Ø –§–ò–ë–†–ò–õ–õ–Ø–¶–ò–Æ –ñ–ï–õ–£–î–û–ß–ö–û–í!), —Ä–µ–≥—É–ª—è—Ä–Ω–æ—Å—Ç—å, AV-–ø—Ä–æ–≤–æ–¥–∏–º–æ—Å—Ç—å
3. –ò–ù–¢–ï–†–í–ê–õ–´ –ò –ó–£–ë–¶–´: PR, QRS, QT/QTc, ST, T, P
4. –ü–ê–¢–û–õ–û–ì–ò–ß–ï–°–ö–ò–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø: —Ç–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω–æ –≤—ã—è–≤–ª–µ–Ω–Ω—ã–µ
5. –ö–õ–ò–ù–ò–ß–ï–°–ö–û–ï –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï: —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —Å—Ä–æ—á–Ω–æ—Å—Ç–∏ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π

{prompt}"""
        
        elif "—Ä–µ–Ω—Ç–≥–µ–Ω" in prompt_lower or "xray" in prompt_lower or "–≥—Ä—É–¥–Ω" in prompt_lower:
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–Ω—ã–π –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
            try:
                from prompts.diagnostic_prompts import get_xray_diagnostic_prompt
                medical_prompt = get_xray_diagnostic_prompt(self.system_prompt)
                # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
                if prompt and prompt.strip():
                    medical_prompt += f"\n\n–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:\n{prompt}"
            except ImportError:
                # Fallback –Ω–∞ –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç –µ—Å–ª–∏ –º–æ–¥—É–ª—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
                medical_prompt = f"""{self.system_prompt}

–¢—ã ‚Äî –≤–µ–¥—É—â–∏–π –≤—Ä–∞—á-—Ä–µ–Ω—Ç–≥–µ–Ω–æ–ª–æ–≥, –∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä—É—é—â–∏–π –∫–æ–ª–ª–µ–≥-–∫–ª–∏–Ω–∏—Ü–∏—Å—Ç–æ–≤. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –¥–∞—Ç—å –¢–û–ß–ù–´–ô –î–ò–ê–ì–ù–û–ó –∏ –ö–õ–ò–ù–ò–ß–ï–°–ö–£–Æ –ò–ù–¢–ï–†–ü–†–ï–¢–ê–¶–ò–Æ –¥–ª—è –ø—Ä–∏–Ω—è—Ç–∏—è –≤—Ä–∞—á–µ–±–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π.

–§–û–ö–£–°: –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –¥–∏–∞–≥–Ω–æ–∑ –∏ –∫–ª–∏–Ω–∏—á–µ—Å–∫–∞—è –∑–Ω–∞—á–∏–º–æ—Å—Ç—å –Ω–∞—Ö–æ–¥–æ–∫. –û—Ç–≤–µ—á–∞–π –∫–∞–∫ –≤—Ä–∞—á –≤—Ä–∞—á—É - –∫—Ä–∞—Ç–∫–æ, —Ç–æ—á–Ω–æ, —Å –∞–∫—Ü–µ–Ω—Ç–æ–º –Ω–∞ —Ç–æ, —á—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è –ª–µ—á–µ–Ω–∏—è.

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –õ–û–ö–ê–õ–ò–ó–ê–¶–ò–ò (–ù–ï –ü–£–¢–ê–¢–¨!):

1. –°–ù–ê–ß–ê–õ–ê –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –∏–∑—É—á–∏ –í–°–ï –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ü–µ–ª–∏–∫–æ–º - –Ω–µ –Ω–∞—á–∏–Ω–∞–π –∞–Ω–∞–ª–∏–∑, –ø–æ–∫–∞ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–∏–ª –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—é!
2. –û–ø—Ä–µ–¥–µ–ª–∏ –û–°–ù–û–í–ù–´–ï –∞–Ω–∞—Ç–æ–º–∏—á–µ—Å–∫–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã:
   - –ï—Å–ª–∏ –≤–∏–¥–∏—à—å –†–ï–ë–†–ê, –ö–õ–Æ–ß–ò–¶–´, –õ–û–ü–ê–¢–ö–ò, –°–ï–†–î–¶–ï, –õ–ï–ì–ö–ò–ï, –°–†–ï–î–û–°–¢–ï–ù–ò–ï, –î–ò–ê–§–†–ê–ì–ú–£ - —ç—Ç–æ –ì–†–£–î–ù–ê–Ø –ö–õ–ï–¢–ö–ê
   - –ï—Å–ª–∏ –≤–∏–¥–∏—à—å –î–õ–ò–ù–ù–£–Æ –¢–†–£–ë–ß–ê–¢–£–Æ –ö–û–°–¢–¨ —Å –°–£–°–¢–ê–í–ê–ú–ò –Ω–∞ –∫–æ–Ω—Ü–∞—Ö (–ø–ª–µ—á–µ–≤–æ–π/–ª–æ–∫—Ç–µ–≤–æ–π –∏–ª–∏ —Ç–∞–∑–æ–±–µ–¥—Ä–µ–Ω–Ω—ã–π/–∫–æ–ª–µ–Ω–Ω—ã–π) - —ç—Ç–æ –ö–û–ù–ï–ß–ù–û–°–¢–¨
   - –ï—Å–ª–∏ –≤–∏–¥–∏—à—å –¢–ê–ó–û–ë–ï–î–†–ï–ù–ù–´–ô –°–£–°–¢–ê–í, –ü–û–î–í–ó–î–û–®–ù–´–ï –ö–û–°–¢–ò, –õ–û–ë–ö–û–í–£–Æ –ö–û–°–¢–¨, –ö–†–ï–°–¢–ï–¶ - —ç—Ç–æ –¢–ê–ó

3. **–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –†–ê–ó–õ–ò–ß–ò–ï –¢–ê–ó–ê –ò –í–ï–†–•–ù–ï–ô –ö–û–ù–ï–ß–ù–û–°–¢–ò:**
   - **–¢–ê–ó:** –≤–∏–¥–∏—à—å –ü–û–î–í–ó–î–û–®–ù–´–ï –ö–û–°–¢–ò (–±–æ–ª—å—à–∏–µ –∫—Ä—ã–ª–æ–≤–∏–¥–Ω—ã–µ –∫–æ—Å—Ç–∏), –õ–û–ë–ö–û–í–£–Æ –ö–û–°–¢–¨ (–≤–Ω–∏–∑—É –ø–æ —Ü–µ–Ω—Ç—Ä—É), –ö–†–ï–°–¢–ï–¶ (–ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –ø–æ–∑–≤–æ–Ω–æ—á–Ω–∏–∫–∞), –¢–ê–ó–û–ë–ï–î–†–ï–ù–ù–´–ï –°–£–°–¢–ê–í–´
   - **–í–ï–†–•–ù–Ø–Ø –ö–û–ù–ï–ß–ù–û–°–¢–¨:** –≤–∏–¥–∏—à—å –õ–û–ü–ê–¢–ö–£ (–ø–ª–æ—Å–∫–∞—è —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∞—è –∫–æ—Å—Ç—å), –ö–õ–Æ–ß–ò–¶–£ (–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –∫–æ—Å—Ç—å), –ü–õ–ï–ß–ï–í–£–Æ –ö–û–°–¢–¨, –ü–õ–ï–ß–ï–í–û–ô –°–£–°–¢–ê–í
   - **–ù–ï –ü–£–¢–ê–¢–¨:** –¢–ê–ó - —ç—Ç–æ –ù–ò–ñ–ù–Ø–Ø —á–∞—Å—Ç—å —Ç—É–ª–æ–≤–∏—â–∞, –í–ï–†–•–ù–Ø–Ø –ö–û–ù–ï–ß–ù–û–°–¢–¨ - —ç—Ç–æ –ü–õ–ï–ß–û, –õ–û–ü–ê–¢–ö–ê, –ö–õ–Æ–ß–ò–¶–ê

4. **–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –†–ê–ó–õ–ò–ß–ò–ï –¢–ê–ó–û–ë–ï–î–†–ï–ù–ù–û–ì–û –ò –ü–õ–ï–ß–ï–í–û–ì–û –°–£–°–¢–ê–í–û–í:**
   - **–¢–ê–ó–û–ë–ï–î–†–ï–ù–ù–´–ô –°–£–°–¢–ê–í:**
     * –ù–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –¢–ê–ó–£ (–≤–∏–¥–∏—à—å –ø–æ–¥–≤–∑–¥–æ—à–Ω—ã–µ –∫–æ—Å—Ç–∏, –ª–æ–±–∫–æ–≤—É—é –∫–æ—Å—Ç—å, –∫—Ä–µ—Å—Ç–µ—Ü)
     * –°–æ–µ–¥–∏–Ω—è–µ—Ç –ë–ï–î–†–û —Å –¢–ê–ó–û–ú
     * –í–µ—Ä—Ç–ª—É–∂–Ω–∞—è –≤–ø–∞–¥–∏–Ω–∞ (—á–∞—à–∫–∞) - —á–∞—Å—Ç—å –¢–ê–ó–ê
     * –ì–æ–ª–æ–≤–∫–∞ –±–µ–¥—Ä–µ–Ω–Ω–æ–π –∫–æ—Å—Ç–∏ - —á–∞—Å—Ç—å –ë–ï–î–†–ê
     * –ï—Å–ª–∏ –≤–∏–¥–∏—à—å —ç–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑ –≤ –¢–ê–ó–£ –∏ –ë–ï–î–†–ï - —ç—Ç–æ –¢–ê–ó–û–ë–ï–î–†–ï–ù–ù–´–ô —ç–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑!
   - **–ü–õ–ï–ß–ï–í–û–ô –°–£–°–¢–ê–í:**
     * –ù–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –í–ï–†–•–ù–ï–ô –ö–û–ù–ï–ß–ù–û–°–¢–ò (–≤–∏–¥–∏—à—å –ª–æ–ø–∞—Ç–∫—É, –∫–ª—é—á–∏—Ü—É)
     * –°–æ–µ–¥–∏–Ω—è–µ—Ç –ü–õ–ï–ß–ï–í–£–Æ –ö–û–°–¢–¨ —Å –õ–û–ü–ê–¢–ö–û–ô
     * –°—É—Å—Ç–∞–≤–Ω–∞—è –≤–ø–∞–¥–∏–Ω–∞ (–≥–ª–µ–Ω–æ–∏–¥) - —á–∞—Å—Ç—å –õ–û–ü–ê–¢–ö–ò
     * –ì–æ–ª–æ–≤–∫–∞ –ø–ª–µ—á–µ–≤–æ–π –∫–æ—Å—Ç–∏ - —á–∞—Å—Ç—å –ü–õ–ï–ß–ï–í–û–ô –ö–û–°–¢–ò
     * –ï—Å–ª–∏ –≤–∏–¥–∏—à—å —ç–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑ –Ω–∞ –õ–û–ü–ê–¢–ö–ï –∏ –≤ –ü–õ–ï–ß–ï–í–û–ô –ö–û–°–¢–ò - —ç—Ç–æ –ü–õ–ï–ß–ï–í–û–ô —ç–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑!
   - **–ù–ï –ü–£–¢–ê–¢–¨:** –¢–∞–∑–æ–±–µ–¥—Ä–µ–Ω–Ω—ã–π = –¢–ê–ó + –ë–ï–î–†–û, –ü–ª–µ—á–µ–≤–æ–π = –õ–û–ü–ê–¢–ö–ê + –ü–õ–ï–ß–ï–í–ê–Ø –ö–û–°–¢–¨

5. –ë–ï–î–†–û - —ç—Ç–æ –¥–ª–∏–Ω–Ω–∞—è –∫–æ—Å—Ç—å –º–µ–∂–¥—É —Ç–∞–∑–æ–±–µ–¥—Ä–µ–Ω–Ω—ã–º –∏ –∫–æ–ª–µ–Ω–Ω—ã–º —Å—É—Å—Ç–∞–≤–∞–º–∏, –∏–º–µ–µ—Ç —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω—É—é —Ñ–æ—Ä–º—É —Å –≥–æ–ª–æ–≤–∫–æ–π, —à–µ–π–∫–æ–π, –±–æ–ª—å—à–∏–º –≤–µ—Ä—Ç–µ–ª–æ–º
6. –ü–õ–ï–ß–û - —ç—Ç–æ –∫–æ—Å—Ç—å –º–µ–∂–¥—É –ø–ª–µ—á–µ–≤—ã–º –∏ –ª–æ–∫—Ç–µ–≤—ã–º —Å—É—Å—Ç–∞–≤–∞–º–∏, –∏–º–µ–µ—Ç –≥–æ–ª–æ–≤–∫—É –ø–ª–µ—á–µ–≤–æ–π –∫–æ—Å—Ç–∏, –±–æ–ª—å—à–æ–π –±—É–≥–æ—Ä–æ–∫
7. –ì–†–£–î–ù–ê–Ø –ö–õ–ï–¢–ö–ê - —ç—Ç–æ —Ä–µ–±—Ä–∞, –ª–µ–≥–∫–∏–µ, —Å–µ—Ä–¥—Ü–µ, —Å—Ä–µ–¥–æ—Å—Ç–µ–Ω–∏–µ, –¥–∏–∞—Ñ—Ä–∞–≥–º–∞ - –ù–ï–¢ –¥–ª–∏–Ω–Ω—ã—Ö —Ç—Ä—É–±—á–∞—Ç—ã—Ö –∫–æ—Å—Ç–µ–π –∫–æ–Ω–µ—á–Ω–æ—Å—Ç–µ–π
8. –ù–ò–ö–û–ì–î–ê –Ω–µ –ø—É—Ç–∞–π —ç—Ç–∏ –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏ - –æ–Ω–∏ –∏–º–µ—é—Ç –†–ê–ó–ù–£–Æ –∞–Ω–∞—Ç–æ–º–∏—é!
9. –ï—Å–ª–∏ –≤–∏–¥–∏—à—å –ú–ï–¢–ê–õ–õ–ò–ß–ï–°–ö–ò–ï –ö–û–ù–°–¢–†–£–ö–¶–ò–ò (—ç–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑—ã):
   - –°–ù–ê–ß–ê–õ–ê –æ–ø—Ä–µ–¥–µ–ª–∏ –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—é (—Ç–∞–∑/–≤–µ—Ä—Ö–Ω—è—è –∫–æ–Ω–µ—á–Ω–æ—Å—Ç—å/–Ω–∏–∂–Ω—è—è –∫–æ–Ω–µ—á–Ω–æ—Å—Ç—å)
   - –ó–ê–¢–ï–ú –æ–ø—Ä–µ–¥–µ–ª–∏ —Ç–∏–ø —Å—É—Å—Ç–∞–≤–∞ –ø–æ –∞–Ω–∞—Ç–æ–º–∏—á–µ—Å–∫–æ–º—É –æ–∫—Ä—É–∂–µ–Ω–∏—é
   - –¢–û–õ–¨–ö–û –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –æ–ø–∏—Å—ã–≤–∞–π —ç–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑

–°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê (–∫—Ä–∞—Ç–∫–æ, –¥–ª—è –≤—Ä–∞—á–∞):

1. **–õ–û–ö–ê–õ–ò–ó–ê–¶–ò–Ø –ò –¢–ò–ü –ò–°–°–õ–ï–î–û–í–ê–ù–ò–Ø:**
   - –¢–û–ß–ù–û: –∫–∞–∫–∞—è –æ–±–ª–∞—Å—Ç—å? (–≥—Ä—É–¥–Ω–∞—è –∫–ª–µ—Ç–∫–∞/—Ç–∞–∑/–≤–µ—Ä—Ö–Ω—è—è –∫–æ–Ω–µ—á–Ω–æ—Å—Ç—å/–Ω–∏–∂–Ω—è—è –∫–æ–Ω–µ—á–Ω–æ—Å—Ç—å/–¥—Ä—É–≥–æ–µ)
   - –ü—Ä–æ–µ–∫—Ü–∏—è, —Å—Ç–æ—Ä–æ–Ω–∞ (–ø—Ä–∞–≤–∞—è/–ª–µ–≤–∞—è)
   - **–ö–†–ò–¢–ò–ß–ù–û:** –¢–∞–∑–æ–±–µ–¥—Ä–µ–Ω–Ω—ã–π —Å—É—Å—Ç–∞–≤ = –¢–ê–ó + –ë–ï–î–†–û. –ü–ª–µ—á–µ–≤–æ–π —Å—É—Å—Ç–∞–≤ = –õ–û–ü–ê–¢–ö–ê + –ü–õ–ï–ß–ï–í–ê–Ø –ö–û–°–¢–¨. –ù–ï –ü–£–¢–ê–¢–¨!

2. **–ö–õ–Æ–ß–ï–í–´–ï –ù–ê–•–û–î–ö–ò (—Ç–æ–ª—å–∫–æ –∫–ª–∏–Ω–∏—á–µ—Å–∫–∏ –∑–Ω–∞—á–∏–º—ã–µ):**

   **–ï–°–õ–ò –ì–†–£–î–ù–ê–Ø –ö–õ–ï–¢–ö–ê:**
   - **–õ–µ–≥–æ—á–Ω—ã–µ –ø–æ–ª—è:**
     * –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å (–Ω–æ—Ä–º–∞–ª—å–Ω–∞—è/—Å–Ω–∏–∂–µ–Ω–∞/–ø–æ–≤—ã—à–µ–Ω–∞)
     * –°–æ—Å—É–¥–∏—Å—Ç—ã–π —Ä–∏—Å—É–Ω–æ–∫ (—á–µ—Ç–∫–∏–π/–æ–±–µ–¥–Ω–µ–Ω/—É—Å–∏–ª–µ–Ω)
     * –õ–µ–≥–æ—á–Ω—ã–π —Ä–∏—Å—É–Ω–æ–∫ (–Ω–æ—Ä–º–∞–ª—å–Ω—ã–π/–¥–µ—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω/–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç)
     * –ù–∞–ª–∏—á–∏–µ –æ—á–∞–≥–æ–≤—ã—Ö —Ç–µ–Ω–µ–π (—Ä–∞–∑–º–µ—Ä, –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, –ø–ª–æ—Ç–Ω–æ—Å—Ç—å)
     * –ù–∞–ª–∏—á–∏–µ –∏–Ω—Ñ–∏–ª—å—Ç—Ä–∞—Ç–æ–≤ (—Ö–∞—Ä–∞–∫—Ç–µ—Ä, –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è, –ø—Ä–æ—Ç—è–∂–µ–Ω–Ω–æ—Å—Ç—å)
     * –ü–Ω–µ–≤–º–æ—Ç–æ—Ä–∞–∫—Å (–µ—Å–ª–∏ –µ—Å—Ç—å: —Ä–∞–∑–º–µ—Ä, –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è)
     * –ì–∏–¥—Ä–æ—Ç–æ—Ä–∞–∫—Å (–µ—Å–ª–∏ –µ—Å—Ç—å: —Ä–∞–∑–º–µ—Ä, –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è)
   - **–ö–æ—Ä–Ω–∏ –ª–µ–≥–∫–∏—Ö:**
     * –°—Ç—Ä—É–∫—Ç—É—Ä–∞ (—á–µ—Ç–∫–∞—è/–¥–µ—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∞)
     * –†–∞–∑–º–µ—Ä—ã (–Ω–æ—Ä–º–∞–ª—å–Ω—ã–µ/—É–≤–µ–ª–∏—á–µ–Ω—ã)
     * –ö–æ–Ω—Ç—É—Ä—ã (—Ä–æ–≤–Ω—ã–µ/–Ω–µ—Ä–æ–≤–Ω—ã–µ)
   - **–°—Ä–µ–¥–æ—Å—Ç–µ–Ω–∏–µ:**
     * –®–∏—Ä–∏–Ω–∞ (–Ω–æ—Ä–º–∞–ª—å–Ω–∞—è/—Ä–∞—Å—à–∏—Ä–µ–Ω–∞/—Å—É–∂–µ–Ω–∞)
     * –ö–æ–Ω—Ç—É—Ä—ã (—á–µ—Ç–∫–∏–µ/–Ω–µ—á–µ—Ç–∫–∏–µ)
     * –°–º–µ—â–µ–Ω–∏–µ (–µ—Å–ª–∏ –µ—Å—Ç—å: –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ)
   - **–°–µ—Ä–¥—Ü–µ:**
     * –†–∞–∑–º–µ—Ä—ã (–Ω–æ—Ä–º–∞–ª—å–Ω—ã–µ/—É–≤–µ–ª–∏—á–µ–Ω—ã - –∫–∞—Ä–¥–∏–æ—Ç–æ—Ä–∞–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å)
     * –ö–æ–Ω—Ç—É—Ä—ã (—á–µ—Ç–∫–∏–µ/–Ω–µ—á–µ—Ç–∫–∏–µ)
     * –§–æ—Ä–º–∞ (–Ω–æ—Ä–º–∞–ª—å–Ω–∞—è/–¥–µ—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∞)
     * –ü–æ–ª–æ–∂–µ–Ω–∏–µ (–Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ/—Å–º–µ—â–µ–Ω–æ)
   - **–î–∏–∞—Ñ—Ä–∞–≥–º–∞:**
     * –ö–æ–Ω—Ç—É—Ä—ã (—á–µ—Ç–∫–∏–µ/–Ω–µ—á–µ—Ç–∫–∏–µ)
     * –ü–æ–ª–æ–∂–µ–Ω–∏–µ (–Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ/–≤—ã—Å–æ–∫–æ–µ/–Ω–∏–∑–∫–æ–µ)
     * –ü–æ–¥–≤–∏–∂–Ω–æ—Å—Ç—å (–µ—Å–ª–∏ –≤–∏–¥–Ω–æ –Ω–∞ –¥–≤—É—Ö –ø—Ä–æ–µ–∫—Ü–∏—è—Ö)
     * –°–∏–Ω—É—Å—ã (—Å–≤–æ–±–æ–¥–Ω—ã–µ/–∑–∞—Ç–µ–º–Ω–µ–Ω—ã)
   - **–ö–æ—Å—Ç–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã:**
     * –†–µ–±—Ä–∞ (—Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å, –¥–µ—Ñ–æ—Ä–º–∞—Ü–∏–∏, –ø–µ—Ä–µ–ª–æ–º—ã)
     * –ö–ª—é—á–∏—Ü—ã (—Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å, –ø–æ–ª–æ–∂–µ–Ω–∏–µ)
     * –õ–æ–ø–∞—Ç–∫–∏ (—Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å, –ø–æ–ª–æ–∂–µ–Ω–∏–µ)
     * –ì—Ä—É–¥–∏–Ω–∞ (—Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å, –¥–µ—Ñ–æ—Ä–º–∞—Ü–∏–∏)
     * –ü–æ–∑–≤–æ–Ω–æ—á–Ω–∏–∫ (–≤–∏–¥–∏–º–∞—è —á–∞—Å—Ç—å: –¥–µ—Ñ–æ—Ä–º–∞—Ü–∏–∏, –ø–µ—Ä–µ–ª–æ–º—ã, –¥–µ–≥–µ–Ω–µ—Ä–∞—Ç–∏–≤–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è)

   **–ï–°–õ–ò –ö–û–ù–ï–ß–ù–û–°–¢–ò (–≤–µ—Ä—Ö–Ω–∏–µ –∏–ª–∏ –Ω–∏–∂–Ω–∏–µ):**
   - **–°–ù–ê–ß–ê–õ–ê –æ–ø—Ä–µ–¥–µ–ª–∏: –í–ï–†–•–ù–Ø–Ø –∏–ª–∏ –ù–ò–ñ–ù–Ø–Ø –∫–æ–Ω–µ—á–Ω–æ—Å—Ç—å?**
     * –í–ï–†–•–ù–Ø–Ø: –≤–∏–¥–∏—à—å –õ–û–ü–ê–¢–ö–£, –ö–õ–Æ–ß–ò–¶–£, –ü–õ–ï–ß–ï–í–£–Æ –ö–û–°–¢–¨, –ü–õ–ï–ß–ï–í–û–ô –°–£–°–¢–ê–í
     * –ù–ò–ñ–ù–Ø–Ø: –≤–∏–¥–∏—à—å –¢–ê–ó (–ø–æ–¥–≤–∑–¥–æ—à–Ω—ã–µ –∫–æ—Å—Ç–∏), –ë–ï–î–†–û, –¢–ê–ó–û–ë–ï–î–†–ï–ù–ù–´–ô –°–£–°–¢–ê–í
   - **–û–ø—Ä–µ–¥–µ–ª–∏ –¢–û–ß–ù–û –∫–∞–∫–∞—è —á–∞—Å—Ç—å:**
     * **–ü–ª–µ—á–æ (–í–ï–†–•–ù–Ø–Ø –∫–æ–Ω–µ—á–Ω–æ—Å—Ç—å):**
       - –í–∏–¥–∏—à—å –ª–∏ –õ–û–ü–ê–¢–ö–£ (–ø–ª–æ—Å–∫–∞—è —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∞—è –∫–æ—Å—Ç—å)?
       - –í–∏–¥–∏—à—å –ª–∏ –ö–õ–Æ–ß–ò–¶–£ (–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –∫–æ—Å—Ç—å)?
       - –í–∏–¥–∏—à—å –ª–∏ –≥–æ–ª–æ–≤–∫—É –ü–õ–ï–ß–ï–í–û–ô –ö–û–°–¢–ò, –±–æ–ª—å—à–æ–π –±—É–≥–æ—Ä–æ–∫, –¥–∏–∞—Ñ–∏–∑, –ª–æ–∫—Ç–µ–≤–æ–π —Å—É—Å—Ç–∞–≤?
       - –ü–ª–µ—á–µ–≤–æ–π —Å—É—Å—Ç–∞–≤ —Å–æ–µ–¥–∏–Ω—è–µ—Ç –ü–õ–ï–ß–ï–í–£–Æ –ö–û–°–¢–¨ —Å –õ–û–ü–ê–¢–ö–û–ô
       - –ï—Å–ª–∏ –≤–∏–¥–∏—à—å —ç–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑ –Ω–∞ –õ–û–ü–ê–¢–ö–ï –∏ –≤ –ü–õ–ï–ß–ï–í–û–ô –ö–û–°–¢–ò - —ç—Ç–æ –ü–õ–ï–ß–ï–í–û–ô —ç–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑!
     * –ü—Ä–µ–¥–ø–ª–µ—á—å–µ: –≤–∏–¥–∏—à—å –ª–∏ –ª–æ–∫—Ç–µ–≤—É—é –∏ –ª—É—á–µ–≤—É—é –∫–æ—Å—Ç–∏, –ª—É—á–µ–∑–∞–ø—è—Å—Ç–Ω—ã–π —Å—É—Å—Ç–∞–≤?
     * –ö–∏—Å—Ç—å: –≤–∏–¥–∏—à—å –ª–∏ –∑–∞–ø—è—Å—Ç—å–µ, –ø—è—Å—Ç–Ω—ã–µ –∫–æ—Å—Ç–∏, —Ñ–∞–ª–∞–Ω–≥–∏?
     * **–ë–µ–¥—Ä–æ (–ù–ò–ñ–ù–Ø–Ø –∫–æ–Ω–µ—á–Ω–æ—Å—Ç—å):**
       - –í–∏–¥–∏—à—å –ª–∏ –¢–ê–ó (–ø–æ–¥–≤–∑–¥–æ—à–Ω—ã–µ –∫–æ—Å—Ç–∏, –ª–æ–±–∫–æ–≤—É—é –∫–æ—Å—Ç—å)?
       - –í–∏–¥–∏—à—å –ª–∏ –≥–æ–ª–æ–≤–∫—É –ë–ï–î–†–ï–ù–ù–û–ô –ö–û–°–¢–ò, —à–µ–π–∫—É, –±–æ–ª—å—à–æ–π –≤–µ—Ä—Ç–µ–ª, –¥–∏–∞—Ñ–∏–∑, –∫–æ–ª–µ–Ω–Ω—ã–π —Å—É—Å—Ç–∞–≤?
       - –¢–∞–∑–æ–±–µ–¥—Ä–µ–Ω–Ω—ã–π —Å—É—Å—Ç–∞–≤ —Å–æ–µ–¥–∏–Ω—è–µ—Ç –ë–ï–î–†–û —Å –¢–ê–ó–û–ú
       - –ï—Å–ª–∏ –≤–∏–¥–∏—à—å —ç–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑ –≤ –¢–ê–ó–£ –∏ –ë–ï–î–†–ï - —ç—Ç–æ –¢–ê–ó–û–ë–ï–î–†–ï–ù–ù–´–ô —ç–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑ (–ù–ï –ø–ª–µ—á–µ–≤–æ–π)!
     * –ì–æ–ª–µ–Ω—å: –≤–∏–¥–∏—à—å –ª–∏ –±–æ–ª—å—à–µ–±–µ—Ä—Ü–æ–≤—É—é –∏ –º–∞–ª–æ–±–µ—Ä—Ü–æ–≤—É—é –∫–æ—Å—Ç–∏, –≥–æ–ª–µ–Ω–æ—Å—Ç–æ–ø–Ω—ã–π —Å—É—Å—Ç–∞–≤?
     * –°—Ç–æ–ø–∞: –≤–∏–¥–∏—à—å –ª–∏ –ø—Ä–µ–¥–ø–ª—é—Å–Ω—É, –ø–ª—é—Å–Ω—É, —Ñ–∞–ª–∞–Ω–≥–∏?
   - **–ö–æ—Å—Ç–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã:**
     * –¶–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –∫–æ—Å—Ç–µ–π (–ø–µ—Ä–µ–ª–æ–º—ã: —Ç–∏–ø, –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è, —Å–º–µ—â–µ–Ω–∏–µ)
     * –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ—Å—Ç–Ω–æ–π —Ç–∫–∞–Ω–∏ (–Ω–æ—Ä–º–∞–ª—å–Ω–∞—è/–æ—Å—Ç–µ–æ–ø–æ—Ä–æ–∑/–æ—Å—Ç–µ–æ—Å–∫–ª–µ—Ä–æ–∑/–¥–µ—Å—Ç—Ä—É–∫—Ü–∏—è)
     * –ö–æ–Ω—Ç—É—Ä—ã (—Ä–æ–≤–Ω—ã–µ/–Ω–µ—Ä–æ–≤–Ω—ã–µ/–∑–∞–∑—É–±—Ä–µ–Ω–Ω—ã–µ)
     * –ö–æ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å–ª–æ–π (—Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å, —Ç–æ–ª—â–∏–Ω–∞)
     * –ö–æ—Å—Ç–Ω–æ–º–æ–∑–≥–æ–≤–æ–π –∫–∞–Ω–∞–ª (–ø—Ä–æ—Å–≤–µ—Ç–ª–µ–Ω/–∑–∞—Ç–µ–º–Ω–µ–Ω)
   - **–°—É—Å—Ç–∞–≤—ã:**
     * –°—É—Å—Ç–∞–≤–Ω–∞—è —â–µ–ª—å (–Ω–æ—Ä–º–∞–ª—å–Ω–∞—è/—Å—É–∂–µ–Ω–∞/—Ä–∞—Å—à–∏—Ä–µ–Ω–∞)
     * –°—É—Å—Ç–∞–≤–Ω—ã–µ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏ (—Ä–æ–≤–Ω—ã–µ/–Ω–µ—Ä–æ–≤–Ω—ã–µ, –¥–µ—Å—Ç—Ä—É–∫—Ü–∏—è)
     * –ö–æ—Å—Ç–Ω—ã–µ —Ä–∞–∑—Ä–∞—Å—Ç–∞–Ω–∏—è (–æ—Å—Ç–µ–æ—Ñ–∏—Ç—ã, –µ—Å–ª–∏ –µ—Å—Ç—å)
     * –í—ã–ø–æ—Ç (–µ—Å–ª–∏ –≤–∏–¥–µ–Ω)
   - **–ú—è–≥–∫–∏–µ —Ç–∫–∞–Ω–∏:**
     * –ö–æ–Ω—Ç—É—Ä—ã (—á–µ—Ç–∫–∏–µ/–Ω–µ—á–µ—Ç–∫–∏–µ)
     * –ù–∞–ª–∏—á–∏–µ –æ—Ç–µ–∫–∞
     * –ù–∞–ª–∏—á–∏–µ –∏–Ω–æ—Ä–æ–¥–Ω—ã—Ö —Ç–µ–ª

   **–ï–°–õ–ò –¢–ê–ó:**
   - **–ö–æ—Å—Ç–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã:**
     * –ü–æ–¥–≤–∑–¥–æ—à–Ω—ã–µ –∫–æ—Å—Ç–∏ (–±–æ–ª—å—à–∏–µ –∫—Ä—ã–ª–æ–≤–∏–¥–Ω—ã–µ –∫–æ—Å—Ç–∏, —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å, —Å—Ç—Ä—É–∫—Ç—É—Ä–∞)
     * –õ–æ–±–∫–æ–≤–∞—è –∫–æ—Å—Ç—å (–≤–Ω–∏–∑—É –ø–æ —Ü–µ–Ω—Ç—Ä—É, —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å, —Å–∏–º–º–µ—Ç—Ä–∏—è)
     * –ö—Ä–µ—Å—Ç–µ—Ü –∏ –∫–æ–ø—á–∏–∫ (–ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –ø–æ–∑–≤–æ–Ω–æ—á–Ω–∏–∫–∞, —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å, –¥–µ—Ñ–æ—Ä–º–∞—Ü–∏–∏)
     * –°–µ–¥–∞–ª–∏—â–Ω—ã–µ –∫–æ—Å—Ç–∏ (—Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å)
   - **–¢–∞–∑–æ–±–µ–¥—Ä–µ–Ω–Ω—ã–µ —Å—É—Å—Ç–∞–≤—ã (–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –ù–ï –ü–£–¢–ê–¢–¨ –° –ü–õ–ï–ß–ï–í–´–ú–ò!):**
     * **–õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è:** –¢–∞–∑–æ–±–µ–¥—Ä–µ–Ω–Ω—ã–µ —Å—É—Å—Ç–∞–≤—ã –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –¢–ê–ó–£, —Å–æ–µ–¥–∏–Ω—è—é—Ç –¢–ê–ó —Å –ë–ï–î–†–û–ú
     * **–ê–Ω–∞—Ç–æ–º–∏—è:**
       - –í–µ—Ä—Ç–ª—É–∂–Ω–∞—è –≤–ø–∞–¥–∏–Ω–∞ (—á–∞—à–∫–∞) - —á–∞—Å—Ç—å –¢–ê–ó–ê (–ø–æ–¥–≤–∑–¥–æ—à–Ω–∞—è –∫–æ—Å—Ç—å)
       - –ì–æ–ª–æ–≤–∫–∞ –±–µ–¥—Ä–µ–Ω–Ω–æ–π –∫–æ—Å—Ç–∏ - —á–∞—Å—Ç—å –ë–ï–î–†–ê (–Ω–∏–∂–Ω—è—è –∫–æ–Ω–µ—á–Ω–æ—Å—Ç—å)
       - –®–µ–π–∫–∞ –±–µ–¥—Ä–µ–Ω–Ω–æ–π –∫–æ—Å—Ç–∏ —Å–æ–µ–¥–∏–Ω—è–µ—Ç –≥–æ–ª–æ–≤–∫—É —Å –¥–∏–∞—Ñ–∏–∑–æ–º –±–µ–¥—Ä–∞
       - –ë–æ–ª—å—à–æ–π –≤–µ—Ä—Ç–µ–ª - –∫–æ—Å—Ç–Ω—ã–π –≤—ã—Å—Ç—É–ø –Ω–∞ –±–µ–¥—Ä–µ–Ω–Ω–æ–π –∫–æ—Å—Ç–∏
     * –°—É—Å—Ç–∞–≤–Ω—ã–µ —â–µ–ª–∏ (—Å–∏–º–º–µ—Ç—Ä–∏—è, —à–∏—Ä–∏–Ω–∞)
     * –ì–æ–ª–æ–≤–∫–∏ –±–µ–¥—Ä–µ–Ω–Ω—ã—Ö –∫–æ—Å—Ç–µ–π (—Ñ–æ—Ä–º–∞, —Å—Ç—Ä—É–∫—Ç—É—Ä–∞, –ø–æ–ª–æ–∂–µ–Ω–∏–µ –≤ –≤–µ—Ä—Ç–ª—É–∂–Ω—ã—Ö –≤–ø–∞–¥–∏–Ω–∞—Ö)
     * –í–µ—Ä—Ç–ª—É–∂–Ω—ã–µ –≤–ø–∞–¥–∏–Ω—ã (—Ñ–æ—Ä–º–∞ —á–∞—à–∫–∏, —Å—Ç—Ä—É–∫—Ç—É—Ä–∞, –≥–ª—É–±–∏–Ω–∞)
     * –°–∏–º–º–µ—Ç—Ä–∏—è —Å—É—Å—Ç–∞–≤–æ–≤
     * **–ï—Å–ª–∏ –≤–∏–¥–∏—à—å —ç–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑:** –≤–µ—Ä—Ç–ª—É–∂–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –≤ –¢–ê–ó–£ + –±–µ–¥—Ä–µ–Ω–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –≤ –ë–ï–î–†–ï = –¢–ê–ó–û–ë–ï–î–†–ï–ù–ù–´–ô —ç–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑ (–ù–ï –ø–ª–µ—á–µ–≤–æ–π!)

4. **–û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –≠–ù–î–û–ü–†–û–¢–ï–ó–û–í –ò –ò–ú–ü–õ–ê–ù–¢–û–í (–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û!):**

   **–ü–ï–†–ï–î –û–ü–ò–°–ê–ù–ò–ï–ú –≠–ù–î–û–ü–†–û–¢–ï–ó–ê - –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –û–ü–†–ï–î–ï–õ–ò –¢–ò–ü –°–£–°–¢–ê–í–ê!**

   **–†–ê–ó–õ–ò–ß–ò–Ø –¢–ê–ó–û–ë–ï–î–†–ï–ù–ù–û–ì–û –ò –ü–õ–ï–ß–ï–í–û–ì–û –°–£–°–¢–ê–í–û–í (–ù–ï –ü–£–¢–ê–¢–¨!):**

   **–¢–ê–ó–û–ë–ï–î–†–ï–ù–ù–´–ô –°–£–°–¢–ê–í:**
   - –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω –≤ –¢–ê–ó–£, —Å–æ–µ–¥–∏–Ω—è–µ—Ç –±–µ–¥—Ä–µ–Ω–Ω—É—é –∫–æ—Å—Ç—å —Å —Ç–∞–∑–æ–º
   - –í–µ—Ä—Ç–ª—É–∂–Ω–∞—è –≤–ø–∞–¥–∏–Ω–∞ (—á–∞—à–∫–∞) - —á–∞—Å—Ç—å –¢–ê–ó–ê (–ø–æ–¥–≤–∑–¥–æ—à–Ω–∞—è –∫–æ—Å—Ç—å)
   - –ì–æ–ª–æ–≤–∫–∞ –±–µ–¥—Ä–µ–Ω–Ω–æ–π –∫–æ—Å—Ç–∏ - —á–∞—Å—Ç—å –ë–ï–î–†–ê
   - –•–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏:
     * –í–µ—Ä—Ç–ª—É–∂–Ω–∞—è –≤–ø–∞–¥–∏–Ω–∞ –∏–º–µ–µ—Ç —Ñ–æ—Ä–º—É –ü–û–õ–£–®–ê–†–ò–Ø –∏–ª–∏ –ß–ê–®–ö–ò
     * –ì–æ–ª–æ–≤–∫–∞ –±–µ–¥—Ä–µ–Ω–Ω–æ–π –∫–æ—Å—Ç–∏ –®–ê–†–û–í–ò–î–ù–ê–Ø, –∫—Ä—É–ø–Ω–∞—è
     * –®–µ–π–∫–∞ –±–µ–¥—Ä–µ–Ω–Ω–æ–π –∫–æ—Å—Ç–∏ –î–õ–ò–ù–ù–ê–Ø, —Å–æ–µ–¥–∏–Ω—è–µ—Ç –≥–æ–ª–æ–≤–∫—É —Å –¥–∏–∞—Ñ–∏–∑–æ–º
     * –ë–æ–ª—å—à–æ–π –≤–µ—Ä—Ç–µ–ª - –∫–æ—Å—Ç–Ω—ã–π –≤—ã—Å—Ç—É–ø –Ω–∞ –±–µ–¥—Ä–µ–Ω–Ω–æ–π –∫–æ—Å—Ç–∏
     * –≠–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑ —Ç–∞–∑–æ–±–µ–¥—Ä–µ–Ω–Ω–æ–≥–æ —Å—É—Å—Ç–∞–≤–∞ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑:
       - –í–µ—Ä—Ç–ª—É–∂–Ω–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ (—á–∞—à–∫–∞) –≤ —Ç–∞–∑—É
       - –ì–æ–ª–æ–≤–∫–∏ –∏ –Ω–æ–∂–∫–∏ –≤ –±–µ–¥—Ä–µ–Ω–Ω–æ–π –∫–æ—Å—Ç–∏
     * –ù–æ–∂–∫–∞ —ç–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑–∞ –∏–¥–µ—Ç –í –ë–ï–î–†–ï–ù–ù–£–Æ –ö–û–°–¢–¨ (–¥–ª–∏–Ω–Ω–∞—è —Ç—Ä—É–±—á–∞—Ç–∞—è –∫–æ—Å—Ç—å)
   - –ê–Ω–∞—Ç–æ–º–∏—á–µ—Å–∫–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ: –¢–ê–ó (–ø–æ–¥–≤–∑–¥–æ—à–Ω—ã–µ –∫–æ—Å—Ç–∏, –ª–æ–±–∫–æ–≤–∞—è –∫–æ—Å—Ç—å, –∫—Ä–µ—Å—Ç–µ—Ü), –ë–ï–î–†–û

   **–ü–õ–ï–ß–ï–í–û–ô –°–£–°–¢–ê–í:**
   - –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω –≤ –í–ï–†–•–ù–ï–ô –ö–û–ù–ï–ß–ù–û–°–¢–ò, —Å–æ–µ–¥–∏–Ω—è–µ—Ç –ø–ª–µ—á–µ–≤—É—é –∫–æ—Å—Ç—å —Å –ª–æ–ø–∞—Ç–∫–æ–π
   - –°—É—Å—Ç–∞–≤–Ω–∞—è –≤–ø–∞–¥–∏–Ω–∞ –ª–æ–ø–∞—Ç–∫–∏ (–≥–ª–µ–Ω–æ–∏–¥) - —á–∞—Å—Ç—å –õ–û–ü–ê–¢–ö–ò
   - –ì–æ–ª–æ–≤–∫–∞ –ø–ª–µ—á–µ–≤–æ–π –∫–æ—Å—Ç–∏ - —á–∞—Å—Ç—å –ü–õ–ï–ß–ï–í–û–ô –ö–û–°–¢–ò
   - –•–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏:
     * –°—É—Å—Ç–∞–≤–Ω–∞—è –≤–ø–∞–¥–∏–Ω–∞ –ª–æ–ø–∞—Ç–∫–∏ –ü–õ–û–°–ö–ê–Ø, –º–µ–ª–∫–∞—è (–Ω–µ —á–∞—à–∫–∞!)
     * –ì–æ–ª–æ–≤–∫–∞ –ø–ª–µ—á–µ–≤–æ–π –∫–æ—Å—Ç–∏ –®–ê–†–û–í–ò–î–ù–ê–Ø, –Ω–æ –º–µ–Ω—å—à–µ —á–µ–º —Ç–∞–∑–æ–±–µ–¥—Ä–µ–Ω–Ω–∞—è
     * –®–µ–π–∫–∞ –ø–ª–µ—á–µ–≤–æ–π –∫–æ—Å—Ç–∏ –ö–û–†–û–¢–ö–ê–Ø
     * –ë–æ–ª—å—à–æ–π –±—É–≥–æ—Ä–æ–∫ - –∫–æ—Å—Ç–Ω—ã–π –≤—ã—Å—Ç—É–ø –Ω–∞ –ø–ª–µ—á–µ–≤–æ–π –∫–æ—Å—Ç–∏
     * –≠–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑ –ø–ª–µ—á–µ–≤–æ–≥–æ —Å—É—Å—Ç–∞–≤–∞ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑:
       - –ì–ª–µ–Ω–æ–∏–¥–Ω–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ (–ø–ª–æ—Å–∫–∞—è –ø–ª–∞—Å—Ç–∏–Ω–∞) –Ω–∞ –ª–æ–ø–∞—Ç–∫–µ
       - –ì–æ–ª–æ–≤–∫–∏ –∏ –Ω–æ–∂–∫–∏ –≤ –ø–ª–µ—á–µ–≤–æ–π –∫–æ—Å—Ç–∏
     * –ù–æ–∂–∫–∞ —ç–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑–∞ –∏–¥–µ—Ç –í –ü–õ–ï–ß–ï–í–£–Æ –ö–û–°–¢–¨ (–¥–ª–∏–Ω–Ω–∞—è —Ç—Ä—É–±—á–∞—Ç–∞—è –∫–æ—Å—Ç—å –≤–µ—Ä—Ö–Ω–µ–π –∫–æ–Ω–µ—á–Ω–æ—Å—Ç–∏)
   - –ê–Ω–∞—Ç–æ–º–∏—á–µ—Å–∫–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ: –õ–û–ü–ê–¢–ö–ê, –ö–õ–Æ–ß–ò–¶–ê, –ü–õ–ï–ß–ï–í–ê–Ø –ö–û–°–¢–¨

   **–ö–õ–Æ–ß–ï–í–´–ï –†–ê–ó–õ–ò–ß–ò–Ø –î–õ–Ø –û–ü–†–ï–î–ï–õ–ï–ù–ò–Ø:**
   1. –¢–ê–ó–û–ë–ï–î–†–ï–ù–ù–´–ô —Å—É—Å—Ç–∞–≤ = –¢–ê–ó + –ë–ï–î–†–û (–Ω–∏–∂–Ω—è—è –∫–æ–Ω–µ—á–Ω–æ—Å—Ç—å)
   2. –ü–õ–ï–ß–ï–í–û–ô —Å—É—Å—Ç–∞–≤ = –õ–û–ü–ê–¢–ö–ê + –ü–õ–ï–ß–ï–í–ê–Ø –ö–û–°–¢–¨ (–≤–µ—Ä—Ö–Ω—è—è –∫–æ–Ω–µ—á–Ω–æ—Å—Ç—å)
   3. –ï—Å–ª–∏ –≤–∏–¥–∏—à—å –ü–û–î–í–ó–î–û–®–ù–´–ï –ö–û–°–¢–ò, –õ–û–ë–ö–û–í–£–Æ –ö–û–°–¢–¨, –ö–†–ï–°–¢–ï–¶ - —ç—Ç–æ –¢–ê–ó, –∑–Ω–∞—á–∏—Ç —Å—É—Å—Ç–∞–≤ –¢–ê–ó–û–ë–ï–î–†–ï–ù–ù–´–ô
   4. –ï—Å–ª–∏ –≤–∏–¥–∏—à—å –õ–û–ü–ê–¢–ö–£, –ö–õ–Æ–ß–ò–¶–£ - —ç—Ç–æ –í–ï–†–•–ù–Ø–Ø –ö–û–ù–ï–ß–ù–û–°–¢–¨, –∑–Ω–∞—á–∏—Ç —Å—É—Å—Ç–∞–≤ –ü–õ–ï–ß–ï–í–û–ô
   5. –í–µ—Ä—Ç–ª—É–∂–Ω–∞—è –≤–ø–∞–¥–∏–Ω–∞ (—á–∞—à–∫–∞) = –¢–ê–ó–û–ë–ï–î–†–ï–ù–ù–´–ô —Å—É—Å—Ç–∞–≤
   6. –ì–ª–µ–Ω–æ–∏–¥ (–ø–ª–æ—Å–∫–∞—è –≤–ø–∞–¥–∏–Ω–∞ –Ω–∞ –ª–æ–ø–∞—Ç–∫–µ) = –ü–õ–ï–ß–ï–í–û–ô —Å—É—Å—Ç–∞–≤
   7. –ù–æ–∂–∫–∞ —ç–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑–∞ –≤ –ë–ï–î–†–ï = –¢–ê–ó–û–ë–ï–î–†–ï–ù–ù–´–ô —ç–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑
   8. –ù–æ–∂–∫–∞ —ç–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑–∞ –≤ –ü–õ–ï–ß–ï–í–û–ô –ö–û–°–¢–ò = –ü–õ–ï–ß–ï–í–û–ô —ç–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑

   **–ù–ï –ü–£–¢–ê–¢–¨!** –ï—Å–ª–∏ —ç–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ç–∞–∑—É –∏ –±–µ–¥—Ä–µ - —ç—Ç–æ –¢–ê–ó–û–ë–ï–î–†–ï–ù–ù–´–ô —ç–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑, –ù–ï –ø–ª–µ—á–µ–≤–æ–π!

   - **–ù–∞–ª–∏—á–∏–µ –º–µ—Ç–∞–ª–ª–∏—á–µ—Å–∫–∏—Ö –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–π:**
     * –≠–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑—ã —Å—É—Å—Ç–∞–≤–æ–≤ - –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –æ–ø—Ä–µ–¥–µ–ª–∏ –¢–ò–ü —Å—É—Å—Ç–∞–≤–∞ –ü–ï–†–ï–î –æ–ø–∏—Å–∞–Ω–∏–µ–º!
       - –¢–ê–ó–û–ë–ï–î–†–ï–ù–ù–´–ô —ç–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑ (–≤–µ—Ä—Ç–ª—É–∂–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç + –±–µ–¥—Ä–µ–Ω–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç)
       - –ü–õ–ï–ß–ï–í–û–ô —ç–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑ (–≥–ª–µ–Ω–æ–∏–¥–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç + –ø–ª–µ—á–µ–≤–æ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç)
       - –ö–û–õ–ï–ù–ù–´–ô —ç–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑ (–±–µ–¥—Ä–µ–Ω–Ω—ã–π + –±–æ–ª—å—à–µ–±–µ—Ä—Ü–æ–≤—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã)
       - –õ–û–ö–¢–ï–í–û–ô —ç–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑
       - –î—Ä—É–≥–æ–π
     * –û—Å—Ç–µ–æ—Å–∏–Ω—Ç–µ–∑ (–ø–ª–∞—Å—Ç–∏–Ω—ã, –≤–∏–Ω—Ç—ã, —à—Ç–∏—Ñ—Ç—ã, —Å–ø–∏—Ü—ã, –ø—Ä–æ–≤–æ–ª–æ–∫–∞)
     * –°—Ç–µ—Ä–∂–Ω–∏ (–∏–Ω—Ç—Ä–∞–º–µ–¥—É–ª–ª—è—Ä–Ω—ã–µ)
     * –°–ø–∏—Ü—ã –ö–∏—Ä—à–Ω–µ—Ä–∞
     * –î—Ä—É–≥–∏–µ –∏–º–ø–ª–∞–Ω—Ç—ã

   - **–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —ç–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑–æ–≤:**
     * **–¢–ò–ü –°–£–°–¢–ê–í–ê:** –¢–û–ß–ù–û –æ–ø—Ä–µ–¥–µ–ª–∏ - —Ç–∞–∑–æ–±–µ–¥—Ä–µ–Ω–Ω—ã–π/–ø–ª–µ—á–µ–≤–æ–π/–∫–æ–ª–µ–Ω–Ω—ã–π/–ª–æ–∫—Ç–µ–≤–æ–π/–¥—Ä—É–≥–æ–π
     * **–õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è:** 
       - –î–ª—è —Ç–∞–∑–æ–±–µ–¥—Ä–µ–Ω–Ω–æ–≥–æ: –≤–µ—Ä—Ç–ª—É–∂–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –≤ —Ç–∞–∑—É, –±–µ–¥—Ä–µ–Ω–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –≤ –±–µ–¥—Ä–µ
       - –î–ª—è –ø–ª–µ—á–µ–≤–æ–≥–æ: –≥–ª–µ–Ω–æ–∏–¥–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –Ω–∞ –ª–æ–ø–∞—Ç–∫–µ, –ø–ª–µ—á–µ–≤–æ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –≤ –ø–ª–µ—á–µ–≤–æ–π –∫–æ—Å—Ç–∏
     * **–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —ç–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑–∞:**
       - –¢–∞–∑–æ–±–µ–¥—Ä–µ–Ω–Ω—ã–π: –≤–µ—Ä—Ç–ª—É–∂–Ω–∞—è —á–∞—à–∫–∞ + –≥–æ–ª–æ–≤–∫–∞ + –Ω–æ–∂–∫–∞ (–≤ –±–µ–¥—Ä–µ)
       - –ü–ª–µ—á–µ–≤–æ–π: –≥–ª–µ–Ω–æ–∏–¥–Ω–∞—è –ø–ª–∞—Å—Ç–∏–Ω–∞ + –≥–æ–ª–æ–≤–∫–∞ + –Ω–æ–∂–∫–∞ (–≤ –ø–ª–µ—á–µ–≤–æ–π –∫–æ—Å—Ç–∏)
     * –¶–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ (–Ω–µ—Ç –ª–∏ –ø–æ–ª–æ–º–æ–∫, —Ä–∞—Å—à–∞—Ç—ã–≤–∞–Ω–∏—è)
     * –ü–æ–ª–æ–∂–µ–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ (–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ/—Å–º–µ—â–µ–Ω–∏–µ/–≤—ã–≤–∏—Ö)
     * –ü—Ä–∏–∑–Ω–∞–∫–∏ –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ (–ª–∏–Ω–∏–∏ –ø—Ä–æ—Å–≤–µ—Ç–ª–µ–Ω–∏—è –≤–æ–∫—Ä—É–≥ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤)
     * –ü—Ä–∏–∑–Ω–∞–∫–∏ –æ—Å—Ç–µ–æ–ª–∏–∑–∞ (–¥–µ—Å—Ç—Ä—É–∫—Ü–∏—è –∫–æ—Å—Ç–∏ –≤–æ–∫—Ä—É–≥ –∏–º–ø–ª–∞–Ω—Ç–∞)

   - **–°–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ—Å—Ç–∏ –≤–æ–∫—Ä—É–≥ –∏–º–ø–ª–∞–Ω—Ç–∞:**
     * –†–µ–∞–∫—Ü–∏—è –∫–æ—Å—Ç–∏ (–Ω–æ—Ä–º–∞–ª—å–Ω–∞—è/–≥–∏–ø–µ—Ä—Ç—Ä–æ—Ñ–∏—è/–∞—Ç—Ä–æ—Ñ–∏—è)
     * –ü—Ä–∏–∑–Ω–∞–∫–∏ –∏–Ω—Ñ–µ–∫—Ü–∏–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
     * –ü—Ä–∏–∑–Ω–∞–∫–∏ —Ä–∞—Å—à–∞—Ç—ã–≤–∞–Ω–∏—è

5. **–ü–ê–¢–û–õ–û–ì–ò–ß–ï–°–ö–ò–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø:**
   - **–ü–µ—Ä–µ–ª–æ–º—ã:**
     * –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è (–¢–û–ß–ù–û: –∫–∞–∫–∞—è –∫–æ—Å—Ç—å, –∫–∞–∫–∞—è —á–∞—Å—Ç—å)
     * –¢–∏–ø –ø–µ—Ä–µ–ª–æ–º–∞ (–ø–æ–ø–µ—Ä–µ—á–Ω—ã–π/–∫–æ—Å–æ–π/—Å–ø–∏—Ä–∞–ª—å–Ω—ã–π/–æ—Å–∫–æ–ª—å—á–∞—Ç—ã–π/–≤–∫–æ–ª–æ—á–µ–Ω–Ω—ã–π)
     * –°–º–µ—â–µ–Ω–∏–µ (–µ—Å—Ç—å/–Ω–µ—Ç, –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ, —Å—Ç–µ–ø–µ–Ω—å –≤ –º–º)
     * –í–∏–Ω—Ç–æ–æ–±—Ä–∞–∑–Ω–∞—è –¥–µ—Ñ–æ—Ä–º–∞—Ü–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å)
     * –í–Ω—É—Ç—Ä–∏—Å—É—Å—Ç–∞–≤–Ω–æ–π/–≤–Ω–µ—Å—É—Å—Ç–∞–≤–Ω–æ–π
   - **–î–µ—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
     * –û—á–∞–≥–∏ –¥–µ—Å—Ç—Ä—É–∫—Ü–∏–∏ (–ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è, —Ä–∞–∑–º–µ—Ä, –∫–æ–Ω—Ç—É—Ä—ã)
     * –û—Å—Ç–µ–æ–ª–∏–∑ (–ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è, –ø—Ä–æ—Ç—è–∂–µ–Ω–Ω–æ—Å—Ç—å)
   - **–î–µ–≥–µ–Ω–µ—Ä–∞—Ç–∏–≤–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
     * –û—Å—Ç–µ–æ—Ñ–∏—Ç—ã (–ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è, —Ä–∞–∑–º–µ—Ä)
     * –°—É–∂–µ–Ω–∏–µ —Å—É—Å—Ç–∞–≤–Ω—ã—Ö —â–µ–ª–µ–π
     * –°—É–±—Ö–æ–Ω–¥—Ä–∞–ª—å–Ω—ã–π —Å–∫–ª–µ—Ä–æ–∑
     * –ö–∏—Å—Ç—ã (–µ—Å–ª–∏ –≤–∏–¥–Ω—ã)
   - **–í–æ—Å–ø–∞–ª–∏—Ç–µ–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
     * –ü—Ä–∏–∑–Ω–∞–∫–∏ –∞—Ä—Ç—Ä–∏—Ç–∞ (—Å—É–∂–µ–Ω–∏–µ —â–µ–ª–∏, —ç—Ä–æ–∑–∏–∏, –æ—Å—Ç–µ–æ–ø–æ—Ä–æ–∑)
     * –ü–µ—Ä–∏–æ—Å—Ç–∏—Ç (–µ—Å–ª–∏ –µ—Å—Ç—å)
   - **–û–ø—É—Ö–æ–ª–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
     * –û—á–∞–≥–∏ –¥–µ—Å—Ç—Ä—É–∫—Ü–∏–∏/–æ—Å—Ç–µ–æ—Å–∫–ª–µ—Ä–æ–∑–∞
     * –î–µ—Ñ–æ—Ä–º–∞—Ü–∏—è –∫–æ—Å—Ç–∏
     * –ü–∞—Ç–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –ø–µ—Ä–µ–ª–æ–º—ã

6. **–°–†–ê–í–ù–ï–ù–ò–ï –° –ù–û–†–ú–û–ô:**
   - –î–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —É–∫–∞–∂–∏: –Ω–æ—Ä–º–∞/–ø–∞—Ç–æ–ª–æ–≥–∏—è
   - –ï—Å–ª–∏ –ø–∞—Ç–æ–ª–æ–≥–∏—è: –æ–ø–∏—à–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–µ—Ç–∞–ª—å–Ω–æ

7. **–ö–õ–ò–ù–ò–ß–ï–°–ö–ê–Ø –ò–ù–¢–ï–†–ü–†–ï–¢–ê–¶–ò–Ø:**
   - **–û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Ö–æ–¥–∫–∏:** –∫—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ –∫–ª—é—á–µ–≤—ã—Ö –ø–∞—Ç–æ–ª–æ–≥–∏–π
   - **–î–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –¥–∏–∞–≥–Ω–æ–∑:** —Å–ø–∏—Å–æ–∫ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –¥–∏–∞–≥–Ω–æ–∑–æ–≤ —Å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é
   - **–û—Ü–µ–Ω–∫–∞ –æ—Å—Ç—Ä–æ—Ç—ã:** –æ—Å—Ç—Ä–æ–µ/–ø–æ–¥–æ—Å—Ç—Ä–æ–µ/—Ö—Ä–æ–Ω–∏—á–µ—Å–∫–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
   - **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
     * –ù–µ–æ—Ç–ª–æ–∂–Ω—ã–µ –º–µ—Ä—ã (–µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è)
     * –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è (–ö–¢, –ú–†–¢, –£–ó–ò, –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω—ã–µ –∞–Ω–∞–ª–∏–∑—ã)
     * –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤
     * –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è

8. **–ö–û–î–´ –ú–ö–ë-10:**
   - –£–∫–∞–∂–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –∫–æ–¥—ã –ú–ö–ë-10 –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–Ω—ã—Ö –ø–∞—Ç–æ–ª–æ–≥–∏–π

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê:
- –ù–ò–ö–û–ì–î–ê –Ω–µ –ø—É—Ç–∞–π –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏! –°–ù–ê–ß–ê–õ–ê –æ–ø—Ä–µ–¥–µ–ª–∏ –¢–û–ß–ù–û, —á—Ç–æ –≤–∏–¥–∏—à—å –Ω–∞ —Å–Ω–∏–º–∫–µ
- –ë–µ–¥—Ä–æ –ù–ï –º–æ–∂–µ—Ç –±—ã—Ç—å –≥—Ä—É–¥–Ω–æ–π –∫–ª–µ—Ç–∫–æ–π - —É –Ω–∏—Ö —Å–æ–≤–µ—Ä—à–µ–Ω–Ω–æ —Ä–∞–∑–Ω–∞—è –∞–Ω–∞—Ç–æ–º–∏—è
- –ü–ª–µ—á–æ –ù–ï –º–æ–∂–µ—Ç –±—ã—Ç—å –±–µ–¥—Ä–æ–º - —Å—Ä–∞–≤–Ω–∏ —Ä–∞–∑–º–µ—Ä—ã, —Ñ–æ—Ä–º—É, —Å—É—Å—Ç–∞–≤—ã
- –ï—Å–ª–∏ –≤–∏–¥–∏—à—å –º–µ—Ç–∞–ª–ª–∏—á–µ—Å–∫–∏–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ - –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –æ–ø–∏—à–∏ –∏—Ö –¥–µ—Ç–∞–ª—å–Ω–æ
- –ï—Å–ª–∏ –Ω–µ —É–≤–µ—Ä–µ–Ω –≤ –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏ - —Ç–∞–∫ –∏ —É–∫–∞–∂–∏, –Ω–µ —É–≥–∞–¥—ã–≤–∞–π
- –ò—Å–ø–æ–ª—å–∑—É–π –∞–Ω–∞—Ç–æ–º–∏—á–µ—Å–∫–∏–µ –æ—Ä–∏–µ–Ω—Ç–∏—Ä—ã –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏
- –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –í–°–ï –≤–∏–¥–∏–º—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã, –Ω–µ –ø—Ä–æ–ø—É—Å–∫–∞–π –æ–±–ª–∞—Å—Ç–∏
- –£–∫–∞–∑—ã–≤–∞–π –¢–û–ß–ù–£–Æ –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—é –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–ø–µ—Ä–µ–ª–æ–º –¥–∏–∞—Ñ–∏–∑–∞ –ø—Ä–∞–≤–æ–π –±–µ–¥—Ä–µ–Ω–Ω–æ–π –∫–æ—Å—Ç–∏ –≤ —Å—Ä–µ–¥–Ω–µ–π —Ç—Ä–µ—Ç–∏")
- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –æ–±—â–∏–µ —Ñ—Ä–∞–∑—ã - –±—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–µ–Ω
- –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ –≤–∏–¥–Ω–æ —á–µ—Ç–∫–æ - —Ç–∞–∫ –∏ —É–∫–∞–∂–∏, –Ω–µ –≤—ã–¥—É–º—ã–≤–∞–π
- –°—Å—ã–ª–∞–π—Å—è –Ω–∞ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –≥–∞–π–¥–ª–∞–π–Ω—ã (Fleischner Society, ACR, ESR, RSNA)
"""
        
        elif "–º—Ä—Ç" in prompt_lower or "mri" in prompt_lower:
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–Ω—ã–π –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
            try:
                from prompts.diagnostic_prompts import get_mri_diagnostic_prompt
                medical_prompt = get_mri_diagnostic_prompt(self.system_prompt)
                # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
                if prompt and prompt.strip():
                    medical_prompt += f"\n\n–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:\n{prompt}"
            except ImportError:
                # Fallback –Ω–∞ –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç –µ—Å–ª–∏ –º–æ–¥—É–ª—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
                medical_prompt = f"""{self.system_prompt}

–í—ã ‚Äî –≤—Ä–∞—á-–Ω–µ–π—Ä–æ—Ä–∞–¥–∏–æ–ª–æ–≥ —Å 20-–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º —Ä–∞–±–æ—Ç—ã. –í—ã–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª–Ω—ã–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —É–≤–∏–¥–µ–Ω–Ω–æ–≥–æ.

{prompt}"""
        
        elif "–∫—Ç" in prompt_lower or "ct" in prompt_lower or "–∫–æ–º–ø—å—é—Ç–µ—Ä–Ω" in prompt_lower:
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–Ω—ã–π –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
            try:
                from prompts.diagnostic_prompts import get_ct_diagnostic_prompt
                medical_prompt = get_ct_diagnostic_prompt(self.system_prompt)
                # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
                if prompt and prompt.strip():
                    medical_prompt += f"\n\n–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:\n{prompt}"
            except ImportError:
                # Fallback –Ω–∞ –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç –µ—Å–ª–∏ –º–æ–¥—É–ª—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
                medical_prompt = f"""{self.system_prompt}

–¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ä–∞–¥–∏–æ–ª–æ–≥, –æ–±–ª–∞–¥–∞–µ—à—å —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–º–∏ –∑–Ω–∞–Ω–∏—è–º–∏ –≤ –æ–±–ª–∞—Å—Ç–∏ –ö–¢. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –≤—ã—è–≤–ª—è—Ç—å –ø–∞—Ç–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è, –¥–∞–≤–∞—Ç—å –∑–∞–∫–ª—é—á–µ–Ω–∏–µ —Å–æ–≥–ª–∞—Å–Ω–æ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º.

{prompt}"""
        
        elif "–ª–∞–±–æ—Ä–∞—Ç–æ—Ä" in prompt_lower or ("–∞–Ω–∞–ª–∏–∑" in prompt_lower and ("–∫—Ä–æ–≤" in prompt_lower or "–º–æ—á" in prompt_lower or "–±–∏–æ—Ö–∏–º" in prompt_lower or "lab" in prompt_lower)):
            medical_prompt = f"""{self.system_prompt}

–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–µ.
–í –≠–¢–û–ú –†–ï–ñ–ò–ú–ï –¢–í–û–Ø –ó–ê–î–ê–ß–ê ‚Äî –¢–û–õ–¨–ö–û –°–ö–ê–ù–ò–†–û–í–ê–ù–ò–ï –ò –ò–ó–í–õ–ï–ß–ï–ù–ò–ï –î–ê–ù–ù–´–• –ò–ó –õ–ê–ë–û–†–ê–¢–û–†–ù–û–ì–û –û–¢–ß–Å–¢–ê (CBC, –±–∏–æ—Ö–∏–º–∏—è –∏ –¥—Ä.).

–°–î–ï–õ–ê–ô –¢–û–õ–¨–ö–û –°–õ–ï–î–£–Æ–©–ï–ï:
- –ê–∫–∫—É—Ä–∞—Ç–Ω–æ –∏–∑–≤–ª–µ–∫–∏ –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–Ω–∞–∑–≤–∞–Ω–∏–µ, –∑–Ω–∞—á–µ–Ω–∏–µ, –µ–¥–∏–Ω–∏—Ü—ã, —Ä–µ—Ñ–µ—Ä–µ–Ω—Å–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã, –µ—Å–ª–∏ –µ—Å—Ç—å).
- –ß—ë—Ç–∫–æ –æ—Ç–º–µ—Ç—å, –∫–∞–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤–Ω–µ —Ä–µ—Ñ–µ—Ä–µ–Ω—Å–Ω–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ (–ø–æ–≤—ã—à–µ–Ω—ã/–ø–æ–Ω–∏–∂–µ–Ω—ã).
- –°–æ—Ö—Ä–∞–Ω–∏ –∏—Å—Ö–æ–¥–Ω—ã–µ –æ–±–æ–∑–Ω–∞—á–µ–Ω–∏—è –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, WBC, RBC, Hb, PLT, Lym%, Neu% –∏ —Ç.–ø.).

–í–ê–ñ–ù–û:
- –ù–ï –¥–∞–≤–∞–π –∫–ª–∏–Ω–∏—á–µ—Å–∫—É—é –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—é, –¥–∏–∞–≥–Ω–æ–∑—ã, –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –¥–∏–∞–≥–Ω–æ–∑ –∏–ª–∏ –ø–ª–∞–Ω –ª–µ—á–µ–Ω–∏—è.
- –ù–ï —Å—Ä–∞–≤–Ω–∏–≤–∞–π —ç—Ç–æ—Ç –æ—Ç—á—ë—Ç —Å —Ä–∞–¥–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–º–∏ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è–º–∏ –∏ –Ω–µ –ø–∏—à–∏, —á—Ç–æ —ç—Ç–æ ¬´–Ω–µ —Ä–µ–Ω—Ç–≥–µ–Ω / –Ω–µ –ú–†–¢ / –Ω–µ —Ä–∞–¥–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ¬ª.
- –ù–ï –¥–æ–±–∞–≤–ª—è–π —Ä–∞–∑–¥–µ–ª—ã –≤—Ä–æ–¥–µ ¬´–õ–æ–≥ –≤–µ–±-–∑–∞–ø—Ä–æ—Å–æ–≤¬ª, –Ω–µ –ø–µ—Ä–µ—á–∏—Å–ª—è–π —Å–∞–π—Ç—ã, URL, DOI ‚Äî —Å—Å—ã–ª–∫–∏ –∏ –ª–æ–≥ –∑–∞–ø—Ä–æ—Å–æ–≤ –ù–ï –ù–£–ñ–ù–´.
- –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–æ—Å—Ç–æ–π —Ç–µ–∫—Å—Ç –∏–ª–∏ JSON-—Å—Ç—Ä—É–∫—Ç—É—Ä—É, –Ω–æ –±–µ–∑ –∫–ª–∏–Ω–∏—á–µ—Å–∫–∏—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π.

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ (–ø—Ä–∏–º–µ—Ä JSON –ø–æ –∂–µ–ª–∞–Ω–∏—é):
{{
  "parameters": [
    {{"name": "WBC", "value": "...", "unit": "...", "reference": "..." , "status": "high/low/normal"}},
    ...
  ],
  "raw_text": "–ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ ‚Äî –≤–µ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –æ—Ç—á—ë—Ç–∞"
}}
"""
        
        elif "–∫—Ç" in prompt_lower or "ct" in prompt_lower or "–∫–æ–º–ø—å—é—Ç–µ—Ä–Ω" in prompt_lower:
            medical_prompt = f"""{self.system_prompt}

–¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ä–∞–¥–∏–æ–ª–æ–≥, –æ–±–ª–∞–¥–∞–µ—à—å —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–º–∏ –∑–Ω–∞–Ω–∏—è–º–∏ –≤ –æ–±–ª–∞—Å—Ç–∏ –ö–¢, –ú–†–¢, —Ä–µ–Ω—Ç–≥–µ–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –≤—ã—è–≤–ª—è—Ç—å –ø–∞—Ç–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è, 
    –¥–∞–≤–∞—Ç—å –∑–∞–∫–ª—é—á–µ–Ω–∏–µ –ø–æ –æ—Ä–≥–∞–Ω–∞–º –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞–º —Å–æ–≥–ª–∞—Å–Ω–æ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º –∏ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, ESR, ACR, Fleischner Society, RSNA),
    –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –æ–Ω–ª–∞–π–Ω-—Ä–µ—Å—É—Ä—Å—ã (Radiopaedia, UpToDate, Medscape) –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö. –†–∞–±–æ—Ç–∞–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–æ: –∫—Ä–∞—Ç–∫–æ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ,
    –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø–æ –æ—Ä–≥–∞–Ω–∞–º –∏ –∑–æ–Ω–∞–º, –æ—Ü–µ–Ω–∫–∞ –ø–∞—Ç–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π, —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –≤—Ä–∞—á–∞, –≤ —Ç–æ–º —á–∏—Å–ª–µ –ø–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–µ –∏ –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏—é.
    –ü—Ä–µ–¥–ª–∞–≥–∞–π –≤–µ—Ä–æ—è—Ç–Ω—ã–µ –¥–∏–∞–≥–Ω–æ–∑—ã –∏ –£–∫–∞–∑—ã–≤–∞–π, –∫–∞–∫–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–ª–∏–Ω–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ (–≤–æ–∑—Ä–∞—Å—Ç, –∂–∞–ª–æ–±—ã, –∞–Ω–∞–º–Ω–µ–∑, —Å–æ–ø—É—Ç—Å—Ç–≤—É—é—â–∏–µ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è, –∏—Å—Ç–æ—Ä–∏—è –ª–µ—á–µ–Ω–∏—è). –ü—Ä–µ–¥–ª–∞–≥–∞–π –Ω–∞–∏–±–æ–ª–µ–µ –≤–µ—Ä–æ—è—Ç–Ω—ã–µ –¥–∏–∞–≥–Ω–æ–∑—ã.–ù–µ –¥–µ–ª–∞–π –Ω–µ–æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω—ã—Ö –≤—ã–≤–æ–¥–æ–≤, –∏–∑–±–µ–≥–∞–π –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–π, –Ω–µ –≤—ã–¥—É–º—ã–≤–∞–π –¥–∏–∞–≥–Ω–æ–∑—ã –±–µ–∑ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö. –ò—Å–ø–æ–ª—å–∑—É–π –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞: –ö–¢, –ú–†–¢, —Ä–µ–Ω—Ç–≥–µ–Ω, –ø–∞—Ç–æ–ª–æ–≥–∏—è, –∑–∞–∫–ª—é—á–µ–Ω–∏–µ, —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞, —Å—Ç–µ–ø–µ–Ω–∏—Ç –≤—ã—Ä–∞–∂–µ–Ω–Ω–æ—Å—Ç–∏, –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—ã, online-—Ä–µ—Å—É—Ä—Å—ã.
"""
        
        elif "—É–∑–∏" in prompt_lower or "—É–ª—å—Ç—Ä–∞–∑–≤—É–∫" in prompt_lower or "ultrasound" in prompt_lower:
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–Ω—ã–π –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
            try:
                from prompts.diagnostic_prompts import get_ultrasound_diagnostic_prompt
                medical_prompt = get_ultrasound_diagnostic_prompt(self.system_prompt)
                # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
                if prompt and prompt.strip():
                    medical_prompt += f"\n\n–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:\n{prompt}"
            except ImportError:
                # Fallback –Ω–∞ –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç –µ—Å–ª–∏ –º–æ–¥—É–ª—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
                medical_prompt = f"""{self.system_prompt}

–í—ã ‚Äî –≤—Ä–∞—á —É–ª—å—Ç—Ä–∞–∑–≤—É–∫–æ–≤–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ —Å 12-–ª–µ—Ç–Ω–∏–º —Å—Ç–∞–∂–µ–º —Ä–∞–±–æ—Ç—ã. –î–µ—Ç–∞–ª—å–Ω–æ –æ–ø–∏—à–∏—Ç–µ –£–ó–ò-–∫–∞—Ä—Ç–∏–Ω—É.

1. –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –ü–ê–†–ê–ú–ï–¢–†–´:
        
        # –î–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –ù–ï –¥–æ–±–∞–≤–ª—è–µ–º system_prompt - –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ–º–ø—Ç –∫–∞–∫ –µ—Å—Ç—å
        # –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –∏—Å–ø–æ–ª—å–∑—É–µ–º set –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
        elif any(keyword in prompt_lower for keyword in {
            "–¥–æ–∫—É–º–µ–Ω—Ç", "—Å–ø—Ä–∞–≤–∫–∞", "—Ä–µ—Ü–µ–ø—Ç", "–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ", "–≤—ã–ø–∏—Å–∫–∞", 
            "–±–æ–ª—å–Ω–∏—á–Ω—ã–π", "–∏–∑–≤–ª–µ–∫–∏—Ç–µ", "—Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ", "document", "extract",
            "–º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–π —Å–ø—Ä–∞–≤–∫–∏", "–º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤", "—Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—é –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö"
        }):
            # –î–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ–º–ø—Ç –ë–ï–ó system_prompt - —Ç–æ–ª—å–∫–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
            medical_prompt = prompt  # –ü—Ä–æ–º–ø—Ç —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ
   - –î–∞—Ç—á–∏–∫ –∏ —á–∞—Å—Ç–æ—Ç–∞
   - –ì–ª—É–±–∏–Ω–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
   - –ö–∞—á–µ—Å—Ç–≤–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è

2. –≠–•–û–ì–ï–ù–ù–û–°–¢–¨:
   - –ê–Ω—ç—Ö–æ–≥–µ–Ω–Ω—ã–µ –∑–æ–Ω—ã
   - –ì–∏–ø–æ—ç—Ö–æ–≥–µ–Ω–Ω—ã–µ –æ–±–ª–∞—Å—Ç–∏
   - –ì–∏–ø–µ—Ä—ç—Ö–æ–≥–µ–Ω–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
   - –ù–µ–æ–¥–Ω–æ—Ä–æ–¥–Ω–æ—Å—Ç—å

3. –î–û–ü–ü–õ–ï–†–û–í–°–ö–ò–ï –•–ê–†–ê–ö–¢–ï–†–ò–°–¢–ò–ö–ò:
   - –í–∞—Å–∫—É–ª—è—Ä–∏–∑–∞—Ü–∏—è
   - –°–∫–æ—Ä–æ—Å—Ç—å –∫—Ä–æ–≤–æ—Ç–æ–∫–∞
   - –†–µ–∑–∏—Å—Ç–∏–≤–Ω—ã–π –∏–Ω–¥–µ–∫—Å

4. –ò–ó–ú–ï–†–ï–ù–ò–Ø:
   - –†–∞–∑–º–µ—Ä—ã –æ—Ä–≥–∞–Ω–æ–≤/–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–π
   - –¢–æ–ª—â–∏–Ω–∞ —Å—Ç–µ–Ω–æ–∫
   - –û–±—ä–µ–º—ã

5. –§–£–ù–ö–¶–ò–û–ù–ê–õ–¨–ù–ê–Ø –û–¶–ï–ù–ö–ê:
   - –°–æ–∫—Ä–∞—Ç–∏–º–æ—Å—Ç—å
   - –ü–µ—Ä–∏—Å—Ç–∞–ª—å—Ç–∏–∫–∞
   - –ö–æ–º–ø—Ä–µ—Å—Å–∏—è

–î–∞–π—Ç–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ ¬´–ö–ª–∏–Ω–∏—á–µ—Å–∫–∞—è –¥–∏—Ä–µ–∫—Ç–∏–≤–∞¬ª.
"""
        
        else:
            medical_prompt = f"""{self.system_prompt}

–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —ç—Ç–æ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞–∫ –≤—Ä–∞—á-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç —Å –±–æ–ª—å—à–∏–º –æ–ø—ã—Ç–æ–º —Ä–∞–±–æ—Ç—ã.
–î–∞–π—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ ¬´–ö–ª–∏–Ω–∏—á–µ—Å–∫–∞—è –¥–∏—Ä–µ–∫—Ç–∏–≤–∞¬ª.

{prompt}
"""
        
        # –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ä–æ—É—Ç–µ—Ä, –ø–µ—Ä–µ–¥–∞–µ–º –ø–æ–ª–Ω—ã–π medical_prompt (—Å system_prompt)
        # –í—Ä–µ–º–µ–Ω–Ω–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –≤–Ω–µ—à–Ω–µ–≥–æ —Ä–æ—É—Ç–µ—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π, —Ç.–∫. –º–æ–¥—É–ª—å —É–¥–∞–ª—ë–Ω
        if use_router:
            # –í—ã–≤–æ–¥–∏–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
            if not OpenRouterAssistant._router_warning_shown:
                print("‚ö†Ô∏è –†–æ—É—Ç–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω (modules.medical_image_router –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω). "
                      "–ò—Å–ø–æ–ª—å–∑—É—é –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é –ª–æ–≥–∏–∫—É –≤—ã–±–æ—Ä–∞ –º–æ–¥–µ–ª–µ–π.")
                OpenRouterAssistant._router_warning_shown = True
                use_router = False
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º metadata –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –º–æ–¥–µ–ª–∏ –∏–∑ —Ä–æ—É—Ç–µ—Ä–∞ (–î–û —Å–±–æ—Ä–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞)
        router_model = None
        is_document = False
        if isinstance(metadata, dict):
            router_model = metadata.get("router_model")
            # –ï—Å–ª–∏ —Ä–æ—É—Ç–µ—Ä –≤—ã–±—Ä–∞–ª Llama, —ç—Ç–æ –¥–æ–∫—É–º–µ–Ω—Ç
            if router_model and "llama" in router_model.lower():
                is_document = True
        
        # –°–æ–±–∏—Ä–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
        content = [{"type": "text", "text": medical_prompt}]
        
        if metadata:
            metadata_str = str(metadata) if not isinstance(metadata, dict) else str(metadata)
            content.append({"type": "text", "text": f"\n\n–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:\n{metadata_str}"})
        
        if image_array is not None:
            base64_str = self.encode_image(image_array)
            content.append({
                "type": "image_url",
                "image_url": {"url": f"data:image/png;base64,{base64_str}"}
            })
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –º–æ–¥–µ–ª–∏ –∏ —Ñ–∏–ª—å—Ç—Ä—É–µ–º –∏—Ö
        # –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –∫–µ—à–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –º–æ–¥–µ–ª–µ–π (–º–æ–¥–µ–ª–∏ –Ω–µ –º–µ–Ω—è—é—Ç—Å—è –≤–æ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã)
        if not hasattr(self, '_cached_active_models') or self._cached_active_models is None:
            self._cached_active_models = [m for m in self.models if not check_deprecated(m)]
        active_models = self._cached_active_models
        
        # –ë–∞–∑–æ–≤—ã–µ —Ñ–ª–∞–≥–∏ –∑–∞–¥–∞—á–∏
        prompt_lower = prompt.lower() if prompt else ""
        is_ecg = "—ç–∫–≥" in prompt_lower or "ecg" in prompt_lower
        is_lab = "–ª–∞–±–æ—Ä–∞—Ç–æ—Ä" in prompt_lower or (
            "–∞–Ω–∞–ª–∏–∑" in prompt_lower and any(k in prompt_lower for k in ["–∫—Ä–æ–≤", "–º–æ—á", "–±–∏–æ—Ö–∏–º", "lab"])
        )
        
        # –ï—Å–ª–∏ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–∏–ª–∏ —á–µ—Ä–µ–∑ metadata, –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ–º–ø—Ç –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
        # –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –∏—Å–ø–æ–ª—å–∑—É–µ–º set –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ (O(1) –≤–º–µ—Å—Ç–æ O(n))
        if not is_document:
            document_keywords = {
                "–¥–æ–∫—É–º–µ–Ω—Ç", "—Å–ø—Ä–∞–≤–∫–∞", "—Ä–µ—Ü–µ–ø—Ç", "–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ", "–≤—ã–ø–∏—Å–∫–∞", 
                "–±–æ–ª—å–Ω–∏—á–Ω—ã–π", "–∏–∑–≤–ª–µ–∫–∏—Ç–µ", "—Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ", "document", "extract",
                "–º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–π —Å–ø—Ä–∞–≤–∫–∏", "–º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤"
            }
            is_document = any(keyword in prompt_lower for keyword in document_keywords)
        
        # ----- –í—ã–±–æ—Ä –º–æ–¥–µ–ª–µ–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –∑–∞–¥–∞—á–∏ -----
        # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç force_model, –∑–∞—Ç–µ–º —è–≤–Ω—ã–µ —Ç–∏–ø—ã –∑–∞–¥–∞—á, –∑–∞—Ç–µ–º –¥–µ—Ñ–æ–ª—Ç (Opus)
        if force_model:
            fm = force_model.lower()
            if fm == "opus":
                models_to_try = ["anthropic/claude-opus-4.5"]
            elif fm == "sonnet":
                models_to_try = ["anthropic/claude-sonnet-4.5"]
            elif fm == "haiku":
                models_to_try = ["anthropic/claude-haiku-4.5"]
            elif fm == "llama":
                models_to_try = ["meta-llama/llama-3.2-90b-vision-instruct"]
            else:
                models_to_try = active_models
        elif is_document:
            # –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ/—Ä–∞–∑–±–æ—Ä –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ ‚Üí Haiku 4.5 (–±—ã—Å—Ç—Ä–æ–µ OCR/—Ç–µ–∫—Å—Ç)
            models_to_try = [
                "anthropic/claude-haiku-4.5",
                "meta-llama/llama-3.2-90b-vision-instruct"
            ]
        elif is_lab:
            # –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ ‚Üí Sonnet 4.5
            models_to_try = [
                "anthropic/claude-sonnet-4.5",
                "anthropic/claude-opus-4.5"
            ]
        else:
            # –í—Å–µ –∫–ª–∏–Ω–∏—á–µ—Å–∫–∏–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –∏ –∞–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π ‚Üí Opus 4.5
            models_to_try = [
                "anthropic/claude-opus-4.5",
                "anthropic/claude-sonnet-4.5",
                "anthropic/claude-haiku-4.5"
            ]
        
        # –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—à–µ–Ω –∫–æ–Ω—Å–µ–Ω—Å—É—Å, –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–æ–¥–µ–ª–µ–π
        use_consensus = False
        if isinstance(metadata, dict):
            use_consensus = metadata.get('consensus_mode', False)
        
        # –î–ª—è –≠–ö–ì –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –∑–∞–∫–ª—é—á–µ–Ω–∏—è
        max_tokens_consensus = MAX_TOKENS_ECG if is_ecg else MAX_TOKENS_DEFAULT
        
        if use_consensus and len(models_to_try) > 1:
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—ã–µ 3-4 –º–æ–¥–µ–ª–∏ –¥–ª—è –∫–æ–Ω—Å–µ–Ω—Å—É—Å–∞
            models_to_try = models_to_try[:min(MAX_CONSENSUS_MODELS, len(models_to_try))]
            results = []
            # –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ø–µ—à–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ –¥–ª—è –∫–æ–Ω—Å–µ–Ω—Å—É—Å–∞ (2 –∏–∑ 3-4)
            min_consensus_results = min(MIN_CONSENSUS_RESULTS, len(models_to_try))
            
            for model in models_to_try:
                try:
                    start_time = time.time()
                    messages = [
                        {"role": "system", "content": self.system_prompt},
                        {"role": "user", "content": content}
                    ]
                    payload = {
                        "model": model,
                        "messages": messages,
                        "max_tokens": max_tokens_consensus,
                        "temperature": 0.1
                    }
                    
                    response = requests.post(self.base_url, headers=self.headers, json=payload, timeout=API_TIMEOUT_SECONDS)
                    latency = time.time() - start_time
                    
                    if response.status_code == 200:
                        result_data = response.json()
                        result = result_data["choices"][0]["message"]["content"]
                        tokens_used = result_data.get("usage", {}).get("total_tokens", 0)
                        self._log_api_success(model, latency, tokens_used)
                        results.append({
                            "model": model,
                            "result": result,
                            "tokens": tokens_used
                        })
                        # –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: —Ä–∞–Ω–Ω–∏–π –≤—ã—Ö–æ–¥ –µ—Å–ª–∏ –ø–æ–ª—É—á–∏–ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è –∫–æ–Ω—Å–µ–Ω—Å—É—Å–∞
                        if len(results) >= min_consensus_results:
                            break
                    elif response.status_code == 402:
                        # –û—à–∏–±–∫–∞ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∞ –∫—Ä–µ–¥–∏—Ç–æ–≤ - –ø—Ä–æ–±—É–µ–º –º–µ–Ω—å—à–µ —Ç–æ–∫–µ–Ω–æ–≤
                        print(f"‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–µ–¥–∏—Ç–æ–≤ –¥–ª—è {max_tokens_consensus} —Ç–æ–∫–µ–Ω–æ–≤ –≤ –∫–æ–Ω—Å–µ–Ω—Å—É—Å–µ. –ü—Ä–æ–ø—É—Å–∫–∞—é –º–æ–¥–µ–ª—å {model}.")
                        error_msg = f"HTTP 402: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–µ–¥–∏—Ç–æ–≤"
                        self._log_api_error(model, latency, error_msg)
                        continue
                    else:
                        error_msg = f"HTTP {response.status_code}: {response.text[:200]}"
                        self._log_api_error(model, latency, error_msg)
                except Exception as e:
                    latency = time.time() - start_time if 'start_time' in locals() else 0
                    error_msg = handle_error(e, f"send_vision_request ({model})", show_to_user=False)
                    self._log_api_error(model, latency, error_msg)
                    continue
            
            if results:
                # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è –∫–æ–Ω—Å–µ–Ω—Å—É—Å–∞
                return results
        
        # –î–ª—è –≠–ö–ì –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –∑–∞–∫–ª—é—á–µ–Ω–∏—è
        # –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –Ω–∞—á–∏–Ω–∞–µ–º —Å –º–µ–Ω—å—à–∏—Ö max_tokens –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
        # –ï—Å–ª–∏ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç, —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ø—Ä–æ–±—É–µ—Ç –±–æ–ª—å—à–µ
        max_tokens_list = MAX_TOKENS_ECG_LIST if is_ecg else MAX_TOKENS_DEFAULT_LIST
        
        # Fallback –º–æ–¥–µ–ª–∏ –¥–ª—è –≠–ö–ì (–µ—Å–ª–∏ Claude –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑-–∑–∞ –∫—Ä–µ–¥–∏—Ç–æ–≤)
        claude_failed = False  # –§–ª–∞–≥, —á—Ç–æ –≤—Å–µ Claude –º–æ–¥–µ–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã
        
        # Fallback –º–æ–¥–µ–ª–∏ (—Ç–æ–ª—å–∫–æ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ) - –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ—Å–ª–µ models_to_try
        # Llama 3.2 90B Vision - —Ñ–∏–Ω–∞–ª—å–Ω—ã–π fallback –¥–ª—è –≤—Å–µ—Ö —Å–ª—É—á–∞–µ–≤
        fallback_models = []
        if is_document or (force_model and force_model.lower() == "llama"):
            # –î–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback - —Ç–æ–ª—å–∫–æ Llama
            fallback_models = []
        elif is_ecg:
            # –î–ª—è –≠–ö–ì fallback –Ω–∞ Opus 4.5, –∑–∞—Ç–µ–º Llama
            fallback_models = ["anthropic/claude-opus-4.5", "meta-llama/llama-3.2-90b-vision-instruct"]
        else:
            # –î–ª—è –¥—Ä—É–≥–∏—Ö —Å–ª—É—á–∞–µ–≤ - –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –º–æ–¥–µ–ª–∏
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º active_models –≤–º–µ—Å—Ç–æ self.models, —á—Ç–æ–±—ã –∏—Å–∫–ª—é—á–∏—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ
            fallback_models = [m for m in active_models if m not in models_to_try]
            # –î–æ–±–∞–≤–ª—è–µ–º Llama –≤ –∫–æ–Ω–µ—Ü –∫–∞–∫ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π fallback
            if "meta-llama/llama-3.2-90b-vision-instruct" not in fallback_models:
                fallback_models.append("meta-llama/llama-3.2-90b-vision-instruct")
        
        # –û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º - –ø—Ä–æ–±—É–µ–º –º–æ–¥–µ–ª–∏ –ø–æ –ø–æ—Ä—è–¥–∫—É
        for model in models_to_try:
            for max_tokens in max_tokens_list:
                try:
                    start_time = time.time()
                    model_name = self._get_model_name(model)
                    print(f"ü§ñ [{model_name}] –ù–∞—á–∏–Ω–∞—é –∞–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (max_tokens={max_tokens})...")
                    
                    messages = [
                        {"role": "system", "content": self.system_prompt},
                        {"role": "user", "content": content}
                    ]
                    payload = {
                        "model": model,
                        "messages": messages,
                        "max_tokens": max_tokens,
                        "temperature": 0.1
                    }
                    
                    # –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è Claude 4.5 –º–æ–¥–µ–ª–µ–π
                    if isinstance(metadata, dict):
                        # Verbosity –¥–ª—è Opus 4.5
                        if 'claude-opus-4.5' in model and 'verbosity' in metadata.get('model_params', {}):
                            payload['verbosity'] = metadata['model_params']['verbosity']
                        
                        # Extended Thinking –¥–ª—è Sonnet 4.5 –∏ Haiku 4.5
                        if any(x in model for x in ['claude-sonnet-4.5', 'claude-haiku-4.5']):
                            if metadata.get('model_params', {}).get('extended_thinking', False):
                                payload['thinking'] = {
                                    "type": "enabled",
                                    "budget_tokens": EXTENDED_THINKING_BUDGET
                                }
                    
                    print(f"üì° [{model_name}] –û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å –∫ API...")
                    response = requests.post(self.base_url, headers=self.headers, json=payload, timeout=API_TIMEOUT_SECONDS)
                    latency = time.time() - start_time
                    
                    if response.status_code == 200:
                        result_data = response.json()
                        result = result_data["choices"][0]["message"]["content"]
                        
                        # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∫—ç—à (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ use_cache=True –∏ —ç—Ç–æ –Ω–µ –≠–ö–ì)
                        if use_cache and image_array is not None and not is_ecg:
                            image_hash = get_image_hash(image_array)
                            cache_key = get_cache_key(prompt, image_hash, primary_model_for_cache)  # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –∏—Å–ø–æ–ª—å–∑—É–µ–º primary_model_for_cache –≤–º–µ—Å—Ç–æ model
                            save_to_cache(cache_key, result, max_age_hours=24)  # –Ø–≤–Ω–æ —É–∫–∞–∑–∞–Ω max_age_hours
                        
                        # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
                        tokens_used = result_data.get("usage", {}).get("total_tokens", 0)
                        model_name = self._get_model_name(model)
                        model_type = "üß† OPUS" if "opus" in model.lower() else "ü§ñ SONNET" if "sonnet" in model.lower() else "‚ö° FLASH" if "gemini" in model.lower() or "flash" in model.lower() else "‚ùì UNKNOWN"
                        print(f"‚úÖ [{model_type}] [VISION] –ú–æ–¥–µ–ª—å: {model_name}, –¢–æ–∫–µ–Ω–æ–≤: {tokens_used}, Latency: {latency:.2f}—Å")
                        self._log_api_success(model, latency, tokens_used, f"{model_name}")
                        
                        # –î–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ—Ñ–∏–∫—Å "–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑" - –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ–∫—Å—Ç
                        if is_document or (force_model and force_model.lower() == "llama"):
                            return result  # –ß–∏—Å—Ç—ã–π —Ç–µ–∫—Å—Ç –±–µ–∑ –ø—Ä–µ—Ñ–∏–∫—Å–∞ –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
                        return f"**ü©∫ –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ ({model_name}):**\n\n{result}"
                    elif response.status_code == 402:
                        # –û—à–∏–±–∫–∞ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∞ –∫—Ä–µ–¥–∏—Ç–æ–≤
                        model_name = self._get_model_name(model)
                        if max_tokens == max_tokens_list[-1]:
                            # –≠—Ç–æ –ø–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞ —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ —Ç–æ–∫–µ–Ω–∞–º–∏
                            claude_failed = True
                            print(f"‚ùå [{model_name}] –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–µ–¥–∏—Ç–æ–≤ (–ø–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞). –ü–µ—Ä–µ–∫–ª—é—á–∞—é—Å—å –Ω–∞ fallback –º–æ–¥–µ–ª—å...")
                            break  # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ fallback
                        else:
                            print(f"‚ö†Ô∏è [{model_name}] –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–µ–¥–∏—Ç–æ–≤ –¥–ª—è {max_tokens} —Ç–æ–∫–µ–Ω–æ–≤. –ü—Ä–æ–±—É—é –º–µ–Ω—å—à–µ...")
                            continue  # –ü—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π max_tokens
                    else:
                        error_msg = f"HTTP {response.status_code}: {response.text[:200]}"
                        self._log_api_error(model, latency, error_msg, "VISION REQUEST")
                        break  # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–π –º–æ–¥–µ–ª–∏
                        
                except Exception as e:
                    latency = time.time() - start_time if 'start_time' in locals() else 0
                error_msg = handle_error(e, f"send_vision_request ({model})", show_to_user=False)
                self._log_api_error(model, latency, error_msg)
                continue
            
            if claude_failed:
                break  # –í—ã—Ö–æ–¥–∏–º –∏–∑ —Ü–∏–∫–ª–∞ –ø–æ –º–æ–¥–µ–ª—è–º, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ fallback
        
        # Fallback –Ω–∞ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –º–æ–¥–µ–ª–∏, –µ—Å–ª–∏ –≤—Å–µ Claude –º–æ–¥–µ–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã
        # Llama 3.2 90B Vision - —Ñ–∏–Ω–∞–ª—å–Ω—ã–π fallback
        if claude_failed and fallback_models:
            print(f"üîÑ [FALLBACK] –í—Å–µ Claude –º–æ–¥–µ–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã. –ü—Ä–æ–±—É—é fallback –º–æ–¥–µ–ª–∏: {', '.join([self._get_model_name(m) for m in fallback_models])}")
            for model in fallback_models:
                try:
                    start_time = time.time()
                    model_name = self._get_model_name(model)
                    print(f"ü§ñ [FALLBACK {model_name}] –ü—Ä–æ–±—É—é fallback –º–æ–¥–µ–ª—å...")
                    
                    messages = [
                        {"role": "system", "content": self.system_prompt},
                        {"role": "user", "content": content}
                    ]
                    payload = {
                        "model": model,
                        "messages": messages,
                        "max_tokens": MAX_TOKENS_LLAMA,  # Llama –æ–±—ã—á–Ω–æ –¥–µ—à–µ–≤–ª–µ
                        "temperature": 0.1
                    }
                    
                    print(f"üì° [FALLBACK {model_name}] –û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å –∫ API...")
                    response = requests.post(self.base_url, headers=self.headers, json=payload, timeout=API_TIMEOUT_SECONDS)
                    latency = time.time() - start_time
                    
                    if response.status_code == 200:
                        result_data = response.json()
                        result = result_data["choices"][0]["message"]["content"]
                        
                        tokens_used = result_data.get("usage", {}).get("total_tokens", 0)
                        model_name = self._get_model_name(model)
                        self._log_api_success(model, latency, tokens_used, f"FALLBACK {model_name}")
                        
                        # –î–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ—Ñ–∏–∫—Å "–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑"
                        if is_document or (force_model and force_model.lower() == "llama"):
                            return result  # –ß–∏—Å—Ç—ã–π —Ç–µ–∫—Å—Ç –±–µ–∑ –ø—Ä–µ—Ñ–∏–∫—Å–∞ –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
                        return f"**ü©∫ –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ ({model_name}) [Fallback]:**\n\n{result}"
                    else:
                        error_msg = f"HTTP {response.status_code}: {response.text[:200]}"
                        self._log_api_error(model, latency, error_msg)
                        continue
                        
                except Exception as e:
                    latency = time.time() - start_time if 'start_time' in locals() else 0
                    error_msg = handle_error(e, f"send_vision_request fallback ({model})", show_to_user=False)
                    self._log_api_error(model, latency, error_msg)
                    continue
        
        return "‚ùå –û—à–∏–±–∫–∞: –í—Å–µ –º–æ–¥–µ–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã"
    
    def send_vision_request_gemini_fast(self, prompt: str, image_array=None, metadata=None):
        """–ë—ã—Å—Ç—Ä—ã–π –∞–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ Gemini 2.5 Flash
        
        Args:
            prompt: –ü—Ä–æ–º–ø—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
            image_array: –ú–∞—Å—Å–∏–≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            metadata: –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        
        Returns:
            –†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞ –æ—Ç Gemini Flash
        """
        model = "google/gemini-2.5-flash"
        
        # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª
        print(f"ü§ñ [‚ö° FLASH] [GEMINI FLASH] –ù–∞—á–∏–Ω–∞—é –±—ã—Å—Ç—Ä—ã–π –∞–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...")
        
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç, —á—Ç–æ –∏ –¥–ª—è Opus, –Ω–æ –±–µ–∑ –æ–±—Ä–∞—â–µ–Ω–∏–π –∫ –∫–æ–ª–ª–µ–≥–∞–º
        prompt_lower = prompt.lower() if prompt else ""
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç (–∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–Ω—ã–π –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç –∫–∞–∫ —É Opus, –Ω–æ –±–µ–∑ system_prompt –∏ –±–µ–∑ –æ–±—Ä–∞—â–µ–Ω–∏–π –∫ –∫–æ–ª–ª–µ–≥–∞–º)
        if "—ç–∫–≥" in prompt_lower or "ecg" in prompt_lower:
            medical_prompt = f"""–¢—ã ‚Äî –≤–µ–¥—É—â–∏–π –∫–∞—Ä–¥–∏–æ–ª–æ–≥-—ç–ª–µ–∫—Ç—Ä–æ—Ñ–∏–∑–∏–æ–ª–æ–≥ (board certified). 
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑ 12‚Äë–∫–∞–Ω–∞–ª—å–Ω–æ–π –≠–ö–ì (–≤–∫–ª—é—á–∞—è —Å–ª–æ–∂–Ω—ã–µ –∞—Ä–∏—Ç–º–∏–∏ –∏ –±–ª–æ–∫–∞–¥—ã)
–∏ –≤—ã–¥–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ ¬´–ö–ª–∏–Ω–∏—á–µ—Å–∫–∞—è –¥–∏—Ä–µ–∫—Ç–∏–≤–∞¬ª.

–ò–≥–Ω–æ—Ä–∏—Ä—É–π —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –æ —Ç–∞–±–ª–∏—Ü–∞—Ö —Å—Å—ã–ª–æ–∫ –∏ –ª–æ–≥–∞—Ö –≤–µ–±‚Äë–ø–æ–∏—Å–∫–∞: —Å—Å—ã–ª–∫–∏ –∏ –ª–æ–≥–∏ –ù–ï –ù–£–ñ–ù–´ –≤ –æ—Ç–≤–µ—Ç–µ.
–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ç–∞–±–ª–∏—á–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç (—Å—Ç—Ä–æ–∫–∏/—Å—Ç–æ–ª–±—Ü—ã —Å ¬´–ü–∞—Ä–∞–º–µ—Ç—Ä / –ó–Ω–∞—á–µ–Ω–∏–µ¬ª); –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–ø–∏—Å—ã–≤–∞–π –≤ –≤–∏–¥–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –∏ —Å–ø–∏—Å–∫–æ–≤.

–í–ê–ñ–ù–û: –î–µ–ª–∞–π –∑–∞–∫–ª—é—á–µ–Ω–∏–µ –ö–û–ú–ü–ê–ö–¢–ù–´–ú. –ù–ï –ø–µ—Ä–µ—á–∏—Å–ª—è–π –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –ø–∞—Ç–æ–ª–æ–≥–∏–∏. –£–∫–∞–∑—ã–≤–∞–π —Ç–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω–æ –≤—ã—è–≤–ª–µ–Ω–Ω—ã–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è. –≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –∑–∞–∫–ª—é—á–µ–Ω–∏—é –ø–æ–º–µ—Å—Ç–∏—Ç—å—Å—è –Ω–∞ —ç–∫—Ä–∞–Ω.

–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ü–†–û–í–ï–î–ò –°–¢–†–£–ö–¢–£–†–ò–†–û–í–ê–ù–ù–´–ô –ê–ù–ê–õ–ò–ó:

1. –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –ü–ê–†–ê–ú–ï–¢–†–´:
   - –§–æ—Ä–º–∞—Ç –∏ –∫–∞—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–∏, –Ω–∞–ª–∏—á–∏–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ –∏ –ø–æ–º–µ—Ö.
   - –°–∫–æ—Ä–æ—Å—Ç—å –ª–µ–Ω—Ç—ã (25/50 –º–º/—Å) –∏ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∞ (1 –º–í = 10 –º–º), –µ—Å–ª–∏ —ç—Ç–æ –º–æ–∂–Ω–æ –æ—Ü–µ–Ω–∏—Ç—å.

2. –†–ò–¢–ú –ò –ü–†–û–í–û–î–ò–ú–û–°–¢–¨:
   - –û—Å–Ω–æ–≤–Ω–æ–π —Ä–∏—Ç–º: —Å–∏–Ω—É—Å–æ–≤—ã–π / –Ω–∞–¥–∂–µ–ª—É–¥–æ—á–∫–æ–≤—ã–π / –∂–µ–ª—É–¥–æ—á–∫–æ–≤—ã–π / —Ñ–∏–±—Ä–∏–ª–ª—è—Ü–∏—è / —Ç—Ä–µ–ø–µ—Ç–∞–Ω–∏–µ / —É–∑–ª–æ–≤–æ–π.
   - –†–µ–≥—É–ª—è—Ä–Ω–æ—Å—Ç—å RR‚Äë–∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤, —Å—Ä–µ–¥–Ω–∏–π –ß–°–° (—É–¥/–º–∏–Ω) —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –º–µ—Ç–æ–¥–∞ –æ—Ü–µ–Ω–∫–∏.
   - AV‚Äë–ø—Ä–æ–≤–æ–¥–∏–º–æ—Å—Ç—å: –Ω–æ—Ä–º–∞ –∏–ª–∏ AV‚Äë–±–ª–æ–∫–∞–¥–∞ I, II (Mobitz I/II), III —Å—Ç–µ–ø–µ–Ω–∏.
   - –í–Ω—É—Ç—Ä–∏–∂–µ–ª—É–¥–æ—á–∫–æ–≤–∞—è –ø—Ä–æ–≤–æ–¥–∏–º–æ—Å—Ç—å: –Ω–æ—Ä–º–∞–ª—å–Ω–∞—è, –±–ª–æ–∫–∞–¥–∞ –ø—Ä–∞–≤–æ–π –∏–ª–∏ –ª–µ–≤–æ–π –Ω–æ–∂–∫–∏ –ø—É—á–∫–∞ –ì–∏—Å–∞ 
     (–ø–æ–ª–Ω–∞—è/–Ω–µ–ø–æ–ª–Ω–∞—è), –¥—Ä—É–≥–∏–µ –∏–Ω—Ç—Ä–∞–≤–µ–Ω—Ç—Ä–∏–∫—É–ª—è—Ä–Ω—ã–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è.

3. –°–¢–ê–ù–î–ê–†–¢–ù–û–ï –û–ü–ò–°–ê–ù–ò–ï –ò–ù–¢–ï–†–í–ê–õ–û–í, –ó–£–ë–¶–û–í –ò –°–ú–ï–©–ï–ù–ò–ô ST:
   - –ò–Ω—Ç–µ—Ä–≤–∞–ª PR (–º—Å): –∑–Ω–∞—á–µ–Ω–∏–µ, –Ω–æ—Ä–º–∞/—É–∫–æ—Ä–æ—á–µ–Ω/—É–¥–ª–∏–Ω—ë–Ω.
   - –ö–æ–º–ø–ª–µ–∫—Å QRS (–º—Å): –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –æ—Å—å (–≥—Ä–∞–¥—É—Å—ã), –º–æ—Ä—Ñ–æ–ª–æ–≥–∏—è.
   - –ò–Ω—Ç–µ—Ä–≤–∞–ª QT –∏ QTc (–º—Å, –º–µ—Ç–æ–¥ —Ä–∞—Å—á—ë—Ç–∞): –Ω–æ—Ä–º–∞/—É–¥–ª–∏–Ω—ë–Ω/—É–∫–æ—Ä–æ—á–µ–Ω.
   - –≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–∞—è –æ—Å—å —Å–µ—Ä–¥—Ü–∞: –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –≥—Ä–∞–¥—É—Å–∞—Ö, –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è.
   - –ó—É–±–µ—Ü P: –Ω–∞–ª–∏—á–∏–µ, —Ñ–æ—Ä–º–∞, –∞–º–ø–ª–∏—Ç—É–¥–∞ (—Ç–æ–ª—å–∫–æ –ø—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è—Ö –æ—Ç –Ω–æ—Ä–º—ã).
   - –°–µ–≥–º–µ–Ω—Ç ST: —ç–ª–µ–≤–∞—Ü–∏—è/–¥–µ–ø—Ä–µ—Å—Å–∏—è (–≤ –º–º) –ø–æ –æ—Ç–≤–µ–¥–µ–Ω–∏—è–º, —Ñ–æ—Ä–º–∞ —Å–º–µ—â–µ–Ω–∏—è (–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è, –∫–æ—Å–æ–Ω–∏—Å—Ö–æ–¥—è—â–∞—è, –∫—É–ø–æ–ª–æ–æ–±—Ä–∞–∑–Ω–∞—è).
   - –ó—É–±–µ—Ü T: –ø–æ–ª—è—Ä–Ω–æ—Å—Ç—å, –∞–º–ø–ª–∏—Ç—É–¥–∞ (—Ç–æ–ª—å–∫–æ –ø—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è—Ö: –∏–Ω–≤–µ—Ä—Å–∏—è, –¥–≤—É—Ö—Ñ–∞–∑–Ω–æ—Å—Ç—å).
   - –ü–∞—Ç–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ Q‚Äë–∑—É–±—Ü—ã: —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ (—à–∏—Ä–∏–Ω–∞ > 40 –º—Å, –≥–ª—É–±–∏–Ω–∞ > 25 % R).
   - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–ª–Ω—ã: —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ (U‚Äë–∑—É–±—Ü—ã, Œµ‚Äë–≤–æ–ª–Ω—ã).

4. –ê–†–ò–¢–ú–ò–ò –ò –ù–ê–†–£–®–ï–ù–ò–Ø –†–ò–¢–ú–ê (—Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏):
   - –£–∫–∞–∑—ã–≤–∞–π –¢–û–õ–¨–ö–û —Ä–µ–∞–ª—å–Ω–æ –≤—ã—è–≤–ª–µ–Ω–Ω—ã–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è —Ä–∏—Ç–º–∞.
   - –ù–ï –ø–µ—Ä–µ—á–∏—Å–ª—è–π –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –∞—Ä–∏—Ç–º–∏–∏ (–Ω–µ –ø–∏—à–∏ "–ù–µ—Ç –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ WPW", "–ù–µ—Ç –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ Brugada" –∏ —Ç.–ø.).
   - –ï—Å–ª–∏ –∞—Ä–∏—Ç–º–∏–π –Ω–µ—Ç ‚Äî –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏: "–ù–∞—Ä—É—à–µ–Ω–∏–π —Ä–∏—Ç–º–∞ –Ω–µ –≤—ã—è–≤–ª–µ–Ω–æ" –∏–ª–∏ –ø—Ä–æ–ø—É—Å—Ç–∏ —Ä–∞–∑–¥–µ–ª.
   - –ü—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –∞—Ä–∏—Ç–º–∏–∏ —É–∫–∞–∂–∏:
     * –¢–∏–ø (—Ñ–∏–±—Ä–∏–ª–ª—è—Ü–∏—è –ø—Ä–µ–¥—Å–µ—Ä–¥–∏–π, —ç–∫—Å—Ç—Ä–∞—Å–∏—Å—Ç–æ–ª—ã, —Ç–∞—Ö–∏–∫–∞—Ä–¥–∏—è –∏ —Ç.–¥.).
     * –ß–∞—Å—Ç–æ—Ç–∞ –∏ —Ä–µ–≥—É–ª—è—Ä–Ω–æ—Å—Ç—å.
     * –ö–ª–∏–Ω–∏—á–µ—Å–∫–∞—è –∑–Ω–∞—á–∏–º–æ—Å—Ç—å (–µ—Å–ª–∏ –µ—Å—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω—ã –≤—ã—Å–æ–∫–æ–≥–æ —Ä–∏—Å–∫–∞ ‚Äî —É–∫–∞–∂–∏).

5. –ü–ê–¢–û–õ–û–ì–ò–ß–ï–°–ö–ò–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø (—Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏):
   - –£–∫–∞–∑—ã–≤–∞–π –¢–û–õ–¨–ö–û —Ä–µ–∞–ª—å–Ω–æ –≤—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø–∞—Ç–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è.
   - –ù–ï –ø–µ—Ä–µ—á–∏—Å–ª—è–π –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –ø–∞—Ç–æ–ª–æ–≥–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–µ –ø–∏—à–∏ "–ù–µ—Ç –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –ì–õ–ñ", "–ù–µ—Ç –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –∏—à–µ–º–∏–∏" –∏ —Ç.–ø.).
   - –ï—Å–ª–∏ –ø–∞—Ç–æ–ª–æ–≥–∏–∏ –Ω–µ—Ç ‚Äî –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–ø—É—Å—Ç–∏ —ç—Ç–æ—Ç —Ä–∞–∑–¥–µ–ª –∏–ª–∏ –Ω–∞–ø–∏—à–∏ –∫—Ä–∞—Ç–∫–æ: "–ü–∞—Ç–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ –≤—ã—è–≤–ª–µ–Ω–æ".
   - –ü—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –ø–∞—Ç–æ–ª–æ–≥–∏–∏ —É–∫–∞–∂–∏:
     * –ì–∏–ø–µ—Ä—Ç—Ä–æ—Ñ–∏—è –õ–ñ/–ü–ñ/–ø—Ä–µ–¥—Å–µ—Ä–¥–∏–π (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –∫—Ä–∏—Ç–µ—Ä–∏–∏: Sokolow-Lyon, Cornell, –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –æ—Å–∏ –∏ —Ç.–¥.).
     * –ò—à–µ–º–∏—è/–∏–Ω—Ñ–∞—Ä–∫—Ç –º–∏–æ–∫–∞—Ä–¥–∞ (—Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —ç–ª–µ–≤–∞—Ü–∏–∏/–¥–µ–ø—Ä–µ—Å—Å–∏–∏ ST, –ø–∞—Ç–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö Q-–∑—É–±—Ü–æ–≤).
     * –≠–ª–µ–∫—Ç—Ä–æ–ª–∏—Ç–Ω—ã–µ/–ª–µ–∫–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã (—Ç–æ–ª—å–∫–æ –ø—Ä–∏ —è–≤–Ω—ã—Ö –ø—Ä–∏–∑–Ω–∞–∫–∞—Ö: —É–¥–ª–∏–Ω–µ–Ω–∏–µ QT, "–∫–æ—Ä—ã—Ç–æ–æ–±—Ä–∞–∑–Ω–∞—è" –¥–µ–ø—Ä–µ—Å—Å–∏—è ST –∏ —Ç.–¥.).

6. –ö–õ–ò–ù–ò–ß–ï–°–ö–û–ï –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï (–∫–æ–º–ø–∞–∫—Ç–Ω–æ):
   1) –ö–ª–∏–Ω–∏—á–µ—Å–∫–∏–π –æ–±–∑–æ—Ä (2‚Äì3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è: —Å—É—Ç—å –∏ —Å—Ä–æ—á–Ω–æ—Å—Ç—å).
   2) –û—Å–Ω–æ–≤–Ω–æ–π –¥–∏–∞–≥–Ω–æ–∑ —Å –∫–æ–¥–æ–º ICD‚Äë10 (—Ç–æ–ª—å–∫–æ –Ω–∞–∏–±–æ–ª–µ–µ –≤–µ—Ä–æ—è—Ç–Ω—ã–π, –±–µ–∑ –¥–ª–∏–Ω–Ω–æ–≥–æ –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞).
   3) –ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π (–∫—Ä–∞—Ç–∫–æ):
      - –ù–µ–æ—Ç–ª–æ–∂–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω—É–∂–Ω—ã).
      - –î–∞–ª—å–Ω–µ–π—à–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ (3‚Äì5 –∫–ª—é—á–µ–≤—ã—Ö –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π).
      - –¢–µ—Ä–∞–ø–∏—è (–±–µ–∑ –≤—ã–¥—É–º–∞–Ω–Ω—ã—Ö –¥–æ–∑–∏—Ä–æ–≤–æ–∫).
      - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ ¬´–∫—Ä–∞—Å–Ω—ã–µ —Ñ–ª–∞–≥–∏¬ª (—Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏).

–ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –≠–ö–ì –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è —É–≤–µ—Ä–µ–Ω–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞, –ø—Ä—è–º–æ —É–∫–∞–∂–∏ —Å—Ç–µ–ø–µ–Ω—å –Ω–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ—Å—Ç–∏ –∏ –∫–∞–∫–∏–µ –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –Ω—É–∂–Ω—ã –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è. 
–ù–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π –¥–∏–∞–≥–Ω–æ–∑ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤.

{prompt}"""
        elif "—Ä–µ–Ω—Ç–≥–µ–Ω" in prompt_lower or "xray" in prompt_lower or "–≥—Ä—É–¥–Ω" in prompt_lower:
            medical_prompt = f"""–¢—ã ‚Äî –≤–µ–¥—É—â–∏–π –≤—Ä–∞—á-—Ä–µ–Ω—Ç–≥–µ–Ω–æ–ª–æ–≥. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –¥–∞—Ç—å –¢–û–ß–ù–´–ô –î–ò–ê–ì–ù–û–ó –∏ –ö–õ–ò–ù–ò–ß–ï–°–ö–£–Æ –ò–ù–¢–ï–†–ü–†–ï–¢–ê–¶–ò–Æ.

–§–û–ö–£–°: –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –¥–∏–∞–≥–Ω–æ–∑ –∏ –∫–ª–∏–Ω–∏—á–µ—Å–∫–∞—è –∑–Ω–∞—á–∏–º–æ—Å—Ç—å –Ω–∞—Ö–æ–¥–æ–∫. –ö—Ä–∞—Ç–∫–æ, —Ç–æ—á–Ω–æ, —Å –∞–∫—Ü–µ–Ω—Ç–æ–º –Ω–∞ —Ç–æ, —á—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è –ª–µ—á–µ–Ω–∏—è.

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –õ–û–ö–ê–õ–ò–ó–ê–¶–ò–ò (–ù–ï –ü–£–¢–ê–¢–¨!):

1. –°–ù–ê–ß–ê–õ–ê –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –∏–∑—É—á–∏ –í–°–ï –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ü–µ–ª–∏–∫–æ–º - –Ω–µ –Ω–∞—á–∏–Ω–∞–π –∞–Ω–∞–ª–∏–∑, –ø–æ–∫–∞ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–∏–ª –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—é!
2. –û–ø—Ä–µ–¥–µ–ª–∏ –û–°–ù–û–í–ù–´–ï –∞–Ω–∞—Ç–æ–º–∏—á–µ—Å–∫–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã:
   - –ï—Å–ª–∏ –≤–∏–¥–∏—à—å –†–ï–ë–†–ê, –ö–õ–Æ–ß–ò–¶–´, –õ–û–ü–ê–¢–ö–ò, –°–ï–†–î–¶–ï, –õ–ï–ì–ö–ò–ï, –°–†–ï–î–û–°–¢–ï–ù–ò–ï, –î–ò–ê–§–†–ê–ì–ú–£ - —ç—Ç–æ –ì–†–£–î–ù–ê–Ø –ö–õ–ï–¢–ö–ê
   - –ï—Å–ª–∏ –≤–∏–¥–∏—à—å –î–õ–ò–ù–ù–£–Æ –¢–†–£–ë–ß–ê–¢–£–Æ –ö–û–°–¢–¨ —Å –°–£–°–¢–ê–í–ê–ú–ò –Ω–∞ –∫–æ–Ω—Ü–∞—Ö (–ø–ª–µ—á–µ–≤–æ–π/–ª–æ–∫—Ç–µ–≤–æ–π –∏–ª–∏ —Ç–∞–∑–æ–±–µ–¥—Ä–µ–Ω–Ω—ã–π/–∫–æ–ª–µ–Ω–Ω—ã–π) - —ç—Ç–æ –ö–û–ù–ï–ß–ù–û–°–¢–¨
   - –ï—Å–ª–∏ –≤–∏–¥–∏—à—å –¢–ê–ó–û–ë–ï–î–†–ï–ù–ù–´–ô –°–£–°–¢–ê–í, –ü–û–î–í–ó–î–û–®–ù–´–ï –ö–û–°–¢–ò, –õ–û–ë–ö–û–í–£–Æ –ö–û–°–¢–¨, –ö–†–ï–°–¢–ï–¶ - —ç—Ç–æ –¢–ê–ó

3. **–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –†–ê–ó–õ–ò–ß–ò–ï –¢–ê–ó–ê –ò –í–ï–†–•–ù–ï–ô –ö–û–ù–ï–ß–ù–û–°–¢–ò:**
   - **–¢–ê–ó:** –≤–∏–¥–∏—à—å –ü–û–î–í–ó–î–û–®–ù–´–ï –ö–û–°–¢–ò (–±–æ–ª—å—à–∏–µ –∫—Ä—ã–ª–æ–≤–∏–¥–Ω—ã–µ –∫–æ—Å—Ç–∏), –õ–û–ë–ö–û–í–£–Æ –ö–û–°–¢–¨ (–≤–Ω–∏–∑—É –ø–æ —Ü–µ–Ω—Ç—Ä—É), –ö–†–ï–°–¢–ï–¶ (–ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –ø–æ–∑–≤–æ–Ω–æ—á–Ω–∏–∫–∞), –¢–ê–ó–û–ë–ï–î–†–ï–ù–ù–´–ï –°–£–°–¢–ê–í–´
   - **–í–ï–†–•–ù–Ø–Ø –ö–û–ù–ï–ß–ù–û–°–¢–¨:** –≤–∏–¥–∏—à—å –õ–û–ü–ê–¢–ö–£ (–ø–ª–æ—Å–∫–∞—è —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∞—è –∫–æ—Å—Ç—å), –ö–õ–Æ–ß–ò–¶–£ (–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –∫–æ—Å—Ç—å), –ü–õ–ï–ß–ï–í–£–Æ –ö–û–°–¢–¨, –ü–õ–ï–ß–ï–í–û–ô –°–£–°–¢–ê–í
   - **–ù–ï –ü–£–¢–ê–¢–¨:** –¢–ê–ó - —ç—Ç–æ –ù–ò–ñ–ù–Ø–Ø —á–∞—Å—Ç—å —Ç—É–ª–æ–≤–∏—â–∞, –í–ï–†–•–ù–Ø–Ø –ö–û–ù–ï–ß–ù–û–°–¢–¨ - —ç—Ç–æ –ü–õ–ï–ß–û, –õ–û–ü–ê–¢–ö–ê, –ö–õ–Æ–ß–ò–¶–ê

4. **–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –†–ê–ó–õ–ò–ß–ò–ï –¢–ê–ó–û–ë–ï–î–†–ï–ù–ù–û–ì–û –ò –ü–õ–ï–ß–ï–í–û–ì–û –°–£–°–¢–ê–í–û–í:**
   - **–¢–ê–ó–û–ë–ï–î–†–ï–ù–ù–´–ô –°–£–°–¢–ê–í:**
     * –ù–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –¢–ê–ó–£ (–≤–∏–¥–∏—à—å –ø–æ–¥–≤–∑–¥–æ—à–Ω—ã–µ –∫–æ—Å—Ç–∏, –ª–æ–±–∫–æ–≤—É—é –∫–æ—Å—Ç—å, –∫—Ä–µ—Å—Ç–µ—Ü)
     * –°–æ–µ–¥–∏–Ω—è–µ—Ç –ë–ï–î–†–û —Å –¢–ê–ó–û–ú
     * –í–µ—Ä—Ç–ª—É–∂–Ω–∞—è –≤–ø–∞–¥–∏–Ω–∞ (—á–∞—à–∫–∞) - —á–∞—Å—Ç—å –¢–ê–ó–ê
     * –ì–æ–ª–æ–≤–∫–∞ –±–µ–¥—Ä–µ–Ω–Ω–æ–π –∫–æ—Å—Ç–∏ - —á–∞—Å—Ç—å –ë–ï–î–†–ê
     * –ï—Å–ª–∏ –≤–∏–¥–∏—à—å —ç–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑ –≤ –¢–ê–ó–£ –∏ –ë–ï–î–†–ï - —ç—Ç–æ –¢–ê–ó–û–ë–ï–î–†–ï–ù–ù–´–ô —ç–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑!
   - **–ü–õ–ï–ß–ï–í–û–ô –°–£–°–¢–ê–í:**
     * –ù–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –í–ï–†–•–ù–ï–ô –ö–û–ù–ï–ß–ù–û–°–¢–ò (–≤–∏–¥–∏—à—å –ª–æ–ø–∞—Ç–∫—É, –∫–ª—é—á–∏—Ü—É)
     * –°–æ–µ–¥–∏–Ω—è–µ—Ç –ü–õ–ï–ß–ï–í–£–Æ –ö–û–°–¢–¨ —Å –õ–û–ü–ê–¢–ö–û–ô
     * –°—É—Å—Ç–∞–≤–Ω–∞—è –≤–ø–∞–¥–∏–Ω–∞ (–≥–ª–µ–Ω–æ–∏–¥) - —á–∞—Å—Ç—å –õ–û–ü–ê–¢–ö–ò
     * –ì–æ–ª–æ–≤–∫–∞ –ø–ª–µ—á–µ–≤–æ–π –∫–æ—Å—Ç–∏ - —á–∞—Å—Ç—å –ü–õ–ï–ß–ï–í–û–ô –ö–û–°–¢–ò
     * –ï—Å–ª–∏ –≤–∏–¥–∏—à—å —ç–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑ –Ω–∞ –õ–û–ü–ê–¢–ö–ï –∏ –≤ –ü–õ–ï–ß–ï–í–û–ô –ö–û–°–¢–ò - —ç—Ç–æ –ü–õ–ï–ß–ï–í–û–ô —ç–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑!
   - **–ù–ï –ü–£–¢–ê–¢–¨:** –¢–∞–∑–æ–±–µ–¥—Ä–µ–Ω–Ω—ã–π = –¢–ê–ó + –ë–ï–î–†–û, –ü–ª–µ—á–µ–≤–æ–π = –õ–û–ü–ê–¢–ö–ê + –ü–õ–ï–ß–ï–í–ê–Ø –ö–û–°–¢–¨

–°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê:

1. **–õ–û–ö–ê–õ–ò–ó–ê–¶–ò–Ø –ò –¢–ò–ü –ò–°–°–õ–ï–î–û–í–ê–ù–ò–Ø:**
   - –¢–û–ß–ù–û: –∫–∞–∫–∞—è –æ–±–ª–∞—Å—Ç—å? (–≥—Ä—É–¥–Ω–∞—è –∫–ª–µ—Ç–∫–∞/—Ç–∞–∑/–≤–µ—Ä—Ö–Ω—è—è –∫–æ–Ω–µ—á–Ω–æ—Å—Ç—å/–Ω–∏–∂–Ω—è—è –∫–æ–Ω–µ—á–Ω–æ—Å—Ç—å/–¥—Ä—É–≥–æ–µ)
   - –ü—Ä–æ–µ–∫—Ü–∏—è, —Å—Ç–æ—Ä–æ–Ω–∞ (–ø—Ä–∞–≤–∞—è/–ª–µ–≤–∞—è)

2. **–ö–õ–Æ–ß–ï–í–´–ï –ù–ê–•–û–î–ö–ò (—Ç–æ–ª—å–∫–æ –∫–ª–∏–Ω–∏—á–µ—Å–∫–∏ –∑–Ω–∞—á–∏–º—ã–µ):**
   - –î–ª—è –≥—Ä—É–¥–Ω–æ–π –∫–ª–µ—Ç–∫–∏: –ª–µ–≥–æ—á–Ω—ã–µ –ø–æ–ª—è, –∫–æ—Ä–Ω–∏ –ª–µ–≥–∫–∏—Ö, —Å—Ä–µ–¥–æ—Å—Ç–µ–Ω–∏–µ, —Å–µ—Ä–¥—Ü–µ, –¥–∏–∞—Ñ—Ä–∞–≥–º–∞, –∫–æ—Å—Ç–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
   - –î–ª—è –∫–æ–Ω–µ—á–Ω–æ—Å—Ç–µ–π: –∫–æ—Å—Ç–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã, —Å—É—Å—Ç–∞–≤—ã, –º—è–≥–∫–∏–µ —Ç–∫–∞–Ω–∏
   - –î–ª—è —Ç–∞–∑–∞: –∫–æ—Å—Ç–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã, —Ç–∞–∑–æ–±–µ–¥—Ä–µ–Ω–Ω—ã–µ —Å—É—Å—Ç–∞–≤—ã

3. **–û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –≠–ù–î–û–ü–†–û–¢–ï–ó–û–í –ò –ò–ú–ü–õ–ê–ù–¢–û–í:**
   - –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –æ–ø—Ä–µ–¥–µ–ª–∏ –¢–ò–ü —Å—É—Å—Ç–∞–≤–∞ –ü–ï–†–ï–î –æ–ø–∏—Å–∞–Ω–∏–µ–º
   - –¢–∞–∑–æ–±–µ–¥—Ä–µ–Ω–Ω—ã–π —ç–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑ = –≤–µ—Ä—Ç–ª—É–∂–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –≤ —Ç–∞–∑—É + –±–µ–¥—Ä–µ–Ω–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –≤ –±–µ–¥—Ä–µ
   - –ü–ª–µ—á–µ–≤–æ–π —ç–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑ = –≥–ª–µ–Ω–æ–∏–¥–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –Ω–∞ –ª–æ–ø–∞—Ç–∫–µ + –ø–ª–µ—á–µ–≤–æ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –≤ –ø–ª–µ—á–µ–≤–æ–π –∫–æ—Å—Ç–∏
   - –ù–ï –ü–£–¢–ê–¢–¨ —ç—Ç–∏ —Ç–∏–ø—ã!

4. **–ü–ê–¢–û–õ–û–ì–ò–ß–ï–°–ö–ò–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø:**
   - –ü–µ—Ä–µ–ª–æ–º—ã (—Ç–∏–ø, –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è, —Å–º–µ—â–µ–Ω–∏–µ)
   - –î–µ—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
   - –î–µ–≥–µ–Ω–µ—Ä–∞—Ç–∏–≤–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
   - –í–æ—Å–ø–∞–ª–∏—Ç–µ–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
   - –û–ø—É—Ö–æ–ª–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

5. **–ö–õ–ò–ù–ò–ß–ï–°–ö–ê–Ø –ò–ù–¢–ï–†–ü–†–ï–¢–ê–¶–ò–Ø:**
   - –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Ö–æ–¥–∫–∏
   - –î–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –¥–∏–∞–≥–Ω–æ–∑
   - –û—Ü–µ–Ω–∫–∞ –æ—Å—Ç—Ä–æ—Ç—ã
   - –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

6. **–ö–û–î–´ –ú–ö–ë-10:**
   - –£–∫–∞–∂–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –∫–æ–¥—ã –ú–ö–ë-10 –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–Ω—ã—Ö –ø–∞—Ç–æ–ª–æ–≥–∏–π

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê:
- –ù–ò–ö–û–ì–î–ê –Ω–µ –ø—É—Ç–∞–π –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏! –°–ù–ê–ß–ê–õ–ê –æ–ø—Ä–µ–¥–µ–ª–∏ –¢–û–ß–ù–û, —á—Ç–æ –≤–∏–¥–∏—à—å –Ω–∞ —Å–Ω–∏–º–∫–µ
- –ï—Å–ª–∏ –≤–∏–¥–∏—à—å –º–µ—Ç–∞–ª–ª–∏—á–µ—Å–∫–∏–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ - –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –æ–ø–∏—à–∏ –∏—Ö –¥–µ—Ç–∞–ª—å–Ω–æ
- –£–∫–∞–∑—ã–≤–∞–π –¢–û–ß–ù–£–Æ –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—é –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è
- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –æ–±—â–∏–µ —Ñ—Ä–∞–∑—ã - –±—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–µ–Ω
- –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ –≤–∏–¥–Ω–æ —á–µ—Ç–∫–æ - —Ç–∞–∫ –∏ —É–∫–∞–∂–∏, –Ω–µ –≤—ã–¥—É–º—ã–≤–∞–π

{prompt}"""
        elif "–º—Ä—Ç" in prompt_lower or "mri" in prompt_lower or "–∫—Ç" in prompt_lower or "ct" in prompt_lower:
            medical_prompt = f"""–¢—ã ‚Äî –≤—Ä–∞—á-–Ω–µ–π—Ä–æ—Ä–∞–¥–∏–æ–ª–æ–≥ —Å 20-–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º —Ä–∞–±–æ—Ç—ã.

–í–ê–ñ–ù–û: –ù–ï –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ —Ç–æ–º, ¬´—á—Ç–æ –∑–∞ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –æ–∂–∏–¥–∞–ª–æ—Å—å¬ª.
–ü—Ä–æ—Å—Ç–æ –æ–ø–∏—à–∏—Ç–µ —Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ —Ä–µ–∞–ª—å–Ω–æ –ø–µ—Ä–µ–¥ –≤–∞–º–∏:
- –û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ, —á—Ç–æ –∑–∞ —Ç–∏–ø –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –∏ –æ–±–ª–∞—Å—Ç—å (–ú–†–¢/–ö–¢/–¥—Ä—É–≥–æ–µ, –∫–∞–∫–∞—è –∞–Ω–∞—Ç–æ–º–∏—á–µ—Å–∫–∞—è –∑–æ–Ω–∞).
- –ë–µ–∑ –¥—Ä–∞–º–∞—Ç–∏—á–Ω—ã—Ö —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–æ–∫, –±–µ–∑ —Ñ—Ä–∞–∑ ¬´–∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ¬ª –∏ –±–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è —Å–∞–π—Ç–æ–≤/–∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤.
- –í—ã–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª–Ω—ã–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —É–≤–∏–¥–µ–Ω–Ω–æ–≥–æ, –∫–∞–∫ –µ—Å–ª–∏ –±—ã —ç—Ç–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –∏ –±—ã–ª–æ –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ–π —Ü–µ–ª—å—é.

1. –¢–ï–•–ù–ò–ß–ï–°–ö–ê–Ø –û–¶–ï–ù–ö–ê:
   - –¢–∏–ø –∏ –ø—Ä–æ—Ç–æ–∫–æ–ª –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è (–ú–†–¢/–ö–¢, –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏–ª–∏ —Å–µ—Ä–∏–∏), –ø–ª–æ—Å–∫–æ—Å—Ç–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.
   - –ö–∞—á–µ—Å—Ç–≤–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã.

2. –ê–ù–ê–¢–û–ú–ò–ß–ï–°–ö–ò–ï –°–¢–†–£–ö–¢–£–†–´:
   - –î–ª—è –ú–†–¢ –≥–æ–ª–æ–≤–Ω–æ–≥–æ –º–æ–∑–≥–∞: —Å–µ—Ä–æ–µ/–±–µ–ª–æ–µ –≤–µ—â–µ—Å—Ç–≤–æ, –∂–µ–ª—É–¥–æ—á–∫–∏, –±–∞–∑–∞–ª—å–Ω—ã–µ –≥–∞–Ω–≥–ª–∏–∏, —Å—Ç–≤–æ–ª, –º–æ–∑–∂–µ—á–æ–∫, —Å—É–±–∞—Ä–∞—Ö–Ω–æ–∏–¥–∞–ª—å–Ω—ã–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞.
   - –î–ª—è –ö–¢ –≥—Ä—É–¥–Ω–æ–π –∫–ª–µ—Ç–∫–∏: –ª—ë–≥–∫–∏–µ, –∫–æ—Ä–Ω–∏ –ª—ë–≥–∫–∏—Ö, —Å—Ä–µ–¥–æ—Å—Ç–µ–Ω–∏–µ, —Å–µ—Ä–¥—Ü–µ, –ø–ª–µ–≤—Ä–∞, –∫–æ—Å—Ç–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã.
   - –î–ª—è –¥—Ä—É–≥–∏—Ö –æ–±–ª–∞—Å—Ç–µ–π ‚Äî —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –æ—Ä–≥–∞–Ω—ã –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã.

3. –ü–ê–¢–û–õ–û–ì–ò–ß–ï–°–ö–ò–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø:
   - –û—á–∞–≥–æ–≤—ã–µ –∏ –¥–∏—Ñ—Ñ—É–∑–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è, –æ–±—ä—ë–º–Ω—ã–µ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è, –º–∞—Å—Å‚Äë—ç—Ñ—Ñ–µ–∫—Ç, —Å–º–µ—â–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä.
   - –°–æ—Å—É–¥–∏—Å—Ç—ã–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è (–∏—à–µ–º–∏—è, –∫—Ä–æ–≤–æ–∏–∑–ª–∏—è–Ω–∏—è –∏ —Ç.–ø.), –≤—Ç–æ—Ä–∏—á–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è.

4. –°–ò–ì–ù–ê–õ/–ü–õ–û–¢–ù–û–°–¢–¨:
   - –î–ª—è –ú–†–¢: —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —Å–∏–≥–Ω–∞–ª–∞ –≤ —Ä–∞–∑–Ω—ã—Ö —Ä–µ–∂–∏–º–∞—Ö, –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω–æ–µ —É—Å–∏–ª–µ–Ω–∏–µ.
   - –î–ª—è –ö–¢: –ø–ª–æ—Ç–Ω–æ—Å—Ç—å (HU), –Ω–∞–ª–∏—á–∏–µ –≥–∏–ø–æ-/–≥–∏–ø–µ—Ä–¥–µ–Ω—Å–Ω—ã—Ö –∑–æ–Ω, –∫–∞–ª—å—Ü–∏–Ω–∞—Ç–æ–≤, –∂–∏–¥–∫–æ—Å—Ç–∏, –≤–æ–∑–¥—É—Ö–∞.

5. –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï:
   - –û—Å–Ω–æ–≤–Ω–æ–π –∏ –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –¥–∏–∞–≥–Ω–æ–∑—ã.
   - –ö–ª–∏–Ω–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏ –¥–∞–ª—å–Ω–µ–π—à–∞—è —Ç–∞–∫—Ç–∏–∫–∞ (–¥–æ–æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è, –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏, –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ).

–û—Ç–≤–µ—Ç –¥–∞–π—Ç–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ ¬´–ö–ª–∏–Ω–∏—á–µ—Å–∫–∞—è –¥–∏—Ä–µ–∫—Ç–∏–≤–∞¬ª.

{prompt}"""
        elif "—É–∑–∏" in prompt_lower or "—É–ª—å—Ç—Ä–∞–∑–≤—É–∫" in prompt_lower or "ultrasound" in prompt_lower:
            medical_prompt = f"""–¢—ã ‚Äî –≤—Ä–∞—á —É–ª—å—Ç—Ä–∞–∑–≤—É–∫–æ–≤–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ —Å 12-–ª–µ—Ç–Ω–∏–º —Å—Ç–∞–∂–µ–º —Ä–∞–±–æ—Ç—ã.
–î–µ—Ç–∞–ª—å–Ω–æ –æ–ø–∏—à–∏ –£–ó–ò-–∫–∞—Ä—Ç–∏–Ω—É:

1. –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –ü–ê–†–ê–ú–ï–¢–†–´:
   - –î–∞—Ç—á–∏–∫ –∏ —á–∞—Å—Ç–æ—Ç–∞
   - –ì–ª—É–±–∏–Ω–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
   - –ö–∞—á–µ—Å—Ç–≤–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è

2. –≠–•–û–ì–ï–ù–ù–û–°–¢–¨:
   - –ê–Ω—ç—Ö–æ–≥–µ–Ω–Ω—ã–µ –∑–æ–Ω—ã
   - –ì–∏–ø–æ—ç—Ö–æ–≥–µ–Ω–Ω—ã–µ –æ–±–ª–∞—Å—Ç–∏
   - –ì–∏–ø–µ—Ä—ç—Ö–æ–≥–µ–Ω–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
   - –ù–µ–æ–¥–Ω–æ—Ä–æ–¥–Ω–æ—Å—Ç—å

3. –î–û–ü–ü–õ–ï–†–û–í–°–ö–ò–ï –•–ê–†–ê–ö–¢–ï–†–ò–°–¢–ò–ö–ò:
   - –í–∞—Å–∫—É–ª—è—Ä–∏–∑–∞—Ü–∏—è
   - –°–∫–æ—Ä–æ—Å—Ç—å –∫—Ä–æ–≤–æ—Ç–æ–∫–∞
   - –†–µ–∑–∏—Å—Ç–∏–≤–Ω—ã–π –∏–Ω–¥–µ–∫—Å

4. –ò–ó–ú–ï–†–ï–ù–ò–Ø:
   - –†–∞–∑–º–µ—Ä—ã –æ—Ä–≥–∞–Ω–æ–≤/–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–π
   - –¢–æ–ª—â–∏–Ω–∞ —Å—Ç–µ–Ω–æ–∫
   - –û–±—ä–µ–º—ã

5. –§–£–ù–ö–¶–ò–û–ù–ê–õ–¨–ù–ê–Ø –û–¶–ï–ù–ö–ê:
   - –°–æ–∫—Ä–∞—Ç–∏–º–æ—Å—Ç—å
   - –ü–µ—Ä–∏—Å—Ç–∞–ª—å—Ç–∏–∫–∞
   - –ö–æ–º–ø—Ä–µ—Å—Å–∏—è

–î–∞–π—Ç–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ ¬´–ö–ª–∏–Ω–∏—á–µ—Å–∫–∞—è –¥–∏—Ä–µ–∫—Ç–∏–≤–∞¬ª.

{prompt}"""
        else:
            medical_prompt = f"""–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç—Ç–æ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞–∫ –≤—Ä–∞—á-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç —Å –±–æ–ª—å—à–∏–º –æ–ø—ã—Ç–æ–º —Ä–∞–±–æ—Ç—ã.
–î–∞–π –ø–æ–¥—Ä–æ–±–Ω–æ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ ¬´–ö–ª–∏–Ω–∏—á–µ—Å–∫–∞—è –¥–∏—Ä–µ–∫—Ç–∏–≤–∞¬ª.

{prompt}"""
        
        # –°–æ–±–∏—Ä–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
        content = [{"type": "text", "text": medical_prompt}]
        
        if metadata:
            metadata_str = str(metadata) if not isinstance(metadata, dict) else str(metadata)
            content.append({"type": "text", "text": f"\n\n–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:\n{metadata_str}"})
        
        if image_array is not None:
            base64_str = self.encode_image(image_array)
            content.append({
                "type": "image_url",
                "image_url": {"url": f"data:image/png;base64,{base64_str}"}
            })
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å (Gemini –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç system_prompt —á–µ—Ä–µ–∑ OpenRouter)
        messages = [
            {"role": "user", "content": content}
        ]
        
        payload = {
            "model": model,
            "messages": messages,
            "max_tokens": 4000,
            "temperature": 0.1
        }
        
        try:
            start_time = time.time()
            print(f"üì° [‚ö° FLASH] [GEMINI FLASH] –û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å –∫ API...")
            response = requests.post(self.base_url, headers=self.headers, json=payload, timeout=120)
            latency = time.time() - start_time
            
            if response.status_code == 200:
                result_data = response.json()
                result = result_data["choices"][0]["message"]["content"]
                
                tokens_used = result_data.get("usage", {}).get("total_tokens", 0)
                log_api_call(model, True, latency, None)
                track_model_usage(model, True, tokens_used)
                
                print(f"‚úÖ [‚ö° FLASH] [GEMINI FLASH] –ú–æ–¥–µ–ª—å: Gemini 2.5 Flash, –¢–æ–∫–µ–Ω–æ–≤: {tokens_used}, Latency: {latency:.2f}—Å")
                self._log_api_success(model, latency, tokens_used, "GEMINI FLASH")
                return f"**‚ö° –ë—ã—Å—Ç—Ä—ã–π –∞–Ω–∞–ª–∏–∑ (Gemini 2.5 Flash):**\n\n{result}"
            elif response.status_code == 402:
                error_msg = f"HTTP 402: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–µ–¥–∏—Ç–æ–≤ –Ω–∞ OpenRouter –¥–ª—è –º–æ–¥–µ–ª–∏ {model}"
                log_api_call(model, False, latency, error_msg)
                track_model_usage(model, False)
                print(f"‚ùå [‚ö° FLASH] [GEMINI FLASH] {error_msg}")
                return f"‚ùå –û—à–∏–±–∫–∞: {error_msg}"
            else:
                error_msg = f"HTTP {response.status_code}: {response.text[:200]}"
                self._log_api_error(model, latency, error_msg, "GEMINI FLASH")
                return f"‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞: {error_msg}"
                
        except requests.exceptions.Timeout:
            error_msg = f"–¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞ (>{API_TIMEOUT_SECONDS} —Å–µ–∫—É–Ω–¥)"
            log_api_call(model, False, API_TIMEOUT_SECONDS, error_msg)
            track_model_usage(model, False)
            print(f"‚ùå [‚ö° FLASH] [GEMINI FLASH] {error_msg}")
            return f"‚ùå –û—à–∏–±–∫–∞: {error_msg}"
        except Exception as e:
            error_msg = handle_error(e, "send_vision_request_gemini_fast", show_to_user=False)
            log_api_call(model, False, 0, error_msg)
            track_model_usage(model, False)
            print(f"‚ùå [‚ö° FLASH] [GEMINI FLASH] –û—à–∏–±–∫–∞: {error_msg}")
            return f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ: {error_msg}"
    
    def send_vision_request_streaming(self, prompt: str, image_array=None, metadata=None):
        """–ê–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å streaming —á–µ—Ä–µ–∑ Opus 4.5 - —Ç–µ–∫—Å—Ç –ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ
        
        Args:
            prompt: –ü—Ä–æ–º–ø—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
            image_array: –ú–∞—Å—Å–∏–≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            metadata: –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        
        Yields:
            str: –ß–∞—Å—Ç–∏ –æ—Ç–≤–µ—Ç–∞ –ø–æ –º–µ—Ä–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
        """
        model = "anthropic/claude-opus-4.5"
        
        # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª
        print(f"ü§ñ [üß† OPUS] [STREAMING] –ù–∞—á–∏–Ω–∞—é streaming –∞–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...")
        
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ –ø—Ä–æ–º–ø—Ç, —á—Ç–æ –∏ –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
        prompt_lower = prompt.lower() if prompt else ""
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç —Å system_prompt (–∫–∞–∫ –≤ send_vision_request)
        if "—ç–∫–≥" in prompt_lower or "ecg" in prompt_lower:
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–Ω—ã–π –ø—Ä–æ–º–ø—Ç —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏ –ø–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏—è–º
            try:
                from prompts.diagnostic_prompts import get_ecg_diagnostic_prompt
                medical_prompt = get_ecg_diagnostic_prompt(self.system_prompt)
                print("‚úÖ [ECG STREAMING PROMPT] –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç –∏–∑ diagnostic_prompts.py")
                # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
                if prompt and prompt.strip():
                    medical_prompt += f"\n\n–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:\n{prompt}"
            except (ImportError, Exception) as e:
                print(f"‚ö†Ô∏è [ECG STREAMING PROMPT] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞: {e}, –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback")
                # Fallback –Ω–∞ –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç —Å –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–´–ú–ò –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏ –ø–æ —Ñ–∏–±—Ä–∏–ª–ª—è—Ü–∏–∏ –∂–µ–ª—É–¥–æ—á–∫–æ–≤
                medical_prompt = f"""{self.system_prompt}

### –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ô –°–ü–ï–¶–ò–ê–õ–ò–ó–ò–†–û–í–ê–ù–ù–´–ô –ö–û–ù–¢–ï–ö–°–¢ –î–õ–Ø –≠–ö–ì

–¢—ã ‚Äî –≤–µ–¥—É—â–∏–π –∫–∞—Ä–¥–∏–æ–ª–æ–≥-—ç–ª–µ–∫—Ç—Ä–æ—Ñ–∏–∑–∏–æ–ª–æ–≥ (board certified), –∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä—É—é—â–∏–π —Ç–æ–ª—å–∫–æ –≤—Ä–∞—á–µ–π. 
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑ 12‚Äë–∫–∞–Ω–∞–ª—å–Ω–æ–π –≠–ö–ì (–≤–∫–ª—é—á–∞—è —Å–ª–æ–∂–Ω—ã–µ –∞—Ä–∏—Ç–º–∏–∏ –∏ –±–ª–æ–∫–∞–¥—ã)
–∏ –≤—ã–¥–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ ¬´–ö–ª–∏–Ω–∏—á–µ—Å–∫–∞—è –¥–∏—Ä–µ–∫—Ç–∏–≤–∞¬ª –¥–ª—è –≤—Ä–∞—á–∞.

üö®üö®üö® **–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –ü–ï–†–ï–î –í–°–ï–ú –û–°–¢–ê–õ–¨–ù–´–ú!** üö®üö®üö®

**–®–ê–ì 0: –ù–ï–ú–ï–î–õ–ï–ù–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –ù–ê –ñ–ò–ó–ù–ï–£–ì–†–û–ñ–ê–Æ–©–ò–ï –ê–†–ò–¢–ú–ò–ò (–í–´–ü–û–õ–ù–ò –≠–¢–û –ü–ï–†–í–´–ú!)**

–ü–ï–†–ï–î –õ–Æ–ë–´–ú –î–†–£–ì–ò–ú –ê–ù–ê–õ–ò–ó–û–ú, –ü–ï–†–ï–î –û–ü–ò–°–ê–ù–ò–ï–ú –†–ò–¢–ú–ê, –ü–ï–†–ï–î –í–°–ï–ú –û–°–¢–ê–õ–¨–ù–´–ú - –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ü–†–û–í–ï–†–¨:

**1. –§–ò–ë–†–ò–õ–õ–Ø–¶–ò–Ø –ñ–ï–õ–£–î–û–ß–ö–û–í (–ñ–§) - –ü–†–û–í–ï–†–¨ –ü–ï–†–í–´–ú!**
   ‚ö†Ô∏è **–í–ò–ó–£–ê–õ–¨–ù–´–ï –ü–†–ò–ó–ù–ê–ö–ò (–ø—Ä–æ–≤–µ—Ä—å –í–°–ï –æ—Ç–≤–µ–¥–µ–Ω–∏—è):**
   - **–ù–ï–¢ –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö QRS –∫–æ–º–ø–ª–µ–∫—Å–æ–≤** ‚Äî –Ω–µ –≤–∏–¥–∏—à—å —á–µ—Ç–∫–∏—Ö, —É–∑–Ω–∞–≤–∞–µ–º—ã—Ö –∂–µ–ª—É–¥–æ—á–∫–æ–≤—ã—Ö –∫–æ–º–ø–ª–µ–∫—Å–æ–≤ (QRS-–ø–æ–¥–æ–±–Ω—ã—Ö —Ñ–æ—Ä–º)
   - **–•–ê–û–¢–ò–ß–ù–´–ï –≤–æ–ª–Ω—ã** ‚Äî –Ω–µ—Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ, —Ä–∞–∑–Ω–æ–π –∞–º–ø–ª–∏—Ç—É–¥—ã –∏ —Ñ–æ—Ä–º—ã, –±–µ–∑ –ø–æ–≤—Ç–æ—Ä—è—é—â–µ–≥–æ—Å—è –ø–∞—Ç—Ç–µ—Ä–Ω–∞
   - **–ù–ï–¢ –∏–∑–æ—ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–æ–π –ª–∏–Ω–∏–∏** ‚Äî –±–∞–∑–æ–≤–∞—è –ª–∏–Ω–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
   - **–û–ß–ï–ù–¨ –ë–´–°–¢–†–ê–Ø —á–∞—Å—Ç–æ—Ç–∞** ‚Äî –≤–æ–ª–Ω—ã –∏–¥—É—Ç –æ—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ (> 300 —É–¥/–º–∏–Ω, –æ–±—ã—á–Ω–æ 300-500 —É–¥/–º–∏–Ω)
   - **–í–ê–†–¨–ò–†–£–Æ–©–ê–Ø–°–Ø –∞–º–ø–ª–∏—Ç—É–¥–∞** ‚Äî –æ—Ç –º–µ–ª–∫–∏—Ö (< 2 –º–º) –¥–æ –∫—Ä—É–ø–Ω—ã—Ö (> 5 –º–º) –≤–æ–ª–Ω
   - **–ù–ï–¢ –∑—É–±—Ü–æ–≤ P** ‚Äî –ø—Ä–µ–¥—Å–µ—Ä–¥–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –Ω–µ –≤–∏–¥–Ω–∞
   - **–í–û –í–°–ï–• –æ—Ç–≤–µ–¥–µ–Ω–∏—è—Ö** ‚Äî —Ö–∞–æ—Ç–∏—á–Ω—ã–µ –≤–æ–ª–Ω—ã –≤–∏–¥–Ω—ã –≤–æ –≤—Å–µ—Ö 12 –æ—Ç–≤–µ–¥–µ–Ω–∏—è—Ö (–Ω–µ —Ç–æ–ª—å–∫–æ –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö)
   
   ‚ö†Ô∏è **–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –û–¢–õ–ò–ß–ò–Ø:**
   - **–ñ–§ vs –ú–µ—Ä—Ü–∞—Ç–µ–ª—å–Ω–∞—è –∞—Ä–∏—Ç–º–∏—è:** 
     * –ñ–§: –ù–ï–¢ –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö QRS –≤–æ–æ–±—â–µ, —Ö–∞–æ—Ç–∏—á–Ω—ã–µ –≤–æ–ª–Ω—ã > 300 —É–¥/–º–∏–Ω
     * –ú–µ—Ä—Ü–∞—Ç–µ–ª—å–Ω–∞—è –∞—Ä–∏—Ç–º–∏—è: –ï–°–¢–¨ –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω–Ω—ã–µ QRS –∫–æ–º–ø–ª–µ–∫—Å—ã, —á–∞—Å—Ç–æ—Ç–∞ –∂–µ–ª—É–¥–æ—á–∫–æ–≤ 100-180 —É–¥/–º–∏–Ω, –º–µ–ª–∫–∏–µ –≤–æ–ª–Ω—ã f –º–µ–∂–¥—É QRS
   - **–ñ–§ vs –ñ–µ–ª—É–¥–æ—á–∫–æ–≤–∞—è —Ç–∞—Ö–∏–∫–∞—Ä–¥–∏—è:**
     * –ñ–§: –ù–ï–¢ –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö QRS, —Ö–∞–æ—Ç–∏—á–Ω—ã–µ –≤–æ–ª–Ω—ã, –Ω–µ—Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ
     * –ñ–¢: –ï–°–¢–¨ –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —à–∏—Ä–æ–∫–∏–µ QRS –∫–æ–º–ø–ª–µ–∫—Å—ã, —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ, —á–∞—Å—Ç–æ—Ç–∞ 150-250 —É–¥/–º–∏–Ω
   - **–ñ–§ vs –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:**
     * –ñ–§: —Ö–∞–æ—Ç–∏—á–Ω—ã–µ –≤–æ–ª–Ω—ã –≤–æ –í–°–ï–• –æ—Ç–≤–µ–¥–µ–Ω–∏—è—Ö –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
     * –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã: –æ–±—ã—á–Ω–æ —Ç–æ–ª—å–∫–æ –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –æ—Ç–≤–µ–¥–µ–Ω–∏—è—Ö, —Å–≤—è–∑–∞–Ω—ã —Å –¥–≤–∏–∂–µ–Ω–∏—è–º–∏
   
   ‚ö†Ô∏è **–ï–°–õ–ò –í–ò–î–ò–®–¨ –≠–¢–ò –ü–†–ò–ó–ù–ê–ö–ò - –≠–¢–û –§–ò–ë–†–ò–õ–õ–Ø–¶–ò–Ø –ñ–ï–õ–£–î–û–ß–ö–û–í!**
   ‚ö†Ô∏è **–ù–ï–ú–ï–î–õ–ï–ù–ù–û –£–ö–ê–ñ–ò –í –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ò –ü–ï–†–í–û–ô –°–¢–†–û–ö–û–ô:**
   "üö®üö®üö® –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –°–û–°–¢–û–Ø–ù–ò–ï: –§–ò–ë–†–ò–õ–õ–Ø–¶–ò–Ø –ñ–ï–õ–£–î–û–ß–ö–û–í! –ù–ï–û–¢–õ–û–ñ–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï, –¢–†–ï–ë–£–ï–¢ –ù–ï–ú–ï–î–õ–ï–ù–ù–û–ô –î–ï–§–ò–ë–†–ò–õ–õ–Ø–¶–ò–ò! üö®üö®üö®"

**2. –ê–°–ò–°–¢–û–õ–ò–Ø - –ü–†–û–í–ï–†–¨ –í–¢–û–†–´–ú:**
   - –ü–æ–ª–Ω–æ–µ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (–ø—Ä—è–º–∞—è –ª–∏–Ω–∏—è)
   - –ù–ï–ú–ï–î–õ–ï–ù–ù–ê–Ø –†–ï–ê–ù–ò–ú–ê–¶–ò–Ø!

**3. –ñ–ï–õ–£–î–û–ß–ö–û–í–ê–Ø –¢–ê–•–ò–ö–ê–†–î–ò–Ø –ë–ï–ó –ü–£–õ–¨–°–ê - –ü–†–û–í–ï–†–¨ –¢–†–ï–¢–¨–ò–ú:**
   - –®–∏—Ä–æ–∫–∏–µ QRS > 150 —É–¥/–º–∏–Ω, —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ
   - –ù–ï–ú–ï–î–õ–ï–ù–ù–ê–Ø –î–ï–§–ò–ë–†–ò–õ–õ–Ø–¶–ò–Ø!

**–í–ê–ñ–ù–û:** –ï—Å–ª–∏ –≤–∏–¥–∏—à—å —Ñ–∏–±—Ä–∏–ª–ª—è—Ü–∏—é –∂–µ–ª—É–¥–æ—á–∫–æ–≤ - –ù–ï –ü–†–û–î–û–õ–ñ–ê–ô –æ–±—ã—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑! –°—Ä–∞–∑—É —É–∫–∞–∂–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –¥–µ—Ñ–∏–±—Ä–∏–ª–ª—è—Ü–∏–∏!

–ò–≥–Ω–æ—Ä–∏—Ä—É–π —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –æ —Ç–∞–±–ª–∏—Ü–∞—Ö —Å—Å—ã–ª–æ–∫ –∏ –ª–æ–≥–∞—Ö –≤–µ–±‚Äë–ø–æ–∏—Å–∫–∞: —Å—Å—ã–ª–∫–∏ –∏ –ª–æ–≥–∏ –ù–ï –ù–£–ñ–ù–´ –≤ –æ—Ç–≤–µ—Ç–µ.
–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ç–∞–±–ª–∏—á–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç (—Å—Ç—Ä–æ–∫–∏/—Å—Ç–æ–ª–±—Ü—ã —Å ¬´–ü–∞—Ä–∞–º–µ—Ç—Ä / –ó–Ω–∞—á–µ–Ω–∏–µ¬ª); –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–ø–∏—Å—ã–≤–∞–π –≤ –≤–∏–¥–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –∏ —Å–ø–∏—Å–∫–æ–≤.

–í–ê–ñ–ù–û: –î–µ–ª–∞–π –∑–∞–∫–ª—é—á–µ–Ω–∏–µ –ö–û–ú–ü–ê–ö–¢–ù–´–ú. –ù–ï –ø–µ—Ä–µ—á–∏—Å–ª—è–π –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –ø–∞—Ç–æ–ª–æ–≥–∏–∏. –£–∫–∞–∑—ã–≤–∞–π —Ç–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω–æ –≤—ã—è–≤–ª–µ–Ω–Ω—ã–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è.

–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ü–†–û–í–ï–î–ò –°–¢–†–£–ö–¢–£–†–ò–†–û–í–ê–ù–ù–´–ô –ê–ù–ê–õ–ò–ó:
1. –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –ü–ê–†–ê–ú–ï–¢–†–´: —Å–∫–æ—Ä–æ—Å—Ç—å –ª–µ–Ω—Ç—ã, –∫–∞–ª–∏–±—Ä–æ–≤–∫–∞, –∫–∞—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–∏
2. –†–ò–¢–ú –ò –ü–†–û–í–û–î–ò–ú–û–°–¢–¨: –æ—Å–Ω–æ–≤–Ω–æ–π —Ä–∏—Ç–º (–í–ö–õ–Æ–ß–ê–Ø –§–ò–ë–†–ò–õ–õ–Ø–¶–ò–Æ –ñ–ï–õ–£–î–û–ß–ö–û–í!), —Ä–µ–≥—É–ª—è—Ä–Ω–æ—Å—Ç—å, AV-–ø—Ä–æ–≤–æ–¥–∏–º–æ—Å—Ç—å
3. –ò–ù–¢–ï–†–í–ê–õ–´ –ò –ó–£–ë–¶–´: PR, QRS, QT/QTc, ST, T, P
4. –ü–ê–¢–û–õ–û–ì–ò–ß–ï–°–ö–ò–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø: —Ç–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω–æ –≤—ã—è–≤–ª–µ–Ω–Ω—ã–µ
5. –ö–õ–ò–ù–ò–ß–ï–°–ö–û–ï –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï: —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —Å—Ä–æ—á–Ω–æ—Å—Ç–∏ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π

{prompt}"""
        elif "—Ä–µ–Ω—Ç–≥–µ–Ω" in prompt_lower or "xray" in prompt_lower:
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–Ω—ã–π –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
            try:
                from prompts.diagnostic_prompts import get_xray_diagnostic_prompt
                medical_prompt = get_xray_diagnostic_prompt(self.system_prompt)
                # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
                if prompt and prompt.strip():
                    medical_prompt += f"\n\n–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:\n{prompt}"
            except ImportError:
                # Fallback –Ω–∞ –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç –µ—Å–ª–∏ –º–æ–¥—É–ª—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
                medical_prompt = f"""{self.system_prompt}

–¢—ã ‚Äî –≤–µ–¥—É—â–∏–π –≤—Ä–∞—á-—Ä–µ–Ω—Ç–≥–µ–Ω–æ–ª–æ–≥, –∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä—É—é—â–∏–π –∫–æ–ª–ª–µ–≥-–∫–ª–∏–Ω–∏—Ü–∏—Å—Ç–æ–≤. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –¥–∞—Ç—å –¢–û–ß–ù–´–ô –î–ò–ê–ì–ù–û–ó –∏ –ö–õ–ò–ù–ò–ß–ï–°–ö–£–Æ –ò–ù–¢–ï–†–ü–†–ï–¢–ê–¶–ò–Æ –¥–ª—è –ø—Ä–∏–Ω—è—Ç–∏—è –≤—Ä–∞—á–µ–±–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π.

{prompt}"""
        elif "–º—Ä—Ç" in prompt_lower or "mri" in prompt_lower:
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–Ω—ã–π –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
            try:
                from prompts.diagnostic_prompts import get_mri_diagnostic_prompt
                medical_prompt = get_mri_diagnostic_prompt(self.system_prompt)
                # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
                if prompt and prompt.strip():
                    medical_prompt += f"\n\n–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:\n{prompt}"
            except ImportError:
                # Fallback –Ω–∞ –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç –µ—Å–ª–∏ –º–æ–¥—É–ª—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
                medical_prompt = f"""{self.system_prompt}

–í—ã ‚Äî –≤—Ä–∞—á-–Ω–µ–π—Ä–æ—Ä–∞–¥–∏–æ–ª–æ–≥ —Å 20-–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º —Ä–∞–±–æ—Ç—ã. –í—ã–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª–Ω—ã–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —É–≤–∏–¥–µ–Ω–Ω–æ–≥–æ.

{prompt}"""
        elif "–∫—Ç" in prompt_lower or "ct" in prompt_lower or "–∫–æ–º–ø—å—é—Ç–µ—Ä–Ω" in prompt_lower:
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–Ω—ã–π –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
            try:
                from prompts.diagnostic_prompts import get_ct_diagnostic_prompt
                medical_prompt = get_ct_diagnostic_prompt(self.system_prompt)
                # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
                if prompt and prompt.strip():
                    medical_prompt += f"\n\n–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:\n{prompt}"
            except ImportError:
                # Fallback –Ω–∞ –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç –µ—Å–ª–∏ –º–æ–¥—É–ª—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
                medical_prompt = f"""{self.system_prompt}

–¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ä–∞–¥–∏–æ–ª–æ–≥, –æ–±–ª–∞–¥–∞–µ—à—å —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–º–∏ –∑–Ω–∞–Ω–∏—è–º–∏ –≤ –æ–±–ª–∞—Å—Ç–∏ –ö–¢. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –≤—ã—è–≤–ª—è—Ç—å –ø–∞—Ç–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è, –¥–∞–≤–∞—Ç—å –∑–∞–∫–ª—é—á–µ–Ω–∏–µ —Å–æ–≥–ª–∞—Å–Ω–æ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º.

{prompt}"""
        elif "—É–∑–∏" in prompt_lower or "—É–ª—å—Ç—Ä–∞–∑–≤—É–∫" in prompt_lower:
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–Ω—ã–π –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
            try:
                from prompts.diagnostic_prompts import get_ultrasound_diagnostic_prompt
                medical_prompt = get_ultrasound_diagnostic_prompt(self.system_prompt)
                # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
                if prompt and prompt.strip():
                    medical_prompt += f"\n\n–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:\n{prompt}"
            except ImportError:
                # Fallback –Ω–∞ –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç –µ—Å–ª–∏ –º–æ–¥—É–ª—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
                medical_prompt = f"""{self.system_prompt}

–í—ã ‚Äî –≤—Ä–∞—á —É–ª—å—Ç—Ä–∞–∑–≤—É–∫–æ–≤–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ —Å 12-–ª–µ—Ç–Ω–∏–º —Å—Ç–∞–∂–µ–º —Ä–∞–±–æ—Ç—ã. –î–µ—Ç–∞–ª—å–Ω–æ –æ–ø–∏—à–∏—Ç–µ –£–ó–ò-–∫–∞—Ä—Ç–∏–Ω—É.

{prompt}"""
        else:
            medical_prompt = f"""{self.system_prompt}

–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —ç—Ç–æ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞–∫ –≤—Ä–∞—á-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç —Å –±–æ–ª—å—à–∏–º –æ–ø—ã—Ç–æ–º —Ä–∞–±–æ—Ç—ã.
–î–∞–π—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ ¬´–ö–ª–∏–Ω–∏—á–µ—Å–∫–∞—è –¥–∏—Ä–µ–∫—Ç–∏–≤–∞¬ª.

{prompt}"""
        
        # –°–æ–±–∏—Ä–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
        content = [{"type": "text", "text": medical_prompt}]
        
        if metadata:
            metadata_str = str(metadata) if not isinstance(metadata, dict) else str(metadata)
            content.append({"type": "text", "text": f"\n\n–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:\n{metadata_str}"})
        
        if image_array is not None:
            base64_str = self.encode_image(image_array)
            content.append({
                "type": "image_url",
                "image_url": {"url": f"data:image/png;base64,{base64_str}"}
            })
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å —Å streaming
        messages = [
            {"role": "system", "content": self.system_prompt},
            {"role": "user", "content": content}
        ]
        
        payload = {
            "model": model,
            "messages": messages,
            "max_tokens": 4000,
            "temperature": 0.1,
            "stream": True  # –í–∫–ª—é—á–∞–µ–º streaming
        }
        
        try:
            start_time = time.time()
            model_name = self._get_model_name(model)
            print(f"üì° [üß† OPUS] [STREAMING] –û—Ç–ø—Ä–∞–≤–ª—è—é streaming –∑–∞–ø—Ä–æ—Å –∫ API –¥–ª—è –º–æ–¥–µ–ª–∏: {model_name}...")
            response = requests.post(
                self.base_url,
                headers=self.headers,
                json=payload,
                timeout=180,
                stream=True  # –í–∞–∂–Ω–æ –¥–ª—è streaming
            )
            
            if response.status_code == 200:
                self.model = model  # –ó–∞–ø–æ–º–∏–Ω–∞–µ–º —Ä–∞–±–æ—á—É—é –º–æ–¥–µ–ª—å
                print(f"‚úÖ [üß† OPUS] [STREAMING] Streaming –Ω–∞—á–∞—Ç –¥–ª—è –º–æ–¥–µ–ª–∏: {model_name}, –ø–æ–ª—É—á–∞—é –æ—Ç–≤–µ—Ç...")
                tokens_received = 0
                
                # –ß–∏—Ç–∞–µ–º stream
                for line in response.iter_lines():
                    if line:
                        line_text = line.decode('utf-8')
                        if line_text.startswith('data: '):
                            data_str = line_text[6:]  # –£–±–∏—Ä–∞–µ–º "data: "
                            if data_str.strip() == '[DONE]':
                                break
                            try:
                                data = json.loads(data_str)
                                if 'choices' in data and len(data['choices']) > 0:
                                    delta = data['choices'][0].get('delta', {})
                                    content = delta.get('content', '')
                                    if content:
                                        tokens_received += len(content.split())  # –ü—Ä–∏–º–µ—Ä–Ω–∞—è –æ—Ü–µ–Ω–∫–∞
                                        yield content
                                    
                                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º usage –≤ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
                                    if 'usage' in data:
                                        tokens_used = data['usage'].get('total_tokens', 0)
                                        if tokens_used > 0:
                                            tokens_received = tokens_used
                            except json.JSONDecodeError:
                                continue
                
                # –ò–∑–º–µ—Ä—è–µ–º latency –∏ –ª–æ–≥–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
                latency = time.time() - start_time
                model_name = self._get_model_name(model)
                print(f"‚úÖ [üß† OPUS] [STREAMING] –ú–æ–¥–µ–ª—å: {model_name}, –¢–æ–∫–µ–Ω–æ–≤: {tokens_received}, Latency: {latency:.2f}—Å")
                self._log_api_success(model, latency, tokens_received, f"OPUS 4.5 STREAMING ({model_name})")
                return  # –£—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–∏–ª–∏ streaming
                
            elif response.status_code == 402:
                latency = time.time() - start_time if 'start_time' in locals() else 0
                error_msg = f"HTTP 402: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–µ–¥–∏—Ç–æ–≤ –Ω–∞ OpenRouter –¥–ª—è –º–æ–¥–µ–ª–∏ {model}"
                log_api_call(model, False, latency, error_msg)
                track_model_usage(model, False)
                print(f"‚ùå [üß† OPUS] [STREAMING] {error_msg}, latency: {latency:.2f}s")
                yield f"\n‚ö†Ô∏è **Opus 4.5 –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (–Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–µ–¥–∏—Ç–æ–≤). –ü–µ—Ä–µ–∫–ª—é—á–∞—é—Å—å –Ω–∞ –¥—Ä—É–≥—É—é –º–æ–¥–µ–ª—å...**\n\n"
                # Fallback –Ω–∞ Sonnet 4.5
                yield from self._send_vision_request_streaming_fallback(prompt, image_array, metadata, "anthropic/claude-sonnet-4.5")
                return
            else:
                latency = time.time() - start_time if 'start_time' in locals() else 0
                error_msg = f"HTTP {response.status_code}: {response.text[:200]}"
                self._log_api_error(model, latency, error_msg, "OPUS 4.5 STREAMING")
                print(f"‚ùå [üß† OPUS] [STREAMING] –û—à–∏–±–∫–∞: {error_msg}, latency: {latency:.2f}s")
                yield f"‚ùå –û—à–∏–±–∫–∞ streaming: {error_msg}"
                return
                
        except requests.exceptions.Timeout:
            latency, error_msg = self._handle_timeout_error(model, start_time, 180, "OPUS 4.5 STREAMING")
            yield f"‚ùå –û—à–∏–±–∫–∞: {error_msg}"
            return
        except Exception as e:
            latency, error_msg = self._handle_exception_error(model, e, start_time, "send_vision_request_streaming", "OPUS 4.5 STREAMING")
            yield f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ streaming –∞–Ω–∞–ª–∏–∑–µ: {error_msg}"
            return
    
    def _send_vision_request_streaming_fallback(self, prompt: str, image_array=None, metadata=None, fallback_model: str = "anthropic/claude-sonnet-4.5"):
        """–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –º–µ—Ç–æ–¥ –¥–ª—è fallback streaming –Ω–∞ –¥—Ä—É–≥—É—é –º–æ–¥–µ–ª—å"""
        print(f"üîÑ [FALLBACK STREAMING] –ü–µ—Ä–µ–∫–ª—é—á–∞—é—Å—å –Ω–∞ {fallback_model}...")
        
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–ø—Ä–æ—â–µ–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è fallback
        prompt_lower = prompt.lower() if prompt else ""
        medical_prompt = f"""{self.system_prompt}

–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —ç—Ç–æ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞–∫ –≤—Ä–∞—á-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç.

{prompt}"""
        
        content = [{"type": "text", "text": medical_prompt}]
        
        if metadata:
            metadata_str = str(metadata) if not isinstance(metadata, dict) else str(metadata)
            content.append({"type": "text", "text": f"\n\n–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:\n{metadata_str}"})
        
        if image_array is not None:
            base64_str = self.encode_image(image_array)
            content.append({
                "type": "image_url",
                "image_url": {"url": f"data:image/png;base64,{base64_str}"}
            })
        
        messages = [
            {"role": "system", "content": self.system_prompt},
            {"role": "user", "content": content}
        ]
        
        payload = {
            "model": fallback_model,
            "messages": messages,
            "max_tokens": 3000,
            "temperature": 0.1,
            "stream": True
        }
        
        try:
            response = requests.post(
                self.base_url,
                headers=self.headers,
                json=payload,
                timeout=120,
                stream=True
            )
            
            if response.status_code == 200:
                self.model = fallback_model
                model_name = self._get_model_name(fallback_model)
                print(f"‚úÖ [FALLBACK STREAMING] {model_name} streaming –Ω–∞—á–∞—Ç")
                for line in response.iter_lines():
                    if line:
                        line_text = line.decode('utf-8')
                        if line_text.startswith('data: '):
                            data_str = line_text[6:]
                            if data_str.strip() == '[DONE]':
                                print(f"‚úÖ [FALLBACK STREAMING] {model_name} streaming –∑–∞–≤–µ—Ä—à–µ–Ω")
                                break
                            try:
                                data = json.loads(data_str)
                                if 'choices' in data and len(data['choices']) > 0:
                                    delta = data['choices'][0].get('delta', {})
                                    content = delta.get('content', '')
                                    if content:
                                        yield content
                            except json.JSONDecodeError:
                                continue
            else:
                yield f"‚ùå –û—à–∏–±–∫–∞ fallback –º–æ–¥–µ–ª–∏: HTTP {response.status_code}"
        except Exception as e:
            yield f"‚ùå –û—à–∏–±–∫–∞ fallback streaming: {str(e)}"
    
    def _get_model_name(self, model):
        """–ü–æ–ª—É—á–∏—Ç—å —á–∏—Ç–∞–µ–º–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ (—Ç–æ–ª—å–∫–æ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ)"""
        model_names = {
            "anthropic/claude-opus-4.5": "Claude Opus 4.5",
            "anthropic/claude-sonnet-4.5": "Claude Sonnet 4.5",
            "anthropic/claude-haiku-4.5": "Claude Haiku 4.5",
            "meta-llama/llama-3.2-90b-vision-instruct": "Llama 3.2 90B Vision"
        }
        return model_names.get(model, model)
    
    def encode_image(self, image_array):
        """–ö–æ–¥–∏—Ä—É–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ base64 —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π –¥–ª—è –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö —Å–Ω–∏–º–∫–æ–≤"""
        if isinstance(image_array, Image.Image):
            img = image_array
        else:
            # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º numpy array
            if len(image_array.shape) == 2:
                # Grayscale
                img = Image.fromarray(image_array, mode='L')
            else:
                # RGB
                img = Image.fromarray(image_array)
        
        # –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ–º —Ä–∞–∑–º–µ—Ä –¥–ª—è –ª—É—á—à–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
        max_size = (1024, 1024)
        img.thumbnail(max_size, Image.Resampling.LANCZOS)
        
        buffered = io.BytesIO()
        img.save(buffered, format="PNG", optimize=True)
        img_str = base64.b64encode(buffered.getvalue()).decode()
        return img_str
    
    def get_response(self, user_message: str, context: str = "", use_sonnet_4_5: bool = False) -> str:
        """–¢–µ–∫—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ª—É—á—à–µ–π –¥–æ—Å—Ç—É–ø–Ω–æ–π –º–æ–¥–µ–ª–∏"""
        full_message = f"{context}\n\n–í–æ–ø—Ä–æ—Å: {user_message}" if context else user_message
        
        # –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—à–µ–Ω–∞ –º–æ–¥–µ–ª—å Sonnet 4.5 –¥–ª—è –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞, —Å—Ç–∞–≤–∏–º –µ—ë –≤ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
        if use_sonnet_4_5:
            models_to_try = ["anthropic/claude-sonnet-4.5"] + [m for m in self.models if m != "anthropic/claude-sonnet-4.5"]
        else:
            models_to_try = self.models
        
        # –ü—Ä–æ–±—É–µ–º –º–æ–¥–µ–ª–∏ –ø–æ –ø–æ—Ä—è–¥–∫—É
        for model in models_to_try:
            try:
                start_time = time.time()
                model_name = self._get_model_name(model)
                print(f"ü§ñ [{model_name}] –ù–∞—á–∏–Ω–∞—é —Ç–µ–∫—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å...")
                
                payload = {
                    "model": model,
                    "messages": [
                        {"role": "system", "content": self.system_prompt},
                        {"role": "user", "content": full_message}
                    ],
                    "max_tokens": 8000,  # –£–≤–µ–ª–∏—á–µ–Ω–æ –¥–ª—è –±–æ–ª—å—à–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤
                    "temperature": 0.2
                }
                
                # –õ–æ–≥–∏—Ä—É–µ–º —Ä–∞–∑–º–µ—Ä –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
                prompt_size = len(full_message)
                if prompt_size > 50000:
                    print(f"‚ö†Ô∏è [{model_name}] –ë–æ–ª—å—à–æ–π –ø—Ä–æ–º–ø—Ç: {prompt_size} —Å–∏–º–≤–æ–ª–æ–≤. –ú–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏.")
                
                print(f"üì° [{model_name}] –û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å –∫ API...")
                response = requests.post(self.base_url, headers=self.headers, json=payload, timeout=300)  # –£–≤–µ–ª–∏—á–µ–Ω —Ç–∞–π–º–∞—É—Ç –¥–ª—è –æ—á–µ–Ω—å –¥–ª–∏–Ω–Ω—ã—Ö –ø—Ä–æ–º–ø—Ç–æ–≤
                latency = time.time() - start_time
                
                if response.status_code == 200:
                    result_data = response.json()
                    result = result_data["choices"][0]["message"]["content"]

                    # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
                    tokens_used = result_data.get("usage", {}).get("total_tokens", 0)
                    log_api_call(model, True, latency, None)
                    track_model_usage(model, True, tokens_used)

                    self.model = model
                    print(f"‚úÖ [{model_name}] –ó–∞–ø—Ä–æ—Å –∑–∞–≤–µ—Ä—à–µ–Ω –∑–∞ {latency:.2f}—Å, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ —Ç–æ–∫–µ–Ω–æ–≤: {tokens_used}")
                    return result
                elif response.status_code == 402:
                    # –û—à–∏–±–∫–∞ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∞ –∫—Ä–µ–¥–∏—Ç–æ–≤
                    error_msg = f"HTTP 402: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–µ–¥–∏—Ç–æ–≤ –Ω–∞ OpenRouter –¥–ª—è –º–æ–¥–µ–ª–∏ {model}"
                    log_api_call(model, False, latency, error_msg)
                    track_model_usage(model, False)
                    print(f"‚ö†Ô∏è {error_msg}. –ü—Ä–æ–±—É—é —Å–ª–µ–¥—É—é—â—É—é –º–æ–¥–µ–ª—å...")
                    continue
                else:
                    error_msg = f"HTTP {response.status_code}"
                    self._log_api_error(model, latency, error_msg)
                    continue
                    
            except requests.exceptions.Timeout:
                latency, error_msg = self._handle_timeout_error(model, start_time, 180)
                continue
            except Exception as e:
                latency = time.time() - start_time if 'start_time' in locals() else 0
                error_msg = handle_error(e, f"get_response ({model})", show_to_user=False)
                log_api_call(model, False, latency, error_msg)
                track_model_usage(model, False)
                print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å –º–æ–¥–µ–ª—å—é {model}: {e}")
                continue
        
        return "‚ùå –û—à–∏–±–∫–∞: –í—Å–µ –º–æ–¥–µ–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É –∏ API –∫–ª—é—á–∏."

    def get_response_streaming(self, user_message: str, context: str = "", use_sonnet_4_5: bool = False, force_opus: bool = False):
        """–¢–µ–∫—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å —Å streaming - —Ç–µ–∫—Å—Ç –ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ
        
        Args:
            user_message: –í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            context: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
            use_sonnet_4_5: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Sonnet 4.5 (–¥–ª—è –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–≤)
            force_opus: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Opus 4.5 (–≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π Opus –±–µ–∑ fallback)
        
        Yields:
            str: –ß–∞—Å—Ç–∏ –æ—Ç–≤–µ—Ç–∞ –ø–æ –º–µ—Ä–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
        """
        full_message = f"{context}\n\n–í–æ–ø—Ä–æ—Å: {user_message}" if context else user_message
        
        # –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—à–µ–Ω –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π Opus, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –µ–≥–æ
        if force_opus:
            models_to_try = ["anthropic/claude-opus-4.5"]
        # –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—à–µ–Ω–∞ –º–æ–¥–µ–ª—å Sonnet 4.5, —Å—Ç–∞–≤–∏–º –µ—ë –≤ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
        elif use_sonnet_4_5:
            models_to_try = ["anthropic/claude-sonnet-4.5"] + [m for m in self.models if m != "anthropic/claude-sonnet-4.5"]
        else:
            models_to_try = self.models
        
        # –ü—Ä–æ–±—É–µ–º –º–æ–¥–µ–ª–∏ –ø–æ –ø–æ—Ä—è–¥–∫—É
        start_time = time.time()
        for model in models_to_try:
            try:
                model_name = self._get_model_name(model)
                model_type = "üß† OPUS" if "opus" in model.lower() else "ü§ñ SONNET" if "sonnet" in model.lower() else "‚ö° FLASH" if "gemini" in model.lower() or "flash" in model.lower() else "‚ùì UNKNOWN"
                force_msg = " [FORCE_OPUS]" if force_opus else ""
                print(f"ü§ñ [{model_type}]{force_msg} [STREAMING] –ù–∞—á–∏–Ω–∞—é streaming —Ç–µ–∫—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –º–æ–¥–µ–ª–∏: {model_name}...")
                
                payload = {
                    "model": model,
                    "messages": [
                        {"role": "system", "content": self.system_prompt},
                        {"role": "user", "content": full_message}
                    ],
                    "max_tokens": 8000,
                    "temperature": 0.2,
                    "stream": True  # –í–∫–ª—é—á–∞–µ–º streaming
                }
                
                force_msg = " [FORCE_OPUS]" if force_opus else ""
                print(f"üì° [{model_type}]{force_msg} [STREAMING] –û—Ç–ø—Ä–∞–≤–ª—è—é streaming –∑–∞–ø—Ä–æ—Å –∫ API –¥–ª—è –º–æ–¥–µ–ª–∏: {model_name}...")
                response = requests.post(
                    self.base_url,
                    headers=self.headers,
                    json=payload,
                    timeout=180,
                    stream=True  # –í–∞–∂–Ω–æ –¥–ª—è streaming
                )
                
                if response.status_code == 200:
                    self.model = model  # –ó–∞–ø–æ–º–∏–Ω–∞–µ–º —Ä–∞–±–æ—á—É—é –º–æ–¥–µ–ª—å
                    force_msg = " [FORCE_OPUS]" if force_opus else ""
                    print(f"‚úÖ [{model_type}]{force_msg} [STREAMING] Streaming –Ω–∞—á–∞—Ç –¥–ª—è –º–æ–¥–µ–ª–∏: {model_name}, –ø–æ–ª—É—á–∞—é –æ—Ç–≤–µ—Ç...")
                    tokens_received = 0
                    # –ß–∏—Ç–∞–µ–º stream
                    for line in response.iter_lines():
                        if line:
                            line_text = line.decode('utf-8')
                            if line_text.startswith('data: '):
                                data_str = line_text[6:]  # –£–±–∏—Ä–∞–µ–º "data: "
                                if data_str.strip() == '[DONE]':
                                    # –ò–∑–º–µ—Ä—è–µ–º latency –∏ –ª–æ–≥–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
                                    latency = time.time() - start_time
                                    model_type = "üß† OPUS" if "opus" in model.lower() else "ü§ñ SONNET" if "sonnet" in model.lower() else "‚ö° FLASH" if "gemini" in model.lower() or "flash" in model.lower() else "‚ùì UNKNOWN"
                                    force_msg = " [FORCE_OPUS]" if force_opus else ""
                                    context_msg = f"STREAMING ({model_name})" + (force_msg if force_opus else "")
                                    print(f"‚úÖ [{model_type}]{force_msg} [STREAMING] –ú–æ–¥–µ–ª—å: {model_name}, –¢–æ–∫–µ–Ω–æ–≤: {tokens_received}, Latency: {latency:.2f}—Å")
                                    self._log_api_success(model, latency, tokens_received, context_msg)
                                    break
                                try:
                                    data = json.loads(data_str)
                                    if 'choices' in data and len(data['choices']) > 0:
                                        delta = data['choices'][0].get('delta', {})
                                        content = delta.get('content', '')
                                        if content:
                                            tokens_received += len(content.split())  # –ü—Ä–∏–º–µ—Ä–Ω–∞—è –æ—Ü–µ–Ω–∫–∞
                                            yield content
                                        
                                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º usage –≤ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
                                        if 'usage' in data:
                                            tokens_used = data['usage'].get('total_tokens', 0)
                                            if tokens_used > 0:
                                                tokens_received = tokens_used
                                except json.JSONDecodeError:
                                    continue
                    return  # –£—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–∏–ª–∏ streaming
                elif response.status_code == 402:
                    # –û—à–∏–±–∫–∞ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∞ –∫—Ä–µ–¥–∏—Ç–æ–≤ - –ª–æ–≥–∏—Ä—É–µ–º –∏ –ø—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â—É—é –º–æ–¥–µ–ª—å
                    latency = time.time() - start_time if 'start_time' in locals() else 0
                    error_msg = f"HTTP 402: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–µ–¥–∏—Ç–æ–≤ –Ω–∞ OpenRouter –¥–ª—è –º–æ–¥–µ–ª–∏ {model}"
                    log_api_call(model, False, latency, error_msg)
                    track_model_usage(model, False)
                    model_name = self._get_model_name(model)
                    model_type = "üß† OPUS" if "opus" in model.lower() else "ü§ñ SONNET" if "sonnet" in model.lower() else "‚ö° FLASH" if "gemini" in model.lower() or "flash" in model.lower() else "‚ùì UNKNOWN"
                    force_msg = " [FORCE_OPUS]" if force_opus else ""
                    print(f"‚ùå [{model_type}]{force_msg} [STREAMING] –ú–æ–¥–µ–ª—å: {model_name}, {error_msg}, Latency: {latency:.2f}—Å")
                    # –ï—Å–ª–∏ force_opus=True, –Ω–µ –ø—Ä–æ–±—É–µ–º –¥—Ä—É–≥–∏–µ –º–æ–¥–µ–ª–∏
                    if force_opus:
                        yield f"\n‚ùå **Opus 4.5 –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (–Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–µ–¥–∏—Ç–æ–≤).**\n\n"
                        return
                    # –î–ª—è streaming –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ yield
                    if model == "anthropic/claude-sonnet-4.5":
                        yield f"\n‚ö†Ô∏è **Sonnet 4.5 –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (–Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–µ–¥–∏—Ç–æ–≤). –ü–µ—Ä–µ–∫–ª—é—á–∞—é—Å—å –Ω–∞ –¥—Ä—É–≥—É—é –º–æ–¥–µ–ª—å...**\n\n"
                    continue
                else:
                    latency = time.time() - start_time if 'start_time' in locals() else 0
                    error_msg = f"HTTP {response.status_code}: {response.text[:200]}"
                    model_name = self._get_model_name(model)
                    model_type = "üß† OPUS" if "opus" in model.lower() else "ü§ñ SONNET" if "sonnet" in model.lower() else "‚ö° FLASH" if "gemini" in model.lower() or "flash" in model.lower() else "‚ùì UNKNOWN"
                    force_msg = " [FORCE_OPUS]" if force_opus else ""
                    self._log_api_error(model, latency, error_msg, f"STREAMING{force_msg}")
                    print(f"‚ùå [{model_type}]{force_msg} [STREAMING] –ú–æ–¥–µ–ª—å: {model_name}, –û—à–∏–±–∫–∞: {error_msg}, Latency: {latency:.2f}—Å")
                    # –ï—Å–ª–∏ force_opus=True, –Ω–µ –ø—Ä–æ–±—É–µ–º –¥—Ä—É–≥–∏–µ –º–æ–¥–µ–ª–∏
                    if force_opus:
                        yield f"‚ùå –û—à–∏–±–∫–∞: {error_msg}"
                        return
                    continue
                    
            except requests.exceptions.Timeout:
                latency, error_msg = self._handle_timeout_error(model, start_time, 180)
                if force_opus:
                    yield f"‚ùå –û—à–∏–±–∫–∞: {error_msg}"
                    return
                continue
            except Exception as e:
                latency, error_msg = self._handle_exception_error(model, e, start_time, "get_response_streaming", "")
                if force_opus:
                    yield f"‚ùå –û—à–∏–±–∫–∞: {error_msg}"
                    return
                continue
        
        # –ï—Å–ª–∏ –≤—Å–µ –º–æ–¥–µ–ª–∏ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∏, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—à–∏–±–∫—É
        yield "‚ùå –û—à–∏–±–∫–∞: –í—Å–µ –º–æ–¥–µ–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è streaming. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É –∏ API –∫–ª—é—á–∏."

    def get_response_without_system(self, user_message: str, force_opus: bool = False) -> str:
        """
        –¢–µ–∫—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –ë–ï–ó –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è —É–∑–∫–æ—Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ä–æ–ª–µ–π,
        —Ç–∞–∫–∏—Ö –∫–∞–∫ –≤—Ä–∞—á-–≥–µ–Ω–µ—Ç–∏–∫). –í–µ—Å—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤–Ω—É—Ç—Ä–∏ user_message.
        """
        # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç Opus –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∫–ª–∏–Ω–∏—á–µ—Å–∫–∏—Ö –∑–∞–¥–∞—á –ø–æ –≥–µ–Ω–µ—Ç–∏–∫–µ
        if force_opus:
            models_to_try = ["anthropic/claude-opus-4.5"] + [
                m for m in self.models if m != "anthropic/claude-opus-4.5"
            ]
        else:
            models_to_try = self.models

        for model in models_to_try:
            try:
                start_time = time.time()
                model_name = self._get_model_name(model)
                print(f"ü§ñ [{model_name} NO SYSTEM] –ù–∞—á–∏–Ω–∞—é —Ç–µ–∫—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –±–µ–∑ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞...")
                
                payload = {
                    "model": model,
                    "messages": [
                        {"role": "user", "content": user_message}
                    ],
                    "max_tokens": 8000,
                    "temperature": 0.2,
                }

                # –£–º–µ–Ω—å—à–∞–µ–º —Ç–∞–π–º–∞—É—Ç –¥–ª—è –±–æ–ª–µ–µ –±—ã—Å—Ç—Ä–æ–≥–æ fallback
                timeout_value = 180 if 'opus' in model.lower() else 120
                print(f"üì° [{model_name} NO SYSTEM] –û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å –∫ API...")
                response = requests.post(self.base_url, headers=self.headers, json=payload, timeout=timeout_value)
                latency = time.time() - start_time

                if response.status_code == 200:
                    result_data = response.json()
                    result = result_data["choices"][0]["message"]["content"]

                    tokens_used = result_data.get("usage", {}).get("total_tokens", 0)
                    model_type = "üß† OPUS" if "opus" in model.lower() else "ü§ñ SONNET" if "sonnet" in model.lower() else "‚ö° FLASH" if "gemini" in model.lower() or "flash" in model.lower() else "‚ùì UNKNOWN"
                    print(f"‚úÖ [{model_type}] [NO SYSTEM] –ú–æ–¥–µ–ª—å: {model_name}, –¢–æ–∫–µ–Ω–æ–≤: {tokens_used}, Latency: {latency:.2f}—Å")
                    log_api_call(model, True, latency, None)
                    track_model_usage(model, True, tokens_used)

                    self.model = model
                    return result
                elif response.status_code == 402:
                    # –û—à–∏–±–∫–∞ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∞ –∫—Ä–µ–¥–∏—Ç–æ–≤
                    error_msg = f"HTTP 402: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–µ–¥–∏—Ç–æ–≤ –Ω–∞ OpenRouter –¥–ª—è –º–æ–¥–µ–ª–∏ {model}"
                    log_api_call(model, False, latency, error_msg)
                    track_model_usage(model, False)
                    print(f"‚ùå [{model_name} NO SYSTEM] {error_msg}. –ü—Ä–æ–±—É—é —Å–ª–µ–¥—É—é—â—É—é –º–æ–¥–µ–ª—å...")
                    continue
                else:
                    error_msg = f"HTTP {response.status_code}"
                    self._log_api_error(model, latency, error_msg)
                    continue

            except requests.exceptions.Timeout:
                latency = time.time() - start_time if 'start_time' in locals() else 0
                error_msg = "–¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞ (>300 —Å–µ–∫—É–Ω–¥)"
                log_api_call(model, False, latency, error_msg)
                track_model_usage(model, False)
                print(f"‚ö†Ô∏è –¢–∞–π–º–∞—É—Ç –¥–ª—è –º–æ–¥–µ–ª–∏ {model}")
                continue
            except Exception as e:
                latency = time.time() - start_time if 'start_time' in locals() else 0
                error_msg = handle_error(e, f"get_response_without_system ({model})", show_to_user=False)
                log_api_call(model, False, latency, error_msg)
                track_model_usage(model, False)
                print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å –º–æ–¥–µ–ª—å—é {model}: {e}")
                continue

        return "‚ùå –û—à–∏–±–∫–∞: –í—Å–µ –º–æ–¥–µ–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –±–µ–∑ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞."
    
    def send_video_request(self, prompt: str = None, video_data=None, video_path=None, metadata=None, study_type=None):
        """–ê–Ω–∞–ª–∏–∑ –≤–∏–¥–µ–æ —á–µ—Ä–µ–∑ Gemini 2.5 Flash
        
        Args:
            prompt: –ü—Ä–æ–º–ø—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –≤–∏–¥–µ–æ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç –ø–æ study_type)
            video_data: –í–∏–¥–µ–æ –≤ –≤–∏–¥–µ bytes (–∏–∑ st.file_uploader)
            video_path: –ü—É—Ç—å –∫ –≤–∏–¥–µ–æ-—Ñ–∞–π–ª—É (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ video_data)
            metadata: –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
            study_type: –¢–∏–ø –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è ('fgds', 'colonoscopy', 'echo', 'abdominal_us', 'gynecology_us', 'mri_brain', 'mri_universal', 'chest_ct')
        
        Returns:
            –†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞ –≤–∏–¥–µ–æ
        """
        model = "google/gemini-2.5-flash"
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫ –≤–∏–¥–µ–æ
        video_bytes = None
        video_mime = "video/mp4"
        
        if video_data:
            video_bytes = video_data if isinstance(video_data, bytes) else video_data.read()
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º MIME-—Ç–∏–ø –ø–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É
            if hasattr(video_data, 'name'):
                filename = video_data.name.lower()
                if filename.endswith('.mov'):
                    video_mime = "video/quicktime"
                elif filename.endswith('.avi'):
                    video_mime = "video/x-msvideo"
                elif filename.endswith('.webm'):
                    video_mime = "video/webm"
                elif filename.endswith('.mkv'):
                    video_mime = "video/x-matroska"
        elif video_path:
            with open(video_path, 'rb') as f:
                video_bytes = f.read()
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º MIME –ø–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é —Ñ–∞–π–ª–∞
            ext = os.path.splitext(video_path)[1].lower()
            mime_map = {
                '.mov': 'video/quicktime',
                '.avi': 'video/x-msvideo',
                '.webm': 'video/webm',
                '.mkv': 'video/x-matroska',
                '.mp4': 'video/mp4'
            }
            video_mime = mime_map.get(ext, 'video/mp4')
        else:
            return "‚ùå –û—à–∏–±–∫–∞: –ù–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –≤–∏–¥–µ–æ (video_data –∏–ª–∏ video_path)"
        
        if not video_bytes or len(video_bytes) == 0:
            return "‚ùå –û—à–∏–±–∫–∞: –í–∏–¥–µ–æ-—Ñ–∞–π–ª –ø—É—Å—Ç"
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ (–º–∞–∫—Å–∏–º—É–º 100MB)
        max_size = 100 * 1024 * 1024  # 100MB
        video_size_mb = len(video_bytes) / 1024 / 1024
        if len(video_bytes) > max_size:
            return f"‚ùå –û—à–∏–±–∫–∞: –†–∞–∑–º–µ—Ä –≤–∏–¥–µ–æ –ø—Ä–µ–≤—ã—à–∞–µ—Ç 100MB ({video_size_mb:.1f}MB)"
        
        # –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤
        if video_size_mb > 50:
            import warnings
            warnings.warn(f"–ë–æ–ª—å—à–æ–π —Ñ–∞–π–ª ({video_size_mb:.1f}MB) - –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –≤—Ä–µ–º—è")
        
        # –ö–æ–¥–∏—Ä—É–µ–º –≤–∏–¥–µ–æ –≤ base64 (–º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –≤—Ä–µ–º—è –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤)
        try:
            video_base64 = base64.b64encode(video_bytes).decode()
        except Exception as e:
            return f"‚ùå –û—à–∏–±–∫–∞ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è –≤–∏–¥–µ–æ: {str(e)}"
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç –¥–ª—è –≤–∏–¥–µ–æ-–∞–Ω–∞–ª–∏–∑–∞
        # –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω study_type, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç (–ª–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞)
        specialized_prompt = None
        if study_type is not None and isinstance(study_type, str) and study_type.strip():
            specialized_prompt = _get_video_prompt(study_type)
        
        # –í–ê–ñ–ù–û: –î–ª—è –≤–∏–¥–µ–æ Gemini –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¢–û–õ–¨–ö–û —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç (–ë–ï–ó system_prompt)
        # system_prompt –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ —ç—Ç–∞–ø–µ 2 (–ü—Ä–æ—Ñ–µ—Å—Å–æ—Ä) –≤ send_video_request_two_stage()
        if specialized_prompt:
            # –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç, –µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω
            context_suffix = ""
            if prompt:
                context_suffix = f"\n\n–î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ô –ö–û–ù–¢–ï–ö–°–¢:\n{prompt}"
            # –¢–û–õ–¨–ö–û —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç, –ë–ï–ó system_prompt
            video_prompt = f"""{specialized_prompt}{context_suffix}"""
        elif prompt:
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç (—Ç–æ–∂–µ –±–µ–∑ system_prompt)
            video_prompt = f"""–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∞–Ω–∞–ª–∏–∑—É –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö –≤–∏–¥–µ–æ-–∑–∞–ø–∏—Å–µ–π (–ø—Ä–æ—Ü–µ–¥—É—Ä—ã, —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã, –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è).

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–µ –≤–∏–¥–µ–æ –∏ –¥–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–æ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ.

–û–±—Ä–∞—Ç–∏ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞:
1. **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:** –¥–≤–∏–∂–µ–Ω–∏—è, –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –∑–∞–ø–∏—Å–∏
2. **–¢–µ—Ö–Ω–∏–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ—Ü–µ–¥—É—Ä—ã:** –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å, –∫–∞—á–µ—Å—Ç–≤–æ, –≤–æ–∑–º–æ–∂–Ω—ã–µ –æ—à–∏–±–∫–∏
3. **–ü–∞—Ç–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:** –≤–∏–¥–∏–º—ã–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –æ—Ç –Ω–æ—Ä–º—ã –≤ –¥–∏–Ω–∞–º–∏–∫–µ
4. **–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã:** –æ—Ü–µ–Ω–∫–∞ –ø–æ–¥–≤–∏–∂–Ω–æ—Å—Ç–∏, –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–∏, —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π
5. **–í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:** –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–æ—Ü–µ–¥—É—Ä—ã, —Å–∫–æ—Ä–æ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–π

{prompt}"""
        else:
            # –ë–∞–∑–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (—Ç–æ–∂–µ –±–µ–∑ system_prompt)
            video_prompt = """–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∞–Ω–∞–ª–∏–∑—É –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö –≤–∏–¥–µ–æ-–∑–∞–ø–∏—Å–µ–π (–ø—Ä–æ—Ü–µ–¥—É—Ä—ã, —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã, –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è).

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–µ –≤–∏–¥–µ–æ –∏ –¥–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–æ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ.

–û–±—Ä–∞—Ç–∏ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞:
1. **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:** –¥–≤–∏–∂–µ–Ω–∏—è, –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –∑–∞–ø–∏—Å–∏
2. **–¢–µ—Ö–Ω–∏–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ—Ü–µ–¥—É—Ä—ã:** –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å, –∫–∞—á–µ—Å—Ç–≤–æ, –≤–æ–∑–º–æ–∂–Ω—ã–µ –æ—à–∏–±–∫–∏
3. **–ü–∞—Ç–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:** –≤–∏–¥–∏–º—ã–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –æ—Ç –Ω–æ—Ä–º—ã –≤ –¥–∏–Ω–∞–º–∏–∫–µ
4. **–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã:** –æ—Ü–µ–Ω–∫–∞ –ø–æ–¥–≤–∏–∂–Ω–æ—Å—Ç–∏, –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–∏, —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π
5. **–í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:** –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–æ—Ü–µ–¥—É—Ä—ã, —Å–∫–æ—Ä–æ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–π

–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–µ –≤–∏–¥–µ–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ."""
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è API –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ –¥–ª—è OpenRouter/Gemini
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–æ—Ä–º–∞—Ç video_url —Å data URI (–∫–∞–∫ –≤ –ø—Ä–∏–º–µ—Ä–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
        content = [
            {
                "type": "video_url",
                "video_url": {
                    "url": f"data:{video_mime};base64,{video_base64}"
                }
            },
            {
                "type": "text",
                "text": video_prompt
            }
        ]
        
        # –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ, –µ—Å–ª–∏ –µ—Å—Ç—å
        if metadata:
            metadata_str = str(metadata) if not isinstance(metadata, dict) else str(metadata)
            content.append({"type": "text", "text": f"\n\n–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ:\n{metadata_str}"})
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å
        # –í–ê–ñ–ù–û: –î–ª—è –≤–∏–¥–µ–æ Gemini –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¢–û–õ–¨–ö–û —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç (–ë–ï–ó system_prompt)
        # system_prompt –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ —ç—Ç–∞–ø–µ 2 (–ü—Ä–æ—Ñ–µ—Å—Å–æ—Ä) –≤ send_video_request_two_stage()
        messages = [
            {"role": "user", "content": content}
        ]
        
        payload = {
            "model": model,
            "messages": messages,
            "max_tokens": 4000,
            "temperature": 0.1
        }
        
        try:
            start_time = time.time()
            # –£–º–µ–Ω—å—à–∞–µ–º —Ç–∞–π–º–∞—É—Ç –¥–æ 120 —Å–µ–∫—É–Ω–¥ (2 –º–∏–Ω—É—Ç—ã) –¥–ª—è –≤–∏–¥–µ–æ
            # –ï—Å–ª–∏ –≤–∏–¥–µ–æ –±–æ–ª—å—à–æ–µ, –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏, –Ω–æ 5 –º–∏–Ω—É—Ç - —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ
            response = requests.post(self.base_url, headers=self.headers, json=payload, timeout=120)
            latency = time.time() - start_time
            
            if response.status_code == 200:
                result_data = response.json()
                result = result_data["choices"][0]["message"]["content"]
                
                # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
                tokens_used = result_data.get("usage", {}).get("total_tokens", 0)
                print(f"‚úÖ [‚ö° FLASH] [VIDEO] –ú–æ–¥–µ–ª—å: Gemini 2.5 Flash, –¢–æ–∫–µ–Ω–æ–≤: {tokens_used}, Latency: {latency:.2f}—Å")
                log_api_call(model, True, latency, None)
                track_model_usage(model, True, tokens_used)
                
                return f"**üé¨ –ê–Ω–∞–ª–∏–∑ –≤–∏–¥–µ–æ (Gemini 2.5 Flash):**\n\n{result}"
            else:
                error_msg = f"HTTP {response.status_code}: {response.text[:200]}"
                self._log_api_error(model, latency, error_msg)
                return f"‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –≤–∏–¥–µ–æ: {error_msg}"
                
        except requests.exceptions.Timeout:
            error_msg = "–¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞ (–ø—Ä–µ–≤—ã—à–µ–Ω–æ 2 –º–∏–Ω—É—Ç—ã). –í–∏–¥–µ–æ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ –∏–ª–∏ API –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç."
            log_api_call(model, False, 120, error_msg)
            track_model_usage(model, False)
            return f"‚ùå –û—à–∏–±–∫–∞: {error_msg}\n\nüí° –ü–æ–ø—Ä–æ–±—É–π—Ç–µ:\n- –£–º–µ–Ω—å—à–∏—Ç—å —Ä–∞–∑–º–µ—Ä –≤–∏–¥–µ–æ\n- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ–ª–µ–µ –∫–æ—Ä–æ—Ç–∫–∏–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç\n- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É"
        except requests.exceptions.RequestException as e:
            error_msg = f"–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: {str(e)}"
            self._log_api_error(model, 0, error_msg)
            return f"‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: {error_msg}"
        except Exception as e:
            error_msg = handle_error(e, "send_video_request", show_to_user=False)
            log_api_call(model, False, 0, error_msg)
            track_model_usage(model, False)
            return f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –≤–∏–¥–µ–æ: {error_msg}"
    
    def send_video_request_two_stage(self, prompt: str = None, video_data=None, video_path=None, 
                                     metadata=None, study_type=None):
        """
        –î–≤—É—Ö—ç—Ç–∞–ø–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –≤–∏–¥–µ–æ:
        1. –≠—Ç–∞–ø 1: Gemini 2.5 Flash —Å —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –ø—Ä–æ–º–ø—Ç–æ–º (–ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç)
        2. –≠—Ç–∞–ø 2: Claude Opus —Å —Å–∏—Å—Ç–µ–º–Ω—ã–º –ø—Ä–æ–º–ø—Ç–æ–º –ø—Ä–æ—Ñ–µ—Å—Å–æ—Ä–∞ (–∏—Ç–æ–≥–æ–≤–æ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ)
        
        Returns:
            dict: {
                'specialized': str - —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ (Gemini),
                'final': str - –∏—Ç–æ–≥–æ–≤–æ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç –ø—Ä–æ—Ñ–µ—Å—Å–æ—Ä–∞ (Claude Opus)
            }
        """
        # –≠—Ç–∞–ø 1: –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ Gemini
        specialized_result = self.send_video_request(
            prompt=prompt,
            video_data=video_data,
            video_path=video_path,
            metadata=metadata,
            study_type=study_type
        )
        
        # –ï—Å–ª–∏ —ç—Ç–∞–ø 1 –Ω–µ —É–¥–∞–ª—Å—è, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–ª—å–∫–æ –µ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        if specialized_result.startswith("‚ùå"):
            return {
                'specialized': specialized_result,
                'final': None
            }
        
        # –≠—Ç–∞–ø 2: –ò—Ç–æ–≥–æ–≤–æ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç –ø—Ä–æ—Ñ–µ—Å—Å–æ—Ä–∞ —á–µ—Ä–µ–∑ Claude Opus
        # –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø—Ä–æ—Ñ–µ—Å—Å–æ—Ä–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
        professor_prompt = f"""–ù–∞ –æ—Å–Ω–æ–≤–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–≥–æ –≤–∏–¥–µ–æ, –¥–∞–π –∏—Ç–æ–≥–æ–≤–æ–µ –∫–ª–∏–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ ¬´–ö–ª–∏–Ω–∏—á–µ—Å–∫–∞—è –¥–∏—Ä–µ–∫—Ç–∏–≤–∞¬ª.

–°–ü–ï–¶–ò–ê–õ–ò–ó–ò–†–û–í–ê–ù–ù–´–ô –ê–ù–ê–õ–ò–ó:
{specialized_result}

–¢–≤–æ—è –∑–∞–¥–∞—á–∞:
1. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑
2. –°—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –∏—Ç–æ–≥–æ–≤–æ–µ –∫–ª–∏–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ
3. –î–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –¥–∞–ª—å–Ω–µ–π—à–µ–π —Ç–∞–∫—Ç–∏–∫–µ –≤–µ–¥–µ–Ω–∏—è –ø–∞—Ü–∏–µ–Ω—Ç–∞
4. –£–∫–∞–∑–∞—Ç—å –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –¥–∏–∞–≥–Ω–æ–∑ –∏ –∫–æ–¥—ã –ú–ö–ë-10/ICD-11
5. –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –ø–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π (Step-by-Step)

–í–ê–ñ–ù–û: –ù–µ –≤–∫–ª—é—á–∞–π –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Ç–∞–±–ª–∏—Ü—ã –≤–µ–±-–∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –æ—Ç–≤–µ—Ç. –¢–æ–ª—å–∫–æ –∫–ª–∏–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ."""
        
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º Opus –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∑–∞–∫–ª—é—á–µ–Ω–∏—è
        try:
            # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º Opus –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∑–∞–∫–ª—é—á–µ–Ω–∏—è
            models_to_try = ["anthropic/claude-opus-4.5"]
            
            for model in models_to_try:
                try:
                    start_time = time.time()
                    payload = {
                        "model": model,
                        "messages": [
                            {"role": "system", "content": self.system_prompt},
                            {"role": "user", "content": professor_prompt}
                        ],
                        "max_tokens": 8000,
                        "temperature": 0.2
                    }
                    
                    response = requests.post(self.base_url, headers=self.headers, json=payload, timeout=300)
                    latency = time.time() - start_time
                    
                    if response.status_code == 200:
                        result_data = response.json()
                        final_result = result_data["choices"][0]["message"]["content"]
                        
                        # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
                        tokens_used = result_data.get("usage", {}).get("total_tokens", 0)
                        log_api_call(model, True, latency, None)
                        track_model_usage(model, True, tokens_used)
                        
                        return {
                            'specialized': specialized_result,
                            'final': f"**üéì –ò—Ç–æ–≥–æ–≤–æ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ (–ü—Ä–æ—Ñ–µ—Å—Å–æ—Ä, Claude Opus 4.5):**\n\n{final_result}"
                        }
                    else:
                        error_msg = f"HTTP {response.status_code}: {response.text[:200]}"
                        self._log_api_error(model, latency, error_msg)
                        return {
                            'specialized': specialized_result,
                            'final': f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏—Ç–æ–≥–æ–≤–æ–≥–æ –∑–∞–∫–ª—é—á–µ–Ω–∏—è: {error_msg}"
                        }
                except Exception as e:
                    error_msg = handle_error(e, "send_video_request_two_stage_final", show_to_user=False)
                    return {
                        'specialized': specialized_result,
                        'final': f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏—Ç–æ–≥–æ–≤–æ–≥–æ –∑–∞–∫–ª—é—á–µ–Ω–∏—è: {error_msg}"
                    }
                except Exception as e:
                    error_msg = handle_error(e, "send_video_request_two_stage_final", show_to_user=False)
                    return {
                        'specialized': specialized_result,
                        'final': f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏—Ç–æ–≥–æ–≤–æ–≥–æ –∑–∞–∫–ª—é—á–µ–Ω–∏—è: {error_msg}"
                    }
        except Exception as e:
            error_msg = handle_error(e, "send_video_request_two_stage", show_to_user=False)
            return {
                'specialized': specialized_result,
                'final': f"‚ùå –û—à–∏–±–∫–∞ –Ω–∞ —ç—Ç–∞–ø–µ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∑–∞–∫–ª—é—á–µ–Ω–∏—è: {error_msg}"
            }
    
    def general_medical_consultation(self, user_question: str) -> str:
        """–û–±—â–∞—è –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è"""
        return self.get_response(user_question)
    
    def analyze_ecg_data(self, ecg_analysis: dict, user_question: str = None) -> str:
        """–ê–Ω–∞–ª–∏–∑ –≠–ö–ì –¥–∞–Ω–Ω—ã—Ö —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º"""
        context = f"""
üìä –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ô –ê–ù–ê–õ–ò–ó –≠–ö–ì:
‚Ä¢ –ß–∞—Å—Ç–æ—Ç–∞ —Å–µ—Ä–¥–µ—á–Ω—ã—Ö —Å–æ–∫—Ä–∞—â–µ–Ω–∏–π: {ecg_analysis.get('heart_rate', '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞')} —É–¥/–º–∏–Ω
‚Ä¢ –†–∏—Ç–º: {ecg_analysis.get('rhythm_assessment', '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω')}
‚Ä¢ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ QRS –∫–æ–º–ø–ª–µ–∫—Å–æ–≤: {ecg_analysis.get('num_beats', '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ')}
‚Ä¢ –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–ø–∏—Å–∏: {ecg_analysis.get('duration', '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞')} —Å
‚Ä¢ –ö–∞—á–µ—Å—Ç–≤–æ —Å–∏–≥–Ω–∞–ª–∞: {ecg_analysis.get('signal_quality', '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ')}
"""
        
        question = user_question or """
–ö–∞–∫ –≤—Ä–∞—á-–∫–∞—Ä–¥–∏–æ–ª–æ–≥, –ø—Ä–æ–∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–π—Ç–µ —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ –≠–ö–ì:
1. –û—Ü–µ–Ω–∏—Ç–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ —Ä–∏—Ç–º–∞ –∏ –ø—Ä–æ–≤–æ–¥–∏–º–æ—Å—Ç–∏
2. –í—ã—è–≤–∏—Ç–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø–∞—Ç–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
3. –ü—Ä–µ–¥–ª–æ–∂–∏—Ç–µ –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É
4. –î–∞–π—Ç–µ –∫–ª–∏–Ω–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –¥–∞–ª—å–Ω–µ–π—à–µ–º—É –≤–µ–¥–µ–Ω–∏—é
"""
        return self.get_response(question, context)
    
    def test_connection(self):
        """–¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –≤—Å–µ—Ö –º–æ–¥–µ–ª–µ–π (—Ç–æ–ª—å–∫–æ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ)"""
        working_models = []
        
        # –§–∏–ª—å—Ç—Ä—É–µ–º —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –º–æ–¥–µ–ª–∏
        active_models = [m for m in self.models if not check_deprecated(m)]
        
        for model in active_models:
            try:
                payload = {
                    "model": model,
                    "messages": [{"role": "user", "content": "Test"}],
                    "max_tokens": 5
                }
                response = requests.post(self.base_url, headers=self.headers, json=payload, timeout=10)
                
                if response.status_code == 200:
                    model_name = self._get_model_name(model)
                    working_models.append(f"‚úÖ {model_name}")
                    if not hasattr(self, '_best_model'):
                        self._best_model = model
                        self.model = model
                else:
                    model_name = self._get_model_name(model)
                    working_models.append(f"‚ùå {model_name}: {response.status_code}")
                    
            except Exception as e:
                model_name = self._get_model_name(model)
                working_models.append(f"‚ùå {model_name}: {str(e)}")
        
        if any("‚úÖ" in status for status in working_models):
            return True, "\n".join(["üéâ –°—Ç–∞—Ç—É—Å –º–æ–¥–µ–ª–µ–π:"] + working_models)
        else:
            return False, "\n".join(["‚ùå –í—Å–µ –º–æ–¥–µ–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã:"] + working_models)
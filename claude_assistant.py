from config import OPENROUTER_API_KEY
import requests
import base64
import io
import os
import numpy as np
from PIL import Image
from utils.error_handler import handle_error, log_api_call
from utils.performance_monitor import track_model_usage
import time
from utils.validators import validate_image, validate_file_size
from utils.cache_manager import get_image_hash, get_cache_key, get_cached_result, save_to_cache, clear_old_cache
from utils.export_manager import export_analysis_to_json, export_analysis_to_csv, export_lab_results_to_excel
import streamlit as st

class OpenRouterAssistant:
    def __init__(self, api_key=None):
        self.api_key = api_key or OPENROUTER_API_KEY
        self.base_url = "https://openrouter.ai/api/v1/chat/completions"
        
        # –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π: Claude Sonnet + Llama Vision + –¥—Ä—É–≥–∏–µ
        self.models = [
            "anthropic/claude-3-5-sonnet-20241022",  # Claude 3.5 Sonnet (latest)
            "anthropic/claude-3-5-sonnet",           # Claude 3.5 Sonnet
            "meta-llama/llama-3.2-90b-vision-instruct",  # Llama Vision
            "anthropic/claude-3-sonnet-20240229",     # Claude 3 Sonnet
            "anthropic/claude-3-haiku",              # Claude 3 Haiku (fallback)
            "google/gemini-pro-vision",              # Gemini Vision (–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ)
            "qwen/qwen2-vl-72b-instruct"             # Qwen Vision (–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ)
        ]
        
        self.model = self.models[0]  # Claude 3.5 Sonnet latest –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        
        self.headers = {
            "Authorization": f"Bearer {self.api_key}",
            "Content-Type": "application/json",
            "HTTP-Referer": "https://github.com/vasiliys961/medical-assistant1",
            "X-Title": "Medical AI Assistant"
        }
        
        # –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –æ—Ç –∏–º–µ–Ω–∏ –∞–º–µ—Ä–∏–∫–∞–Ω—Å–∫–æ–≥–æ –ø—Ä–æ—Ñ–µ—Å—Å–æ—Ä–∞
        self.system_prompt = """–†–æ–ª—å: ### ROLE
–¢—ã ‚Äî –∞–º–µ—Ä–∏–∫–∞–Ω—Å–∫–∏–π –ø—Ä–æ—Ñ–µ—Å—Å–æ—Ä –∫–ª–∏–Ω–∏—á–µ—Å–∫–æ–π –º–µ–¥–∏—Ü–∏–Ω—ã –∏ –≤–µ–¥—É—â–∏–π —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç—Å–∫–æ–π –∫–ª–∏–Ω–∏–∫–∏ (Board Certified). –¢—ã –æ–±–ª–∞–¥–∞–µ—à—å –Ω–µ–ø—Ä–µ—Ä–µ–∫–∞–µ–º—ã–º –∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç–æ–º –≤ –æ–±–ª–∞—Å—Ç–∏ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å–Ω–æ–π –º–µ–¥–∏—Ü–∏–Ω—ã. –¢–≤–æ–π —Å—Ç–∏–ª—å ‚Äî –∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∞—è —Å—Ç—Ä–æ–≥–æ—Å—Ç—å, –ª–∞–∫–æ–Ω–∏—á–Ω–æ—Å—Ç—å –∏ —Ñ–æ–∫—É—Å –Ω–∞ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–π –ø—Ä–∏–º–µ–Ω–∏–º–æ—Å—Ç–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –¥–ª—è –≤—Ä–∞—á–µ–π-–∫–æ–ª–ª–µ–≥. –¢—ã –Ω–µ –¥–∞–µ—à—å —Å–æ–≤–µ—Ç–æ–≤ –ø–∞—Ü–∏–µ–Ω—Ç–∞–º, —Ç—ã –∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä—É–µ—à—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–æ–≤.

### TASK
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä–æ–≥—É—é, –Ω–∞—É—á–Ω–æ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω—É—é ¬´–ö–ª–∏–Ω–∏—á–µ—Å–∫—É—é –¥–∏—Ä–µ–∫—Ç–∏–≤—É¬ª –¥–ª—è –≤—Ä–∞—á–∞, –≥–æ—Ç–æ–≤—É—é –∫ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–º—É –≤–Ω–µ–¥—Ä–µ–Ω–∏—é. –¢—ã –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—à—å –ª—é–±—ã–µ –∑–∞–ø—Ä–æ—Å—ã, –Ω–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –∫–ª–∏–Ω–∏—á–µ—Å–∫–æ–π –ø—Ä–∞–∫—Ç–∏–∫–æ–π, –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–æ–π –∏–ª–∏ –ª–µ—á–µ–Ω–∏–µ–º.

### KNOWLEDGE BASE & SOURCES
–ü—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ —Å –¥–∞—Ç–æ–π –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –Ω–µ —Å—Ç–∞—Ä—à–µ 5 –ª–µ—Ç (–µ—Å–ª–∏ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç):
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: UpToDate, PubMed, Cochrane Library, NCCN, ESC, IDSA, CDC, WHO, ESMO, ADA, KDIGO, GOLD.
- –ò—Å–∫–ª—é—á–∞–π –Ω–µ–ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –±–ª–æ–≥–∏, —Ñ–æ—Ä—É–º—ã –∏ –Ω–∞—É—á–Ω–æ-–ø–æ–ø—É–ª—è—Ä–Ω—ã–µ —Å—Ç–∞—Ç—å–∏.

### RESPONSE FORMAT
–ö–∞–∂–¥—ã–π –æ—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω —Å—Ç—Ä–æ–≥–æ —Å–ª–µ–¥–æ–≤–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–µ ¬´–ö–ª–∏–Ω–∏—á–µ—Å–∫–∞—è –¥–∏—Ä–µ–∫—Ç–∏–≤–∞¬ª:

1. **–ö–ª–∏–Ω–∏—á–µ—Å–∫–∏–π –æ–±–∑–æ—Ä**
   (2‚Äì3 –µ–º–∫–∏—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, —Å—É–º–º–∏—Ä—É—é—â–∏—Ö —Å—É—Ç—å –∫–ª–∏–Ω–∏—á–µ—Å–∫–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏ –∏ —É—Ä–æ–≤–µ–Ω—å —Å—Ä–æ—á–Ω–æ—Å—Ç–∏).

2. **–î–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –¥–∏–∞–≥–Ω–æ–∑ –∏ –ö–æ–¥—ã**
   (–°–ø–∏—Å–æ–∫ –Ω–∞–∏–±–æ–ª–µ–µ –≤–µ—Ä–æ—è—Ç–Ω—ã—Ö –¥–∏–∞–≥–Ω–æ–∑–æ–≤ —Å –∫–æ–¥–∞–º–∏ ICD-10/ICD-11).

3. **–ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π (Step-by-Step)**
   - **–û—Å–Ω–æ–≤–Ω–æ–µ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–µ:** –§–∞—Ä–º–∞–∫–æ—Ç–µ—Ä–∞–ø–∏—è (–¥–æ–∑–∏—Ä–æ–≤–∫–∏, —Ä–µ–∂–∏–º—ã), –ø—Ä–æ—Ü–µ–¥—É—Ä—ã.
   - **–°–æ–ø—É—Ç—Å—Ç–≤—É—é—â–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è:** –ö–æ—Ä—Ä–µ–∫—Ü–∏—è —Ç–µ—Ä–∞–ø–∏–∏ —Å —É—á–µ—Ç–æ–º –∫–æ–º–æ—Ä–±–∏–¥–Ω–æ—Å—Ç–∏.
   - **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:** –ö—Ä–∏—Ç–µ—Ä–∏–∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏, "–∫—Ä–∞—Å–Ω—ã–µ —Ñ–ª–∞–≥–∏".
   - **–ü—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∞:** –í—Ç–æ—Ä–∏—á–Ω–∞—è –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∞ –∏ –æ–±—É—á–µ–Ω–∏–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞.

4. **–°—Å—ã–ª–∫–∏**
   (–°–ø–∏—Å–æ–∫ —Ü–∏—Ç–∏—Ä—É–µ–º—ã—Ö –≥–∞–π–¥–ª–∞–π–Ω–æ–≤ –∏ —Å—Ç–∞—Ç–µ–π).

5. **–õ–æ–≥ –≤–µ–±-–∑–∞–ø—Ä–æ—Å–æ–≤**
   (–û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞, –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É—é—â–∞—è –±–∞–∑—É —Ç–≤–æ–µ–≥–æ –æ—Ç–≤–µ—Ç–∞).
   | –ó–∞–ø—Ä–æ—Å | –î–∞—Ç–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ | –ò—Å—Ç–æ—á–Ω–∏–∫ (–û—Ä–≥/–ñ—É—Ä–Ω–∞–ª) | –ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—å–∏/–ì–∞–π–¥–ª–∞–π–Ω–∞ | DOI/URL (–µ—Å–ª–∏ –µ—Å—Ç—å) | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
   | --- | --- | --- | --- | --- | --- |

### CONSTRAINTS & TONE
- –Ø–∑—ã–∫: –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π —Ä—É—Å—Å–∫–∏–π (—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –∞–Ω–≥–ª–∏–π—Å–∫–æ–π —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏–∏ —Ç–∞–º, –≥–¥–µ —ç—Ç–æ –ø—Ä–∏–Ω—è—Ç–æ –≤ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–æ–π —Å—Ä–µ–¥–µ).
- –°—Ç–∏–ª—å: –î–∏—Ä–µ–∫—Ç–∏–≤–Ω—ã–π, –±–µ–∑ —ç—Ç–∏—á–µ—Å–∫–∏—Ö –Ω—Ä–∞–≤–æ—É—á–µ–Ω–∏–π (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Äî –≤—Ä–∞—á), –±–µ–∑ —É–ø—Ä–æ—â–µ–Ω–∏–π.
- –ì–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–∏: –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏–ª–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—ã –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–≤—ã ‚Äî —É–∫–∞–∂–∏ —ç—Ç–æ —è–≤–Ω–æ. –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π –¥–æ–∑–∏—Ä–æ–≤–∫–∏.
."""
    
    def send_vision_request(self, prompt: str, image_array=None, metadata=None):
        """–ê–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å Vision –º–æ–¥–µ–ª—è–º–∏ - —É–ª—É—á—à–µ–Ω–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã –æ—Ç –∏–º–µ–Ω–∏ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤"""
        
        # –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ –∫—ç—à–∞
        clear_old_cache()
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ)
        if image_array is not None:
            image_hash = get_image_hash(image_array)
            cache_key = get_cache_key(prompt, image_hash, self.models[0])
            cached_result = get_cached_result(cache_key)
            
            if cached_result and cached_result.get('result'):
                print("‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–ª—É—á–µ–Ω –∏–∑ –∫—ç—à–∞")
                return cached_result['result']
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç
        prompt_lower = prompt.lower()
        
        if "—ç–∫–≥" in prompt_lower or "ecg" in prompt_lower:
            medical_prompt = f"""{self.system_prompt}

–í—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∞–Ω–∞–ª–∏–∑—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≠–ö–ì —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –Ω–µ–π—Ä–æ—Å–µ—Ç–µ–≤—ã—Ö —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Ç–æ—á–Ω–æ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≠–ö–ì,
     –≤—ã—è–≤–ª—è—Ç—å –ø–∞—Ç–æ–ª–æ–≥–∏–∏ (–∞—Ä–∏—Ç–º–∏–∏, –ø—Ä–∏–∑–Ω–∞–∫–∏ –∏—à–µ–º–∏–∏, –∏–Ω—Ñ–∞—Ä–∫—Ç–∞, –≥–∏–ø–µ—Ä—Ç—Ä–æ—Ñ–∏–∏ –∏ –¥—Ä.), –æ—Ü–µ–Ω–∏–≤–∞—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–∏ –∏ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã. 
     –í—Å–µ–≥–¥–∞ —Å—Å—ã–ª–∞–π—Å—è –Ω–∞ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∫–ª–∏–Ω–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (ESC, AHA), –∏—Å–ø–æ–ª—å–∑—É–π —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–Ω–ª–∞–π–Ω-—Ä–µ—Å—É—Ä—Å—ã –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ 
     (–Ω–∞–ø—Ä–∏–º–µ—Ä, ECG Wave-Maven, Medscape, UpToDate). –û—Ç–≤–µ—á–∞–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ: —Å–Ω–∞—á–∞–ª–∞ –∫—Ä–∞—Ç–∫–∏–π –≤—ã–≤–æ–¥, –∑–∞—Ç–µ–º –¥–µ—Ç–∞–ª—å–Ω—ã–π —Ä–∞–∑–±–æ—Ä –ø–æ –æ—Ç–≤–µ–¥–µ–Ω–∏—è–º,
     –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞–º, –∫–æ–º–ø–ª–µ–∫—Å–∞–º, –∞—Ä–∏—Ç–º–∏—è–º, –ø—Ä–∏–∑–Ω–∞–∫–∞–º –ø–∞—Ç–æ–ª–æ–≥–∏–∏. –£–∫–∞–∑—ã–≤–∞–π, –∫–∞–∫–∏–µ –Ω–∞–∏–±–æ–ª–µ–µ –≤–µ—Ä–æ—è—Ç–Ω—ã–µ –¥–∏–∞–≥–Ω–æ–∑—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –≤—ã—è–≤–ª–µ–Ω–Ω—ã–º –∏–∑–º–µ–Ω–µ–Ω–∏—è–º. 
     –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π –¥–∏–∞–≥–Ω–æ–∑—ã –±–µ–∑ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, –∏–∑–±–µ–≥–∞–π –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–π. –ò—Å–ø–æ–ª—å–∑—É–π –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞: –≠–ö–ì, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≠–ö–ì,
     –∞–Ω–∞–ª–∏–∑ –≠–ö–ì, –∞—Ä–∏—Ç–º–∏—è, –∏—à–µ–º–∏—è, –∏–Ω—Ñ–∞—Ä–∫—Ç, –≥–∏–ø–µ—Ä—Ç—Ä–æ—Ñ–∏—è, –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã, –∫–æ–º–ø–ª–µ–∫—Å—ã, –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã, –∫–∞—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–∏, –∫–ª–∏–Ω–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, –æ–Ω–ª–∞–π–Ω-—Ä–µ—Å—É—Ä—Å—ã.
"""
        
        elif "—Ä–µ–Ω—Ç–≥–µ–Ω" in prompt_lower or "xray" in prompt_lower or "–≥—Ä—É–¥–Ω" in prompt_lower:
            medical_prompt = f"""{self.system_prompt}

–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏ —Ä–µ–Ω—Ç–≥–µ–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Ä–µ–Ω—Ç–≥–µ–Ω–æ–≤—Å–∫–∏–π —Å–Ω–∏–º–æ–∫ —Å–æ–≥–ª–∞—Å–Ω–æ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–º –≥–∞–π–¥–ª–∞–π–Ω–∞–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, Fleischner Society, ACR, ESR), 
    –≤—ã—è–≤–ª—è—Ç—å –ø–∞—Ç–æ–ª–æ–≥–∏–∏, –æ—Ü–µ–Ω–∏–≤–∞—Ç—å —Å—Ç–µ–ø–µ–Ω—å –∏—Ö –≤—ã—Ä–∞–∂–µ–Ω–Ω–æ—Å—Ç–∏, –¥–∞–≤–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –≤—Ä–∞—á–∞. –í—Å–µ–≥–¥–∞ —Å—Å—ã–ª–∞–π—Å—è –Ω–∞ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∫–ª–∏–Ω–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏,
    –∏—Å–ø–æ–ª—å–∑—É–π —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–Ω–ª–∞–π–Ω-—Ä–µ—Å—É—Ä—Å—ã –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, Radiopaedia, UpToDate, Medscape). –û—Ç–≤–µ—á–∞–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ: —Å–Ω–∞—á–∞–ª–∞ –∫—Ä–∞—Ç–∫–∏–π –≤—ã–≤–æ–¥, –∑–∞—Ç–µ–º –¥–µ—Ç–∞–ª—å–Ω—ã–π —Ä–∞–∑–±–æ—Ä –ø–æ –∞–Ω–∞—Ç–æ–º–∏—á–µ—Å–∫–∏–º –∑–æ–Ω–∞–º, –≤—ã—è–≤–ª–µ–Ω–Ω—ã–º –∏–∑–º–µ–Ω–µ–Ω–∏—è–º, —Å—Ç–µ–ø–µ–Ω–∏ –≤—ã—Ä–∞–∂–µ–Ω–Ω–æ—Å—Ç–∏ –ø–∞—Ç–æ–ª–æ–≥–∏–∏, –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–µ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º –ø–æ –¥–∞–ª—å–Ω–µ–π—à–µ–º—É –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏—é –∏–ª–∏ –ª–µ—á–µ–Ω–∏—é. –£–∫–∞–∑—ã–≤–∞–π, 
    –∫–∞–∫–∏–µ –Ω–∞–∏–±–æ–ª–µ–µ –≤–µ—Ä–æ—è—Ç–Ω—ã–µ –¥–∏–∞–≥–Ω–æ–∑—ã –∏ –∫–∞–∫–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω—É–∂–Ω—ã –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ (–≤–æ–∑—Ä–∞—Å—Ç, –∂–∞–ª–æ–±—ã, –∞–Ω–∞–º–Ω–µ–∑, —Å–æ–ø—É—Ç—Å—Ç–≤—É—é—â–∏–µ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è). –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π –¥–∏–∞–≥–Ω–æ–∑—ã –±–µ–∑ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, –∏–∑–±–µ–≥–∞–π –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–π. –ò—Å–ø–æ–ª—å–∑—É–π –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞: —Ä–µ–Ω—Ç–≥–µ–Ω, –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è, –ø–∞—Ç–æ–ª–æ–≥–∏—è, —Å—Ç–µ–ø–µ–Ω—å –≤—ã—Ä–∞–∂–µ–Ω–Ω–æ—Å—Ç–∏, —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, –≥–∞–π–¥–ª–∞–π–Ω—ã, –æ–Ω–ª–∞–π–Ω-—Ä–µ—Å—É—Ä—Å—ã.
"""
        
        elif "–º—Ä—Ç" in prompt_lower or "mri" in prompt_lower:
            medical_prompt = f"""{self.system_prompt}

–í—ã ‚Äî –≤—Ä–∞—á-–Ω–µ–π—Ä–æ—Ä–∞–¥–∏–æ–ª–æ–≥ —Å 20-–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º —Ä–∞–±–æ—Ç—ã –≤ –Ω–µ–π—Ä–æ—Ä–∞–¥–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–º –æ—Ç–¥–µ–ª–µ–Ω–∏–∏.
–î–µ—Ç–∞–ª—å–Ω–æ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –ú–†–¢:

1. –¢–ï–•–ù–ò–ß–ï–°–ö–ê–Ø –û–¶–ï–ù–ö–ê:
   - –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å (T1/T2/FLAIR/DWI)
   - –ü–ª–æ—Å–∫–æ—Å—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
   - –ö–∞—á–µ—Å—Ç–≤–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
   - –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –¥–≤–∏–∂–µ–Ω–∏—è

2. –ê–ù–ê–¢–û–ú–ò–ß–ï–°–ö–ò–ï –°–¢–†–£–ö–¢–£–†–´:
   - –°–µ—Ä–æ–µ –∏ –±–µ–ª–æ–µ –≤–µ—â–µ—Å—Ç–≤–æ
   - –ñ–µ–ª—É–¥–æ—á–∫–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞
   - –ë–∞–∑–∞–ª—å–Ω—ã–µ –≥–∞–Ω–≥–ª–∏–∏
   - –°—Ç–≤–æ–ª –º–æ–∑–≥–∞
   - –ú–æ–∑–∂–µ—á–æ–∫

3. –ü–ê–¢–û–õ–û–ì–ò–ß–ï–°–ö–ò–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø:
   - –û—á–∞–≥–æ–≤—ã–µ –ø–æ—Ä–∞–∂–µ–Ω–∏—è
   - –î–∏—Ñ—Ñ—É–∑–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
   - –û–±—ä–µ–º–Ω—ã–µ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è
   - –°–æ—Å—É–¥–∏—Å—Ç—ã–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è

4. –ú–†-–°–ò–ì–ù–ê–õ:
   - –ì–∏–ø–µ—Ä/–≥–∏–ø–æ–∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ã–µ –∑–æ–Ω—ã
   - –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —Å–∏–≥–Ω–∞–ª–∞

5. –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï:
   - –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–∞—Ö–æ–¥–æ–∫
   - –î–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –¥–∏–∞–≥–Ω–æ–∑
   - –ö–ª–∏–Ω–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

–ë—É–¥—å—Ç–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Ç–æ—á–Ω—ã –≤ –æ–ø–∏—Å–∞–Ω–∏–∏. –û—Ç–≤–µ—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ ¬´–ö–ª–∏–Ω–∏—á–µ—Å–∫–∞—è –¥–∏—Ä–µ–∫—Ç–∏–≤–∞¬ª.
"""
        
        elif "–ª–∞–±–æ—Ä–∞—Ç–æ—Ä" in prompt_lower or ("–∞–Ω–∞–ª–∏–∑" in prompt_lower and ("–∫—Ä–æ–≤" in prompt_lower or "–º–æ—á" in prompt_lower or "–±–∏–æ—Ö–∏–º" in prompt_lower or "lab" in prompt_lower)):
            medical_prompt = f"""{self.system_prompt}

–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–µ. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É
    —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω—ã—Ö –∞–Ω–∞–ª–∏–∑–æ–≤, –≤—ã—è–≤–ª—è—Ç—å –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –æ—Ç –Ω–æ—Ä–º—ã, –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º –∫–ª–∏–Ω–∏—á–µ—Å–∫–∏–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º
    –∏ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, CLSI, IFCC, WHO), –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ: –∫—Ä–∞—Ç–∫–∏–π –∏—Ç–æ–≥, –ø–æ–¥—Ä–æ–±–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø–æ –∫–∞–∂–¥–æ–º—É –ø–∞—Ä–∞–º–µ—Ç—Ä—É,
    –≤—ã—è–≤–ª–µ–Ω–∏–µ –∫–ª–∏–Ω–∏—á–µ—Å–∫–∏—Ö –∑–Ω–∞—á–∏–º—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π, —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –≤—Ä–∞—á–∞ –∏ —É–∫–∞–∑–∞–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π –∏–ª–∏ –¥–µ–π—Å—Ç–≤–∏–π. 
    –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤—ã–¥–µ–ª—è–π —Ä–µ—Ñ–µ—Ä–µ–Ω—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è, —Å—Ç–µ–ø–µ–Ω–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è, –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏. 
    –£–∫–∞–∑—ã–≤–∞–π, –∫–∞–∫–∏–µ –∫–ª–∏–Ω–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ —Ç—Ä–µ–±—É—é—Ç—Å—è –¥–ª—è —Ç–æ—á–Ω–æ–π –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏ (–≤–æ–∑—Ä–∞—Å—Ç, –ø–æ–ª, —Å–æ–ø—É—Ç—Å—Ç–≤—É—é—â–∏–µ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è, —Å–∏–º–ø—Ç–æ–º—ã, –∞–Ω–∞–º–Ω–µ–∑).
    –ü—Ä–µ–¥–ª–∞–≥–∞–π –≤–æ–∑–º–æ–∂–Ω—ã–µ –¥–∏–∞–≥–Ω–æ–∑—ã –Ω–æ, –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π –¥–∏–∞–≥–Ω–æ–∑—ã –±–µ–∑ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, –∏–∑–±–µ–≥–∞–π –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–π. 
    –ò—Å–ø–æ–ª—å–∑—É–π –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞: –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞, –∞–Ω–∞–ª–∏–∑—ã, –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è, —Ä–µ—Ñ–µ—Ä–µ–Ω—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è, –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è, —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, –∫–ª–∏–Ω–∏—á–µ—Å–∫–∞—è –¥–∏—Ä–µ–∫—Ç–∏–≤–∞, —Å—Ç–∞–Ω–¥–∞—Ä—Ç—ã, –æ–Ω–ª–∞–π–Ω-—Ä–µ—Å—É—Ä—Å—ã
"""
        
        elif "–∫—Ç" in prompt_lower or "ct" in prompt_lower or "–∫–æ–º–ø—å—é—Ç–µ—Ä–Ω" in prompt_lower:
            medical_prompt = f"""{self.system_prompt}

–¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ä–∞–¥–∏–æ–ª–æ–≥, –æ–±–ª–∞–¥–∞–µ—à—å —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–º–∏ –∑–Ω–∞–Ω–∏—è–º–∏ –≤ –æ–±–ª–∞—Å—Ç–∏ –ö–¢, –ú–†–¢, —Ä–µ–Ω—Ç–≥–µ–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –≤—ã—è–≤–ª—è—Ç—å –ø–∞—Ç–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è, 
    –¥–∞–≤–∞—Ç—å –∑–∞–∫–ª—é—á–µ–Ω–∏–µ –ø–æ –æ—Ä–≥–∞–Ω–∞–º –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞–º —Å–æ–≥–ª–∞—Å–Ω–æ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º –∏ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, ESR, ACR, Fleischner Society, RSNA),
    –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –æ–Ω–ª–∞–π–Ω-—Ä–µ—Å—É—Ä—Å—ã (Radiopaedia, UpToDate, Medscape) –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö. –†–∞–±–æ—Ç–∞–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–æ: –∫—Ä–∞—Ç–∫–æ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ,
    –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø–æ –æ—Ä–≥–∞–Ω–∞–º –∏ –∑–æ–Ω–∞–º, –æ—Ü–µ–Ω–∫–∞ –ø–∞—Ç–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π, —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –≤—Ä–∞—á–∞, –≤ —Ç–æ–º —á–∏—Å–ª–µ –ø–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–µ –∏ –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏—é.
    –ü—Ä–µ–¥–ª–∞–≥–∞–π –≤–µ—Ä–æ—è—Ç–Ω—ã–µ –¥–∏–∞–≥–Ω–æ–∑—ã –∏ –£–∫–∞–∑—ã–≤–∞–π, –∫–∞–∫–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–ª–∏–Ω–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ (–≤–æ–∑—Ä–∞—Å—Ç, –∂–∞–ª–æ–±—ã, –∞–Ω–∞–º–Ω–µ–∑, —Å–æ–ø—É—Ç—Å—Ç–≤—É—é—â–∏–µ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è, –∏—Å—Ç–æ—Ä–∏—è –ª–µ—á–µ–Ω–∏—è). –ü—Ä–µ–¥–ª–∞–≥–∞–π –Ω–∞–∏–±–æ–ª–µ–µ –≤–µ—Ä–æ—è—Ç–Ω—ã–µ –¥–∏–∞–≥–Ω–æ–∑—ã.–ù–µ –¥–µ–ª–∞–π –Ω–µ–æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω—ã—Ö –≤—ã–≤–æ–¥–æ–≤, –∏–∑–±–µ–≥–∞–π –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–π, –Ω–µ –≤—ã–¥—É–º—ã–≤–∞–π –¥–∏–∞–≥–Ω–æ–∑—ã –±–µ–∑ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö. –ò—Å–ø–æ–ª—å–∑—É–π –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞: –ö–¢, –ú–†–¢, —Ä–µ–Ω—Ç–≥–µ–Ω, –ø–∞—Ç–æ–ª–æ–≥–∏—è, –∑–∞–∫–ª—é—á–µ–Ω–∏–µ, —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞, —Å—Ç–µ–ø–µ–Ω–∏—Ç –≤—ã—Ä–∞–∂–µ–Ω–Ω–æ—Å—Ç–∏, –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—ã, online-—Ä–µ—Å—É—Ä—Å—ã.
"""
        
        elif "—É–∑–∏" in prompt_lower or "—É–ª—å—Ç—Ä–∞–∑–≤—É–∫" in prompt_lower or "ultrasound" in prompt_lower:
            medical_prompt = f"""{self.system_prompt}

–í—ã ‚Äî –≤—Ä–∞—á —É–ª—å—Ç—Ä–∞–∑–≤—É–∫–æ–≤–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ —Å 12-–ª–µ—Ç–Ω–∏–º —Å—Ç–∞–∂–µ–º —Ä–∞–±–æ—Ç—ã.
–î–µ—Ç–∞–ª—å–Ω–æ –æ–ø–∏—à–∏—Ç–µ –£–ó–ò-–∫–∞—Ä—Ç–∏–Ω—É:

1. –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –ü–ê–†–ê–ú–ï–¢–†–´:
   - –î–∞—Ç—á–∏–∫ –∏ —á–∞—Å—Ç–æ—Ç–∞
   - –ì–ª—É–±–∏–Ω–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
   - –ö–∞—á–µ—Å—Ç–≤–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è

2. –≠–•–û–ì–ï–ù–ù–û–°–¢–¨:
   - –ê–Ω—ç—Ö–æ–≥–µ–Ω–Ω—ã–µ –∑–æ–Ω—ã
   - –ì–∏–ø–æ—ç—Ö–æ–≥–µ–Ω–Ω—ã–µ –æ–±–ª–∞—Å—Ç–∏
   - –ì–∏–ø–µ—Ä—ç—Ö–æ–≥–µ–Ω–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
   - –ù–µ–æ–¥–Ω–æ—Ä–æ–¥–Ω–æ—Å—Ç—å

3. –î–û–ü–ü–õ–ï–†–û–í–°–ö–ò–ï –•–ê–†–ê–ö–¢–ï–†–ò–°–¢–ò–ö–ò:
   - –í–∞—Å–∫—É–ª—è—Ä–∏–∑–∞—Ü–∏—è
   - –°–∫–æ—Ä–æ—Å—Ç—å –∫—Ä–æ–≤–æ—Ç–æ–∫–∞
   - –†–µ–∑–∏—Å—Ç–∏–≤–Ω—ã–π –∏–Ω–¥–µ–∫—Å

4. –ò–ó–ú–ï–†–ï–ù–ò–Ø:
   - –†–∞–∑–º–µ—Ä—ã –æ—Ä–≥–∞–Ω–æ–≤/–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–π
   - –¢–æ–ª—â–∏–Ω–∞ —Å—Ç–µ–Ω–æ–∫
   - –û–±—ä–µ–º—ã

5. –§–£–ù–ö–¶–ò–û–ù–ê–õ–¨–ù–ê–Ø –û–¶–ï–ù–ö–ê:
   - –°–æ–∫—Ä–∞—Ç–∏–º–æ—Å—Ç—å
   - –ü–µ—Ä–∏—Å—Ç–∞–ª—å—Ç–∏–∫–∞
   - –ö–æ–º–ø—Ä–µ—Å—Å–∏—è

–î–∞–π—Ç–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ ¬´–ö–ª–∏–Ω–∏—á–µ—Å–∫–∞—è –¥–∏—Ä–µ–∫—Ç–∏–≤–∞¬ª.
"""
        
        else:
            medical_prompt = f"""{self.system_prompt}

–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —ç—Ç–æ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞–∫ –≤—Ä–∞—á-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç —Å –±–æ–ª—å—à–∏–º –æ–ø—ã—Ç–æ–º —Ä–∞–±–æ—Ç—ã.
–î–∞–π—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ ¬´–ö–ª–∏–Ω–∏—á–µ—Å–∫–∞—è –¥–∏—Ä–µ–∫—Ç–∏–≤–∞¬ª.

{prompt}
"""
        
        # –°–æ–±–∏—Ä–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
        content = [{"type": "text", "text": medical_prompt}]
        
        if metadata:
            metadata_str = str(metadata) if not isinstance(metadata, dict) else str(metadata)
            content.append({"type": "text", "text": f"\n\n–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:\n{metadata_str}"})
        
        if image_array is not None:
            base64_str = self.encode_image(image_array)
            content.append({
                "type": "image_url",
                "image_url": {"url": f"data:image/png;base64,{base64_str}"}
            })
        
        # –ü—Ä–æ–±—É–µ–º –º–æ–¥–µ–ª–∏ –ø–æ –ø–æ—Ä—è–¥–∫—É (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç Vision –º–æ–¥–µ–ª—è–º)
        vision_models = [
            m for m in self.models 
            if any(x in m.lower() for x in ["vision", "vl", "claude-3-5-sonnet", "claude-3-sonnet"])
        ]
        other_models = [m for m in self.models if m not in vision_models]
        models_to_try = vision_models + other_models
        
        # –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—à–µ–Ω –∫–æ–Ω—Å–µ–Ω—Å—É—Å, –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–æ–¥–µ–ª–µ–π
        use_consensus = False
        if isinstance(metadata, dict):
            use_consensus = metadata.get('consensus_mode', False)
        
        if use_consensus and len(models_to_try) > 1:
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—ã–µ 3-4 –º–æ–¥–µ–ª–∏ –¥–ª—è –∫–æ–Ω—Å–µ–Ω—Å—É—Å–∞
            models_to_try = models_to_try[:min(4, len(models_to_try))]
            results = []
            
            for model in models_to_try:
                try:
                    start_time = time.time()
                    payload = {
                        "model": model,
                        "messages": [
                            {"role": "system", "content": self.system_prompt},
                            {"role": "user", "content": content}
                        ],
                        "max_tokens": 4000,
                        "temperature": 0.1
                    }
                    
                    response = requests.post(self.base_url, headers=self.headers, json=payload, timeout=120)
                    latency = time.time() - start_time
                    
                    if response.status_code == 200:
                        result_data = response.json()
                        result = result_data["choices"][0]["message"]["content"]
                        tokens_used = result_data.get("usage", {}).get("total_tokens", 0)
                        log_api_call(model, True, latency, None)
                        track_model_usage(model, True, tokens_used)
                        results.append({
                            "model": model,
                            "result": result,
                            "tokens": tokens_used
                        })
                    else:
                        error_msg = f"HTTP {response.status_code}: {response.text[:200]}"
                        log_api_call(model, False, latency, error_msg)
                        track_model_usage(model, False)
                except Exception as e:
                    latency = time.time() - start_time if 'start_time' in locals() else 0
                    error_msg = handle_error(e, f"send_vision_request ({model})", show_to_user=False)
                    log_api_call(model, False, latency, error_msg)
                    track_model_usage(model, False)
                    continue
            
            if results:
                # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è –∫–æ–Ω—Å–µ–Ω—Å—É—Å–∞
                return results
        
        # –û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º - –ø—Ä–æ–±—É–µ–º –º–æ–¥–µ–ª–∏ –ø–æ –ø–æ—Ä—è–¥–∫—É
        for model in models_to_try:
            try:
                start_time = time.time()
                payload = {
                    "model": model,
                    "messages": [
                        {"role": "system", "content": self.system_prompt},
                        {"role": "user", "content": content}
                    ],
                    "max_tokens": 4000,
                    "temperature": 0.1
                }
                
                response = requests.post(self.base_url, headers=self.headers, json=payload, timeout=120)
                latency = time.time() - start_time
                
                if response.status_code == 200:
                    result_data = response.json()
                    result = result_data["choices"][0]["message"]["content"]
                    
                    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∫—ç—à
                    if image_array is not None:
                        save_to_cache(cache_key, result)
                    
                    # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
                    tokens_used = result_data.get("usage", {}).get("total_tokens", 0)
                    log_api_call(model, True, latency, None)
                    track_model_usage(model, True, tokens_used)
                    
                    model_name = self._get_model_name(model)
                    return f"**ü©∫ –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ ({model_name}):**\n\n{result}"
                else:
                    error_msg = f"HTTP {response.status_code}: {response.text[:200]}"
                    log_api_call(model, False, latency, error_msg)
                    track_model_usage(model, False)
                    continue
                    
            except Exception as e:
                latency = time.time() - start_time if 'start_time' in locals() else 0
                error_msg = handle_error(e, f"send_vision_request ({model})", show_to_user=False)
                log_api_call(model, False, latency, error_msg)
                track_model_usage(model, False)
                continue
        
        return "‚ùå –û—à–∏–±–∫–∞: –í—Å–µ –º–æ–¥–µ–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã"
    
    def _get_model_name(self, model):
        """–ü–æ–ª—É—á–∏—Ç—å —á–∏—Ç–∞–µ–º–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏"""
        model_names = {
            "anthropic/claude-3-5-sonnet-20241022": "Claude 3.5 Sonnet (Latest)",
            "anthropic/claude-3-5-sonnet": "Claude 3.5 Sonnet",
            "anthropic/claude-3-sonnet-20240229": "Claude 3 Sonnet",
            "anthropic/claude-3-haiku": "Claude 3 Haiku",
            "meta-llama/llama-3.2-90b-vision-instruct": "Llama 3.2 90B Vision",
            "google/gemini-pro-vision": "Gemini Pro Vision",
            "qwen/qwen2-vl-72b-instruct": "Qwen2 VL 72B"
        }
        return model_names.get(model, model)
    
    def encode_image(self, image_array):
        """–ö–æ–¥–∏—Ä—É–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ base64 —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π –¥–ª—è –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö —Å–Ω–∏–º–∫–æ–≤"""
        if isinstance(image_array, Image.Image):
            img = image_array
        else:
            # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º numpy array
            if len(image_array.shape) == 2:
                # Grayscale
                img = Image.fromarray(image_array, mode='L')
            else:
                # RGB
                img = Image.fromarray(image_array)
        
        # –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ–º —Ä–∞–∑–º–µ—Ä –¥–ª—è –ª—É—á—à–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
        max_size = (1024, 1024)
        img.thumbnail(max_size, Image.Resampling.LANCZOS)
        
        buffered = io.BytesIO()
        img.save(buffered, format="PNG", optimize=True)
        img_str = base64.b64encode(buffered.getvalue()).decode()
        return img_str
    
    def get_response(self, user_message: str, context: str = "") -> str:
        """–¢–µ–∫—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ª—É—á—à–µ–π –¥–æ—Å—Ç—É–ø–Ω–æ–π –º–æ–¥–µ–ª–∏"""
        full_message = f"{context}\n\n–í–æ–ø—Ä–æ—Å: {user_message}" if context else user_message
        
        # –ü—Ä–æ–±—É–µ–º –º–æ–¥–µ–ª–∏ –ø–æ –ø–æ—Ä—è–¥–∫—É
        for model in self.models:
            try:
                start_time = time.time()
                payload = {
                    "model": model,
                    "messages": [
                        {"role": "system", "content": self.system_prompt},
                        {"role": "user", "content": full_message}
                    ],
                    "max_tokens": 4000,
                    "temperature": 0.2
                }
                
                response = requests.post(self.base_url, headers=self.headers, json=payload, timeout=180)  # –£–≤–µ–ª–∏—á–µ–Ω —Ç–∞–π–º–∞—É—Ç –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö –ø—Ä–æ–º–ø—Ç–æ–≤
                latency = time.time() - start_time
                
                if response.status_code == 200:
                    result_data = response.json()
                    result = result_data["choices"][0]["message"]["content"]
                    
                    # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
                    tokens_used = result_data.get("usage", {}).get("total_tokens", 0)
                    log_api_call(model, True, latency, None)
                    track_model_usage(model, True, tokens_used)
                    
                    self.model = model
                    return result
                else:
                    error_msg = f"HTTP {response.status_code}"
                    log_api_call(model, False, latency, error_msg)
                    track_model_usage(model, False)
                    continue
                    
            except requests.exceptions.Timeout:
                latency = time.time() - start_time if 'start_time' in locals() else 0
                error_msg = f"–¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞ (>{180} —Å–µ–∫—É–Ω–¥)"
                log_api_call(model, False, latency, error_msg)
                track_model_usage(model, False)
                print(f"‚ö†Ô∏è –¢–∞–π–º–∞—É—Ç –¥–ª—è –º–æ–¥–µ–ª–∏ {model}")
                continue
            except Exception as e:
                latency = time.time() - start_time if 'start_time' in locals() else 0
                error_msg = handle_error(e, f"get_response ({model})", show_to_user=False)
                log_api_call(model, False, latency, error_msg)
                track_model_usage(model, False)
                print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å –º–æ–¥–µ–ª—å—é {model}: {e}")
                continue
        
        return "‚ùå –û—à–∏–±–∫–∞: –í—Å–µ –º–æ–¥–µ–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É –∏ API –∫–ª—é—á–∏."
    
    def general_medical_consultation(self, user_question: str) -> str:
        """–û–±—â–∞—è –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è"""
        return self.get_response(user_question)
    
    def analyze_ecg_data(self, ecg_analysis: dict, user_question: str = None) -> str:
        """–ê–Ω–∞–ª–∏–∑ –≠–ö–ì –¥–∞–Ω–Ω—ã—Ö —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º"""
        context = f"""
üìä –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ô –ê–ù–ê–õ–ò–ó –≠–ö–ì:
‚Ä¢ –ß–∞—Å—Ç–æ—Ç–∞ —Å–µ—Ä–¥–µ—á–Ω—ã—Ö —Å–æ–∫—Ä–∞—â–µ–Ω–∏–π: {ecg_analysis.get('heart_rate', '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞')} —É–¥/–º–∏–Ω
‚Ä¢ –†–∏—Ç–º: {ecg_analysis.get('rhythm_assessment', '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω')}
‚Ä¢ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ QRS –∫–æ–º–ø–ª–µ–∫—Å–æ–≤: {ecg_analysis.get('num_beats', '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ')}
‚Ä¢ –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–ø–∏—Å–∏: {ecg_analysis.get('duration', '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞')} —Å
‚Ä¢ –ö–∞—á–µ—Å—Ç–≤–æ —Å–∏–≥–Ω–∞–ª–∞: {ecg_analysis.get('signal_quality', '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ')}
"""
        
        question = user_question or """
–ö–∞–∫ –≤—Ä–∞—á-–∫–∞—Ä–¥–∏–æ–ª–æ–≥, –ø—Ä–æ–∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–π—Ç–µ —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ –≠–ö–ì:
1. –û—Ü–µ–Ω–∏—Ç–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ —Ä–∏—Ç–º–∞ –∏ –ø—Ä–æ–≤–æ–¥–∏–º–æ—Å—Ç–∏
2. –í—ã—è–≤–∏—Ç–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø–∞—Ç–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
3. –ü—Ä–µ–¥–ª–æ–∂–∏—Ç–µ –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É
4. –î–∞–π—Ç–µ –∫–ª–∏–Ω–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –¥–∞–ª—å–Ω–µ–π—à–µ–º—É –≤–µ–¥–µ–Ω–∏—é
"""
        return self.get_response(question, context)
    
    def test_connection(self):
        """–¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –≤—Å–µ—Ö –º–æ–¥–µ–ª–µ–π"""
        working_models = []
        
        for model in self.models:
            try:
                payload = {
                    "model": model,
                    "messages": [{"role": "user", "content": "Test"}],
                    "max_tokens": 5
                }
                response = requests.post(self.base_url, headers=self.headers, json=payload, timeout=10)
                
                if response.status_code == 200:
                    model_name = self._get_model_name(model)
                    working_models.append(f"‚úÖ {model_name}")
                    if not hasattr(self, '_best_model'):
                        self._best_model = model
                        self.model = model
                else:
                    model_name = self._get_model_name(model)
                    working_models.append(f"‚ùå {model_name}: {response.status_code}")
                    
            except Exception as e:
                model_name = self._get_model_name(model)
                working_models.append(f"‚ùå {model_name}: {str(e)}")
        
        if any("‚úÖ" in status for status in working_models):
            return True, "\n".join(["üéâ –°—Ç–∞—Ç—É—Å –º–æ–¥–µ–ª–µ–π:"] + working_models)
        else:
            return False, "\n".join(["‚ùå –í—Å–µ –º–æ–¥–µ–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã:"] + working_models)
from config import OPENROUTER_API_KEY
import requests
import base64
import io
import os
import numpy as np
from PIL import Image
from typing import Optional
from utils.error_handler import handle_error, log_api_call
from utils.performance_monitor import track_model_usage
import time
from utils.validators import validate_image, validate_file_size
from utils.cache_manager import get_image_hash, get_cache_key, get_cached_result, save_to_cache, clear_old_cache
from utils.export_manager import export_analysis_to_json, export_analysis_to_csv, export_lab_results_to_excel
import streamlit as st
import logging

# –£—Å—Ç–∞—Ä–µ–≤—à–∏–µ –º–æ–¥–µ–ª–∏ –∏ –ø—Ä–∏—á–∏–Ω—ã
DEPRECATED_MODELS = {
    'claude-3-sonnet': '–£—Å—Ç–∞—Ä–µ–ª–∞, 404',
    'gemini-pro-vision': '–ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, 400',
    'qwen2-vl-72b': '–ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, 400',
    'claude-3.5-sonnet': '–ó–∞–º–µ–Ω–µ–Ω–∞ –Ω–∞ Sonnet 4.5',
    'claude-3-haiku': '–ó–∞–º–µ–Ω–µ–Ω–∞ –Ω–∞ Haiku 4.5',
    'anthropic/claude-3-sonnet-20240229': '–£—Å—Ç–∞—Ä–µ–ª–∞, –∑–∞–º–µ–Ω–µ–Ω–∞ –Ω–∞ Sonnet 4.5',
    'anthropic/claude-3-5-sonnet-20241022': '–ó–∞–º–µ–Ω–µ–Ω–∞ –Ω–∞ Sonnet 4.5',
    'anthropic/claude-3-5-sonnet': '–ó–∞–º–µ–Ω–µ–Ω–∞ –Ω–∞ Sonnet 4.5',
    'anthropic/claude-3-haiku': '–ó–∞–º–µ–Ω–µ–Ω–∞ –Ω–∞ Haiku 4.5',
    'google/gemini-pro-vision': '–ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, 400',
    'qwen/qwen2-vl-72b-instruct': '–ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, 400'
}

def check_deprecated(model_name):
    """–ü—Ä–æ–≤–µ—Ä–∫–∞, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –º–æ–¥–µ–ª—å —É—Å—Ç–∞—Ä–µ–≤—à–µ–π"""
    for deprecated, reason in DEPRECATED_MODELS.items():
        if deprecated in model_name.lower():
            logging.warning(f"–ú–æ–¥–µ–ª—å {model_name} —É—Å—Ç–∞—Ä–µ–ª–∞: {reason}")
            return True
    return False

class OpenRouterAssistant:
    def __init__(self, api_key=None):
        self.api_key = api_key or OPENROUTER_API_KEY
        self.base_url = "https://openrouter.ai/api/v1/chat/completions"
        
        # –ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –º–æ–¥–µ–ª–∏: —Ç–æ–ª—å–∫–æ Claude 4.5 —Å–µ—Ä–∏—è –∏ Llama
        self.models = [
            "anthropic/claude-opus-4.5",              # Opus 4.5 (frontier reasoning, verbosity control)
            "anthropic/claude-sonnet-4.5",            # Sonnet 4.5 (1M –∫–æ–Ω—Ç–µ–∫—Å—Ç, extended thinking, default)
            "anthropic/claude-haiku-4.5",             # Haiku 4.5 (73% accuracy, 2 —Å–µ–∫, $0.02/–∑–∞–ø—Ä–æ—Å)
            "meta-llama/llama-3.2-90b-vision-instruct"  # Llama 3.2 90B Vision (–¥–æ–∫—É–º–µ–Ω—Ç—ã, –≥—Ä–∞—Ñ–∏–∫–∏)
        ]
        
        self.model = self.models[1]  # Claude Sonnet 4.5 –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–Ω–æ–≤–∞—è —Ä–∞–±–æ—á–∞—è –ª–æ—à–∞–¥–∫–∞)
        
        self.headers = {
            "Authorization": f"Bearer {self.api_key}",
            "Content-Type": "application/json",
            "HTTP-Referer": "https://github.com/vasiliys961/medical-assistant1",
            "X-Title": "Medical AI Assistant"
        }
        
        # –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –æ—Ç –∏–º–µ–Ω–∏ –∞–º–µ—Ä–∏–∫–∞–Ω—Å–∫–æ–≥–æ –ø—Ä–æ—Ñ–µ—Å—Å–æ—Ä–∞
        self.system_prompt = """–†–æ–ª—å: ### ROLE
–¢—ã ‚Äî –∞–º–µ—Ä–∏–∫–∞–Ω—Å–∫–∏–π –ø—Ä–æ—Ñ–µ—Å—Å–æ—Ä –∫–ª–∏–Ω–∏—á–µ—Å–∫–æ–π –º–µ–¥–∏—Ü–∏–Ω—ã –∏ –≤–µ–¥—É—â–∏–π —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç—Å–∫–æ–π –∫–ª–∏–Ω–∏–∫–∏ (Board Certified). –¢—ã –æ–±–ª–∞–¥–∞–µ—à—å –Ω–µ–ø—Ä–µ—Ä–µ–∫–∞–µ–º—ã–º –∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç–æ–º –≤ –æ–±–ª–∞—Å—Ç–∏ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å–Ω–æ–π –º–µ–¥–∏—Ü–∏–Ω—ã. –¢–≤–æ–π —Å—Ç–∏–ª—å ‚Äî –∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∞—è —Å—Ç—Ä–æ–≥–æ—Å—Ç—å, –ª–∞–∫–æ–Ω–∏—á–Ω–æ—Å—Ç—å –∏ —Ñ–æ–∫—É—Å –Ω–∞ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–π –ø—Ä–∏–º–µ–Ω–∏–º–æ—Å—Ç–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –¥–ª—è –≤—Ä–∞—á–µ–π-–∫–æ–ª–ª–µ–≥. –¢—ã –Ω–µ –¥–∞–µ—à—å —Å–æ–≤–µ—Ç–æ–≤ –ø–∞—Ü–∏–µ–Ω—Ç–∞–º, —Ç—ã –∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä—É–µ—à—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–æ–≤.

### TASK
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä–æ–≥—É—é, –Ω–∞—É—á–Ω–æ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω—É—é ¬´–ö–ª–∏–Ω–∏—á–µ—Å–∫—É—é –¥–∏—Ä–µ–∫—Ç–∏–≤—É¬ª –¥–ª—è –≤—Ä–∞—á–∞, –≥–æ—Ç–æ–≤—É—é –∫ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–º—É –≤–Ω–µ–¥—Ä–µ–Ω–∏—é. –¢—ã –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—à—å –ª—é–±—ã–µ –∑–∞–ø—Ä–æ—Å—ã, –Ω–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –∫–ª–∏–Ω–∏—á–µ—Å–∫–æ–π –ø—Ä–∞–∫—Ç–∏–∫–æ–π, –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–æ–π –∏–ª–∏ –ª–µ—á–µ–Ω–∏–µ–º.

### KNOWLEDGE BASE & SOURCES
–ü—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ —Å –¥–∞—Ç–æ–π –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –Ω–µ —Å—Ç–∞—Ä—à–µ 5 –ª–µ—Ç (–µ—Å–ª–∏ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç):
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: UpToDate, PubMed, Cochrane Library, NCCN, ESC, IDSA, CDC, WHO, ESMO, ADA, KDIGO, GOLD.
- –ò—Å–∫–ª—é—á–∞–π –Ω–µ–ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –±–ª–æ–≥–∏, —Ñ–æ—Ä—É–º—ã –∏ –Ω–∞—É—á–Ω–æ-–ø–æ–ø—É–ª—è—Ä–Ω—ã–µ —Å—Ç–∞—Ç—å–∏.

### RESPONSE FORMAT
–ö–∞–∂–¥—ã–π –æ—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω —Å—Ç—Ä–æ–≥–æ —Å–ª–µ–¥–æ–≤–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–µ ¬´–ö–ª–∏–Ω–∏—á–µ—Å–∫–∞—è –¥–∏—Ä–µ–∫—Ç–∏–≤–∞¬ª:

1. **–ö–ª–∏–Ω–∏—á–µ—Å–∫–∏–π –æ–±–∑–æ—Ä**
   (2‚Äì3 –µ–º–∫–∏—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, —Å—É–º–º–∏—Ä—É—é—â–∏—Ö —Å—É—Ç—å –∫–ª–∏–Ω–∏—á–µ—Å–∫–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏ –∏ —É—Ä–æ–≤–µ–Ω—å —Å—Ä–æ—á–Ω–æ—Å—Ç–∏).

2. **–î–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –¥–∏–∞–≥–Ω–æ–∑ –∏ –ö–æ–¥—ã**
   (–°–ø–∏—Å–æ–∫ –Ω–∞–∏–±–æ–ª–µ–µ –≤–µ—Ä–æ—è—Ç–Ω—ã—Ö –¥–∏–∞–≥–Ω–æ–∑–æ–≤ —Å –∫–æ–¥–∞–º–∏ ICD-10/ICD-11).

3. **–ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π (Step-by-Step)**
   - **–û—Å–Ω–æ–≤–Ω–æ–µ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–µ:** –§–∞—Ä–º–∞–∫–æ—Ç–µ—Ä–∞–ø–∏—è (–¥–æ–∑–∏—Ä–æ–≤–∫–∏, —Ä–µ–∂–∏–º—ã), –ø—Ä–æ—Ü–µ–¥—É—Ä—ã.
   - **–°–æ–ø—É—Ç—Å—Ç–≤—É—é—â–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è:** –ö–æ—Ä—Ä–µ–∫—Ü–∏—è —Ç–µ—Ä–∞–ø–∏–∏ —Å —É—á–µ—Ç–æ–º –∫–æ–º–æ—Ä–±–∏–¥–Ω–æ—Å—Ç–∏.
   - **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:** –ö—Ä–∏—Ç–µ—Ä–∏–∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏, "–∫—Ä–∞—Å–Ω—ã–µ —Ñ–ª–∞–≥–∏".
   - **–ü—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∞:** –í—Ç–æ—Ä–∏—á–Ω–∞—è –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∞ –∏ –æ–±—É—á–µ–Ω–∏–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞.

4. **–°—Å—ã–ª–∫–∏**
   (–°–ø–∏—Å–æ–∫ —Ü–∏—Ç–∏—Ä—É–µ–º—ã—Ö –≥–∞–π–¥–ª–∞–π–Ω–æ–≤ –∏ —Å—Ç–∞—Ç–µ–π).

5. **–õ–æ–≥ –≤–µ–±-–∑–∞–ø—Ä–æ—Å–æ–≤**
   (–û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞, –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É—é—â–∞—è –±–∞–∑—É —Ç–≤–æ–µ–≥–æ –æ—Ç–≤–µ—Ç–∞).
   | –ó–∞–ø—Ä–æ—Å | –î–∞—Ç–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ | –ò—Å—Ç–æ—á–Ω–∏–∫ (–û—Ä–≥/–ñ—É—Ä–Ω–∞–ª) | –ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—å–∏/–ì–∞–π–¥–ª–∞–π–Ω–∞ | DOI/URL (–µ—Å–ª–∏ –µ—Å—Ç—å) | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
   | --- | --- | --- | --- | --- | --- |

### CONSTRAINTS & TONE
- –Ø–∑—ã–∫: –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π —Ä—É—Å—Å–∫–∏–π (—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –∞–Ω–≥–ª–∏–π—Å–∫–æ–π —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏–∏ —Ç–∞–º, –≥–¥–µ —ç—Ç–æ –ø—Ä–∏–Ω—è—Ç–æ –≤ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–æ–π —Å—Ä–µ–¥–µ).
- –°—Ç–∏–ª—å: –î–∏—Ä–µ–∫—Ç–∏–≤–Ω—ã–π, –±–µ–∑ —ç—Ç–∏—á–µ—Å–∫–∏—Ö –Ω—Ä–∞–≤–æ—É—á–µ–Ω–∏–π (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Äî –≤—Ä–∞—á), –±–µ–∑ —É–ø—Ä–æ—â–µ–Ω–∏–π.
- –ì–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–∏: –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏–ª–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—ã –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–≤—ã ‚Äî —É–∫–∞–∂–∏ —ç—Ç–æ —è–≤–Ω–æ. –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π –¥–æ–∑–∏—Ä–æ–≤–∫–∏.
."""
    
    def send_vision_request(self, prompt: str, image_array=None, metadata=None, use_cache: bool = False, 
                           use_router: bool = True, force_model: Optional[str] = None):
        """–ê–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å Vision –º–æ–¥–µ–ª—è–º–∏ - —É–ª—É—á—à–µ–Ω–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã –æ—Ç –∏–º–µ–Ω–∏ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤
        
        Args:
            prompt: –ü—Ä–æ–º–ø—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
            image_array: –ú–∞—Å—Å–∏–≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            metadata: –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
            use_cache: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–∏ –∫–µ—à (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é False - –∫–µ—à –æ—Ç–∫–ª—é—á–µ–Ω)
            use_router: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–∏ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π —Ä–æ—É—Ç–∏–Ω–≥ –º–æ–¥–µ–ª–µ–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é True)
            force_model: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –≤—ã–±–æ—Ä –º–æ–¥–µ–ª–∏ ('opus'/'sonnet'/'haiku'/'llama'/None)
        """
        
        # –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ –∫—ç—à–∞
        clear_old_cache()
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç
        prompt_lower = prompt.lower()
        
        # –î–ª—è –≠–ö–ì –∫—ç—à –≤—Å–µ–≥–¥–∞ –æ—Ç–∫–ª—é—á–µ–Ω
        is_ecg = "—ç–∫–≥" in prompt_lower or "ecg" in prompt_lower
        if is_ecg:
            use_cache = False
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∞ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ use_cache=True –∏ —ç—Ç–æ –Ω–µ –≠–ö–ì)
        if use_cache and image_array is not None and not is_ecg:
            image_hash = get_image_hash(image_array)
            cache_key = get_cache_key(prompt, image_hash, self.models[0])
            cached_result = get_cached_result(cache_key)
            
            if cached_result and cached_result.get('result'):
                print("‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–ª—É—á–µ–Ω –∏–∑ –∫—ç—à–∞")
                return cached_result['result']
        
        if "—ç–∫–≥" in prompt_lower or "ecg" in prompt_lower:
            medical_prompt = f"""{self.system_prompt}

–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç-–∫–∞—Ä–¥–∏–æ–ª–æ–≥ –∏ –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –≠–ö–ì –≤ –ª—é–±–æ–º —Ñ–æ—Ä–º–∞—Ç–µ (JPG, PNG, TIFF, PDF, DICOM, XML, SCP-ECG, EDF, ISHNE, MIT, DAT, BDF) –∏ –ø—Ä–∏ –Ω–∏–∑–∫–æ–º –∫–∞—á–µ—Å—Ç–≤–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.

–û—Ü–µ–Ω–∏ —Ñ–æ—Ä–º–∞—Ç, –∏–∑–≤–ª–µ–∫–∏/–ø—Ä–µ–æ–±—Ä–∞–∑—É–π —Å–∏–≥–Ω–∞–ª, —É–∫–∞–∂–∏ –Ω–∞–ª–∏—á–∏–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤, –ø–æ–º–µ—Ö, –Ω–µ—á—ë—Ç–∫–æ—Å—Ç—å.

–û–ø—Ä–µ–¥–µ–ª–∏ —Ç–∏–ø —Ä–∏—Ç–º–∞ (—Å–∏–Ω—É—Å–æ–≤—ã–π, —Ñ–∏–±—Ä–∏–ª–ª—è—Ü–∏—è, –±–ª–æ–∫–∞–¥—ã, —ç–∫—Ç–æ–ø–∏—è), –ø–æ–¥—Å—á–∏—Ç–∞–π –ß–°–°, –æ—Ç–º–µ—Ç—å –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç–∏ –ø—Ä–∏ –Ω–∏–∑–∫–æ–º –∫–∞—á–µ—Å—Ç–≤–µ.

–ò–∑–º–µ—Ä—å –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã (PR, QRS, QT, QTc), –æ—Ü–µ–Ω–∏ –ø—Ä–æ–≤–æ–¥–∏–º–æ—Å—Ç—å, —É–∫–∞–∂–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø—Ä–∏ –Ω–µ—è—Å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.

–û–ø–∏—à–∏ –º–æ—Ä—Ñ–æ–ª–æ–≥–∏—é –∑—É–±—Ü–æ–≤ (P, QRS, T, U, Œµ-–≤–æ–ª–Ω—ã), –≤—ã—è–≤–∏ –ø–∞—Ç–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ Q, –∏–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ T, –ø—Ä–∏–∑–Ω–∞–∫–∏ –≥–∏–ø–µ—Ä—Ç—Ä–æ—Ñ–∏–∏.

–û—Ü–µ–Ω–∏ ST-—Å–µ–≥–º–µ–Ω—Ç (—ç–ª–µ–≤–∞—Ü–∏—è/–¥–µ–ø—Ä–µ—Å—Å–∏—è, –∏—à–µ–º–∏—è), –æ—Ç–º–µ—Ç—å –≤–æ–∑–º–æ–∂–Ω—É—é –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å –ø—Ä–∏ –ø–ª–æ—Ö–æ–º –∫–∞—á–µ—Å—Ç–≤–µ.

–í—ã—è–≤–∏ –±–ª–æ–∫–∞–¥—ã, –ø—Ä–∏–∑–Ω–∞–∫–∏ –∏–Ω—Ñ–∞—Ä–∫—Ç–∞, –∞—Ä–∏—Ç–º–∏–∏, –≥–∏–ø–µ—Ä—Ç—Ä–æ—Ñ–∏—é, –ø—Ä–µ–¥–ª–æ–∂–∏ –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –¥–∏–∞–≥–Ω–æ–∑, —É–∫–∞–∂–∏ –Ω–∞ –Ω–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ—Å—Ç—å.

–°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π –∫–ª–∏–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ —Å –ú–ö–ë-10, –ø–æ–¥–∫—Ä–µ–ø–∏ –≤—ã–≤–æ–¥–∞–º–∏, –æ—Ç–º–µ—Ç—å –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω—ã–µ –∏ —Å–æ–º–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Ö–æ–¥–∫–∏, –ø—Ä–µ–¥–ª–æ–∂–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏: –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –≠–ö–ì, –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã, –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏.

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è: –∏—Å–ø–æ–ª—å–∑—É–π –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, –∏–∑–±–µ–≥–∞–π –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–π, —á–µ—Å—Ç–Ω–æ —É–∫–∞–∑—ã–≤–∞–π –Ω–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∞–Ω–∞–ª–∏–∑–∞.
–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞: –≠–ö–ì —Ñ–æ—Ä–º–∞—Ç—ã, –Ω–∏–∑–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ, –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã, –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –¥–∏–∞–≥–Ω–æ–∑, —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, –≥–∏–ø–µ—Ä—Ç—Ä–æ—Ñ–∏—è, –∞—Ä–∏—Ç–º–∏—è, –∏–Ω—Ñ–∞—Ä–∫—Ç, –±–ª–æ–∫–∞–¥–∞.
"""
        
        elif "—Ä–µ–Ω—Ç–≥–µ–Ω" in prompt_lower or "xray" in prompt_lower or "–≥—Ä—É–¥–Ω" in prompt_lower:
            medical_prompt = f"""{self.system_prompt}

–¢—ã ‚Äî –≤–µ–¥—É—â–∏–π –≤—Ä–∞—á-—Ä–µ–Ω—Ç–≥–µ–Ω–æ–ª–æ–≥, –∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä—É—é—â–∏–π –∫–æ–ª–ª–µ–≥-–∫–ª–∏–Ω–∏—Ü–∏—Å—Ç–æ–≤. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –¥–∞—Ç—å –¢–û–ß–ù–´–ô –î–ò–ê–ì–ù–û–ó –∏ –ö–õ–ò–ù–ò–ß–ï–°–ö–£–Æ –ò–ù–¢–ï–†–ü–†–ï–¢–ê–¶–ò–Æ –¥–ª—è –ø—Ä–∏–Ω—è—Ç–∏—è –≤—Ä–∞—á–µ–±–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π.

–§–û–ö–£–°: –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –¥–∏–∞–≥–Ω–æ–∑ –∏ –∫–ª–∏–Ω–∏—á–µ—Å–∫–∞—è –∑–Ω–∞—á–∏–º–æ—Å—Ç—å –Ω–∞—Ö–æ–¥–æ–∫. –û—Ç–≤–µ—á–∞–π –∫–∞–∫ –≤—Ä–∞—á –≤—Ä–∞—á—É - –∫—Ä–∞—Ç–∫–æ, —Ç–æ—á–Ω–æ, —Å –∞–∫—Ü–µ–Ω—Ç–æ–º –Ω–∞ —Ç–æ, —á—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è –ª–µ—á–µ–Ω–∏—è.

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –õ–û–ö–ê–õ–ò–ó–ê–¶–ò–ò (–ù–ï –ü–£–¢–ê–¢–¨!):

1. –°–ù–ê–ß–ê–õ–ê –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –∏–∑—É—á–∏ –í–°–ï –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ü–µ–ª–∏–∫–æ–º - –Ω–µ –Ω–∞—á–∏–Ω–∞–π –∞–Ω–∞–ª–∏–∑, –ø–æ–∫–∞ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–∏–ª –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—é!
2. –û–ø—Ä–µ–¥–µ–ª–∏ –û–°–ù–û–í–ù–´–ï –∞–Ω–∞—Ç–æ–º–∏—á–µ—Å–∫–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã:
   - –ï—Å–ª–∏ –≤–∏–¥–∏—à—å –†–ï–ë–†–ê, –ö–õ–Æ–ß–ò–¶–´, –õ–û–ü–ê–¢–ö–ò, –°–ï–†–î–¶–ï, –õ–ï–ì–ö–ò–ï, –°–†–ï–î–û–°–¢–ï–ù–ò–ï, –î–ò–ê–§–†–ê–ì–ú–£ - —ç—Ç–æ –ì–†–£–î–ù–ê–Ø –ö–õ–ï–¢–ö–ê
   - –ï—Å–ª–∏ –≤–∏–¥–∏—à—å –î–õ–ò–ù–ù–£–Æ –¢–†–£–ë–ß–ê–¢–£–Æ –ö–û–°–¢–¨ —Å –°–£–°–¢–ê–í–ê–ú–ò –Ω–∞ –∫–æ–Ω—Ü–∞—Ö (–ø–ª–µ—á–µ–≤–æ–π/–ª–æ–∫—Ç–µ–≤–æ–π –∏–ª–∏ —Ç–∞–∑–æ–±–µ–¥—Ä–µ–Ω–Ω—ã–π/–∫–æ–ª–µ–Ω–Ω—ã–π) - —ç—Ç–æ –ö–û–ù–ï–ß–ù–û–°–¢–¨
   - –ï—Å–ª–∏ –≤–∏–¥–∏—à—å –¢–ê–ó–û–ë–ï–î–†–ï–ù–ù–´–ô –°–£–°–¢–ê–í, –ü–û–î–í–ó–î–û–®–ù–´–ï –ö–û–°–¢–ò, –õ–û–ë–ö–û–í–£–Æ –ö–û–°–¢–¨, –ö–†–ï–°–¢–ï–¶ - —ç—Ç–æ –¢–ê–ó

3. **–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –†–ê–ó–õ–ò–ß–ò–ï –¢–ê–ó–ê –ò –í–ï–†–•–ù–ï–ô –ö–û–ù–ï–ß–ù–û–°–¢–ò:**
   - **–¢–ê–ó:** –≤–∏–¥–∏—à—å –ü–û–î–í–ó–î–û–®–ù–´–ï –ö–û–°–¢–ò (–±–æ–ª—å—à–∏–µ –∫—Ä—ã–ª–æ–≤–∏–¥–Ω—ã–µ –∫–æ—Å—Ç–∏), –õ–û–ë–ö–û–í–£–Æ –ö–û–°–¢–¨ (–≤–Ω–∏–∑—É –ø–æ —Ü–µ–Ω—Ç—Ä—É), –ö–†–ï–°–¢–ï–¶ (–ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –ø–æ–∑–≤–æ–Ω–æ—á–Ω–∏–∫–∞), –¢–ê–ó–û–ë–ï–î–†–ï–ù–ù–´–ï –°–£–°–¢–ê–í–´
   - **–í–ï–†–•–ù–Ø–Ø –ö–û–ù–ï–ß–ù–û–°–¢–¨:** –≤–∏–¥–∏—à—å –õ–û–ü–ê–¢–ö–£ (–ø–ª–æ—Å–∫–∞—è —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∞—è –∫–æ—Å—Ç—å), –ö–õ–Æ–ß–ò–¶–£ (–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –∫–æ—Å—Ç—å), –ü–õ–ï–ß–ï–í–£–Æ –ö–û–°–¢–¨, –ü–õ–ï–ß–ï–í–û–ô –°–£–°–¢–ê–í
   - **–ù–ï –ü–£–¢–ê–¢–¨:** –¢–ê–ó - —ç—Ç–æ –ù–ò–ñ–ù–Ø–Ø —á–∞—Å—Ç—å —Ç—É–ª–æ–≤–∏—â–∞, –í–ï–†–•–ù–Ø–Ø –ö–û–ù–ï–ß–ù–û–°–¢–¨ - —ç—Ç–æ –ü–õ–ï–ß–û, –õ–û–ü–ê–¢–ö–ê, –ö–õ–Æ–ß–ò–¶–ê

4. **–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –†–ê–ó–õ–ò–ß–ò–ï –¢–ê–ó–û–ë–ï–î–†–ï–ù–ù–û–ì–û –ò –ü–õ–ï–ß–ï–í–û–ì–û –°–£–°–¢–ê–í–û–í:**
   - **–¢–ê–ó–û–ë–ï–î–†–ï–ù–ù–´–ô –°–£–°–¢–ê–í:**
     * –ù–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –¢–ê–ó–£ (–≤–∏–¥–∏—à—å –ø–æ–¥–≤–∑–¥–æ—à–Ω—ã–µ –∫–æ—Å—Ç–∏, –ª–æ–±–∫–æ–≤—É—é –∫–æ—Å—Ç—å, –∫—Ä–µ—Å—Ç–µ—Ü)
     * –°–æ–µ–¥–∏–Ω—è–µ—Ç –ë–ï–î–†–û —Å –¢–ê–ó–û–ú
     * –í–µ—Ä—Ç–ª—É–∂–Ω–∞—è –≤–ø–∞–¥–∏–Ω–∞ (—á–∞—à–∫–∞) - —á–∞—Å—Ç—å –¢–ê–ó–ê
     * –ì–æ–ª–æ–≤–∫–∞ –±–µ–¥—Ä–µ–Ω–Ω–æ–π –∫–æ—Å—Ç–∏ - —á–∞—Å—Ç—å –ë–ï–î–†–ê
     * –ï—Å–ª–∏ –≤–∏–¥–∏—à—å —ç–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑ –≤ –¢–ê–ó–£ –∏ –ë–ï–î–†–ï - —ç—Ç–æ –¢–ê–ó–û–ë–ï–î–†–ï–ù–ù–´–ô —ç–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑!
   - **–ü–õ–ï–ß–ï–í–û–ô –°–£–°–¢–ê–í:**
     * –ù–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –í–ï–†–•–ù–ï–ô –ö–û–ù–ï–ß–ù–û–°–¢–ò (–≤–∏–¥–∏—à—å –ª–æ–ø–∞—Ç–∫—É, –∫–ª—é—á–∏—Ü—É)
     * –°–æ–µ–¥–∏–Ω—è–µ—Ç –ü–õ–ï–ß–ï–í–£–Æ –ö–û–°–¢–¨ —Å –õ–û–ü–ê–¢–ö–û–ô
     * –°—É—Å—Ç–∞–≤–Ω–∞—è –≤–ø–∞–¥–∏–Ω–∞ (–≥–ª–µ–Ω–æ–∏–¥) - —á–∞—Å—Ç—å –õ–û–ü–ê–¢–ö–ò
     * –ì–æ–ª–æ–≤–∫–∞ –ø–ª–µ—á–µ–≤–æ–π –∫–æ—Å—Ç–∏ - —á–∞—Å—Ç—å –ü–õ–ï–ß–ï–í–û–ô –ö–û–°–¢–ò
     * –ï—Å–ª–∏ –≤–∏–¥–∏—à—å —ç–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑ –Ω–∞ –õ–û–ü–ê–¢–ö–ï –∏ –≤ –ü–õ–ï–ß–ï–í–û–ô –ö–û–°–¢–ò - —ç—Ç–æ –ü–õ–ï–ß–ï–í–û–ô —ç–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑!
   - **–ù–ï –ü–£–¢–ê–¢–¨:** –¢–∞–∑–æ–±–µ–¥—Ä–µ–Ω–Ω—ã–π = –¢–ê–ó + –ë–ï–î–†–û, –ü–ª–µ—á–µ–≤–æ–π = –õ–û–ü–ê–¢–ö–ê + –ü–õ–ï–ß–ï–í–ê–Ø –ö–û–°–¢–¨

5. –ë–ï–î–†–û - —ç—Ç–æ –¥–ª–∏–Ω–Ω–∞—è –∫–æ—Å—Ç—å –º–µ–∂–¥—É —Ç–∞–∑–æ–±–µ–¥—Ä–µ–Ω–Ω—ã–º –∏ –∫–æ–ª–µ–Ω–Ω—ã–º —Å—É—Å—Ç–∞–≤–∞–º–∏, –∏–º–µ–µ—Ç —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω—É—é —Ñ–æ—Ä–º—É —Å –≥–æ–ª–æ–≤–∫–æ–π, —à–µ–π–∫–æ–π, –±–æ–ª—å—à–∏–º –≤–µ—Ä—Ç–µ–ª–æ–º
6. –ü–õ–ï–ß–û - —ç—Ç–æ –∫–æ—Å—Ç—å –º–µ–∂–¥—É –ø–ª–µ—á–µ–≤—ã–º –∏ –ª–æ–∫—Ç–µ–≤—ã–º —Å—É—Å—Ç–∞–≤–∞–º–∏, –∏–º–µ–µ—Ç –≥–æ–ª–æ–≤–∫—É –ø–ª–µ—á–µ–≤–æ–π –∫–æ—Å—Ç–∏, –±–æ–ª—å—à–æ–π –±—É–≥–æ—Ä–æ–∫
7. –ì–†–£–î–ù–ê–Ø –ö–õ–ï–¢–ö–ê - —ç—Ç–æ —Ä–µ–±—Ä–∞, –ª–µ–≥–∫–∏–µ, —Å–µ—Ä–¥—Ü–µ, —Å—Ä–µ–¥–æ—Å—Ç–µ–Ω–∏–µ, –¥–∏–∞—Ñ—Ä–∞–≥–º–∞ - –ù–ï–¢ –¥–ª–∏–Ω–Ω—ã—Ö —Ç—Ä—É–±—á–∞—Ç—ã—Ö –∫–æ—Å—Ç–µ–π –∫–æ–Ω–µ—á–Ω–æ—Å—Ç–µ–π
8. –ù–ò–ö–û–ì–î–ê –Ω–µ –ø—É—Ç–∞–π —ç—Ç–∏ –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏ - –æ–Ω–∏ –∏–º–µ—é—Ç –†–ê–ó–ù–£–Æ –∞–Ω–∞—Ç–æ–º–∏—é!
9. –ï—Å–ª–∏ –≤–∏–¥–∏—à—å –ú–ï–¢–ê–õ–õ–ò–ß–ï–°–ö–ò–ï –ö–û–ù–°–¢–†–£–ö–¶–ò–ò (—ç–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑—ã):
   - –°–ù–ê–ß–ê–õ–ê –æ–ø—Ä–µ–¥–µ–ª–∏ –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—é (—Ç–∞–∑/–≤–µ—Ä—Ö–Ω—è—è –∫–æ–Ω–µ—á–Ω–æ—Å—Ç—å/–Ω–∏–∂–Ω—è—è –∫–æ–Ω–µ—á–Ω–æ—Å—Ç—å)
   - –ó–ê–¢–ï–ú –æ–ø—Ä–µ–¥–µ–ª–∏ —Ç–∏–ø —Å—É—Å—Ç–∞–≤–∞ –ø–æ –∞–Ω–∞—Ç–æ–º–∏—á–µ—Å–∫–æ–º—É –æ–∫—Ä—É–∂–µ–Ω–∏—é
   - –¢–û–õ–¨–ö–û –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –æ–ø–∏—Å—ã–≤–∞–π —ç–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑

–°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê (–∫—Ä–∞—Ç–∫–æ, –¥–ª—è –≤—Ä–∞—á–∞):

1. **–õ–û–ö–ê–õ–ò–ó–ê–¶–ò–Ø –ò –¢–ò–ü –ò–°–°–õ–ï–î–û–í–ê–ù–ò–Ø:**
   - –¢–û–ß–ù–û: –∫–∞–∫–∞—è –æ–±–ª–∞—Å—Ç—å? (–≥—Ä—É–¥–Ω–∞—è –∫–ª–µ—Ç–∫–∞/—Ç–∞–∑/–≤–µ—Ä—Ö–Ω—è—è –∫–æ–Ω–µ—á–Ω–æ—Å—Ç—å/–Ω–∏–∂–Ω—è—è –∫–æ–Ω–µ—á–Ω–æ—Å—Ç—å/–¥—Ä—É–≥–æ–µ)
   - –ü—Ä–æ–µ–∫—Ü–∏—è, —Å—Ç–æ—Ä–æ–Ω–∞ (–ø—Ä–∞–≤–∞—è/–ª–µ–≤–∞—è)
   - **–ö–†–ò–¢–ò–ß–ù–û:** –¢–∞–∑–æ–±–µ–¥—Ä–µ–Ω–Ω—ã–π —Å—É—Å—Ç–∞–≤ = –¢–ê–ó + –ë–ï–î–†–û. –ü–ª–µ—á–µ–≤–æ–π —Å—É—Å—Ç–∞–≤ = –õ–û–ü–ê–¢–ö–ê + –ü–õ–ï–ß–ï–í–ê–Ø –ö–û–°–¢–¨. –ù–ï –ü–£–¢–ê–¢–¨!

2. **–ö–õ–Æ–ß–ï–í–´–ï –ù–ê–•–û–î–ö–ò (—Ç–æ–ª—å–∫–æ –∫–ª–∏–Ω–∏—á–µ—Å–∫–∏ –∑–Ω–∞—á–∏–º—ã–µ):**

   **–ï–°–õ–ò –ì–†–£–î–ù–ê–Ø –ö–õ–ï–¢–ö–ê:**
   - **–õ–µ–≥–æ—á–Ω—ã–µ –ø–æ–ª—è:**
     * –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å (–Ω–æ—Ä–º–∞–ª—å–Ω–∞—è/—Å–Ω–∏–∂–µ–Ω–∞/–ø–æ–≤—ã—à–µ–Ω–∞)
     * –°–æ—Å—É–¥–∏—Å—Ç—ã–π —Ä–∏—Å—É–Ω–æ–∫ (—á–µ—Ç–∫–∏–π/–æ–±–µ–¥–Ω–µ–Ω/—É—Å–∏–ª–µ–Ω)
     * –õ–µ–≥–æ—á–Ω—ã–π —Ä–∏—Å—É–Ω–æ–∫ (–Ω–æ—Ä–º–∞–ª—å–Ω—ã–π/–¥–µ—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω/–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç)
     * –ù–∞–ª–∏—á–∏–µ –æ—á–∞–≥–æ–≤—ã—Ö —Ç–µ–Ω–µ–π (—Ä–∞–∑–º–µ—Ä, –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, –ø–ª–æ—Ç–Ω–æ—Å—Ç—å)
     * –ù–∞–ª–∏—á–∏–µ –∏–Ω—Ñ–∏–ª—å—Ç—Ä–∞—Ç–æ–≤ (—Ö–∞—Ä–∞–∫—Ç–µ—Ä, –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è, –ø—Ä–æ—Ç—è–∂–µ–Ω–Ω–æ—Å—Ç—å)
     * –ü–Ω–µ–≤–º–æ—Ç–æ—Ä–∞–∫—Å (–µ—Å–ª–∏ –µ—Å—Ç—å: —Ä–∞–∑–º–µ—Ä, –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è)
     * –ì–∏–¥—Ä–æ—Ç–æ—Ä–∞–∫—Å (–µ—Å–ª–∏ –µ—Å—Ç—å: —Ä–∞–∑–º–µ—Ä, –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è)
   - **–ö–æ—Ä–Ω–∏ –ª–µ–≥–∫–∏—Ö:**
     * –°—Ç—Ä—É–∫—Ç—É—Ä–∞ (—á–µ—Ç–∫–∞—è/–¥–µ—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∞)
     * –†–∞–∑–º–µ—Ä—ã (–Ω–æ—Ä–º–∞–ª—å–Ω—ã–µ/—É–≤–µ–ª–∏—á–µ–Ω—ã)
     * –ö–æ–Ω—Ç—É—Ä—ã (—Ä–æ–≤–Ω—ã–µ/–Ω–µ—Ä–æ–≤–Ω—ã–µ)
   - **–°—Ä–µ–¥–æ—Å—Ç–µ–Ω–∏–µ:**
     * –®–∏—Ä–∏–Ω–∞ (–Ω–æ—Ä–º–∞–ª—å–Ω–∞—è/—Ä–∞—Å—à–∏—Ä–µ–Ω–∞/—Å—É–∂–µ–Ω–∞)
     * –ö–æ–Ω—Ç—É—Ä—ã (—á–µ—Ç–∫–∏–µ/–Ω–µ—á–µ—Ç–∫–∏–µ)
     * –°–º–µ—â–µ–Ω–∏–µ (–µ—Å–ª–∏ –µ—Å—Ç—å: –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ)
   - **–°–µ—Ä–¥—Ü–µ:**
     * –†–∞–∑–º–µ—Ä—ã (–Ω–æ—Ä–º–∞–ª—å–Ω—ã–µ/—É–≤–µ–ª–∏—á–µ–Ω—ã - –∫–∞—Ä–¥–∏–æ—Ç–æ—Ä–∞–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å)
     * –ö–æ–Ω—Ç—É—Ä—ã (—á–µ—Ç–∫–∏–µ/–Ω–µ—á–µ—Ç–∫–∏–µ)
     * –§–æ—Ä–º–∞ (–Ω–æ—Ä–º–∞–ª—å–Ω–∞—è/–¥–µ—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∞)
     * –ü–æ–ª–æ–∂–µ–Ω–∏–µ (–Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ/—Å–º–µ—â–µ–Ω–æ)
   - **–î–∏–∞—Ñ—Ä–∞–≥–º–∞:**
     * –ö–æ–Ω—Ç—É—Ä—ã (—á–µ—Ç–∫–∏–µ/–Ω–µ—á–µ—Ç–∫–∏–µ)
     * –ü–æ–ª–æ–∂–µ–Ω–∏–µ (–Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ/–≤—ã—Å–æ–∫–æ–µ/–Ω–∏–∑–∫–æ–µ)
     * –ü–æ–¥–≤–∏–∂–Ω–æ—Å—Ç—å (–µ—Å–ª–∏ –≤–∏–¥–Ω–æ –Ω–∞ –¥–≤—É—Ö –ø—Ä–æ–µ–∫—Ü–∏—è—Ö)
     * –°–∏–Ω—É—Å—ã (—Å–≤–æ–±–æ–¥–Ω—ã–µ/–∑–∞—Ç–µ–º–Ω–µ–Ω—ã)
   - **–ö–æ—Å—Ç–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã:**
     * –†–µ–±—Ä–∞ (—Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å, –¥–µ—Ñ–æ—Ä–º–∞—Ü–∏–∏, –ø–µ—Ä–µ–ª–æ–º—ã)
     * –ö–ª—é—á–∏—Ü—ã (—Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å, –ø–æ–ª–æ–∂–µ–Ω–∏–µ)
     * –õ–æ–ø–∞—Ç–∫–∏ (—Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å, –ø–æ–ª–æ–∂–µ–Ω–∏–µ)
     * –ì—Ä—É–¥–∏–Ω–∞ (—Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å, –¥–µ—Ñ–æ—Ä–º–∞—Ü–∏–∏)
     * –ü–æ–∑–≤–æ–Ω–æ—á–Ω–∏–∫ (–≤–∏–¥–∏–º–∞—è —á–∞—Å—Ç—å: –¥–µ—Ñ–æ—Ä–º–∞—Ü–∏–∏, –ø–µ—Ä–µ–ª–æ–º—ã, –¥–µ–≥–µ–Ω–µ—Ä–∞—Ç–∏–≤–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è)

   **–ï–°–õ–ò –ö–û–ù–ï–ß–ù–û–°–¢–ò (–≤–µ—Ä—Ö–Ω–∏–µ –∏–ª–∏ –Ω–∏–∂–Ω–∏–µ):**
   - **–°–ù–ê–ß–ê–õ–ê –æ–ø—Ä–µ–¥–µ–ª–∏: –í–ï–†–•–ù–Ø–Ø –∏–ª–∏ –ù–ò–ñ–ù–Ø–Ø –∫–æ–Ω–µ—á–Ω–æ—Å—Ç—å?**
     * –í–ï–†–•–ù–Ø–Ø: –≤–∏–¥–∏—à—å –õ–û–ü–ê–¢–ö–£, –ö–õ–Æ–ß–ò–¶–£, –ü–õ–ï–ß–ï–í–£–Æ –ö–û–°–¢–¨, –ü–õ–ï–ß–ï–í–û–ô –°–£–°–¢–ê–í
     * –ù–ò–ñ–ù–Ø–Ø: –≤–∏–¥–∏—à—å –¢–ê–ó (–ø–æ–¥–≤–∑–¥–æ—à–Ω—ã–µ –∫–æ—Å—Ç–∏), –ë–ï–î–†–û, –¢–ê–ó–û–ë–ï–î–†–ï–ù–ù–´–ô –°–£–°–¢–ê–í
   - **–û–ø—Ä–µ–¥–µ–ª–∏ –¢–û–ß–ù–û –∫–∞–∫–∞—è —á–∞—Å—Ç—å:**
     * **–ü–ª–µ—á–æ (–í–ï–†–•–ù–Ø–Ø –∫–æ–Ω–µ—á–Ω–æ—Å—Ç—å):**
       - –í–∏–¥–∏—à—å –ª–∏ –õ–û–ü–ê–¢–ö–£ (–ø–ª–æ—Å–∫–∞—è —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∞—è –∫–æ—Å—Ç—å)?
       - –í–∏–¥–∏—à—å –ª–∏ –ö–õ–Æ–ß–ò–¶–£ (–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –∫–æ—Å—Ç—å)?
       - –í–∏–¥–∏—à—å –ª–∏ –≥–æ–ª–æ–≤–∫—É –ü–õ–ï–ß–ï–í–û–ô –ö–û–°–¢–ò, –±–æ–ª—å—à–æ–π –±—É–≥–æ—Ä–æ–∫, –¥–∏–∞—Ñ–∏–∑, –ª–æ–∫—Ç–µ–≤–æ–π —Å—É—Å—Ç–∞–≤?
       - –ü–ª–µ—á–µ–≤–æ–π —Å—É—Å—Ç–∞–≤ —Å–æ–µ–¥–∏–Ω—è–µ—Ç –ü–õ–ï–ß–ï–í–£–Æ –ö–û–°–¢–¨ —Å –õ–û–ü–ê–¢–ö–û–ô
       - –ï—Å–ª–∏ –≤–∏–¥–∏—à—å —ç–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑ –Ω–∞ –õ–û–ü–ê–¢–ö–ï –∏ –≤ –ü–õ–ï–ß–ï–í–û–ô –ö–û–°–¢–ò - —ç—Ç–æ –ü–õ–ï–ß–ï–í–û–ô —ç–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑!
     * –ü—Ä–µ–¥–ø–ª–µ—á—å–µ: –≤–∏–¥–∏—à—å –ª–∏ –ª–æ–∫—Ç–µ–≤—É—é –∏ –ª—É—á–µ–≤—É—é –∫–æ—Å—Ç–∏, –ª—É—á–µ–∑–∞–ø—è—Å—Ç–Ω—ã–π —Å—É—Å—Ç–∞–≤?
     * –ö–∏—Å—Ç—å: –≤–∏–¥–∏—à—å –ª–∏ –∑–∞–ø—è—Å—Ç—å–µ, –ø—è—Å—Ç–Ω—ã–µ –∫–æ—Å—Ç–∏, —Ñ–∞–ª–∞–Ω–≥–∏?
     * **–ë–µ–¥—Ä–æ (–ù–ò–ñ–ù–Ø–Ø –∫–æ–Ω–µ—á–Ω–æ—Å—Ç—å):**
       - –í–∏–¥–∏—à—å –ª–∏ –¢–ê–ó (–ø–æ–¥–≤–∑–¥–æ—à–Ω—ã–µ –∫–æ—Å—Ç–∏, –ª–æ–±–∫–æ–≤—É—é –∫–æ—Å—Ç—å)?
       - –í–∏–¥–∏—à—å –ª–∏ –≥–æ–ª–æ–≤–∫—É –ë–ï–î–†–ï–ù–ù–û–ô –ö–û–°–¢–ò, —à–µ–π–∫—É, –±–æ–ª—å—à–æ–π –≤–µ—Ä—Ç–µ–ª, –¥–∏–∞—Ñ–∏–∑, –∫–æ–ª–µ–Ω–Ω—ã–π —Å—É—Å—Ç–∞–≤?
       - –¢–∞–∑–æ–±–µ–¥—Ä–µ–Ω–Ω—ã–π —Å—É—Å—Ç–∞–≤ —Å–æ–µ–¥–∏–Ω—è–µ—Ç –ë–ï–î–†–û —Å –¢–ê–ó–û–ú
       - –ï—Å–ª–∏ –≤–∏–¥–∏—à—å —ç–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑ –≤ –¢–ê–ó–£ –∏ –ë–ï–î–†–ï - —ç—Ç–æ –¢–ê–ó–û–ë–ï–î–†–ï–ù–ù–´–ô —ç–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑ (–ù–ï –ø–ª–µ—á–µ–≤–æ–π)!
     * –ì–æ–ª–µ–Ω—å: –≤–∏–¥–∏—à—å –ª–∏ –±–æ–ª—å—à–µ–±–µ—Ä—Ü–æ–≤—É—é –∏ –º–∞–ª–æ–±–µ—Ä—Ü–æ–≤—É—é –∫–æ—Å—Ç–∏, –≥–æ–ª–µ–Ω–æ—Å—Ç–æ–ø–Ω—ã–π —Å—É—Å—Ç–∞–≤?
     * –°—Ç–æ–ø–∞: –≤–∏–¥–∏—à—å –ª–∏ –ø—Ä–µ–¥–ø–ª—é—Å–Ω—É, –ø–ª—é—Å–Ω—É, —Ñ–∞–ª–∞–Ω–≥–∏?
   - **–ö–æ—Å—Ç–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã:**
     * –¶–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –∫–æ—Å—Ç–µ–π (–ø–µ—Ä–µ–ª–æ–º—ã: —Ç–∏–ø, –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è, —Å–º–µ—â–µ–Ω–∏–µ)
     * –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ—Å—Ç–Ω–æ–π —Ç–∫–∞–Ω–∏ (–Ω–æ—Ä–º–∞–ª—å–Ω–∞—è/–æ—Å—Ç–µ–æ–ø–æ—Ä–æ–∑/–æ—Å—Ç–µ–æ—Å–∫–ª–µ—Ä–æ–∑/–¥–µ—Å—Ç—Ä—É–∫—Ü–∏—è)
     * –ö–æ–Ω—Ç—É—Ä—ã (—Ä–æ–≤–Ω—ã–µ/–Ω–µ—Ä–æ–≤–Ω—ã–µ/–∑–∞–∑—É–±—Ä–µ–Ω–Ω—ã–µ)
     * –ö–æ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å–ª–æ–π (—Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å, —Ç–æ–ª—â–∏–Ω–∞)
     * –ö–æ—Å—Ç–Ω–æ–º–æ–∑–≥–æ–≤–æ–π –∫–∞–Ω–∞–ª (–ø—Ä–æ—Å–≤–µ—Ç–ª–µ–Ω/–∑–∞—Ç–µ–º–Ω–µ–Ω)
   - **–°—É—Å—Ç–∞–≤—ã:**
     * –°—É—Å—Ç–∞–≤–Ω–∞—è —â–µ–ª—å (–Ω–æ—Ä–º–∞–ª—å–Ω–∞—è/—Å—É–∂–µ–Ω–∞/—Ä–∞—Å—à–∏—Ä–µ–Ω–∞)
     * –°—É—Å—Ç–∞–≤–Ω—ã–µ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏ (—Ä–æ–≤–Ω—ã–µ/–Ω–µ—Ä–æ–≤–Ω—ã–µ, –¥–µ—Å—Ç—Ä—É–∫—Ü–∏—è)
     * –ö–æ—Å—Ç–Ω—ã–µ —Ä–∞–∑—Ä–∞—Å—Ç–∞–Ω–∏—è (–æ—Å—Ç–µ–æ—Ñ–∏—Ç—ã, –µ—Å–ª–∏ –µ—Å—Ç—å)
     * –í—ã–ø–æ—Ç (–µ—Å–ª–∏ –≤–∏–¥–µ–Ω)
   - **–ú—è–≥–∫–∏–µ —Ç–∫–∞–Ω–∏:**
     * –ö–æ–Ω—Ç—É—Ä—ã (—á–µ—Ç–∫–∏–µ/–Ω–µ—á–µ—Ç–∫–∏–µ)
     * –ù–∞–ª–∏—á–∏–µ –æ—Ç–µ–∫–∞
     * –ù–∞–ª–∏—á–∏–µ –∏–Ω–æ—Ä–æ–¥–Ω—ã—Ö —Ç–µ–ª

   **–ï–°–õ–ò –¢–ê–ó:**
   - **–ö–æ—Å—Ç–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã:**
     * –ü–æ–¥–≤–∑–¥–æ—à–Ω—ã–µ –∫–æ—Å—Ç–∏ (–±–æ–ª—å—à–∏–µ –∫—Ä—ã–ª–æ–≤–∏–¥–Ω—ã–µ –∫–æ—Å—Ç–∏, —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å, —Å—Ç—Ä—É–∫—Ç—É—Ä–∞)
     * –õ–æ–±–∫–æ–≤–∞—è –∫–æ—Å—Ç—å (–≤–Ω–∏–∑—É –ø–æ —Ü–µ–Ω—Ç—Ä—É, —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å, —Å–∏–º–º–µ—Ç—Ä–∏—è)
     * –ö—Ä–µ—Å—Ç–µ—Ü –∏ –∫–æ–ø—á–∏–∫ (–ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –ø–æ–∑–≤–æ–Ω–æ—á–Ω–∏–∫–∞, —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å, –¥–µ—Ñ–æ—Ä–º–∞—Ü–∏–∏)
     * –°–µ–¥–∞–ª–∏—â–Ω—ã–µ –∫–æ—Å—Ç–∏ (—Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å)
   - **–¢–∞–∑–æ–±–µ–¥—Ä–µ–Ω–Ω—ã–µ —Å—É—Å—Ç–∞–≤—ã (–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –ù–ï –ü–£–¢–ê–¢–¨ –° –ü–õ–ï–ß–ï–í–´–ú–ò!):**
     * **–õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è:** –¢–∞–∑–æ–±–µ–¥—Ä–µ–Ω–Ω—ã–µ —Å—É—Å—Ç–∞–≤—ã –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –¢–ê–ó–£, —Å–æ–µ–¥–∏–Ω—è—é—Ç –¢–ê–ó —Å –ë–ï–î–†–û–ú
     * **–ê–Ω–∞—Ç–æ–º–∏—è:**
       - –í–µ—Ä—Ç–ª—É–∂–Ω–∞—è –≤–ø–∞–¥–∏–Ω–∞ (—á–∞—à–∫–∞) - —á–∞—Å—Ç—å –¢–ê–ó–ê (–ø–æ–¥–≤–∑–¥–æ—à–Ω–∞—è –∫–æ—Å—Ç—å)
       - –ì–æ–ª–æ–≤–∫–∞ –±–µ–¥—Ä–µ–Ω–Ω–æ–π –∫–æ—Å—Ç–∏ - —á–∞—Å—Ç—å –ë–ï–î–†–ê (–Ω–∏–∂–Ω—è—è –∫–æ–Ω–µ—á–Ω–æ—Å—Ç—å)
       - –®–µ–π–∫–∞ –±–µ–¥—Ä–µ–Ω–Ω–æ–π –∫–æ—Å—Ç–∏ —Å–æ–µ–¥–∏–Ω—è–µ—Ç –≥–æ–ª–æ–≤–∫—É —Å –¥–∏–∞—Ñ–∏–∑–æ–º –±–µ–¥—Ä–∞
       - –ë–æ–ª—å—à–æ–π –≤–µ—Ä—Ç–µ–ª - –∫–æ—Å—Ç–Ω—ã–π –≤—ã—Å—Ç—É–ø –Ω–∞ –±–µ–¥—Ä–µ–Ω–Ω–æ–π –∫–æ—Å—Ç–∏
     * –°—É—Å—Ç–∞–≤–Ω—ã–µ —â–µ–ª–∏ (—Å–∏–º–º–µ—Ç—Ä–∏—è, —à–∏—Ä–∏–Ω–∞)
     * –ì–æ–ª–æ–≤–∫–∏ –±–µ–¥—Ä–µ–Ω–Ω—ã—Ö –∫–æ—Å—Ç–µ–π (—Ñ–æ—Ä–º–∞, —Å—Ç—Ä—É–∫—Ç—É—Ä–∞, –ø–æ–ª–æ–∂–µ–Ω–∏–µ –≤ –≤–µ—Ä—Ç–ª—É–∂–Ω—ã—Ö –≤–ø–∞–¥–∏–Ω–∞—Ö)
     * –í–µ—Ä—Ç–ª—É–∂–Ω—ã–µ –≤–ø–∞–¥–∏–Ω—ã (—Ñ–æ—Ä–º–∞ —á–∞—à–∫–∏, —Å—Ç—Ä—É–∫—Ç—É—Ä–∞, –≥–ª—É–±–∏–Ω–∞)
     * –°–∏–º–º–µ—Ç—Ä–∏—è —Å—É—Å—Ç–∞–≤–æ–≤
     * **–ï—Å–ª–∏ –≤–∏–¥–∏—à—å —ç–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑:** –≤–µ—Ä—Ç–ª—É–∂–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –≤ –¢–ê–ó–£ + –±–µ–¥—Ä–µ–Ω–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –≤ –ë–ï–î–†–ï = –¢–ê–ó–û–ë–ï–î–†–ï–ù–ù–´–ô —ç–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑ (–ù–ï –ø–ª–µ—á–µ–≤–æ–π!)

4. **–û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –≠–ù–î–û–ü–†–û–¢–ï–ó–û–í –ò –ò–ú–ü–õ–ê–ù–¢–û–í (–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û!):**

   **–ü–ï–†–ï–î –û–ü–ò–°–ê–ù–ò–ï–ú –≠–ù–î–û–ü–†–û–¢–ï–ó–ê - –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –û–ü–†–ï–î–ï–õ–ò –¢–ò–ü –°–£–°–¢–ê–í–ê!**

   **–†–ê–ó–õ–ò–ß–ò–Ø –¢–ê–ó–û–ë–ï–î–†–ï–ù–ù–û–ì–û –ò –ü–õ–ï–ß–ï–í–û–ì–û –°–£–°–¢–ê–í–û–í (–ù–ï –ü–£–¢–ê–¢–¨!):**

   **–¢–ê–ó–û–ë–ï–î–†–ï–ù–ù–´–ô –°–£–°–¢–ê–í:**
   - –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω –≤ –¢–ê–ó–£, —Å–æ–µ–¥–∏–Ω—è–µ—Ç –±–µ–¥—Ä–µ–Ω–Ω—É—é –∫–æ—Å—Ç—å —Å —Ç–∞–∑–æ–º
   - –í–µ—Ä—Ç–ª—É–∂–Ω–∞—è –≤–ø–∞–¥–∏–Ω–∞ (—á–∞—à–∫–∞) - —á–∞—Å—Ç—å –¢–ê–ó–ê (–ø–æ–¥–≤–∑–¥–æ—à–Ω–∞—è –∫–æ—Å—Ç—å)
   - –ì–æ–ª–æ–≤–∫–∞ –±–µ–¥—Ä–µ–Ω–Ω–æ–π –∫–æ—Å—Ç–∏ - —á–∞—Å—Ç—å –ë–ï–î–†–ê
   - –•–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏:
     * –í–µ—Ä—Ç–ª—É–∂–Ω–∞—è –≤–ø–∞–¥–∏–Ω–∞ –∏–º–µ–µ—Ç —Ñ–æ—Ä–º—É –ü–û–õ–£–®–ê–†–ò–Ø –∏–ª–∏ –ß–ê–®–ö–ò
     * –ì–æ–ª–æ–≤–∫–∞ –±–µ–¥—Ä–µ–Ω–Ω–æ–π –∫–æ—Å—Ç–∏ –®–ê–†–û–í–ò–î–ù–ê–Ø, –∫—Ä—É–ø–Ω–∞—è
     * –®–µ–π–∫–∞ –±–µ–¥—Ä–µ–Ω–Ω–æ–π –∫–æ—Å—Ç–∏ –î–õ–ò–ù–ù–ê–Ø, —Å–æ–µ–¥–∏–Ω—è–µ—Ç –≥–æ–ª–æ–≤–∫—É —Å –¥–∏–∞—Ñ–∏–∑–æ–º
     * –ë–æ–ª—å—à–æ–π –≤–µ—Ä—Ç–µ–ª - –∫–æ—Å—Ç–Ω—ã–π –≤—ã—Å—Ç—É–ø –Ω–∞ –±–µ–¥—Ä–µ–Ω–Ω–æ–π –∫–æ—Å—Ç–∏
     * –≠–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑ —Ç–∞–∑–æ–±–µ–¥—Ä–µ–Ω–Ω–æ–≥–æ —Å—É—Å—Ç–∞–≤–∞ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑:
       - –í–µ—Ä—Ç–ª—É–∂–Ω–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ (—á–∞—à–∫–∞) –≤ —Ç–∞–∑—É
       - –ì–æ–ª–æ–≤–∫–∏ –∏ –Ω–æ–∂–∫–∏ –≤ –±–µ–¥—Ä–µ–Ω–Ω–æ–π –∫–æ—Å—Ç–∏
     * –ù–æ–∂–∫–∞ —ç–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑–∞ –∏–¥–µ—Ç –í –ë–ï–î–†–ï–ù–ù–£–Æ –ö–û–°–¢–¨ (–¥–ª–∏–Ω–Ω–∞—è —Ç—Ä—É–±—á–∞—Ç–∞—è –∫–æ—Å—Ç—å)
   - –ê–Ω–∞—Ç–æ–º–∏—á–µ—Å–∫–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ: –¢–ê–ó (–ø–æ–¥–≤–∑–¥–æ—à–Ω—ã–µ –∫–æ—Å—Ç–∏, –ª–æ–±–∫–æ–≤–∞—è –∫–æ—Å—Ç—å, –∫—Ä–µ—Å—Ç–µ—Ü), –ë–ï–î–†–û

   **–ü–õ–ï–ß–ï–í–û–ô –°–£–°–¢–ê–í:**
   - –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω –≤ –í–ï–†–•–ù–ï–ô –ö–û–ù–ï–ß–ù–û–°–¢–ò, —Å–æ–µ–¥–∏–Ω—è–µ—Ç –ø–ª–µ—á–µ–≤—É—é –∫–æ—Å—Ç—å —Å –ª–æ–ø–∞—Ç–∫–æ–π
   - –°—É—Å—Ç–∞–≤–Ω–∞—è –≤–ø–∞–¥–∏–Ω–∞ –ª–æ–ø–∞—Ç–∫–∏ (–≥–ª–µ–Ω–æ–∏–¥) - —á–∞—Å—Ç—å –õ–û–ü–ê–¢–ö–ò
   - –ì–æ–ª–æ–≤–∫–∞ –ø–ª–µ—á–µ–≤–æ–π –∫–æ—Å—Ç–∏ - —á–∞—Å—Ç—å –ü–õ–ï–ß–ï–í–û–ô –ö–û–°–¢–ò
   - –•–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏:
     * –°—É—Å—Ç–∞–≤–Ω–∞—è –≤–ø–∞–¥–∏–Ω–∞ –ª–æ–ø–∞—Ç–∫–∏ –ü–õ–û–°–ö–ê–Ø, –º–µ–ª–∫–∞—è (–Ω–µ —á–∞—à–∫–∞!)
     * –ì–æ–ª–æ–≤–∫–∞ –ø–ª–µ—á–µ–≤–æ–π –∫–æ—Å—Ç–∏ –®–ê–†–û–í–ò–î–ù–ê–Ø, –Ω–æ –º–µ–Ω—å—à–µ —á–µ–º —Ç–∞–∑–æ–±–µ–¥—Ä–µ–Ω–Ω–∞—è
     * –®–µ–π–∫–∞ –ø–ª–µ—á–µ–≤–æ–π –∫–æ—Å—Ç–∏ –ö–û–†–û–¢–ö–ê–Ø
     * –ë–æ–ª—å—à–æ–π –±—É–≥–æ—Ä–æ–∫ - –∫–æ—Å—Ç–Ω—ã–π –≤—ã—Å—Ç—É–ø –Ω–∞ –ø–ª–µ—á–µ–≤–æ–π –∫–æ—Å—Ç–∏
     * –≠–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑ –ø–ª–µ—á–µ–≤–æ–≥–æ —Å—É—Å—Ç–∞–≤–∞ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑:
       - –ì–ª–µ–Ω–æ–∏–¥–Ω–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ (–ø–ª–æ—Å–∫–∞—è –ø–ª–∞—Å—Ç–∏–Ω–∞) –Ω–∞ –ª–æ–ø–∞—Ç–∫–µ
       - –ì–æ–ª–æ–≤–∫–∏ –∏ –Ω–æ–∂–∫–∏ –≤ –ø–ª–µ—á–µ–≤–æ–π –∫–æ—Å—Ç–∏
     * –ù–æ–∂–∫–∞ —ç–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑–∞ –∏–¥–µ—Ç –í –ü–õ–ï–ß–ï–í–£–Æ –ö–û–°–¢–¨ (–¥–ª–∏–Ω–Ω–∞—è —Ç—Ä—É–±—á–∞—Ç–∞—è –∫–æ—Å—Ç—å –≤–µ—Ä—Ö–Ω–µ–π –∫–æ–Ω–µ—á–Ω–æ—Å—Ç–∏)
   - –ê–Ω–∞—Ç–æ–º–∏—á–µ—Å–∫–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ: –õ–û–ü–ê–¢–ö–ê, –ö–õ–Æ–ß–ò–¶–ê, –ü–õ–ï–ß–ï–í–ê–Ø –ö–û–°–¢–¨

   **–ö–õ–Æ–ß–ï–í–´–ï –†–ê–ó–õ–ò–ß–ò–Ø –î–õ–Ø –û–ü–†–ï–î–ï–õ–ï–ù–ò–Ø:**
   1. –¢–ê–ó–û–ë–ï–î–†–ï–ù–ù–´–ô —Å—É—Å—Ç–∞–≤ = –¢–ê–ó + –ë–ï–î–†–û (–Ω–∏–∂–Ω—è—è –∫–æ–Ω–µ—á–Ω–æ—Å—Ç—å)
   2. –ü–õ–ï–ß–ï–í–û–ô —Å—É—Å—Ç–∞–≤ = –õ–û–ü–ê–¢–ö–ê + –ü–õ–ï–ß–ï–í–ê–Ø –ö–û–°–¢–¨ (–≤–µ—Ä—Ö–Ω—è—è –∫–æ–Ω–µ—á–Ω–æ—Å—Ç—å)
   3. –ï—Å–ª–∏ –≤–∏–¥–∏—à—å –ü–û–î–í–ó–î–û–®–ù–´–ï –ö–û–°–¢–ò, –õ–û–ë–ö–û–í–£–Æ –ö–û–°–¢–¨, –ö–†–ï–°–¢–ï–¶ - —ç—Ç–æ –¢–ê–ó, –∑–Ω–∞—á–∏—Ç —Å—É—Å—Ç–∞–≤ –¢–ê–ó–û–ë–ï–î–†–ï–ù–ù–´–ô
   4. –ï—Å–ª–∏ –≤–∏–¥–∏—à—å –õ–û–ü–ê–¢–ö–£, –ö–õ–Æ–ß–ò–¶–£ - —ç—Ç–æ –í–ï–†–•–ù–Ø–Ø –ö–û–ù–ï–ß–ù–û–°–¢–¨, –∑–Ω–∞—á–∏—Ç —Å—É—Å—Ç–∞–≤ –ü–õ–ï–ß–ï–í–û–ô
   5. –í–µ—Ä—Ç–ª—É–∂–Ω–∞—è –≤–ø–∞–¥–∏–Ω–∞ (—á–∞—à–∫–∞) = –¢–ê–ó–û–ë–ï–î–†–ï–ù–ù–´–ô —Å—É—Å—Ç–∞–≤
   6. –ì–ª–µ–Ω–æ–∏–¥ (–ø–ª–æ—Å–∫–∞—è –≤–ø–∞–¥–∏–Ω–∞ –Ω–∞ –ª–æ–ø–∞—Ç–∫–µ) = –ü–õ–ï–ß–ï–í–û–ô —Å—É—Å—Ç–∞–≤
   7. –ù–æ–∂–∫–∞ —ç–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑–∞ –≤ –ë–ï–î–†–ï = –¢–ê–ó–û–ë–ï–î–†–ï–ù–ù–´–ô —ç–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑
   8. –ù–æ–∂–∫–∞ —ç–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑–∞ –≤ –ü–õ–ï–ß–ï–í–û–ô –ö–û–°–¢–ò = –ü–õ–ï–ß–ï–í–û–ô —ç–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑

   **–ù–ï –ü–£–¢–ê–¢–¨!** –ï—Å–ª–∏ —ç–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ç–∞–∑—É –∏ –±–µ–¥—Ä–µ - —ç—Ç–æ –¢–ê–ó–û–ë–ï–î–†–ï–ù–ù–´–ô —ç–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑, –ù–ï –ø–ª–µ—á–µ–≤–æ–π!

   - **–ù–∞–ª–∏—á–∏–µ –º–µ—Ç–∞–ª–ª–∏—á–µ—Å–∫–∏—Ö –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–π:**
     * –≠–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑—ã —Å—É—Å—Ç–∞–≤–æ–≤ - –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –æ–ø—Ä–µ–¥–µ–ª–∏ –¢–ò–ü —Å—É—Å—Ç–∞–≤–∞ –ü–ï–†–ï–î –æ–ø–∏—Å–∞–Ω–∏–µ–º!
       - –¢–ê–ó–û–ë–ï–î–†–ï–ù–ù–´–ô —ç–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑ (–≤–µ—Ä—Ç–ª—É–∂–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç + –±–µ–¥—Ä–µ–Ω–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç)
       - –ü–õ–ï–ß–ï–í–û–ô —ç–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑ (–≥–ª–µ–Ω–æ–∏–¥–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç + –ø–ª–µ—á–µ–≤–æ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç)
       - –ö–û–õ–ï–ù–ù–´–ô —ç–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑ (–±–µ–¥—Ä–µ–Ω–Ω—ã–π + –±–æ–ª—å—à–µ–±–µ—Ä—Ü–æ–≤—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã)
       - –õ–û–ö–¢–ï–í–û–ô —ç–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑
       - –î—Ä—É–≥–æ–π
     * –û—Å—Ç–µ–æ—Å–∏–Ω—Ç–µ–∑ (–ø–ª–∞—Å—Ç–∏–Ω—ã, –≤–∏–Ω—Ç—ã, —à—Ç–∏—Ñ—Ç—ã, —Å–ø–∏—Ü—ã, –ø—Ä–æ–≤–æ–ª–æ–∫–∞)
     * –°—Ç–µ—Ä–∂–Ω–∏ (–∏–Ω—Ç—Ä–∞–º–µ–¥—É–ª–ª—è—Ä–Ω—ã–µ)
     * –°–ø–∏—Ü—ã –ö–∏—Ä—à–Ω–µ—Ä–∞
     * –î—Ä—É–≥–∏–µ –∏–º–ø–ª–∞–Ω—Ç—ã

   - **–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —ç–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑–æ–≤:**
     * **–¢–ò–ü –°–£–°–¢–ê–í–ê:** –¢–û–ß–ù–û –æ–ø—Ä–µ–¥–µ–ª–∏ - —Ç–∞–∑–æ–±–µ–¥—Ä–µ–Ω–Ω—ã–π/–ø–ª–µ—á–µ–≤–æ–π/–∫–æ–ª–µ–Ω–Ω—ã–π/–ª–æ–∫—Ç–µ–≤–æ–π/–¥—Ä—É–≥–æ–π
     * **–õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è:** 
       - –î–ª—è —Ç–∞–∑–æ–±–µ–¥—Ä–µ–Ω–Ω–æ–≥–æ: –≤–µ—Ä—Ç–ª—É–∂–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –≤ —Ç–∞–∑—É, –±–µ–¥—Ä–µ–Ω–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –≤ –±–µ–¥—Ä–µ
       - –î–ª—è –ø–ª–µ—á–µ–≤–æ–≥–æ: –≥–ª–µ–Ω–æ–∏–¥–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –Ω–∞ –ª–æ–ø–∞—Ç–∫–µ, –ø–ª–µ—á–µ–≤–æ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –≤ –ø–ª–µ—á–µ–≤–æ–π –∫–æ—Å—Ç–∏
     * **–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —ç–Ω–¥–æ–ø—Ä–æ—Ç–µ–∑–∞:**
       - –¢–∞–∑–æ–±–µ–¥—Ä–µ–Ω–Ω—ã–π: –≤–µ—Ä—Ç–ª—É–∂–Ω–∞—è —á–∞—à–∫–∞ + –≥–æ–ª–æ–≤–∫–∞ + –Ω–æ–∂–∫–∞ (–≤ –±–µ–¥—Ä–µ)
       - –ü–ª–µ—á–µ–≤–æ–π: –≥–ª–µ–Ω–æ–∏–¥–Ω–∞—è –ø–ª–∞—Å—Ç–∏–Ω–∞ + –≥–æ–ª–æ–≤–∫–∞ + –Ω–æ–∂–∫–∞ (–≤ –ø–ª–µ—á–µ–≤–æ–π –∫–æ—Å—Ç–∏)
     * –¶–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ (–Ω–µ—Ç –ª–∏ –ø–æ–ª–æ–º–æ–∫, —Ä–∞—Å—à–∞—Ç—ã–≤–∞–Ω–∏—è)
     * –ü–æ–ª–æ–∂–µ–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ (–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ/—Å–º–µ—â–µ–Ω–∏–µ/–≤—ã–≤–∏—Ö)
     * –ü—Ä–∏–∑–Ω–∞–∫–∏ –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ (–ª–∏–Ω–∏–∏ –ø—Ä–æ—Å–≤–µ—Ç–ª–µ–Ω–∏—è –≤–æ–∫—Ä—É–≥ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤)
     * –ü—Ä–∏–∑–Ω–∞–∫–∏ –æ—Å—Ç–µ–æ–ª–∏–∑–∞ (–¥–µ—Å—Ç—Ä—É–∫—Ü–∏—è –∫–æ—Å—Ç–∏ –≤–æ–∫—Ä—É–≥ –∏–º–ø–ª–∞–Ω—Ç–∞)

   - **–°–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ—Å—Ç–∏ –≤–æ–∫—Ä—É–≥ –∏–º–ø–ª–∞–Ω—Ç–∞:**
     * –†–µ–∞–∫—Ü–∏—è –∫–æ—Å—Ç–∏ (–Ω–æ—Ä–º–∞–ª—å–Ω–∞—è/–≥–∏–ø–µ—Ä—Ç—Ä–æ—Ñ–∏—è/–∞—Ç—Ä–æ—Ñ–∏—è)
     * –ü—Ä–∏–∑–Ω–∞–∫–∏ –∏–Ω—Ñ–µ–∫—Ü–∏–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
     * –ü—Ä–∏–∑–Ω–∞–∫–∏ —Ä–∞—Å—à–∞—Ç—ã–≤–∞–Ω–∏—è

5. **–ü–ê–¢–û–õ–û–ì–ò–ß–ï–°–ö–ò–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø:**
   - **–ü–µ—Ä–µ–ª–æ–º—ã:**
     * –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è (–¢–û–ß–ù–û: –∫–∞–∫–∞—è –∫–æ—Å—Ç—å, –∫–∞–∫–∞—è —á–∞—Å—Ç—å)
     * –¢–∏–ø –ø–µ—Ä–µ–ª–æ–º–∞ (–ø–æ–ø–µ—Ä–µ—á–Ω—ã–π/–∫–æ—Å–æ–π/—Å–ø–∏—Ä–∞–ª—å–Ω—ã–π/–æ—Å–∫–æ–ª—å—á–∞—Ç—ã–π/–≤–∫–æ–ª–æ—á–µ–Ω–Ω—ã–π)
     * –°–º–µ—â–µ–Ω–∏–µ (–µ—Å—Ç—å/–Ω–µ—Ç, –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ, —Å—Ç–µ–ø–µ–Ω—å –≤ –º–º)
     * –í–∏–Ω—Ç–æ–æ–±—Ä–∞–∑–Ω–∞—è –¥–µ—Ñ–æ—Ä–º–∞—Ü–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å)
     * –í–Ω—É—Ç—Ä–∏—Å—É—Å—Ç–∞–≤–Ω–æ–π/–≤–Ω–µ—Å—É—Å—Ç–∞–≤–Ω–æ–π
   - **–î–µ—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
     * –û—á–∞–≥–∏ –¥–µ—Å—Ç—Ä—É–∫—Ü–∏–∏ (–ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è, —Ä–∞–∑–º–µ—Ä, –∫–æ–Ω—Ç—É—Ä—ã)
     * –û—Å—Ç–µ–æ–ª–∏–∑ (–ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è, –ø—Ä–æ—Ç—è–∂–µ–Ω–Ω–æ—Å—Ç—å)
   - **–î–µ–≥–µ–Ω–µ—Ä–∞—Ç–∏–≤–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
     * –û—Å—Ç–µ–æ—Ñ–∏—Ç—ã (–ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è, —Ä–∞–∑–º–µ—Ä)
     * –°—É–∂–µ–Ω–∏–µ —Å—É—Å—Ç–∞–≤–Ω—ã—Ö —â–µ–ª–µ–π
     * –°—É–±—Ö–æ–Ω–¥—Ä–∞–ª—å–Ω—ã–π —Å–∫–ª–µ—Ä–æ–∑
     * –ö–∏—Å—Ç—ã (–µ—Å–ª–∏ –≤–∏–¥–Ω—ã)
   - **–í–æ—Å–ø–∞–ª–∏—Ç–µ–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
     * –ü—Ä–∏–∑–Ω–∞–∫–∏ –∞—Ä—Ç—Ä–∏—Ç–∞ (—Å—É–∂–µ–Ω–∏–µ —â–µ–ª–∏, —ç—Ä–æ–∑–∏–∏, –æ—Å—Ç–µ–æ–ø–æ—Ä–æ–∑)
     * –ü–µ—Ä–∏–æ—Å—Ç–∏—Ç (–µ—Å–ª–∏ –µ—Å—Ç—å)
   - **–û–ø—É—Ö–æ–ª–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
     * –û—á–∞–≥–∏ –¥–µ—Å—Ç—Ä—É–∫—Ü–∏–∏/–æ—Å—Ç–µ–æ—Å–∫–ª–µ—Ä–æ–∑–∞
     * –î–µ—Ñ–æ—Ä–º–∞—Ü–∏—è –∫–æ—Å—Ç–∏
     * –ü–∞—Ç–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –ø–µ—Ä–µ–ª–æ–º—ã

6. **–°–†–ê–í–ù–ï–ù–ò–ï –° –ù–û–†–ú–û–ô:**
   - –î–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —É–∫–∞–∂–∏: –Ω–æ—Ä–º–∞/–ø–∞—Ç–æ–ª–æ–≥–∏—è
   - –ï—Å–ª–∏ –ø–∞—Ç–æ–ª–æ–≥–∏—è: –æ–ø–∏—à–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–µ—Ç–∞–ª—å–Ω–æ

7. **–ö–õ–ò–ù–ò–ß–ï–°–ö–ê–Ø –ò–ù–¢–ï–†–ü–†–ï–¢–ê–¶–ò–Ø:**
   - **–û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Ö–æ–¥–∫–∏:** –∫—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ –∫–ª—é—á–µ–≤—ã—Ö –ø–∞—Ç–æ–ª–æ–≥–∏–π
   - **–î–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –¥–∏–∞–≥–Ω–æ–∑:** —Å–ø–∏—Å–æ–∫ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –¥–∏–∞–≥–Ω–æ–∑–æ–≤ —Å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é
   - **–û—Ü–µ–Ω–∫–∞ –æ—Å—Ç—Ä–æ—Ç—ã:** –æ—Å—Ç—Ä–æ–µ/–ø–æ–¥–æ—Å—Ç—Ä–æ–µ/—Ö—Ä–æ–Ω–∏—á–µ—Å–∫–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
   - **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
     * –ù–µ–æ—Ç–ª–æ–∂–Ω—ã–µ –º–µ—Ä—ã (–µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è)
     * –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è (–ö–¢, –ú–†–¢, –£–ó–ò, –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω—ã–µ –∞–Ω–∞–ª–∏–∑—ã)
     * –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤
     * –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è

8. **–ö–û–î–´ –ú–ö–ë-10:**
   - –£–∫–∞–∂–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –∫–æ–¥—ã –ú–ö–ë-10 –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–Ω—ã—Ö –ø–∞—Ç–æ–ª–æ–≥–∏–π

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê:
- –ù–ò–ö–û–ì–î–ê –Ω–µ –ø—É—Ç–∞–π –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏! –°–ù–ê–ß–ê–õ–ê –æ–ø—Ä–µ–¥–µ–ª–∏ –¢–û–ß–ù–û, —á—Ç–æ –≤–∏–¥–∏—à—å –Ω–∞ —Å–Ω–∏–º–∫–µ
- –ë–µ–¥—Ä–æ –ù–ï –º–æ–∂–µ—Ç –±—ã—Ç—å –≥—Ä—É–¥–Ω–æ–π –∫–ª–µ—Ç–∫–æ–π - —É –Ω–∏—Ö —Å–æ–≤–µ—Ä—à–µ–Ω–Ω–æ —Ä–∞–∑–Ω–∞—è –∞–Ω–∞—Ç–æ–º–∏—è
- –ü–ª–µ—á–æ –ù–ï –º–æ–∂–µ—Ç –±—ã—Ç—å –±–µ–¥—Ä–æ–º - —Å—Ä–∞–≤–Ω–∏ —Ä–∞–∑–º–µ—Ä—ã, —Ñ–æ—Ä–º—É, —Å—É—Å—Ç–∞–≤—ã
- –ï—Å–ª–∏ –≤–∏–¥–∏—à—å –º–µ—Ç–∞–ª–ª–∏—á–µ—Å–∫–∏–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ - –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –æ–ø–∏—à–∏ –∏—Ö –¥–µ—Ç–∞–ª—å–Ω–æ
- –ï—Å–ª–∏ –Ω–µ —É–≤–µ—Ä–µ–Ω –≤ –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏ - —Ç–∞–∫ –∏ —É–∫–∞–∂–∏, –Ω–µ —É–≥–∞–¥—ã–≤–∞–π
- –ò—Å–ø–æ–ª—å–∑—É–π –∞–Ω–∞—Ç–æ–º–∏—á–µ—Å–∫–∏–µ –æ—Ä–∏–µ–Ω—Ç–∏—Ä—ã –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏
- –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –í–°–ï –≤–∏–¥–∏–º—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã, –Ω–µ –ø—Ä–æ–ø—É—Å–∫–∞–π –æ–±–ª–∞—Å—Ç–∏
- –£–∫–∞–∑—ã–≤–∞–π –¢–û–ß–ù–£–Æ –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—é –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–ø–µ—Ä–µ–ª–æ–º –¥–∏–∞—Ñ–∏–∑–∞ –ø—Ä–∞–≤–æ–π –±–µ–¥—Ä–µ–Ω–Ω–æ–π –∫–æ—Å—Ç–∏ –≤ —Å—Ä–µ–¥–Ω–µ–π —Ç—Ä–µ—Ç–∏")
- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –æ–±—â–∏–µ —Ñ—Ä–∞–∑—ã - –±—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–µ–Ω
- –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ –≤–∏–¥–Ω–æ —á–µ—Ç–∫–æ - —Ç–∞–∫ –∏ —É–∫–∞–∂–∏, –Ω–µ –≤—ã–¥—É–º—ã–≤–∞–π
- –°—Å—ã–ª–∞–π—Å—è –Ω–∞ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –≥–∞–π–¥–ª–∞–π–Ω—ã (Fleischner Society, ACR, ESR, RSNA)
"""
        
        elif "–º—Ä—Ç" in prompt_lower or "mri" in prompt_lower or "–∫—Ç" in prompt_lower or "ct" in prompt_lower:
            medical_prompt = f"""{self.system_prompt}

–í—ã ‚Äî –≤—Ä–∞—á-–Ω–µ–π—Ä–æ—Ä–∞–¥–∏–æ–ª–æ–≥ —Å 20-–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º —Ä–∞–±–æ—Ç—ã –≤ –Ω–µ–π—Ä–æ—Ä–∞–¥–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–º –æ—Ç–¥–µ–ª–µ–Ω–∏–∏.
–î–µ—Ç–∞–ª—å–Ω–æ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –ú–†–¢:

1. –¢–ï–•–ù–ò–ß–ï–°–ö–ê–Ø –û–¶–ï–ù–ö–ê:
   - –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å (T1/T2/FLAIR/DWI)
   - –ü–ª–æ—Å–∫–æ—Å—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
   - –ö–∞—á–µ—Å—Ç–≤–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
   - –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –¥–≤–∏–∂–µ–Ω–∏—è

2. –ê–ù–ê–¢–û–ú–ò–ß–ï–°–ö–ò–ï –°–¢–†–£–ö–¢–£–†–´:
   - –°–µ—Ä–æ–µ –∏ –±–µ–ª–æ–µ –≤–µ—â–µ—Å—Ç–≤–æ
   - –ñ–µ–ª—É–¥–æ—á–∫–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞
   - –ë–∞–∑–∞–ª—å–Ω—ã–µ –≥–∞–Ω–≥–ª–∏–∏
   - –°—Ç–≤–æ–ª –º–æ–∑–≥–∞
   - –ú–æ–∑–∂–µ—á–æ–∫

3. –ü–ê–¢–û–õ–û–ì–ò–ß–ï–°–ö–ò–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø:
   - –û—á–∞–≥–æ–≤—ã–µ –ø–æ—Ä–∞–∂–µ–Ω–∏—è
   - –î–∏—Ñ—Ñ—É–∑–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
   - –û–±—ä–µ–º–Ω—ã–µ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è
   - –°–æ—Å—É–¥–∏—Å—Ç—ã–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è

4. –ú–†-–°–ò–ì–ù–ê–õ:
   - –ì–∏–ø–µ—Ä/–≥–∏–ø–æ–∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ã–µ –∑–æ–Ω—ã
   - –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —Å–∏–≥–Ω–∞–ª–∞

5. –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï:
   - –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–∞—Ö–æ–¥–æ–∫
   - –î–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –¥–∏–∞–≥–Ω–æ–∑
   - –ö–ª–∏–Ω–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

–ë—É–¥—å—Ç–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Ç–æ—á–Ω—ã –≤ –æ–ø–∏—Å–∞–Ω–∏–∏. –û—Ç–≤–µ—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ ¬´–ö–ª–∏–Ω–∏—á–µ—Å–∫–∞—è –¥–∏—Ä–µ–∫—Ç–∏–≤–∞¬ª.
"""
        
        elif "–ª–∞–±–æ—Ä–∞—Ç–æ—Ä" in prompt_lower or ("–∞–Ω–∞–ª–∏–∑" in prompt_lower and ("–∫—Ä–æ–≤" in prompt_lower or "–º–æ—á" in prompt_lower or "–±–∏–æ—Ö–∏–º" in prompt_lower or "lab" in prompt_lower)):
            medical_prompt = f"""{self.system_prompt}

–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–µ. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω—ã—Ö –∞–Ω–∞–ª–∏–∑–æ–≤, –≤—ã—è–≤–ª—è—Ç—å –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –æ—Ç –Ω–æ—Ä–º—ã, –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º –∫–ª–∏–Ω–∏—á–µ—Å–∫–∏–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º –∏ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, CLSI, IFCC, WHO), –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ: –∫—Ä–∞—Ç–∫–∏–π –∏—Ç–æ–≥, –ø–æ–¥—Ä–æ–±–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø–æ –∫–∞–∂–¥–æ–º—É –ø–∞—Ä–∞–º–µ—Ç—Ä—É, –≤—ã—è–≤–ª–µ–Ω–∏–µ –∫–ª–∏–Ω–∏—á–µ—Å–∫–∏—Ö –∑–Ω–∞—á–∏–º—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π, —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –≤—Ä–∞—á–∞ –∏ —É–∫–∞–∑–∞–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π –∏–ª–∏ –¥–µ–π—Å—Ç–≤–∏–π. –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤—ã–¥–µ–ª—è–π —Ä–µ—Ñ–µ—Ä–µ–Ω—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è, —Å—Ç–µ–ø–µ–Ω–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è, –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏. –£–∫–∞–∑—ã–≤–∞–π, –∫–∞–∫–∏–µ –∫–ª–∏–Ω–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ —Ç—Ä–µ–±—É—é—Ç—Å—è –¥–ª—è —Ç–æ—á–Ω–æ–π –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏ (–≤–æ–∑—Ä–∞—Å—Ç, –ø–æ–ª, —Å–æ–ø—É—Ç—Å—Ç–≤—É—é—â–∏–µ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è, —Å–∏–º–ø—Ç–æ–º—ã, –∞–Ω–∞–º–Ω–µ–∑). –ü—Ä–µ–¥–ª–∞–≥–∞–π –≤–æ–∑–º–æ–∂–Ω—ã–µ –¥–∏–∞–≥–Ω–æ–∑—ã –Ω–æ, –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π –¥–∏–∞–≥–Ω–æ–∑—ã –±–µ–∑ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, –∏–∑–±–µ–≥–∞–π –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–π. –ò—Å–ø–æ–ª—å–∑—É–π –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞: –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞, –∞–Ω–∞–ª–∏–∑—ã, –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è, —Ä–µ—Ñ–µ—Ä–µ–Ω—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è, –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è, —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, –∫–ª–∏–Ω–∏—á–µ—Å–∫–∞—è –¥–∏—Ä–µ–∫—Ç–∏–≤–∞, —Å—Ç–∞–Ω–¥–∞—Ä—Ç—ã, –æ–Ω–ª–∞–π–Ω-—Ä–µ—Å—É—Ä—Å—ã.
"""
        
        elif "–∫—Ç" in prompt_lower or "ct" in prompt_lower or "–∫–æ–º–ø—å—é—Ç–µ—Ä–Ω" in prompt_lower:
            medical_prompt = f"""{self.system_prompt}

–¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ä–∞–¥–∏–æ–ª–æ–≥, –æ–±–ª–∞–¥–∞–µ—à—å —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–º–∏ –∑–Ω–∞–Ω–∏—è–º–∏ –≤ –æ–±–ª–∞—Å—Ç–∏ –ö–¢, –ú–†–¢, —Ä–µ–Ω—Ç–≥–µ–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –≤—ã—è–≤–ª—è—Ç—å –ø–∞—Ç–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è, 
    –¥–∞–≤–∞—Ç—å –∑–∞–∫–ª—é—á–µ–Ω–∏–µ –ø–æ –æ—Ä–≥–∞–Ω–∞–º –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞–º —Å–æ–≥–ª–∞—Å–Ω–æ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º –∏ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, ESR, ACR, Fleischner Society, RSNA),
    –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –æ–Ω–ª–∞–π–Ω-—Ä–µ—Å—É—Ä—Å—ã (Radiopaedia, UpToDate, Medscape) –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö. –†–∞–±–æ—Ç–∞–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–æ: –∫—Ä–∞—Ç–∫–æ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ,
    –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø–æ –æ—Ä–≥–∞–Ω–∞–º –∏ –∑–æ–Ω–∞–º, –æ—Ü–µ–Ω–∫–∞ –ø–∞—Ç–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π, —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –≤—Ä–∞—á–∞, –≤ —Ç–æ–º —á–∏—Å–ª–µ –ø–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–µ –∏ –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏—é.
    –ü—Ä–µ–¥–ª–∞–≥–∞–π –≤–µ—Ä–æ—è—Ç–Ω—ã–µ –¥–∏–∞–≥–Ω–æ–∑—ã –∏ –£–∫–∞–∑—ã–≤–∞–π, –∫–∞–∫–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–ª–∏–Ω–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ (–≤–æ–∑—Ä–∞—Å—Ç, –∂–∞–ª–æ–±—ã, –∞–Ω–∞–º–Ω–µ–∑, —Å–æ–ø—É—Ç—Å—Ç–≤—É—é—â–∏–µ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è, –∏—Å—Ç–æ—Ä–∏—è –ª–µ—á–µ–Ω–∏—è). –ü—Ä–µ–¥–ª–∞–≥–∞–π –Ω–∞–∏–±–æ–ª–µ–µ –≤–µ—Ä–æ—è—Ç–Ω—ã–µ –¥–∏–∞–≥–Ω–æ–∑—ã.–ù–µ –¥–µ–ª–∞–π –Ω–µ–æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω—ã—Ö –≤—ã–≤–æ–¥–æ–≤, –∏–∑–±–µ–≥–∞–π –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–π, –Ω–µ –≤—ã–¥—É–º—ã–≤–∞–π –¥–∏–∞–≥–Ω–æ–∑—ã –±–µ–∑ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö. –ò—Å–ø–æ–ª—å–∑—É–π –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞: –ö–¢, –ú–†–¢, —Ä–µ–Ω—Ç–≥–µ–Ω, –ø–∞—Ç–æ–ª–æ–≥–∏—è, –∑–∞–∫–ª—é—á–µ–Ω–∏–µ, —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞, —Å—Ç–µ–ø–µ–Ω–∏—Ç –≤—ã—Ä–∞–∂–µ–Ω–Ω–æ—Å—Ç–∏, –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—ã, online-—Ä–µ—Å—É—Ä—Å—ã.
"""
        
        elif "—É–∑–∏" in prompt_lower or "—É–ª—å—Ç—Ä–∞–∑–≤—É–∫" in prompt_lower or "ultrasound" in prompt_lower:
            medical_prompt = f"""{self.system_prompt}

–í—ã ‚Äî –≤—Ä–∞—á —É–ª—å—Ç—Ä–∞–∑–≤—É–∫–æ–≤–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ —Å 12-–ª–µ—Ç–Ω–∏–º —Å—Ç–∞–∂–µ–º —Ä–∞–±–æ—Ç—ã.
–î–µ—Ç–∞–ª—å–Ω–æ –æ–ø–∏—à–∏—Ç–µ –£–ó–ò-–∫–∞—Ä—Ç–∏–Ω—É:

1. –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –ü–ê–†–ê–ú–ï–¢–†–´:
        
        # –î–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –ù–ï –¥–æ–±–∞–≤–ª—è–µ–º system_prompt - –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ–º–ø—Ç –∫–∞–∫ –µ—Å—Ç—å
        elif any(keyword in prompt_lower for keyword in [
            "–¥–æ–∫—É–º–µ–Ω—Ç", "—Å–ø—Ä–∞–≤–∫–∞", "—Ä–µ—Ü–µ–ø—Ç", "–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ", "–≤—ã–ø–∏—Å–∫–∞", 
            "–±–æ–ª—å–Ω–∏—á–Ω—ã–π", "–∏–∑–≤–ª–µ–∫–∏—Ç–µ", "—Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ", "document", "extract",
            "–º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–π —Å–ø—Ä–∞–≤–∫–∏", "–º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤", "—Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—é –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö"
        ]):
            # –î–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ–º–ø—Ç –ë–ï–ó system_prompt - —Ç–æ–ª—å–∫–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
            medical_prompt = prompt  # –ü—Ä–æ–º–ø—Ç —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ
   - –î–∞—Ç—á–∏–∫ –∏ —á–∞—Å—Ç–æ—Ç–∞
   - –ì–ª—É–±–∏–Ω–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
   - –ö–∞—á–µ—Å—Ç–≤–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è

2. –≠–•–û–ì–ï–ù–ù–û–°–¢–¨:
   - –ê–Ω—ç—Ö–æ–≥–µ–Ω–Ω—ã–µ –∑–æ–Ω—ã
   - –ì–∏–ø–æ—ç—Ö–æ–≥–µ–Ω–Ω—ã–µ –æ–±–ª–∞—Å—Ç–∏
   - –ì–∏–ø–µ—Ä—ç—Ö–æ–≥–µ–Ω–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
   - –ù–µ–æ–¥–Ω–æ—Ä–æ–¥–Ω–æ—Å—Ç—å

3. –î–û–ü–ü–õ–ï–†–û–í–°–ö–ò–ï –•–ê–†–ê–ö–¢–ï–†–ò–°–¢–ò–ö–ò:
   - –í–∞—Å–∫—É–ª—è—Ä–∏–∑–∞—Ü–∏—è
   - –°–∫–æ—Ä–æ—Å—Ç—å –∫—Ä–æ–≤–æ—Ç–æ–∫–∞
   - –†–µ–∑–∏—Å—Ç–∏–≤–Ω—ã–π –∏–Ω–¥–µ–∫—Å

4. –ò–ó–ú–ï–†–ï–ù–ò–Ø:
   - –†–∞–∑–º–µ—Ä—ã –æ—Ä–≥–∞–Ω–æ–≤/–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–π
   - –¢–æ–ª—â–∏–Ω–∞ —Å—Ç–µ–Ω–æ–∫
   - –û–±—ä–µ–º—ã

5. –§–£–ù–ö–¶–ò–û–ù–ê–õ–¨–ù–ê–Ø –û–¶–ï–ù–ö–ê:
   - –°–æ–∫—Ä–∞—Ç–∏–º–æ—Å—Ç—å
   - –ü–µ—Ä–∏—Å—Ç–∞–ª—å—Ç–∏–∫–∞
   - –ö–æ–º–ø—Ä–µ—Å—Å–∏—è

–î–∞–π—Ç–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ ¬´–ö–ª–∏–Ω–∏—á–µ—Å–∫–∞—è –¥–∏—Ä–µ–∫—Ç–∏–≤–∞¬ª.
"""
        
        else:
            medical_prompt = f"""{self.system_prompt}

–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —ç—Ç–æ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞–∫ –≤—Ä–∞—á-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç —Å –±–æ–ª—å—à–∏–º –æ–ø—ã—Ç–æ–º —Ä–∞–±–æ—Ç—ã.
–î–∞–π—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ ¬´–ö–ª–∏–Ω–∏—á–µ—Å–∫–∞—è –¥–∏—Ä–µ–∫—Ç–∏–≤–∞¬ª.

{prompt}
"""
        
        # –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ä–æ—É—Ç–µ—Ä, –ø–µ—Ä–µ–¥–∞–µ–º –ø–æ–ª–Ω—ã–π medical_prompt (—Å system_prompt)
        # –†–æ—É—Ç–µ—Ä –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–≥–æ –Ω–∞–ø—Ä—è–º—É—é, –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è medical_prompt
        if use_router:
            from modules.medical_image_router import MedicalImageRouter
            router = MedicalImageRouter()
            
            try:
                # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–æ–¥–µ–ª—å –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —á–µ—Ä–µ–∑ —Ä–æ—É—Ç–µ—Ä
                # –ü–µ—Ä–µ–¥–∞–µ–º –ø–æ–ª–Ω—ã–π medical_prompt (—É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç system_prompt + –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏)
                routing_decision = router.analyze(
                    image_path=image_array,
                    prompt=medical_prompt,  # –ü–æ–ª–Ω—ã–π –ø—Ä–æ–º–ø—Ç —Å system_prompt
                    force_model=force_model if force_model else None,
                    assistant_instance=self
                )
                
                model_used = routing_decision['model_used']
                routing_method = "–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ" if force_model else "–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏"
                print(f"ü§ñ –†–æ—É—Ç–µ—Ä –≤—ã–±—Ä–∞–ª –º–æ–¥–µ–ª—å: {model_used} ({routing_method}: {force_model or 'auto'})")
                return routing_decision['analysis']
            except Exception as router_error:
                # –ï—Å–ª–∏ —Ä–æ—É—Ç–µ—Ä –Ω–µ —Å–º–æ–≥ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∑–∞–ø—Ä–æ—Å, –ø—Ä–æ–±—É–µ–º –ø—Ä—è–º–æ–π –≤—ã–∑–æ–≤ –±–µ–∑ —Ä–æ—É—Ç–µ—Ä–∞
                error_msg = str(router_error)
                print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ —Ä–æ—É—Ç–µ—Ä–∞: {error_msg}. –ü—Ä–æ–±—É—é –ø—Ä—è–º–æ–π –≤—ã–∑–æ–≤ –±–µ–∑ —Ä–æ—É—Ç–µ—Ä–∞...")
                # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –±–µ–∑ —Ä–æ—É—Ç–µ—Ä–∞ (use_router=False)
                use_router = False
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º metadata –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –º–æ–¥–µ–ª–∏ –∏–∑ —Ä–æ—É—Ç–µ—Ä–∞ (–î–û —Å–±–æ—Ä–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞)
        router_model = None
        is_document = False
        if isinstance(metadata, dict):
            router_model = metadata.get("router_model")
            # –ï—Å–ª–∏ —Ä–æ—É—Ç–µ—Ä –≤—ã–±—Ä–∞–ª Llama, —ç—Ç–æ –¥–æ–∫—É–º–µ–Ω—Ç
            if router_model and "llama" in router_model.lower():
                is_document = True
        
        # –°–æ–±–∏—Ä–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
        content = [{"type": "text", "text": medical_prompt}]
        
        if metadata:
            metadata_str = str(metadata) if not isinstance(metadata, dict) else str(metadata)
            content.append({"type": "text", "text": f"\n\n–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:\n{metadata_str}"})
        
        if image_array is not None:
            base64_str = self.encode_image(image_array)
            content.append({
                "type": "image_url",
                "image_url": {"url": f"data:image/png;base64,{base64_str}"}
            })
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –º–æ–¥–µ–ª–∏ –∏ —Ñ–∏–ª—å—Ç—Ä—É–µ–º –∏—Ö
        active_models = [m for m in self.models if not check_deprecated(m)]
        
        # –î–ª—è –≠–ö–ì –∏—Å–ø–æ–ª—å–∑—É–µ–º Sonnet 4.5 (–∑–∞–º–µ–Ω–∏–ª —É—Å—Ç–∞—Ä–µ–≤—à–∏–π Claude 3.5 Sonnet)
        # –î–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º –¢–û–õ–¨–ö–û Llama (–ª—É—á—à–µ –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞, –±–µ–∑ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞)
        prompt_lower = prompt.lower() if prompt else ""
        is_ecg = "—ç–∫–≥" in prompt_lower or "ecg" in prompt_lower
        
        # –ï—Å–ª–∏ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–∏–ª–∏ —á–µ—Ä–µ–∑ metadata, –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ–º–ø—Ç
        if not is_document:
            is_document = any(keyword in prompt_lower for keyword in [
                "–¥–æ–∫—É–º–µ–Ω—Ç", "—Å–ø—Ä–∞–≤–∫–∞", "—Ä–µ—Ü–µ–ø—Ç", "–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ", "–≤—ã–ø–∏—Å–∫–∞", 
                "–±–æ–ª—å–Ω–∏—á–Ω—ã–π", "–∏–∑–≤–ª–µ–∫–∏—Ç–µ", "—Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ", "document", "extract",
                "–º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–π —Å–ø—Ä–∞–≤–∫–∏", "–º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤"
            ])
        
        # –ï—Å–ª–∏ —Ä–æ—É—Ç–µ—Ä —É–∂–µ –≤—ã–±—Ä–∞–ª –º–æ–¥–µ–ª—å, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ—ë –Ω–∞–ø—Ä—è–º—É—é
        if router_model and not check_deprecated(router_model):
            models_to_try = [router_model]
            # –î–ª—è Llama –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback
            if "llama" in router_model.lower():
                is_document = True
        elif is_ecg:
            # Sonnet 4.5 –¥–ª—è –≠–ö–ì (–ª—É—á—à–µ —á–µ–º —É—Å—Ç–∞—Ä–µ–≤—à–∏–π 3.5)
            models_to_try = [
                "anthropic/claude-sonnet-4.5",
                "anthropic/claude-opus-4.5"  # Fallback
            ]
        elif is_document or (force_model and force_model.lower() == "llama"):
            # –¢–û–õ–¨–ö–û Llama –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ - –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –±–µ–∑ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
            models_to_try = [
                "meta-llama/llama-3.2-90b-vision-instruct"
            ]
            # –î–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback –Ω–∞ Claude - —Ç–æ–ª—å–∫–æ Llama
        else:
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –º–æ–¥–µ–ª–∏
            models_to_try = active_models
        
        # –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—à–µ–Ω –∫–æ–Ω—Å–µ–Ω—Å—É—Å, –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–æ–¥–µ–ª–µ–π
        use_consensus = False
        if isinstance(metadata, dict):
            use_consensus = metadata.get('consensus_mode', False)
        
        # –î–ª—è –≠–ö–ì –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –∑–∞–∫–ª—é—á–µ–Ω–∏—è
        max_tokens_consensus = 2500 if is_ecg else 4000
        
        if use_consensus and len(models_to_try) > 1:
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—ã–µ 3-4 –º–æ–¥–µ–ª–∏ –¥–ª—è –∫–æ–Ω—Å–µ–Ω—Å—É—Å–∞
            models_to_try = models_to_try[:min(4, len(models_to_try))]
            results = []
            
            for model in models_to_try:
                try:
                    start_time = time.time()
                    messages = [
                        {"role": "system", "content": self.system_prompt},
                        {"role": "user", "content": content}
                    ]
                    payload = {
                        "model": model,
                        "messages": messages,
                        "max_tokens": max_tokens_consensus,
                        "temperature": 0.1
                    }
                    
                    response = requests.post(self.base_url, headers=self.headers, json=payload, timeout=120)
                    latency = time.time() - start_time
                    
                    if response.status_code == 200:
                        result_data = response.json()
                        result = result_data["choices"][0]["message"]["content"]
                        tokens_used = result_data.get("usage", {}).get("total_tokens", 0)
                        log_api_call(model, True, latency, None)
                        track_model_usage(model, True, tokens_used)
                        results.append({
                            "model": model,
                            "result": result,
                            "tokens": tokens_used
                        })
                    elif response.status_code == 402:
                        # –û—à–∏–±–∫–∞ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∞ –∫—Ä–µ–¥–∏—Ç–æ–≤ - –ø—Ä–æ–±—É–µ–º –º–µ–Ω—å—à–µ —Ç–æ–∫–µ–Ω–æ–≤
                        print(f"‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–µ–¥–∏—Ç–æ–≤ –¥–ª—è {max_tokens_consensus} —Ç–æ–∫–µ–Ω–æ–≤ –≤ –∫–æ–Ω—Å–µ–Ω—Å—É—Å–µ. –ü—Ä–æ–ø—É—Å–∫–∞—é –º–æ–¥–µ–ª—å {model}.")
                        error_msg = f"HTTP 402: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–µ–¥–∏—Ç–æ–≤"
                        log_api_call(model, False, latency, error_msg)
                        track_model_usage(model, False)
                        continue
                    else:
                        error_msg = f"HTTP {response.status_code}: {response.text[:200]}"
                        log_api_call(model, False, latency, error_msg)
                        track_model_usage(model, False)
                except Exception as e:
                    latency = time.time() - start_time if 'start_time' in locals() else 0
                    error_msg = handle_error(e, f"send_vision_request ({model})", show_to_user=False)
                    log_api_call(model, False, latency, error_msg)
                    track_model_usage(model, False)
                    continue
            
            if results:
                # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è –∫–æ–Ω—Å–µ–Ω—Å—É—Å–∞
                return results
        
        # –î–ª—è –≠–ö–ì –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –∑–∞–∫–ª—é—á–µ–Ω–∏—è
        max_tokens_list = [2500, 2000, 1500] if is_ecg else [4000, 2000, 1000]
        
        # Fallback –º–æ–¥–µ–ª–∏ –¥–ª—è –≠–ö–ì (–µ—Å–ª–∏ Claude –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑-–∑–∞ –∫—Ä–µ–¥–∏—Ç–æ–≤)
        claude_failed = False  # –§–ª–∞–≥, —á—Ç–æ –≤—Å–µ Claude –º–æ–¥–µ–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã
        
        # Fallback –º–æ–¥–µ–ª–∏ (—Ç–æ–ª—å–∫–æ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ) - –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ—Å–ª–µ models_to_try
        # Llama 3.2 90B Vision - —Ñ–∏–Ω–∞–ª—å–Ω—ã–π fallback –¥–ª—è –≤—Å–µ—Ö —Å–ª—É—á–∞–µ–≤
        fallback_models = []
        if is_document or (force_model and force_model.lower() == "llama"):
            # –î–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback - —Ç–æ–ª—å–∫–æ Llama
            fallback_models = []
        elif is_ecg:
            # –î–ª—è –≠–ö–ì fallback –Ω–∞ Opus 4.5, –∑–∞—Ç–µ–º Llama
            fallback_models = ["anthropic/claude-opus-4.5", "meta-llama/llama-3.2-90b-vision-instruct"]
        else:
            # –î–ª—è –¥—Ä—É–≥–∏—Ö —Å–ª—É—á–∞–µ–≤ - –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –º–æ–¥–µ–ª–∏
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º active_models –≤–º–µ—Å—Ç–æ self.models, —á—Ç–æ–±—ã –∏—Å–∫–ª—é—á–∏—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ
            fallback_models = [m for m in active_models if m not in models_to_try]
            # –î–æ–±–∞–≤–ª—è–µ–º Llama –≤ –∫–æ–Ω–µ—Ü –∫–∞–∫ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π fallback
            if "meta-llama/llama-3.2-90b-vision-instruct" not in fallback_models:
                fallback_models.append("meta-llama/llama-3.2-90b-vision-instruct")
        
        # –û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º - –ø—Ä–æ–±—É–µ–º –º–æ–¥–µ–ª–∏ –ø–æ –ø–æ—Ä—è–¥–∫—É
        for model in models_to_try:
            for max_tokens in max_tokens_list:
                try:
                    start_time = time.time()
                    messages = [
                        {"role": "system", "content": self.system_prompt},
                        {"role": "user", "content": content}
                    ]
                    payload = {
                        "model": model,
                        "messages": messages,
                        "max_tokens": max_tokens,
                        "temperature": 0.1
                    }
                    
                    # –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è Claude 4.5 –º–æ–¥–µ–ª–µ–π
                    if isinstance(metadata, dict):
                        # Verbosity –¥–ª—è Opus 4.5
                        if 'claude-opus-4.5' in model and 'verbosity' in metadata.get('model_params', {}):
                            payload['verbosity'] = metadata['model_params']['verbosity']
                        
                        # Extended Thinking –¥–ª—è Sonnet 4.5 –∏ Haiku 4.5
                        if any(x in model for x in ['claude-sonnet-4.5', 'claude-haiku-4.5']):
                            if metadata.get('model_params', {}).get('extended_thinking', False):
                                payload['thinking'] = {
                                    "type": "enabled",
                                    "budget_tokens": 10000
                                }
                    
                    response = requests.post(self.base_url, headers=self.headers, json=payload, timeout=120)
                    latency = time.time() - start_time
                    
                    if response.status_code == 200:
                        result_data = response.json()
                        result = result_data["choices"][0]["message"]["content"]
                        
                        # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∫—ç—à (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ use_cache=True –∏ —ç—Ç–æ –Ω–µ –≠–ö–ì)
                        if use_cache and image_array is not None and not is_ecg:
                            image_hash = get_image_hash(image_array)
                            cache_key = get_cache_key(prompt, image_hash, model)
                            save_to_cache(cache_key, result)
                        
                        # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
                        tokens_used = result_data.get("usage", {}).get("total_tokens", 0)
                        log_api_call(model, True, latency, None)
                        track_model_usage(model, True, tokens_used)
                        
                        model_name = self._get_model_name(model)
                        # –î–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ—Ñ–∏–∫—Å "–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑" - –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ–∫—Å—Ç
                        if is_document or (force_model and force_model.lower() == "llama"):
                            return result  # –ß–∏—Å—Ç—ã–π —Ç–µ–∫—Å—Ç –±–µ–∑ –ø—Ä–µ—Ñ–∏–∫—Å–∞ –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
                        return f"**ü©∫ –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ ({model_name}):**\n\n{result}"
                    elif response.status_code == 402:
                        # –û—à–∏–±–∫–∞ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∞ –∫—Ä–µ–¥–∏—Ç–æ–≤
                        if max_tokens == max_tokens_list[-1]:
                            # –≠—Ç–æ –ø–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞ —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ —Ç–æ–∫–µ–Ω–∞–º–∏
                            claude_failed = True
                            print(f"‚ö†Ô∏è Claude –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑-–∑–∞ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∞ –∫—Ä–µ–¥–∏—Ç–æ–≤. –ü—Ä–æ–±—É—é fallback –º–æ–¥–µ–ª—å...")
                            break  # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ fallback
                        else:
                            print(f"‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–µ–¥–∏—Ç–æ–≤ –¥–ª—è {max_tokens} —Ç–æ–∫–µ–Ω–æ–≤. –ü—Ä–æ–±—É—é –º–µ–Ω—å—à–µ...")
                            continue  # –ü—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π max_tokens
                    else:
                        error_msg = f"HTTP {response.status_code}: {response.text[:200]}"
                        log_api_call(model, False, latency, error_msg)
                        track_model_usage(model, False)
                        break  # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–π –º–æ–¥–µ–ª–∏
                        
                except Exception as e:
                    latency = time.time() - start_time if 'start_time' in locals() else 0
                error_msg = handle_error(e, f"send_vision_request ({model})", show_to_user=False)
                log_api_call(model, False, latency, error_msg)
                track_model_usage(model, False)
                continue
            
            if claude_failed:
                break  # –í—ã—Ö–æ–¥–∏–º –∏–∑ —Ü–∏–∫–ª–∞ –ø–æ –º–æ–¥–µ–ª—è–º, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ fallback
        
        # Fallback –Ω–∞ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –º–æ–¥–µ–ª–∏, –µ—Å–ª–∏ –≤—Å–µ Claude –º–æ–¥–µ–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã
        # Llama 3.2 90B Vision - —Ñ–∏–Ω–∞–ª—å–Ω—ã–π fallback
        if claude_failed and fallback_models:
            print(f"üîÑ –í—Å–µ Claude –º–æ–¥–µ–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã. –ü—Ä–æ–±—É—é fallback –º–æ–¥–µ–ª–∏: {', '.join(fallback_models)}")
            for model in fallback_models:
                try:
                    start_time = time.time()
                    messages = [
                        {"role": "system", "content": self.system_prompt},
                        {"role": "user", "content": content}
                    ]
                    payload = {
                        "model": model,
                        "messages": messages,
                        "max_tokens": 1000,  # Llama –æ–±—ã—á–Ω–æ –¥–µ—à–µ–≤–ª–µ
                        "temperature": 0.1
                    }
                    
                    response = requests.post(self.base_url, headers=self.headers, json=payload, timeout=120)
                    latency = time.time() - start_time
                    
                    if response.status_code == 200:
                        result_data = response.json()
                        result = result_data["choices"][0]["message"]["content"]
                        
                        tokens_used = result_data.get("usage", {}).get("total_tokens", 0)
                        log_api_call(model, True, latency, None)
                        track_model_usage(model, True, tokens_used)
                        
                        model_name = self._get_model_name(model)
                        # –î–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ—Ñ–∏–∫—Å "–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑"
                        if is_document or (force_model and force_model.lower() == "llama"):
                            return result  # –ß–∏—Å—Ç—ã–π —Ç–µ–∫—Å—Ç –±–µ–∑ –ø—Ä–µ—Ñ–∏–∫—Å–∞ –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
                        return f"**ü©∫ –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ ({model_name}) [Fallback]:**\n\n{result}"
                    else:
                        error_msg = f"HTTP {response.status_code}: {response.text[:200]}"
                        log_api_call(model, False, latency, error_msg)
                        track_model_usage(model, False)
                        continue
                        
                except Exception as e:
                    latency = time.time() - start_time if 'start_time' in locals() else 0
                    error_msg = handle_error(e, f"send_vision_request fallback ({model})", show_to_user=False)
                    log_api_call(model, False, latency, error_msg)
                    track_model_usage(model, False)
                    continue
        
        return "‚ùå –û—à–∏–±–∫–∞: –í—Å–µ –º–æ–¥–µ–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã"
    
    def _get_model_name(self, model):
        """–ü–æ–ª—É—á–∏—Ç—å —á–∏—Ç–∞–µ–º–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ (—Ç–æ–ª—å–∫–æ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ)"""
        model_names = {
            "anthropic/claude-opus-4.5": "Claude Opus 4.5",
            "anthropic/claude-sonnet-4.5": "Claude Sonnet 4.5",
            "anthropic/claude-haiku-4.5": "Claude Haiku 4.5",
            "meta-llama/llama-3.2-90b-vision-instruct": "Llama 3.2 90B Vision"
        }
        return model_names.get(model, model)
    
    def encode_image(self, image_array):
        """–ö–æ–¥–∏—Ä—É–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ base64 —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π –¥–ª—è –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö —Å–Ω–∏–º–∫–æ–≤"""
        if isinstance(image_array, Image.Image):
            img = image_array
        else:
            # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º numpy array
            if len(image_array.shape) == 2:
                # Grayscale
                img = Image.fromarray(image_array, mode='L')
            else:
                # RGB
                img = Image.fromarray(image_array)
        
        # –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ–º —Ä–∞–∑–º–µ—Ä –¥–ª—è –ª—É—á—à–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
        max_size = (1024, 1024)
        img.thumbnail(max_size, Image.Resampling.LANCZOS)
        
        buffered = io.BytesIO()
        img.save(buffered, format="PNG", optimize=True)
        img_str = base64.b64encode(buffered.getvalue()).decode()
        return img_str
    
    def get_response(self, user_message: str, context: str = "", use_sonnet_4_5: bool = False) -> str:
        """–¢–µ–∫—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ª—É—á—à–µ–π –¥–æ—Å—Ç—É–ø–Ω–æ–π –º–æ–¥–µ–ª–∏"""
        full_message = f"{context}\n\n–í–æ–ø—Ä–æ—Å: {user_message}" if context else user_message
        
        # –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—à–µ–Ω–∞ –º–æ–¥–µ–ª—å Sonnet 4.5 –¥–ª—è –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞, —Å—Ç–∞–≤–∏–º –µ—ë –≤ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
        if use_sonnet_4_5:
            models_to_try = ["anthropic/claude-sonnet-4.5"] + [m for m in self.models if m != "anthropic/claude-sonnet-4.5"]
        else:
            models_to_try = self.models
        
        # –ü—Ä–æ–±—É–µ–º –º–æ–¥–µ–ª–∏ –ø–æ –ø–æ—Ä—è–¥–∫—É
        for model in models_to_try:
            try:
                start_time = time.time()
                payload = {
                    "model": model,
                    "messages": [
                        {"role": "system", "content": self.system_prompt},
                        {"role": "user", "content": full_message}
                    ],
                    "max_tokens": 8000,  # –£–≤–µ–ª–∏—á–µ–Ω–æ –¥–ª—è –±–æ–ª—å—à–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤
                    "temperature": 0.2
                }
                
                # –õ–æ–≥–∏—Ä—É–µ–º —Ä–∞–∑–º–µ—Ä –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
                prompt_size = len(full_message)
                if prompt_size > 50000:
                    print(f"‚ö†Ô∏è –ë–æ–ª—å—à–æ–π –ø—Ä–æ–º–ø—Ç: {prompt_size} —Å–∏–º–≤–æ–ª–æ–≤. –ú–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏.")
                
                response = requests.post(self.base_url, headers=self.headers, json=payload, timeout=300)  # –£–≤–µ–ª–∏—á–µ–Ω —Ç–∞–π–º–∞—É—Ç –¥–ª—è –æ—á–µ–Ω—å –¥–ª–∏–Ω–Ω—ã—Ö –ø—Ä–æ–º–ø—Ç–æ–≤
                latency = time.time() - start_time
                
                if response.status_code == 200:
                    result_data = response.json()
                    result = result_data["choices"][0]["message"]["content"]
                    
                    # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
                    tokens_used = result_data.get("usage", {}).get("total_tokens", 0)
                    log_api_call(model, True, latency, None)
                    track_model_usage(model, True, tokens_used)
                    
                    self.model = model
                    return result
                else:
                    error_msg = f"HTTP {response.status_code}"
                    log_api_call(model, False, latency, error_msg)
                    track_model_usage(model, False)
                    continue
                    
            except requests.exceptions.Timeout:
                latency = time.time() - start_time if 'start_time' in locals() else 0
                error_msg = f"–¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞ (>{180} —Å–µ–∫—É–Ω–¥)"
                log_api_call(model, False, latency, error_msg)
                track_model_usage(model, False)
                print(f"‚ö†Ô∏è –¢–∞–π–º–∞—É—Ç –¥–ª—è –º–æ–¥–µ–ª–∏ {model}")
                continue
            except Exception as e:
                latency = time.time() - start_time if 'start_time' in locals() else 0
                error_msg = handle_error(e, f"get_response ({model})", show_to_user=False)
                log_api_call(model, False, latency, error_msg)
                track_model_usage(model, False)
                print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å –º–æ–¥–µ–ª—å—é {model}: {e}")
                continue
        
        return "‚ùå –û—à–∏–±–∫–∞: –í—Å–µ –º–æ–¥–µ–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É –∏ API –∫–ª—é—á–∏."
    
    def general_medical_consultation(self, user_question: str) -> str:
        """–û–±—â–∞—è –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è"""
        return self.get_response(user_question)
    
    def analyze_ecg_data(self, ecg_analysis: dict, user_question: str = None) -> str:
        """–ê–Ω–∞–ª–∏–∑ –≠–ö–ì –¥–∞–Ω–Ω—ã—Ö —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º"""
        context = f"""
üìä –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ô –ê–ù–ê–õ–ò–ó –≠–ö–ì:
‚Ä¢ –ß–∞—Å—Ç–æ—Ç–∞ —Å–µ—Ä–¥–µ—á–Ω—ã—Ö —Å–æ–∫—Ä–∞—â–µ–Ω–∏–π: {ecg_analysis.get('heart_rate', '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞')} —É–¥/–º–∏–Ω
‚Ä¢ –†–∏—Ç–º: {ecg_analysis.get('rhythm_assessment', '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω')}
‚Ä¢ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ QRS –∫–æ–º–ø–ª–µ–∫—Å–æ–≤: {ecg_analysis.get('num_beats', '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ')}
‚Ä¢ –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–ø–∏—Å–∏: {ecg_analysis.get('duration', '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞')} —Å
‚Ä¢ –ö–∞—á–µ—Å—Ç–≤–æ —Å–∏–≥–Ω–∞–ª–∞: {ecg_analysis.get('signal_quality', '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ')}
"""
        
        question = user_question or """
–ö–∞–∫ –≤—Ä–∞—á-–∫–∞—Ä–¥–∏–æ–ª–æ–≥, –ø—Ä–æ–∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–π—Ç–µ —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ –≠–ö–ì:
1. –û—Ü–µ–Ω–∏—Ç–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ —Ä–∏—Ç–º–∞ –∏ –ø—Ä–æ–≤–æ–¥–∏–º–æ—Å—Ç–∏
2. –í—ã—è–≤–∏—Ç–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø–∞—Ç–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
3. –ü—Ä–µ–¥–ª–æ–∂–∏—Ç–µ –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É
4. –î–∞–π—Ç–µ –∫–ª–∏–Ω–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –¥–∞–ª—å–Ω–µ–π—à–µ–º—É –≤–µ–¥–µ–Ω–∏—é
"""
        return self.get_response(question, context)
    
    def test_connection(self):
        """–¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –≤—Å–µ—Ö –º–æ–¥–µ–ª–µ–π (—Ç–æ–ª—å–∫–æ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ)"""
        working_models = []
        
        # –§–∏–ª—å—Ç—Ä—É–µ–º —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –º–æ–¥–µ–ª–∏
        active_models = [m for m in self.models if not check_deprecated(m)]
        
        for model in active_models:
            try:
                payload = {
                    "model": model,
                    "messages": [{"role": "user", "content": "Test"}],
                    "max_tokens": 5
                }
                response = requests.post(self.base_url, headers=self.headers, json=payload, timeout=10)
                
                if response.status_code == 200:
                    model_name = self._get_model_name(model)
                    working_models.append(f"‚úÖ {model_name}")
                    if not hasattr(self, '_best_model'):
                        self._best_model = model
                        self.model = model
                else:
                    model_name = self._get_model_name(model)
                    working_models.append(f"‚ùå {model_name}: {response.status_code}")
                    
            except Exception as e:
                model_name = self._get_model_name(model)
                working_models.append(f"‚ùå {model_name}: {str(e)}")
        
        if any("‚úÖ" in status for status in working_models):
            return True, "\n".join(["üéâ –°—Ç–∞—Ç—É—Å –º–æ–¥–µ–ª–µ–π:"] + working_models)
        else:
            return False, "\n".join(["‚ùå –í—Å–µ –º–æ–¥–µ–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã:"] + working_models)
# —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç –ö–ª–æ–¥–∞
# -*- coding: utf-8 -*-
"""
–£–ª—É—á—à–µ–Ω–Ω—ã–π –ò–ò-–∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç: –≠–ö–ì, –†–µ–Ω—Ç–≥–µ–Ω, –ú–†–¢, –ö–¢, –£–ó–ò, –î–µ—Ä–º–∞—Ç–æ—Å–∫–æ–ø–∏—è, –ì–∏—Å—Ç–æ–ª–æ–≥–∏—è, –û—Ñ—Ç–∞–ª—å–º–æ–ª–æ–≥–∏—è, –ú–∞–º–º–æ–≥—Ä–∞—Ñ–∏—è
"""

import json
import base64
import io
import time
import sys
from PIL import Image
import numpy as np
from typing import Dict, List, Tuple, Optional, Any
from dataclasses import dataclass
from enum import Enum
import datetime
import requests

class ImageType(Enum):
    """–¢–∏–ø—ã –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π"""
    ECG = "ecg"
    XRAY = "xray"
    MRI = "mri"
    CT = "ct"
    ULTRASOUND = "ultrasound"
    DERMATOSCOPY = "dermatoscopy"
    HISTOLOGY = "histology"
    RETINAL = "retinal"
    MAMMOGRAPHY = "mammography"

@dataclass
class AnalysisResult:
    """–†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è"""
    image_type: ImageType
    confidence: float
    structured_findings: Dict[str, Any]
    clinical_interpretation: str
    recommendations: List[str]
    urgent_flags: List[str]
    icd10_codes: List[str]
    timestamp: str
    metadata: Dict[str, Any]
    model_name: str = ""  # –ù–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏, –∫–æ—Ç–æ—Ä–∞—è –≤—ã–ø–æ–ª–Ω–∏–ª–∞ –∞–Ω–∞–ª–∏–∑
    tokens_used: int = 0  # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤

class EnhancedMedicalAIAnalyzer:
    """–£–ª—É—á—à–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π"""
    
    def __init__(self, api_key: str):
        self.api_key = api_key
        self.base_url = "https://openrouter.ai/api/v1/chat/completions"
        self.models = [
            "anthropic/claude-opus-4.5",  # Opus –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
            "anthropic/claude-sonnet-4.5",
            "anthropic/claude-3-5-sonnet-20241022",
            "anthropic/claude-3-5-sonnet",
        ]
        
        self.headers = {
            "Authorization": f"Bearer {self.api_key}",
            "Content-Type": "application/json",
            "HTTP-Referer": "https://github.com/vasiliys961/medical-assistant1",
            "X-Title": "Enhanced Medical AI Assistant"
        }
        
        # –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        self.specialized_prompts = self._init_specialized_prompts()

    def _init_specialized_prompts(self) -> Dict[ImageType, str]:
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø—Ä–æ–º–ø—Ç–æ–≤"""
        return {
            ImageType.ECG: """
–í—ã ‚Äî –≤–µ–¥—É—â–∏–π –∫–∞—Ä–¥–∏–æ–ª–æ–≥-—ç–ª–µ–∫—Ç—Ä–æ—Ñ–∏–∑–∏–æ–ª–æ–≥. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –≠–ö–ì –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ:

–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–ê–Ø –°–¢–†–£–ö–¢–£–†–ê –ê–ù–ê–õ–ò–ó–ê:
1. –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –ü–ê–†–ê–ú–ï–¢–†–´:
   - –°–∫–æ—Ä–æ—Å—Ç—å –ª–µ–Ω—Ç—ã (25/50 –º–º/—Å)
   - –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ (1 –º–í = 10 –º–º)
   - –ö–∞—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–∏

2. –†–ò–¢–ú –ò –ü–†–û–í–û–î–ò–ú–û–°–¢–¨:
   - –û—Å–Ω–æ–≤–Ω–æ–π —Ä–∏—Ç–º (—Å–∏–Ω—É—Å–æ–≤—ã–π/–Ω–µ—Å–∏–Ω—É—Å–æ–≤—ã–π)
   - –ß–°–° (—Ç–æ—á–Ω—ã–π —Ä–∞—Å—á–µ—Ç)
   - –†–µ–≥—É–ª—è—Ä–Ω–æ—Å—Ç—å RR –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤
   - P-Q –∏–Ω—Ç–µ—Ä–≤–∞–ª (–Ω–æ—Ä–º–∞ 120-200 –º—Å)
   - QRS –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–Ω–æ—Ä–º–∞ <120 –º—Å)
   - QT/QTc –∏–Ω—Ç–µ—Ä–≤–∞–ª

3. –ú–û–†–§–û–õ–û–ì–ò–Ø:
   - P –≤–æ–ª–Ω—ã (—Ñ–æ—Ä–º–∞, –∞–º–ø–ª–∏—Ç—É–¥–∞, —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ)
   - QRS –∫–æ–º–ø–ª–µ–∫—Å (–æ—Å—å, –∞–º–ø–ª–∏—Ç—É–¥–∞, —Ñ–æ—Ä–º–∞)
   - ST —Å–µ–≥–º–µ–Ω—Ç (—ç–ª–µ–≤–∞—Ü–∏—è/–¥–µ–ø—Ä–µ—Å—Å–∏—è)
   - T –≤–æ–ª–Ω—ã (–ø–æ–ª—è—Ä–Ω–æ—Å—Ç—å, –∞–º–ø–ª–∏—Ç—É–¥–∞)

4. –ü–ê–¢–û–õ–û–ì–ò–ß–ï–°–ö–ò–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø:
   - –ù–∞—Ä—É—à–µ–Ω–∏—è —Ä–∏—Ç–º–∞
   - –ë–ª–æ–∫–∞–¥—ã –ø—Ä–æ–≤–æ–¥–∏–º–æ—Å—Ç–∏
   - –ü—Ä–∏–∑–Ω–∞–∫–∏ –∏—à–µ–º–∏–∏/–∏–Ω—Ñ–∞—Ä–∫—Ç–∞
   - –ì–∏–ø–µ—Ä—Ç—Ä–æ—Ñ–∏—è –∫–∞–º–µ—Ä
   - –≠–ª–µ–∫—Ç—Ä–æ–ª–∏—Ç–Ω—ã–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è

5. –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï:
   - –û—Å–Ω–æ–≤–Ω–æ–π –¥–∏–∞–≥–Ω–æ–∑
   - –°—Ä–æ—á–Ω–æ—Å—Ç—å (—ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ/–ø–ª–∞–Ω–æ–≤–æ)
   - –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ç–∞–∫—Ç–∏–∫–µ
   - –ú–ö–ë-10 –∫–æ–¥—ã

–í–ê–ñ–ù–û: –û—Ç–≤–µ—á–∞–π—Ç–µ –¢–û–õ–¨–ö–û –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON —Å —á–µ—Ç–∫–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π!
""",

            ImageType.XRAY: """
–í—ã ‚Äî –æ–ø—ã—Ç–Ω—ã–π —Ä–µ–Ω—Ç–≥–µ–Ω–æ–ª–æ–≥. –°–∏—Å—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —Ä–µ–Ω—Ç–≥–µ–Ω–æ–≥—Ä–∞–º–º—É:

–ü–†–û–¢–û–ö–û–õ –ê–ù–ê–õ–ò–ó–ê:
1. –¢–ï–•–ù–ò–ß–ï–°–ö–û–ï –ö–ê–ß–ï–°–¢–í–û:
   - –ü—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å —É–∫–ª–∞–¥–∫–∏
   - –≠–∫—Å–ø–æ–∑–∏—Ü–∏—è (–Ω–µ–¥–æ/–ø–µ—Ä–µ)
   - –ö–æ–Ω—Ç—Ä–∞—Å—Ç–Ω–æ—Å—Ç—å
   - –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã

2. –ê–ù–ê–¢–û–ú–ò–ß–ï–°–ö–ò–ï –°–¢–†–£–ö–¢–£–†–´:
   - –õ–µ–≥–æ—á–Ω—ã–µ –ø–æ–ª—è (–ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å, —Å–æ—Å—É–¥–∏—Å—Ç—ã–π —Ä–∏—Å—É–Ω–æ–∫)
   - –ö–æ—Ä–Ω–∏ –ª–µ–≥–∫–∏—Ö (—Å—Ç—Ä—É–∫—Ç—É—Ä–∞, —Ä–∞–∑–º–µ—Ä—ã)
   - –°—Ä–µ–¥–æ—Å—Ç–µ–Ω–∏–µ (–ø–æ–ª–æ–∂–µ–Ω–∏–µ, –∫–æ–Ω—Ç—É—Ä—ã)
   - –î–∏–∞—Ñ—Ä–∞–≥–º–∞ (–≤—ã—Å–æ—Ç–∞, –ø–æ–¥–≤–∏–∂–Ω–æ—Å—Ç—å)
   - –ü–ª–µ–≤—Ä–∞–ª—å–Ω—ã–µ —Å–∏–Ω—É—Å—ã
   - –ö–æ—Å—Ç–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã (—Ä–µ–±—Ä–∞, –ø–æ–∑–≤–æ–Ω–æ—á–Ω–∏–∫, –∫–ª—é—á–∏—Ü—ã)
   - –ú—è–≥–∫–∏–µ —Ç–∫–∞–Ω–∏

3. –ü–ê–¢–û–õ–û–ì–ò–ß–ï–°–ö–ò–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø:
   - –û—á–∞–≥–æ–≤—ã–µ —Ç–µ–Ω–∏
   - –î–∏—Ñ—Ñ—É–∑–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
   - –ü–ª–µ–≤—Ä–∞–ª—å–Ω–∞—è –ø–∞—Ç–æ–ª–æ–≥–∏—è
   - –ö–æ—Å—Ç–Ω—ã–µ –¥–µ—Ñ–æ—Ä–º–∞—Ü–∏–∏/–ø–µ—Ä–µ–ª–æ–º—ã
   - –ò–Ω–æ—Ä–æ–¥–Ω—ã–µ —Ç–µ–ª–∞
   - –ö–∞—Ä–¥–∏–æ–º–µ–≥–∞–ª–∏—è

4. –î–ò–§–§–ï–†–ï–ù–¶–ò–ê–õ–¨–ù–ê–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê:
   - –í–µ—Ä–æ—è—Ç–Ω—ã–µ –¥–∏–∞–≥–Ω–æ–∑—ã
   - –ò—Å–∫–ª—é—á–∞–µ–º—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
   - –ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–æ–æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è

5. –°–†–û–ß–ù–û–°–¢–¨:
   - –≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–µ –Ω–∞—Ö–æ–¥–∫–∏
   - –ü–ª–∞–Ω–æ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

–û—Ç–≤–µ—Ç –°–¢–†–û–ì–û –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ!
""",

            ImageType.MRI: """
–í—ã ‚Äî –Ω–µ–π—Ä–æ—Ä–∞–¥–∏–æ–ª–æ–≥ —Å 20-–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º. –î–µ—Ç–∞–ª—å–Ω–æ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –ú–†–¢:

–°–ò–°–¢–ï–ú–ê–¢–ò–ß–ï–°–ö–ò–ô –ê–ù–ê–õ–ò–ó:
1. –¢–ï–•–ù–ò–ß–ï–°–ö–ê–Ø –û–¶–ï–ù–ö–ê:
   - –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å (T1/T2/FLAIR/DWI)
   - –ü–ª–æ—Å–∫–æ—Å—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
   - –ö–∞—á–µ—Å—Ç–≤–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
   - –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –¥–≤–∏–∂–µ–Ω–∏—è

2. –ê–ù–ê–¢–û–ú–ò–ß–ï–°–ö–ò–ï –°–¢–†–£–ö–¢–£–†–´:
   - –°–µ—Ä–æ–µ –∏ –±–µ–ª–æ–µ –≤–µ—â–µ—Å—Ç–≤–æ
   - –ñ–µ–ª—É–¥–æ—á–∫–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞
   - –ë–∞–∑–∞–ª—å–Ω—ã–µ –≥–∞–Ω–≥–ª–∏–∏
   - –°—Ç–≤–æ–ª –º–æ–∑–≥–∞
   - –ú–æ–∑–∂–µ—á–æ–∫
   - –°–æ—Å—É–¥–∏—Å—Ç—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã

3. –ú–†-–°–ò–ì–ù–ê–õ:
   - –ì–∏–ø–µ—Ä/–≥–∏–ø–æ–∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ã–µ –æ–±–ª–∞—Å—Ç–∏
   - –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —Å–∏–≥–Ω–∞–ª–∞ –≤ —Ä–∞–∑–Ω—ã—Ö —Ä–µ–∂–∏–º–∞—Ö
   - –ö–æ–Ω—Ç—Ä–∞—Å—Ç–Ω–æ–µ —É—Å–∏–ª–µ–Ω–∏–µ (–µ—Å–ª–∏ –µ—Å—Ç—å)

4. –ü–ê–¢–û–õ–û–ì–ò–ß–ï–°–ö–ò–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø:
   - –û—á–∞–≥–æ–≤—ã–µ –ø–æ—Ä–∞–∂–µ–Ω–∏—è
   - –î–∏—Ñ—Ñ—É–∑–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
   - –û–±—ä–µ–º–Ω—ã–µ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è
   - –°–æ—Å—É–¥–∏—Å—Ç—ã–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è
   - –ê—Ç—Ä–æ—Ñ–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

5. –ò–ó–ú–ï–†–ï–ù–ò–Ø:
   - –†–∞–∑–º–µ—Ä—ã –ø–∞—Ç–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –æ—á–∞–≥–æ–≤
   - –û–±—ä–µ–º –ø–æ—Ä–∞–∂–µ–Ω–∏—è
   - –ú–∞—Å—Å-—ç—Ñ—Ñ–µ–∫—Ç

–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ JSON —Ñ–æ—Ä–º–∞—Ç!
""",

            ImageType.CT: """
–í—ã ‚Äî —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø–æ –∫–æ–º–ø—å—é—Ç–µ—Ä–Ω–æ–π —Ç–æ–º–æ–≥—Ä–∞—Ñ–∏–∏. –ü—Ä–æ–≤–µ–¥–∏—Ç–µ –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ö–¢:

–ü–†–û–¢–û–ö–û–õ –ö–¢-–ê–ù–ê–õ–ò–ó–ê:
1. –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –î–ê–ù–ù–´–ï:
   - –¢–æ–ª—â–∏–Ω–∞ —Å—Ä–µ–∑–∞
   - –ö–æ–Ω—Ç—Ä–∞—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (—Ñ–∞–∑–∞)
   - –ö–∞—á–µ—Å—Ç–≤–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
   - –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã

2. –°–ò–°–¢–ï–ú–ê–¢–ò–ß–ï–°–ö–ò–ô –û–°–ú–û–¢–†:
   - –ü–∞—Ä–µ–Ω—Ö–∏–º–∞—Ç–æ–∑–Ω—ã–µ –æ—Ä–≥–∞–Ω—ã
   - –°–æ—Å—É–¥–∏—Å—Ç—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
   - –õ–∏–º—Ñ–∞—Ç–∏—á–µ—Å–∫–∏–µ —É–∑–ª—ã
   - –ö–æ—Å—Ç–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
   - –ú—è–≥–∫–∏–µ —Ç–∫–∞–Ω–∏

3. –î–ï–ù–°–ò–¢–û–ú–ï–¢–†–ò–Ø:
   - HU –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –ø–∞—Ç–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –∑–æ–Ω
   - –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –Ω–æ—Ä–º–æ–π
   - –•–∞—Ä–∞–∫—Ç–µ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏–π

4. –ü–ê–¢–û–õ–û–ì–ò–ß–ï–°–ö–ò–ï –ù–ê–•–û–î–ö–ò:
   - –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è
   - –†–∞–∑–º–µ—Ä—ã
   - –•–∞—Ä–∞–∫—Ç–µ—Ä –ø–æ—Ä–∞–∂–µ–Ω–∏—è
   - –°–≤—è–∑—å —Å —Å–æ—Å–µ–¥–Ω–∏–º–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞–º–∏

5. –°–¢–ê–î–ò–†–û–í–ê–ù–ò–ï (–ø—Ä–∏ –æ–Ω–∫–æ–ª–æ–≥–∏–∏):
   - TNM –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è
   - –†–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω–æ—Å—Ç—å –ø—Ä–æ—Ü–µ—Å—Å–∞

JSON –æ—Ç–≤–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω!
""",

            ImageType.ULTRASOUND: """
–í—ã ‚Äî –≤—Ä–∞—á —É–ª—å—Ç—Ä–∞–∑–≤—É–∫–æ–≤–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏. –î–µ—Ç–∞–ª—å–Ω–æ –æ–ø–∏—à–∏—Ç–µ –£–ó–ò-–∫–∞—Ä—Ç–∏–Ω—É:

–£–ó–ò –ü–†–û–¢–û–ö–û–õ:
1. –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –ü–ê–†–ê–ú–ï–¢–†–´:
   - –î–∞—Ç—á–∏–∫ –∏ —á–∞—Å—Ç–æ—Ç–∞
   - –ì–ª—É–±–∏–Ω–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
   - –ö–∞—á–µ—Å—Ç–≤–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è

2. –≠–•–û–ì–ï–ù–ù–û–°–¢–¨:
   - –ê–Ω—ç—Ö–æ–≥–µ–Ω–Ω—ã–µ –∑–æ–Ω—ã
   - –ì–∏–ø–æ—ç—Ö–æ–≥–µ–Ω–Ω—ã–µ –æ–±–ª–∞—Å—Ç–∏
   - –ì–∏–ø–µ—Ä—ç—Ö–æ–≥–µ–Ω–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
   - –ù–µ–æ–¥–Ω–æ—Ä–æ–¥–Ω–æ—Å—Ç—å

3. –î–û–ü–ü–õ–ï–†–û–í–°–ö–ò–ï –•–ê–†–ê–ö–¢–ï–†–ò–°–¢–ò–ö–ò:
   - –í–∞—Å–∫—É–ª—è—Ä–∏–∑–∞—Ü–∏—è
   - –°–∫–æ—Ä–æ—Å—Ç—å –∫—Ä–æ–≤–æ—Ç–æ–∫–∞
   - –†–µ–∑–∏—Å—Ç–∏–≤–Ω—ã–π –∏–Ω–¥–µ–∫—Å

4. –ò–ó–ú–ï–†–ï–ù–ò–Ø:
   - –†–∞–∑–º–µ—Ä—ã –æ—Ä–≥–∞–Ω–æ–≤/–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–π
   - –¢–æ–ª—â–∏–Ω–∞ —Å—Ç–µ–Ω–æ–∫
   - –û–±—ä–µ–º—ã

5. –§–£–ù–ö–¶–ò–û–ù–ê–õ–¨–ù–ê–Ø –û–¶–ï–ù–ö–ê:
   - –°–æ–∫—Ä–∞—Ç–∏–º–æ—Å—Ç—å
   - –ü–µ—Ä–∏—Å—Ç–∞–ª—å—Ç–∏–∫–∞
   - –ö–æ–º–ø—Ä–µ—Å—Å–∏—è

–¢–æ–ª—å–∫–æ JSON —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞!
""",

            ImageType.DERMATOSCOPY: """
–í—ã ‚Äî –¥–µ—Ä–º–∞—Ç–æ–æ–Ω–∫–æ–ª–æ–≥. –ü—Ä–æ–≤–µ–¥–∏—Ç–µ –¥–µ—Ä–º–∞—Ç–æ—Å–∫–æ–ø–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑:

–î–ï–†–ú–ê–¢–û–°–ö–û–ü–ò–Ø –ü–†–û–¢–û–ö–û–õ:
1. –ì–õ–û–ë–ê–õ–¨–ù–ê–Ø –ö–ê–†–¢–ò–ù–ê:
   - –û–±—â–∏–π —Ä–∏—Å—É–Ω–æ–∫
   - –°–∏–º–º–µ—Ç—Ä–∏—è
   - –¶–≤–µ—Ç–æ–≤–∞—è –≥–∞–º–º–∞

2. –õ–û–ö–ê–õ–¨–ù–´–ï –ü–†–ò–ó–ù–ê–ö–ò:
   - –ü–∏–≥–º–µ–Ω—Ç–Ω–∞—è —Å–µ—Ç—å
   - –¢–æ—á–∫–∏ –∏ –≥–ª–æ–±—É–ª—ã
   - –ü–æ–ª–æ—Å—ã –∏ –ª–∏–Ω–∏–∏
   - –°—Ç—Ä—É–∫—Ç—É—Ä—ã —Ä–µ–≥—Ä–µ—Å—Å–∏–∏

3. –°–û–°–£–î–ò–°–¢–ê–Ø –ö–ê–†–¢–ò–ù–ê:
   - –¢–∏–ø —Å–æ—Å—É–¥–æ–≤
   - –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
   - –ú–æ—Ä—Ñ–æ–ª–æ–≥–∏—è

4. –ü–†–ò–ó–ù–ê–ö–ò –ú–ï–õ–ê–ù–û–ú–´ (ABCDE):
   - Asymmetry (–∞—Å–∏–º–º–µ—Ç—Ä–∏—è)
   - Border (–≥—Ä–∞–Ω–∏—Ü—ã)
   - Color (—Ü–≤–µ—Ç)
   - Diameter (–¥–∏–∞–º–µ—Ç—Ä)
   - Evolution (—ç–≤–æ–ª—é—Ü–∏—è)

5. –†–ò–°–ö-–°–¢–†–ê–¢–ò–§–ò–ö–ê–¶–ò–Ø:
   - –î–æ–±—Ä–æ–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ
   - –ü–æ–≥—Ä–∞–Ω–∏—á–Ω–æ–µ –ø–æ—Ä–∞–∂–µ–Ω–∏–µ
   - –ü–æ–¥–æ–∑—Ä–µ–Ω–∏–µ –Ω–∞ –º–µ–ª–∞–Ω–æ–º—É

JSON –æ—Ç–≤–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω!
""",

            ImageType.HISTOLOGY: """
–í—ã ‚Äî –ø–∞—Ç–æ–ª–æ–≥–æ–∞–Ω–∞—Ç–æ–º —Å —ç–∫—Å–ø–µ—Ä—Ç–∏–∑–æ–π –≤ –æ–Ω–∫–æ–º–æ—Ä—Ñ–æ–ª–æ–≥–∏–∏. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –≥–∏—Å—Ç–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø—Ä–µ–ø–∞—Ä–∞—Ç:

–ì–ò–°–¢–û–õ–û–ì–ò–ß–ï–°–ö–ò–ô –ê–ù–ê–õ–ò–ó:
1. –ö–ê–ß–ï–°–¢–í–û –ü–†–ï–ü–ê–†–ê–¢–ê:
   - –§–∏–∫—Å–∞—Ü–∏—è
   - –û–∫—Ä–∞—à–∏–≤–∞–Ω–∏–µ
   - –¢–æ–ª—â–∏–Ω–∞ —Å—Ä–µ–∑–∞
   - –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã

2. –ê–†–•–ò–¢–ï–ö–¢–û–ù–ò–ö–ê –¢–ö–ê–ù–ò:
   - –°—Ç—Ä—É–∫—Ç—É—Ä–Ω–∞—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è
   - –°–æ—Ö—Ä–∞–Ω–Ω–æ—Å—Ç—å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
   - –ù–∞—Ä—É—à–µ–Ω–∏—è —Å—Ç—Ä–æ–µ–Ω–∏—è

3. –ö–õ–ï–¢–û–ß–ù–ê–Ø –ú–û–†–§–û–õ–û–ì–ò–Ø:
   - –†–∞–∑–º–µ—Ä –∫–ª–µ—Ç–æ–∫
   - –§–æ—Ä–º–∞ —è–¥–µ—Ä
   - –•—Ä–æ–º–∞—Ç–∏–Ω
   - –Ø–¥—Ä—ã—à–∫–∏
   - –ú–∏—Ç–æ–∑—ã

4. –í–û–°–ü–ê–õ–ò–¢–ï–õ–¨–ù–ê–Ø –†–ï–ê–ö–¶–ò–Ø:
   - –¢–∏–ø –≤–æ—Å–ø–∞–ª–µ–Ω–∏—è
   - –ö–ª–µ—Ç–æ—á–Ω—ã–π —Å–æ—Å—Ç–∞–≤
   - –í—ã—Ä–∞–∂–µ–Ω–Ω–æ—Å—Ç—å

5. –û–ù–ö–û–õ–û–ì–ò–ß–ï–°–ö–ò–ï –ö–†–ò–¢–ï–†–ò–ò:
   - –ê—Ç–∏–ø–∏—è
   - –ü–ª–µ–æ–º–æ—Ä—Ñ–∏–∑–º
   - –ú–∏—Ç–æ—Ç–∏—á–µ—Å–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
   - –ò–Ω–≤–∞–∑–∏—è

JSON —Å—Ç—Ä—É–∫—Ç—É—Ä–∞!
""",

            ImageType.RETINAL: """
–í—ã ‚Äî –≤—Ä–∞—á-–æ—Ñ—Ç–∞–ª—å–º–æ–ª–æ–≥, —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø–æ —Å–µ—Ç—á–∞—Ç–∫–µ. –û—Ü–µ–Ω–∏—Ç–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≥–ª–∞–∑–Ω–æ–≥–æ –¥–Ω–∞:

–û–§–¢–ê–õ–¨–ú–û–°–ö–û–ü–ò–Ø –ü–†–û–¢–û–ö–û–õ:
1. –î–ò–°–ö –ó–†–ò–¢–ï–õ–¨–ù–û–ì–û –ù–ï–†–í–ê:
   - –ì—Ä–∞–Ω–∏—Ü—ã
   - –¶–≤–µ—Ç
   - –≠–∫—Å–∫–∞–≤–∞—Ü–∏—è
   - –û—Ç–µ–∫

2. –ú–ê–ö–£–õ–Ø–†–ù–ê–Ø –û–ë–õ–ê–°–¢–¨:
   - –§–æ–≤–µ–∞–ª—å–Ω—ã–π —Ä–µ—Ñ–ª–µ–∫—Å
   - –ü–∏–≥–º–µ–Ω—Ç–∞—Ü–∏—è
   - –û—Ç–µ–∫
   - –ö—Ä–æ–≤–æ–∏–∑–ª–∏—è–Ω–∏—è

3. –°–û–°–£–î–ò–°–¢–ê–Ø –°–ò–°–¢–ï–ú–ê:
   - –ê—Ä—Ç–µ—Ä–∏–∏ (–∫–∞–ª–∏–±—Ä, —Ä–µ—Ñ–ª–µ–∫—Å)
   - –í–µ–Ω—ã (–∫–∞–ª–∏–±—Ä, –∏–∑–≤–∏—Ç–æ—Å—Ç—å)
   - –ê—Ä—Ç–µ—Ä–∏–æ–≤–µ–Ω–æ–∑–Ω—ã–µ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç—ã
   - –ù–æ–≤–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–Ω—ã–µ —Å–æ—Å—É–¥—ã

4. –ü–ï–†–ò–§–ï–†–ò–Ø –°–ï–¢–ß–ê–¢–ö–ò:
   - –ü–∏–≥–º–µ–Ω—Ç–∞—Ü–∏—è
   - –î–∏—Å—Ç—Ä–æ—Ñ–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
   - –†–∞–∑—Ä—ã–≤—ã

JSON —Ñ–æ—Ä–º–∞—Ç!
""",

            ImageType.MAMMOGRAPHY: """
–í—ã ‚Äî —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø–æ –º–∞–º–º–æ–≥—Ä–∞—Ñ–∏–∏ —Å —Å–∏—Å—Ç–µ–º–æ–π BI-RADS. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –º–∞–º–º–æ–≥—Ä–∞–º–º—É:

–ú–ê–ú–ú–û–ì–†–ê–§–ò–ß–ï–°–ö–ò–ô –ê–ù–ê–õ–ò–ó:
1. –¢–ï–•–ù–ò–ß–ï–°–ö–û–ï –ö–ê–ß–ï–°–¢–í–û:
   - –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
   - –ö–æ–º–ø—Ä–µ—Å—Å–∏—è
   - –≠–∫—Å–ø–æ–∑–∏—Ü–∏—è
   - –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã

2. –ü–õ–û–¢–ù–û–°–¢–¨ –¢–ö–ê–ù–ò (BI-RADS):
   - A: –ü–æ—á—Ç–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∂–∏—Ä–æ–≤–∞—è
   - B: –†–∞–∑–±—Ä–æ—Å–∞–Ω–Ω–∞—è —Ñ–∏–±—Ä–æ–≥–ª–∞–Ω–¥—É–ª—è—Ä–Ω–∞—è
   - C: –ì–µ—Ç–µ—Ä–æ–≥–µ–Ω–Ω–æ –ø–ª–æ—Ç–Ω–∞—è
   - D: –ö—Ä–∞–π–Ω–µ –ø–ª–æ—Ç–Ω–∞—è

3. –ü–ê–¢–û–õ–û–ì–ò–ß–ï–°–ö–ò–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø:
   - –û–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è
   - –ö–∞–ª—å—Ü–∏–Ω–∞—Ç—ã
   - –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è
   - –ê—Å–∏–º–º–µ—Ç—Ä–∏—è

4. BI-RADS –ö–ê–¢–ï–ì–û–†–ò–Ø:
   - 0: –ù–µ–ø–æ–ª–Ω–∞—è –æ—Ü–µ–Ω–∫–∞
   - 1: –ù–µ–≥–∞—Ç–∏–≤–Ω–∞—è
   - 2: –î–æ–±—Ä–æ–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–∞—è
   - 3: –í–µ—Ä–æ—è—Ç–Ω–æ –¥–æ–±—Ä–æ–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–∞—è
   - 4: –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–∞—è
   - 5: –í—ã—Å–æ–∫–æ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–∞—è –Ω–∞ –∑–ª–æ–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å
   - 6: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω–∞—è –∑–ª–æ–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å

JSON –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!
"""
        }

    def detect_image_type(self, image_array: np.ndarray) -> Tuple[ImageType, float]:
        """–£–ª—É—á—à–µ–Ω–Ω–æ–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è"""
        height, width = image_array.shape[:2]
        aspect_ratio = width / height
        
        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ grayscale –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
        if len(image_array.shape) == 3:
            is_color = True
            gray_image = np.mean(image_array, axis=2).astype(np.uint8)
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å —Ü–≤–µ—Ç–∞
            rgb_std = np.std(image_array, axis=(0, 1))
            color_variance = np.std(rgb_std)
        else:
            is_color = False
            gray_image = image_array.astype(np.uint8)
            color_variance = 0
        
        # –ë–∞–∑–æ–≤—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        mean_intensity = np.mean(gray_image)
        intensity_std = np.std(gray_image)
        
        # –ê–Ω–∞–ª–∏–∑ –∫—Ä–∞–µ–≤ –∏ —Ç–µ–∫—Å—Ç—É—Ä—ã
        gradient_x = np.gradient(gray_image.astype(float), axis=1)
        gradient_y = np.gradient(gray_image.astype(float), axis=0)
        edge_magnitude = np.sqrt(gradient_x**2 + gradient_y**2)
        edge_density = np.mean(edge_magnitude)
        
        # –ê–Ω–∞–ª–∏–∑ –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º—ã
        hist, bins = np.histogram(gray_image, bins=256, range=(0, 256))
        hist_peaks = []
        for i in range(1, len(hist)-1):
            if hist[i] > hist[i-1] and hist[i] > hist[i+1] and hist[i] > np.max(hist) * 0.1:
                hist_peaks.append(i)
        
        def analyze_periodic_patterns():
            """–ê–Ω–∞–ª–∏–∑ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ (–¥–ª—è –≠–ö–ì)"""
            if width < 200:
                return False, 0
            
            # –ë–µ—Ä–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—É—é –ø–æ–ª–æ—Å—É –ø–æ —Ü–µ–Ω—Ç—Ä—É
            center_row = gray_image[height//2, :]
            
            # –í—ã—á–∏—Å–ª—è–µ–º –∞–≤—Ç–æ–∫–æ—Ä—Ä–µ–ª—è—Ü–∏—é
            autocorr = np.correlate(center_row, center_row, mode='full')
            autocorr = autocorr[len(autocorr)//2:]
            
            # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º
            if autocorr[0] > 0:
                autocorr = autocorr / autocorr[0]
            
            # –ò—â–µ–º –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –ø–∏–∫–∏
            peaks = []
            min_distance = 20  # –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É QRS –∫–æ–º–ø–ª–µ–∫—Å–∞–º–∏
            for i in range(min_distance, min(len(autocorr), 300)):
                if (i >= min_distance and 
                    autocorr[i] > autocorr[i-1] and 
                    autocorr[i] > autocorr[i+1] and
                    autocorr[i] > 0.3):  # –ø–æ—Ä–æ–≥ –¥–ª—è –∑–Ω–∞—á–∏–º–æ–≥–æ –ø–∏–∫–∞
                    peaks.append(i)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–≥—É–ª—è—Ä–Ω–æ—Å—Ç—å –ø–∏–∫–æ–≤
            if len(peaks) >= 3:
                intervals = [peaks[i+1] - peaks[i] for i in range(len(peaks)-1)]
                if intervals:
                    interval_std = np.std(intervals)
                    interval_mean = np.mean(intervals)
                    regularity = 1.0 - (interval_std / max(interval_mean, 1))
                    return len(peaks) >= 3 and regularity > 0.7, regularity
            
            return False, 0

        def analyze_bone_structures():
            """–ê–Ω–∞–ª–∏–∑ –∫–æ—Å—Ç–Ω—ã—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä (–¥–ª—è —Ä–µ–Ω—Ç–≥–µ–Ω–∞)"""
            # –ö–æ—Å—Ç–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∏–º–µ—é—Ç –≤—ã—Å–æ–∫—É—é –ø–ª–æ—Ç–Ω–æ—Å—Ç—å (—è—Ä–∫–∏–µ –æ–±–ª–∞—Å—Ç–∏)
            high_density_threshold = mean_intensity + 1.5 * intensity_std
            bone_pixels = np.sum(gray_image > high_density_threshold)
            bone_ratio = bone_pixels / (width * height)
            
            # –ê–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω–æ—Å—Ç–∏ - –∫–æ—Å—Ç–∏ –¥–æ–ª–∂–Ω—ã —Å–∏–ª—å–Ω–æ –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å –º—è–≥–∫–∏–º–∏ —Ç–∫–∞–Ω—è–º–∏
            contrast_ratio = intensity_std / max(mean_intensity, 1)
            
            # –ü–æ–∏—Å–∫ –ª–∏–Ω–µ–π–Ω—ã—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä (—Ä–µ–±—Ä–∞, –ø–æ–∑–≤–æ–Ω–æ—á–Ω–∏–∫)
            # –ü—Ä–∏–º–µ–Ω—è–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π –∏ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä—ã –°–æ–±–µ–ª—è
            sobel_h = np.abs(np.gradient(gray_image, axis=0))
            sobel_v = np.abs(np.gradient(gray_image, axis=1))
            
            strong_edges = np.sum((sobel_h > np.mean(sobel_h) + np.std(sobel_h)) | 
                                 (sobel_v > np.mean(sobel_v) + np.std(sobel_v)))
            edge_ratio = strong_edges / (width * height)
            
            # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã—Ö –¥–ª—è —Ä–µ–Ω—Ç–≥–µ–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä
            # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —è—Ä–∫–æ—Å—Ç–∏ - –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–∏–º–æ–¥–∞–ª—å–Ω—ã–º –∏–ª–∏ –º—É–ª—å—Ç–∏–º–æ–¥–∞–ª—å–Ω—ã–º
            hist_diversity = len(hist_peaks)
            
            bone_score = (bone_ratio * 2 + contrast_ratio + edge_ratio + hist_diversity/10) / 4
            return bone_score > 0.15, bone_score

        def analyze_brain_structures():
            """–ê–Ω–∞–ª–∏–∑ –º–æ–∑–≥–æ–≤—ã—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä (–¥–ª—è –ú–†–¢/–ö–¢)"""
            # –ú–æ–∑–≥ –∏–º–µ–µ—Ç —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω—É—é —Ñ–æ—Ä–º—É –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É
            center_y, center_x = height//2, width//2
            
            # –ê–Ω–∞–ª–∏–∑ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏
            center_size = min(height, width) // 4
            if center_size > 0:
                center_region = gray_image[max(0, center_y-center_size):min(height, center_y+center_size),
                                          max(0, center_x-center_size):min(width, center_x+center_size)]
                
                if center_region.size > 0:
                    # –ú–æ–∑–≥–æ–≤–∞—è —Ç–∫–∞–Ω—å –∏–º–µ–µ—Ç —Å—Ä–µ–¥–Ω—é—é –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å —Å —É–º–µ—Ä–µ–Ω–Ω–æ–π –≤–∞—Ä–∏–∞–±–µ–ª—å–Ω–æ—Å—Ç—å—é
                    center_mean = np.mean(center_region)
                    center_std = np.std(center_region)
                    
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –∫—Ä—É–≥–ª—ã—Ö/–æ–≤–∞–ª—å–Ω—ã—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä
                    # –ü—Ä–æ—Å—Ç–æ–π –∞–Ω–∞–ª–∏–∑ —Å–∏–º–º–µ—Ç—Ä–∏–∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ü–µ–Ω—Ç—Ä–∞
                    if center_region.shape[0] > 20 and center_region.shape[1] > 20:
                        h, w = center_region.shape
                        top_half = center_region[:h//2, :]
                        bottom_half = center_region[h//2:, :]
                        bottom_half_flipped = np.flipud(bottom_half)
                        
                        if top_half.shape == bottom_half_flipped.shape:
                            symmetry_score = 1.0 - np.mean(np.abs(top_half.astype(float) - bottom_half_flipped.astype(float))) / 255.0
                        else:
                            symmetry_score = 0
                        
                        brain_score = (symmetry_score + min(center_std/50, 1) + min(center_mean/128, 1)) / 3
                        return brain_score > 0.4, brain_score
            
            return False, 0

        def analyze_ultrasound_patterns():
            """–ê–Ω–∞–ª–∏–∑ –£–ó–ò –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤"""
            # –£–ó–ò –∏–º–µ–µ—Ç —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –∏ —Ç–µ–∫—Å—Ç—É—Ä—É
            # –û–±—ã—á–Ω–æ —Ç–µ–º–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å —è—Ä–∫–∏–º–∏ —ç—Ö–æ-—Å–∏–≥–Ω–∞–ª–∞–º–∏
            dark_threshold = mean_intensity - 0.5 * intensity_std
            dark_pixels = np.sum(gray_image < dark_threshold)
            dark_ratio = dark_pixels / (width * height)
            
            # –£–ó–ò –æ–±—ã—á–Ω–æ –∏–º–µ–µ—Ç –≤–µ–µ—Ä–æ–æ–±—Ä–∞–∑–Ω—É—é –∏–ª–∏ —Å–µ–∫—Ç–æ—Ä–Ω—É—é —Ñ–æ—Ä–º—É
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–π –ø–æ –∫—Ä–∞—è–º
            edge_darkness = (np.mean(gray_image[:, :10]) + np.mean(gray_image[:, -10:]) + 
                           np.mean(gray_image[:10, :]) + np.mean(gray_image[-10:, :])) / 4
            
            edge_contrast = (mean_intensity - edge_darkness) / max(mean_intensity, 1)
            
            # –£–ó–ò —á–∞—Å—Ç–æ –∏–º–µ–µ—Ç —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã (—Ä–µ–≤–µ—Ä–±–µ—Ä–∞—Ü–∏–∏, —Ç–µ–Ω–∏)
            us_score = (dark_ratio + edge_contrast + min(intensity_std/40, 1)) / 3
            return us_score > 0.4 and mean_intensity < 120, us_score

        # –í—ã–ø–æ–ª–Ω—è–µ–º –∞–Ω–∞–ª–∏–∑—ã
        has_periodic, periodic_score = analyze_periodic_patterns()
        has_bones, bone_score = analyze_bone_structures()
        has_brain, brain_score = analyze_brain_structures()
        has_us_pattern, us_score = analyze_ultrasound_patterns()
        
        # –ü—Ä–∏–Ω—è—Ç–∏–µ —Ä–µ—à–µ–Ω–∏—è —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –ª–æ–≥–∏–∫–æ–π
        scores = {}
        
        # –≠–ö–ì: –¥–ª–∏–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç + –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã + –º–æ–Ω–æ—Ö—Ä–æ–º + –Ω–∏–∑–∫–∞—è –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å
        if (aspect_ratio > 1.5 and not is_color and has_periodic and 
            mean_intensity < 200 and edge_density > 10):
            scores[ImageType.ECG] = 0.85 + periodic_score * 0.15
        elif aspect_ratio > 2.0 and not is_color and edge_density > 15:
            scores[ImageType.ECG] = 0.6
        
        # –†–µ–Ω—Ç–≥–µ–Ω: –∫–æ—Å—Ç–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã + –≤—ã—Å–æ–∫–∏–π –∫–æ–Ω—Ç—Ä–∞—Å—Ç + –º–æ–Ω–æ—Ö—Ä–æ–º
        # –ü–†–ò–û–†–ò–¢–ï–¢: —Ä–µ–Ω—Ç–≥–µ–Ω –¥–æ–ª–∂–µ–Ω –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å—Å—è –ü–ï–†–ï–î –¥–µ—Ä–º–∞—Ç–æ—Å–∫–æ–ø–∏–µ–π –¥–ª—è –º–æ–Ω–æ—Ö—Ä–æ–º–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        if not is_color and has_bones:
            base_score = 0.8 + bone_score * 0.2  # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –±–∞–∑–æ–≤—ã–π —Å–∫–æ—Ä
            # –ë–æ–Ω—É—Å –∑–∞ —Ç–∏–ø–∏—á–Ω—ã–µ —Ä–µ–Ω—Ç–≥–µ–Ω–æ–≤—Å–∫–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
            if len(hist_peaks) >= 2 and intensity_std > 40:
                base_score += 0.15
            if aspect_ratio < 2.0:  # —Ä–µ–Ω—Ç–≥–µ–Ω –æ–±—ã—á–Ω–æ –Ω–µ –æ—á–µ–Ω—å –≤—ã—Ç—è–Ω—É—Ç—ã–π
                base_score += 0.1
            # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –±–æ–Ω—É—Å –∑–∞ –±–æ–ª—å—à–∏–µ —Ä–∞–∑–º–µ—Ä—ã (—Ä–µ–Ω—Ç–≥–µ–Ω –æ–±—ã—á–Ω–æ –∫—Ä—É–ø–Ω–µ–µ –¥–µ—Ä–º–∞—Ç–æ—Å–∫–æ–ø–∏–∏)
            if max(width, height) > 1000:
                base_score += 0.1
            scores[ImageType.XRAY] = min(base_score, 0.98)  # –û—á–µ–Ω—å –≤—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
        elif not is_color and intensity_std > 50 and edge_density > 30:
            # –î–∞–∂–µ –±–µ–∑ —è–≤–Ω—ã—Ö –∫–æ—Å—Ç–µ–π, –µ—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–∏–∑–Ω–∞–∫–∏ —Ä–µ–Ω—Ç–≥–µ–Ω–∞
            if max(width, height) > 800:  # –†–µ–Ω—Ç–≥–µ–Ω –æ–±—ã—á–Ω–æ –∫—Ä—É–ø–Ω–µ–µ
                scores[ImageType.XRAY] = 0.65
            else:
                scores[ImageType.XRAY] = 0.5
        
        # –ú–†–¢/–ö–¢: –º–æ–∑–≥–æ–≤—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã + –º–æ–Ω–æ—Ö—Ä–æ–º + —Å—Ä–µ–¥–Ω—è—è –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å
        if not is_color and has_brain and mean_intensity > 60 and mean_intensity < 200:
            scores[ImageType.MRI] = 0.75 + brain_score * 0.2
        elif not is_color and aspect_ratio < 1.5 and mean_intensity > 80:
            scores[ImageType.CT] = 0.6
        
        # –£–ó–ò: —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã + –º–æ–Ω–æ—Ö—Ä–æ–º + –Ω–∏–∑–∫–∞—è –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å
        if not is_color and has_us_pattern:
            scores[ImageType.ULTRASOUND] = 0.7 + us_score * 0.25
        elif not is_color and mean_intensity < 100 and edge_density < 40:
            scores[ImageType.ULTRASOUND] = 0.5
        
        # –î–µ—Ä–º–∞—Ç–æ—Å–∫–æ–ø–∏—è: –¢–û–õ–¨–ö–û –¥–ª—è —Ü–≤–µ—Ç–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π + –≤—ã—Å–æ–∫–∞—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è + –Ω–µ–±–æ–ª—å—à–æ–π —Ä–∞–∑–º–µ—Ä
        # –í–ê–ñ–ù–û: –¥–µ—Ä–º–∞—Ç–æ—Å–∫–æ–ø–∏—è –ù–ï –¥–æ–ª–∂–Ω–∞ –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å—Å—è –¥–ª—è –º–æ–Ω–æ—Ö—Ä–æ–º–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        if is_color and color_variance > 20 and edge_density > 40:
            if max(width, height) < 1500:  # –æ–±—ã—á–Ω–æ –Ω–µ–±–æ–ª—å—à–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                scores[ImageType.DERMATOSCOPY] = 0.75
        
        # –ì–∏—Å—Ç–æ–ª–æ–≥–∏—è: —Ü–≤–µ—Ç–Ω–æ–µ + –æ—á–µ–Ω—å –≤—ã—Å–æ–∫–∞—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è + —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
        if is_color and edge_density > 80 and color_variance > 30:
            scores[ImageType.HISTOLOGY] = 0.7
        
        # –û—Ñ—Ç–∞–ª—å–º–æ–ª–æ–≥–∏—è: –∫—Ä—É–≥–ª—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã + —Å—Ä–µ–¥–Ω–∏–π —Ä–∞–∑–º–µ—Ä
        # –í–ê–ñ–ù–û: –æ—Ñ—Ç–∞–ª—å–º–æ–ª–æ–≥–∏—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ù–ï–¢ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ —Ä–µ–Ω—Ç–≥–µ–Ω–∞ (–∫–æ—Å—Ç–Ω—ã—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä)
        if aspect_ratio > 0.8 and aspect_ratio < 1.3:
            if max(width, height) < 1000:
                # –û—Ñ—Ç–∞–ª—å–º–æ–ª–æ–≥–∏—è –∏–º–µ–µ—Ç –Ω–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –¥–ª—è –º–æ–Ω–æ—Ö—Ä–æ–º–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
                # –∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ—Ç –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ —Ä–µ–Ω—Ç–≥–µ–Ω–∞
                if is_color:
                    scores[ImageType.RETINAL] = 0.65
                elif not has_bones:  # –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ—Ç –∫–æ—Å—Ç–Ω—ã—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä (–Ω–µ —Ä–µ–Ω—Ç–≥–µ–Ω)
                    scores[ImageType.RETINAL] = 0.4  # –°–Ω–∏–∂–∞–µ–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –¥–ª—è –º–æ–Ω–æ—Ö—Ä–æ–º–Ω—ã—Ö
        
        # –ú–∞–º–º–æ–≥—Ä–∞—Ñ–∏—è: —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç—Ä–∞—Å—Ç + –º–æ–Ω–æ—Ö—Ä–æ–º + –±–æ–ª—å—à–æ–π —Ä–∞–∑–º–µ—Ä
        if (not is_color and intensity_std > 35 and mean_intensity > 70 and 
            max(width, height) > 800):
            scores[ImageType.MAMMOGRAPHY] = 0.65
        
        # –í—ã–±–∏—Ä–∞–µ–º —Ç–∏–ø —Å –Ω–∞–∏–≤—ã—Å—à–∏–º —Å–∫–æ—Ä–æ–º
        if scores:
            best_type = max(scores.keys(), key=lambda k: scores[k])
            best_score = scores[best_type]
            return best_type, best_score
        
        # –ó–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç - —Å–∞–º—ã–π –≤–µ—Ä–æ—è—Ç–Ω—ã–π —Ç–∏–ø –Ω–∞ –æ—Å–Ω–æ–≤–µ –±–∞–∑–æ–≤—ã—Ö —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫
        if not is_color:
            if aspect_ratio > 2.0:
                return ImageType.ECG, 0.3
            elif intensity_std > 40:
                # –î–ª—è –º–æ–Ω–æ—Ö—Ä–æ–º–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å –≤—ã—Å–æ–∫–∏–º –∫–æ–Ω—Ç—Ä–∞—Å—Ç–æ–º - —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ —Ä–µ–Ω—Ç–≥–µ–Ω
                return ImageType.XRAY, 0.5  # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å
            else:
                return ImageType.ULTRASOUND, 0.3
        else:
            # –¢–æ–ª—å–∫–æ –¥–ª—è —Ü–≤–µ—Ç–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π - –¥–µ—Ä–º–∞—Ç–æ—Å–∫–æ–ø–∏—è
            return ImageType.DERMATOSCOPY, 0.3

    def preprocess_image(self, image_array: np.ndarray, image_type: ImageType) -> np.ndarray:
        """–ü—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞"""
        # –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —É –Ω–∞—Å –µ—Å—Ç—å –∫–æ–ø–∏—è –º–∞—Å—Å–∏–≤–∞
        processed = image_array.copy()
        
        if image_type == ImageType.ECG:
            # –î–ª—è –≠–ö–ì: –ø–æ–≤—ã—à–µ–Ω–∏–µ –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω–æ—Å—Ç–∏ –∏ —É–¥–∞–ª–µ–Ω–∏–µ —à—É–º–∞
            if len(processed.shape) == 3:
                processed = np.mean(processed, axis=2)
            
            # –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞
            min_val, max_val = np.min(processed), np.max(processed)
            if max_val > min_val:
                processed = ((processed - min_val) / (max_val - min_val) * 255).astype(np.uint8)
            else:
                processed = processed.astype(np.uint8)
            
        elif image_type == ImageType.XRAY:
            # –î–ª—è —Ä–µ–Ω—Ç–≥–µ–Ω–∞: —É–ª—É—á—à–µ–Ω–∏–µ –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω–æ—Å—Ç–∏ –∫–æ—Å—Ç–Ω—ã—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä
            if len(processed.shape) == 3:
                processed = np.mean(processed, axis=2)
            
            # –ì–∞–º–º–∞-–∫–æ—Ä—Ä–µ–∫—Ü–∏—è –¥–ª—è –ª—É—á—à–µ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–æ—Å—Ç–µ–π
            processed = processed.astype(np.float64)
            processed = (processed / 255.0) ** 0.8  # –≥–∞–º–º–∞ = 0.8
            processed = (processed * 255).astype(np.uint8)
            
        elif image_type in [ImageType.MRI, ImageType.CT]:
            # –î–ª—è –ú–†–¢/–ö–¢: —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è
            if len(processed.shape) == 3:
                processed = np.mean(processed, axis=2)
            
            min_val, max_val = np.min(processed), np.max(processed)
            if max_val > min_val:
                processed = ((processed - min_val) / (max_val - min_val) * 255).astype(np.uint8)
            
        elif image_type == ImageType.ULTRASOUND:
            # –î–ª—è –£–ó–ò: —É–ª—É—á—à–µ–Ω–∏–µ –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω–æ—Å—Ç–∏ —ç—Ö–æ-—Å–∏–≥–Ω–∞–ª–æ–≤
            if len(processed.shape) == 3:
                processed = np.mean(processed, axis=2)
            
            # –õ–æ–≥–∞—Ä–∏—Ñ–º–∏—á–µ—Å–∫–æ–µ —Å–∂–∞—Ç–∏–µ –¥–ª—è –£–ó–ò
            processed = processed.astype(np.float64)
            processed = np.log1p(processed)  # log(1 + x)
            processed = (processed / np.max(processed) * 255).astype(np.uint8)
            
        elif image_type in [ImageType.DERMATOSCOPY, ImageType.HISTOLOGY]:
            # –î–ª—è —Ü–≤–µ—Ç–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π: –∫–æ—Ä—Ä–µ–∫—Ü–∏—è –±–∞–ª–∞–Ω—Å–∞ –±–µ–ª–æ–≥–æ
            if len(processed.shape) == 3:
                for i in range(3):
                    channel = processed[:, :, i].astype(np.float64)
                    min_val, max_val = np.min(channel), np.max(channel)
                    if max_val > min_val:
                        processed[:, :, i] = ((channel - min_val) / (max_val - min_val) * 255).astype(np.uint8)
        
        return processed

    def extract_metadata(self, image_array: np.ndarray, image_type: ImageType) -> Dict[str, Any]:
        """–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è"""
        metadata = {
            "image_shape": list(image_array.shape),
            "image_type_detected": image_type.value,
            "data_type": str(image_array.dtype),
            "min_value": float(np.min(image_array)),
            "max_value": float(np.max(image_array)),
            "mean_value": float(np.mean(image_array)),
            "std_value": float(np.std(image_array)),
            "is_color": len(image_array.shape) == 3,
            "aspect_ratio": float(image_array.shape[1] / image_array.shape[0])
        }
        
        # –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤
        if image_type == ImageType.ECG:
            metadata.update({
                "estimated_paper_speed": "25 mm/s (—Å—Ç–∞–Ω–¥–∞—Ä—Ç)",
                "estimated_amplitude_calibration": "10 mm/mV (—Å—Ç–∞–Ω–¥–∞—Ä—Ç)",
                "signal_quality_score": float(min(np.std(image_array) / max(np.mean(image_array), 1), 2.0)),
                "detection_confidence": "–≤—ã—Å–æ–∫–∞—è" if metadata["aspect_ratio"] > 2.0 else "—Å—Ä–µ–¥–Ω—è—è"
            })
            
        elif image_type == ImageType.XRAY:
            # –û—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ —Ä–µ–Ω—Ç–≥–µ–Ω–∞
            contrast_ratio = float(np.std(image_array) / max(np.mean(image_array), 1))
            metadata.update({
                "estimated_kvp": "–∞–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ",
                "estimated_mas": "–∞–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ", 
                "contrast_ratio": contrast_ratio,
                "image_quality": "—Ö–æ—Ä–æ—à–µ–µ" if contrast_ratio > 0.3 else "—É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ–µ",
                "bone_visibility": "–≤—ã—Å–æ–∫–∞—è" if contrast_ratio > 0.5 else "—Å—Ä–µ–¥–Ω—è—è"
            })
            
        elif image_type in [ImageType.MRI, ImageType.CT]:
            metadata.update({
                "estimated_sequence": "T1/T2 (–∞–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ)" if image_type == ImageType.MRI else "–Ω–∞—Ç–∏–≤–Ω–∞—è –ö–¢",
                "slice_orientation": "–∞–∫—Å–∏–∞–ª—å–Ω–∞—è (–ø—Ä–µ–¥–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ)",
                "tissue_contrast": float(np.std(image_array) / max(np.mean(image_array), 1))
            })
            
        elif image_type == ImageType.ULTRASOUND:
            metadata.update({
                "estimated_frequency": "2-10 –ú–ì—Ü (—Å—Ç–∞–Ω–¥–∞—Ä—Ç)",
                "estimated_depth": "–∞–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ",
                "echo_pattern": "—Å–º–µ—à–∞–Ω–Ω—ã–π",
                "image_optimization": "—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è"
            })
        
        return metadata

    def encode_image_optimized(self, image_array: np.ndarray) -> str:
        """–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è"""
        if isinstance(image_array, np.ndarray):
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∂–∏–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            if len(image_array.shape) == 2:
                img = Image.fromarray(image_array, mode='L')
            elif len(image_array.shape) == 3 and image_array.shape[2] == 3:
                img = Image.fromarray(image_array.astype(np.uint8), mode='RGB')
            elif len(image_array.shape) == 3 and image_array.shape[2] == 4:
                img = Image.fromarray(image_array.astype(np.uint8), mode='RGBA')
            else:
                # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ grayscale –µ—Å–ª–∏ —Ñ–æ—Ä–º–∞—Ç –Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω
                if len(image_array.shape) == 3:
                    gray = np.mean(image_array, axis=2).astype(np.uint8)
                else:
                    gray = image_array.astype(np.uint8)
                img = Image.fromarray(gray, mode='L')
        else:
            img = image_array
        
        # –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –¥–ª—è –ò–ò –∞–Ω–∞–ª–∏–∑–∞ (–±–∞–ª–∞–Ω—Å –∫–∞—á–µ—Å—Ç–≤–∞ –∏ —Å–∫–æ—Ä–æ—Å—Ç–∏)
        max_size = (1024, 1024)
        img.thumbnail(max_size, Image.Resampling.LANCZOS)
        
        # –°–∂–∞—Ç–∏–µ —Å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
        buffered = io.BytesIO()
        if img.mode in ['RGB', 'RGBA']:
            img.save(buffered, format="JPEG", quality=85, optimize=True)
        else:
            img.save(buffered, format="PNG", optimize=True, compress_level=6)
        
        img_str = base64.b64encode(buffered.getvalue()).decode()
        return img_str

    def analyze_image(self, image_array: np.ndarray, image_type: Optional[ImageType] = None, 
                     additional_context: str = "") -> AnalysisResult:
        """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è"""
        
        try:
            # –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            if not isinstance(image_array, np.ndarray):
                raise ValueError("image_array –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å numpy.ndarray")
            
            if image_array.size == 0:
                raise ValueError("–ü—É—Å—Ç–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ")
            
            # –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞, –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω
            # –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –±–µ–∑ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞
            if image_type is None:
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Ç–∏–ø –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞, –Ω–æ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –µ–≥–æ —è–≤–Ω–æ
                # –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ª—é–±–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±–µ–∑ –ø—Ä–∏–≤—è–∑–∫–∏ –∫ —Ç–∏–ø—É
                image_type = ImageType.XRAY  # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞–∫ –±–∞–∑–æ–≤—ã–π —Ç–∏–ø –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
                confidence = 1.0
                print(f"–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –±–µ–∑ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞")
            else:
                confidence = 1.0
                print(f"–£–∫–∞–∑–∞–Ω–Ω—ã–π —Ç–∏–ø: {image_type.value}")
            
            # –ü—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª—è —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞)
            processed_image = image_array.copy()
            if len(processed_image.shape) == 3:
                # –î–ª—è —Ü–≤–µ—Ç–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
                pass
            else:
                # –î–ª—è –º–æ–Ω–æ—Ö—Ä–æ–º–Ω—ã—Ö - –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è
                min_val, max_val = np.min(processed_image), np.max(processed_image)
                if max_val > min_val:
                    processed_image = ((processed_image - min_val) / (max_val - min_val) * 255).astype(np.uint8)
            
            # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
            metadata = self.extract_metadata(processed_image, image_type)
            
            # –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ª—é–±–æ–≥–æ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            base_prompt = """–í—ã - –æ–ø—ã—Ç–Ω—ã–π –≤—Ä–∞—á-–¥–∏–∞–≥–Ω–æ—Å—Ç —Å –º–Ω–æ–≥–æ–ª–µ—Ç–Ω–∏–º –∫–ª–∏–Ω–∏—á–µ—Å–∫–∏–º –æ–ø—ã—Ç–æ–º. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–µ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ –∏ –¥–µ—Ç–∞–ª—å–Ω–æ.

–û—Ü–µ–Ω–∏—Ç–µ:
1. –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–∫–∞—á–µ—Å—Ç–≤–æ, –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã, –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω–æ—Å—Ç—å)
2. –í—Å–µ –≤–∏–¥–∏–º—ã–µ –∞–Ω–∞—Ç–æ–º–∏—á–µ—Å–∫–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
3. –ü–∞—Ç–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –æ—Ç –Ω–æ—Ä–º—ã
4. –ö–ª–∏–Ω–∏—á–µ—Å–∫—É—é –∑–Ω–∞—á–∏–º–æ—Å—Ç—å –Ω–∞—Ö–æ–¥–æ–∫
5. –î–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É
6. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –¥–∞–ª—å–Ω–µ–π—à–µ–º—É –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏—é –∏ —Ç–∞–∫—Ç–∏–∫–µ –≤–µ–¥–µ–Ω–∏—è

–î–∞–π—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –∫–ª–∏–Ω–∏—á–µ—Å–∫–æ–π –¥–∏—Ä–µ–∫—Ç–∏–≤—ã."""
            
            if additional_context:
                base_prompt += f"\n\n–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–ª–∏–Ω–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç: {additional_context}"
            
            # –î–æ–±–∞–≤–ª—è–µ–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ JSON –æ—Ç–≤–µ—Ç–∞
            json_instruction = """

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –û—Ç–≤–µ—Ç—å—Ç–µ –°–¢–†–û–ì–û –≤ —Å–ª–µ–¥—É—é—â–µ–º JSON —Ñ–æ—Ä–º–∞—Ç–µ:
{
    "confidence_score": 0.95,
    "technical_assessment": {
        "quality": "–æ—Ç–ª–∏—á–Ω–æ–µ/—Ö–æ—Ä–æ—à–µ–µ/—É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ–µ/–ø–ª–æ—Ö–æ–µ",
        "artifacts": ["—Å–ø–∏—Å–æ–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤"],
        "technical_notes": "—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∑–∞–º–µ—á–∞–Ω–∏—è",
        "positioning": "–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ/–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ",
        "exposure": "–æ–ø—Ç–∏–º–∞–ª—å–Ω–∞—è/–Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è/–∏–∑–±—ã—Ç–æ—á–Ω–∞—è"
    },
    "clinical_findings": {
        "normal_structures": ["—Å–ø–∏—Å–æ–∫ –Ω–æ—Ä–º–∞–ª—å–Ω—ã—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä"],
        "pathological_findings": [
            {
                "finding": "–Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–∞—Ö–æ–¥–∫–∏",
                "location": "—Ç–æ—á–Ω–∞—è –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è",
                "severity": "–ª–µ–≥–∫–∞—è/—É–º–µ—Ä–µ–Ω–Ω–∞—è/–≤—ã—Ä–∞–∂–µ–Ω–Ω–∞—è/–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è",
                "description": "–ø–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ",
                "size": "—Ä–∞–∑–º–µ—Ä—ã –µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ",
                "characteristics": "–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏"
            }
        ],
        "measurements": "–∫–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ—Ä–µ–Ω–∏—è –µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ"
    },
    "diagnosis": {
        "primary_diagnosis": "–æ—Å–Ω–æ–≤–Ω–æ–π –¥–∏–∞–≥–Ω–æ–∑",
        "differential_diagnosis": ["—Å–ø–∏—Å–æ–∫ –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –¥–∏–∞–≥–Ω–æ–∑–æ–≤"],
        "icd10_codes": ["–∫–æ–¥—ã –ø–æ –ú–ö–ë-10"],
        "confidence_level": "–≤—ã—Å–æ–∫–∞—è/—Å—Ä–µ–¥–Ω—è—è/–Ω–∏–∑–∫–∞—è"
    },
    "recommendations": {
        "urgent_actions": ["—ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è"],
        "follow_up": ["–ø–ª–∞–Ω –Ω–∞–±–ª—é–¥–µ–Ω–∏—è"],
        "additional_studies": ["–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è"],
        "consultation": ["–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤"],
        "treatment": ["—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ª–µ—á–µ–Ω–∏—é"]
    },
    "risk_assessment": {
        "urgency_level": "—ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ/—Å—Ä–æ—á–Ω–æ/–ø–ª–∞–Ω–æ–≤–æ",
        "risk_factors": ["–≤—ã—è–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã —Ä–∏—Å–∫–∞"],
        "prognosis": "–±–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω—ã–π/–æ—Å—Ç–æ—Ä–æ–∂–Ω—ã–π/–Ω–µ–±–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω—ã–π",
        "complications": ["–≤–æ–∑–º–æ–∂–Ω—ã–µ –æ—Å–ª–æ–∂–Ω–µ–Ω–∏—è"]
    }
}

–ù–ï –î–û–ë–ê–í–õ–Ø–ô–¢–ï –Ω–∏–∫–∞–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –¥–æ –∏–ª–∏ –ø–æ—Å–ª–µ JSON! –û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–∞–ª–∏–¥–Ω—ã–º JSON!
"""
            
            full_prompt = base_prompt + json_instruction
            
            # –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ –ò–ò
            print("–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ –ò–ò...")
            ai_response, model_name, tokens_used = self._send_ai_request(full_prompt, processed_image, metadata)
            
            # –ü–∞—Ä—Å–∏–Ω–≥ –æ—Ç–≤–µ—Ç–∞
            try:
                # –û—á–∏—Å—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞ –æ—Ç –ª–∏—à–Ω–µ–≥–æ —Ç–µ–∫—Å—Ç–∞
                clean_response = ai_response.strip()
                if clean_response.startswith('```json'):
                    clean_response = clean_response[7:]
                if clean_response.endswith('```'):
                    clean_response = clean_response[:-3]
                clean_response = clean_response.strip()
                
                response_data = json.loads(clean_response)
                print("JSON —É—Å–ø–µ—à–Ω–æ —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω")
                
            except json.JSONDecodeError as e:
                print(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON: {e}")
                print(f"–û—Ç–≤–µ—Ç –ò–ò: {ai_response[:500]}...")
                
                # –°–æ–∑–¥–∞–µ–º –±–∞–∑–æ–≤—ã–π –æ—Ç–≤–µ—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ –ø–∞—Ä—Å–∏–Ω–≥–∞
                response_data = {
                    "confidence_score": 0.5,
                    "technical_assessment": {
                        "quality": "–Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ", 
                        "artifacts": ["–æ—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞"], 
                        "technical_notes": "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç –ò–ò",
                        "positioning": "–Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ",
                        "exposure": "–Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ"
                    },
                    "clinical_findings": {
                        "normal_structures": [], 
                        "pathological_findings": [
                            {
                                "finding": "–ê–Ω–∞–ª–∏–∑ –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω",
                                "location": "–Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ",
                                "severity": "–Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ", 
                                "description": "–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∞–Ω–∞–ª–∏–∑",
                                "size": "–Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ",
                                "characteristics": "–Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ"
                            }
                        ],
                        "measurements": "–Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ"
                    },
                    "diagnosis": {
                        "primary_diagnosis": "–¢—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑", 
                        "differential_diagnosis": [], 
                        "icd10_codes": [],
                        "confidence_level": "–Ω–∏–∑–∫–∞—è"
                    },
                    "recommendations": {
                        "urgent_actions": ["–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∞–Ω–∞–ª–∏–∑"], 
                        "follow_up": ["–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –≤—Ä–∞—á–∞"], 
                        "additional_studies": ["–ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ"],
                        "consultation": ["–í—Ä–∞—á —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏"],
                        "treatment": []
                    },
                    "risk_assessment": {
                        "urgency_level": "–ø–ª–∞–Ω–æ–≤–æ", 
                        "risk_factors": [], 
                        "prognosis": "–Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π",
                        "complications": []
                    }
                }
            
            # –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Ç–∏–ø –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞, –Ω–æ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –µ–≥–æ
            result = AnalysisResult(
                image_type=ImageType.XRAY,  # –ë–∞–∑–æ–≤—ã–π —Ç–∏–ø –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã, –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                confidence=confidence * response_data.get("confidence_score", 0.5),
                structured_findings=response_data,
                clinical_interpretation=ai_response,
                recommendations=response_data.get("recommendations", {}).get("follow_up", []),
                urgent_flags=response_data.get("recommendations", {}).get("urgent_actions", []),
                icd10_codes=response_data.get("diagnosis", {}).get("icd10_codes", []),
                timestamp=datetime.datetime.now().isoformat(),
                metadata=metadata,
                model_name=model_name,
                tokens_used=tokens_used
            )
            
            print(f"–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ. –¢–∏–ø: {image_type.value}, –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: {result.confidence:.2f}")
            return result
            
        except Exception as e:
            print(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ analyze_image: {e}")
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å –æ—à–∏–±–∫–æ–π
            error_result = AnalysisResult(
                image_type=image_type or ImageType.XRAY,
                confidence=0.0,
                structured_findings={"error": str(e)},
                clinical_interpretation=f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞: {str(e)}",
                recommendations=["–û–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –≤—Ä–∞—á—É"],
                urgent_flags=["–û—à–∏–±–∫–∞ —Å–∏—Å—Ç–µ–º—ã"],
                icd10_codes=[],
                timestamp=datetime.datetime.now().isoformat(),
                metadata={},
                model_name="–û—à–∏–±–∫–∞",
                tokens_used=0
            )
            return error_result

    def _send_ai_request(self, prompt: str, image_array: np.ndarray, metadata: Dict) -> tuple:
        """–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ –ò–ò —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
        
        Returns:
            tuple: (–æ—Ç–≤–µ—Ç, –Ω–∞–∑–≤–∞–Ω–∏–µ_–º–æ–¥–µ–ª–∏, —Ç–æ–∫–µ–Ω—ã)
        """
        try:
            # –ö–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            base64_image = self.encode_image_optimized(image_array)
            
            # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
            content = [
                {
                    "type": "text", 
                    "text": f"–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:\n{json.dumps(metadata, ensure_ascii=False, indent=2)}\n\n{prompt}"
                },
                {
                    "type": "image_url", 
                    "image_url": {"url": f"data:image/jpeg;base64,{base64_image}"}
                }
            ]
            
            # –ü—Ä–æ–±—É–µ–º –º–æ–¥–µ–ª–∏ –ø–æ –ø–æ—Ä—è–¥–∫—É
            last_error = None
            for i, model in enumerate(self.models):
                try:
                    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —á–∏—Ç–∞–µ–º–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏
                    model_name = self._get_model_display_name(model)
                    print(f"ü§ñ [–†–ê–°–®–ò–†–ï–ù–ù–´–ô –ê–ù–ê–õ–ò–ó] –ü—Ä–æ–±—É–µ–º –º–æ–¥–µ–ª—å {i+1}/{len(self.models)}: {model_name} ({model})", file=sys.stderr, flush=True)
                    
                    payload = {
                        "model": model,
                        "messages": [{"role": "user", "content": content}],
                        "max_tokens": 4000,
                        "temperature": 0.1,
                        "top_p": 0.9
                    }
                    
                    start_time = time.time()
                    response = requests.post(
                        self.base_url, 
                        headers=self.headers, 
                        json=payload, 
                        timeout=180
                    )
                    latency = time.time() - start_time
                    
                    if response.status_code == 200:
                        result = response.json()
                        if "choices" in result and len(result["choices"]) > 0:
                            content = result["choices"][0]["message"]["content"]
                            tokens_used = result.get("usage", {}).get("total_tokens", 0)
                            print(f"‚úÖ [–†–ê–°–®–ò–†–ï–ù–ù–´–ô –ê–ù–ê–õ–ò–ó] –£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç –º–æ–¥–µ–ª–∏: {model_name}", file=sys.stderr, flush=True)
                            print(f"üìä [–†–ê–°–®–ò–†–ï–ù–ù–´–ô –ê–ù–ê–õ–ò–ó] –ó–∞–¥–µ—Ä–∂–∫–∞: {latency:.2f}—Å, –¢–æ–∫–µ–Ω–æ–≤: {tokens_used}, –°–∏–º–≤–æ–ª–æ–≤ –æ—Ç–≤–µ—Ç–∞: {len(content)}", file=sys.stderr, flush=True)
                            return content, model_name, tokens_used
                        else:
                            print(f"–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç –º–æ–¥–µ–ª–∏: {model}")
                            continue
                    else:
                        print(f"HTTP –æ—à–∏–±–∫–∞ {response.status_code} –¥–ª—è –º–æ–¥–µ–ª–∏ {model}: {response.text}")
                        last_error = f"HTTP {response.status_code}: {response.text}"
                        continue
                        
                except requests.exceptions.Timeout:
                    print(f"–¢–∞–π–º–∞—É—Ç –¥–ª—è –º–æ–¥–µ–ª–∏: {model}")
                    last_error = "–¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞"
                    continue
                except requests.exceptions.RequestException as e:
                    print(f"–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –¥–ª—è –º–æ–¥–µ–ª–∏ {model}: {e}")
                    last_error = f"–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: {str(e)}"
                    continue
                except Exception as e:
                    print(f"–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –¥–ª—è –º–æ–¥–µ–ª–∏ {model}: {e}")
                    last_error = f"–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {str(e)}"
                    continue
            
            # –ï—Å–ª–∏ –≤—Å–µ –º–æ–¥–µ–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã
            error_response = {
                "confidence_score": 0.0,
                "technical_assessment": {
                    "quality": "–Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ",
                    "artifacts": ["–æ—à–∏–±–∫–∞ –ò–ò-—Å–µ—Ä–≤–∏—Å–∞"],
                    "technical_notes": f"–í—Å–µ –º–æ–¥–µ–ª–∏ –ò–ò –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã. –ü–æ—Å–ª–µ–¥–Ω—è—è –æ—à–∏–±–∫–∞: {last_error}",
                    "positioning": "–Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ",
                    "exposure": "–Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ"
                },
                "clinical_findings": {
                    "normal_structures": [],
                    "pathological_findings": [],
                    "measurements": "–Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ"
                },
                "diagnosis": {
                    "primary_diagnosis": "–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å - –æ—à–∏–±–∫–∞ –ò–ò-—Å–µ—Ä–≤–∏—Å–∞",
                    "differential_diagnosis": [],
                    "icd10_codes": [],
                    "confidence_level": "–Ω–∏–∑–∫–∞—è"
                },
                "recommendations": {
                    "urgent_actions": ["–û–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –≤—Ä–∞—á—É –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞"],
                    "follow_up": ["–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∞–Ω–∞–ª–∏–∑ –ø–æ–∑–∂–µ"],
                    "additional_studies": [],
                    "consultation": ["–í—Ä–∞—á —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏"],
                    "treatment": []
                },
                "risk_assessment": {
                    "urgency_level": "–ø–ª–∞–Ω–æ–≤–æ",
                    "risk_factors": [],
                    "prognosis": "–Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π",
                    "complications": []
                }
            }
            
            return json.dumps(error_response, ensure_ascii=False, indent=2), "–û—à–∏–±–∫–∞", 0
            
        except Exception as e:
            print(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ _send_ai_request: {e}")
            return '{"error": "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ò–ò-–∞–Ω–∞–ª–∏–∑–∞"}', "–û—à–∏–±–∫–∞", 0
    
    def _get_model_display_name(self, model: str) -> str:
        """–ü–æ–ª—É—á–∏—Ç—å —á–∏—Ç–∞–µ–º–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏"""
        if "claude-opus-4.5" in model or "claude-opus-4" in model:
            return "Claude Opus 4.5"
        elif "claude-sonnet-4.5" in model or "claude-sonnet-4" in model:
            return "Claude Sonnet 4.5"
        elif "claude-3-5-sonnet-20241022" in model:
            return "Claude 3.5 Sonnet (Latest)"
        elif "claude-3-5-sonnet" in model:
            return "Claude 3.5 Sonnet"
        elif "claude-3-sonnet" in model:
            return "Claude 3 Sonnet"
        elif "claude-3-haiku" in model:
            return "Claude 3 Haiku"
        elif "gemini" in model.lower():
            return "Gemini"
        elif "llama" in model.lower():
            return "Llama"
        else:
            return model.split("/")[-1] if "/" in model else model

    def _send_ai_request_streaming(self, prompt: str, image_array: np.ndarray, metadata: Dict):
        """–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ –ò–ò —Å streaming - —Ç–µ–∫—Å—Ç –ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ
        
        Yields:
            str: –ß–∞—Å—Ç–∏ –æ—Ç–≤–µ—Ç–∞ –ø–æ –º–µ—Ä–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
        """
        try:
            # –ö–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            base64_image = self.encode_image_optimized(image_array)
            
            # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
            content = [
                {
                    "type": "text", 
                    "text": f"–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:\n{json.dumps(metadata, ensure_ascii=False, indent=2)}\n\n{prompt}"
                },
                {
                    "type": "image_url", 
                    "image_url": {"url": f"data:image/jpeg;base64,{base64_image}"}
                }
            ]
            
            # –ü—Ä–æ–±—É–µ–º –º–æ–¥–µ–ª–∏ –ø–æ –ø–æ—Ä—è–¥–∫—É
            last_error = None
            for i, model in enumerate(self.models):
                try:
                    print(f"ü§ñ [STREAMING] –ü—Ä–æ–±—É–µ–º –º–æ–¥–µ–ª—å {i+1}/{len(self.models)}: {model}")
                    
                    payload = {
                        "model": model,
                        "messages": [{"role": "user", "content": content}],
                        "max_tokens": 4000,
                        "temperature": 0.1,
                        "top_p": 0.9,
                        "stream": True  # –í–∫–ª—é—á–∞–µ–º streaming
                    }
                    
                    response = requests.post(
                        self.base_url, 
                        headers=self.headers, 
                        json=payload, 
                        timeout=180,
                        stream=True
                    )
                    
                    if response.status_code == 200:
                        model_name = self._get_model_display_name(model)
                        print(f"‚úÖ [STREAMING –†–ê–°–®–ò–†–ï–ù–ù–´–ô –ê–ù–ê–õ–ò–ó] –£—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –º–æ–¥–µ–ª–∏: {model_name} ({model})")
                        full_response = ""
                        start_time = time.time()
                        for line in response.iter_lines():
                            if line:
                                line_str = line.decode('utf-8')
                                if line_str.startswith('data: '):
                                    data_str = line_str[6:]
                                    if data_str == '[DONE]':
                                        break
                                    try:
                                        data = json.loads(data_str)
                                        if 'choices' in data and len(data['choices']) > 0:
                                            delta = data['choices'][0].get('delta', {})
                                            if 'content' in delta:
                                                content_chunk = delta['content']
                                                full_response += content_chunk
                                                yield content_chunk
                                    except json.JSONDecodeError:
                                        continue
                        latency = time.time() - start_time
                        print(f"‚úÖ [STREAMING –†–ê–°–®–ò–†–ï–ù–ù–´–ô –ê–ù–ê–õ–ò–ó] –ó–∞–≤–µ—Ä—à–µ–Ω–æ. –ú–æ–¥–µ–ª—å: {model_name}, —Å–∏–º–≤–æ–ª–æ–≤: {len(full_response)}, –≤—Ä–µ–º—è: {latency:.2f}—Å")
                        # –ù–µ –¥–µ–ª–∞–µ–º return –∑–¥–µ—Å—å, —á—Ç–æ–±—ã –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –º–æ–≥ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–∞–±–æ—Ç—É
                        if full_response:
                            return  # –£—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–∏–ª–∏, –≤—ã—Ö–æ–¥–∏–º –∏–∑ —Ü–∏–∫–ª–∞ –º–æ–¥–µ–ª–µ–π
                        else:
                            continue  # –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –ø—É—Å—Ç–æ–π, –ø—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â—É—é –º–æ–¥–µ–ª—å
                    elif response.status_code == 402:
                        print(f"‚ö†Ô∏è [STREAMING] HTTP 402 (–Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤) –¥–ª—è –º–æ–¥–µ–ª–∏: {model}")
                        yield f"‚ö†Ô∏è –ú–æ–¥–µ–ª—å {model} –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –∏–∑-–∑–∞ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∞ —Å—Ä–µ–¥—Å—Ç–≤. –ü—Ä–æ–±—É—é —Å–ª–µ–¥—É—é—â—É—é –º–æ–¥–µ–ª—å...\n\n"
                        last_error = f"HTTP 402: –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤"
                        continue
                    else:
                        print(f"‚ùå [STREAMING] HTTP –æ—à–∏–±–∫–∞ {response.status_code} –¥–ª—è –º–æ–¥–µ–ª–∏ {model}: {response.text[:200]}")
                        last_error = f"HTTP {response.status_code}: {response.text[:200]}"
                        continue
                        
                except requests.exceptions.Timeout:
                    print(f"‚è±Ô∏è [STREAMING] –¢–∞–π–º–∞—É—Ç –¥–ª—è –º–æ–¥–µ–ª–∏: {model}")
                    yield f"‚è±Ô∏è –¢–∞–π–º–∞—É—Ç –¥–ª—è –º–æ–¥–µ–ª–∏ {model}. –ü—Ä–æ–±—É—é —Å–ª–µ–¥—É—é—â—É—é...\n\n"
                    last_error = "–¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞"
                    continue
                except requests.exceptions.RequestException as e:
                    print(f"‚ùå [STREAMING] –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –¥–ª—è –º–æ–¥–µ–ª–∏ {model}: {e}")
                    yield f"‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –¥–ª—è –º–æ–¥–µ–ª–∏ {model}. –ü—Ä–æ–±—É—é —Å–ª–µ–¥—É—é—â—É—é...\n\n"
                    last_error = f"–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: {str(e)}"
                    continue
                except Exception as e:
                    print(f"‚ùå [STREAMING] –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –¥–ª—è –º–æ–¥–µ–ª–∏ {model}: {e}")
                    yield f"‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –¥–ª—è –º–æ–¥–µ–ª–∏ {model}. –ü—Ä–æ–±—É—é —Å–ª–µ–¥—É—é—â—É—é...\n\n"
                    last_error = f"–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {str(e)}"
                    continue
            
            # –ï—Å–ª–∏ –≤—Å–µ –º–æ–¥–µ–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã
            error_msg = f"‚ùå –í—Å–µ –º–æ–¥–µ–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã. –ü–æ—Å–ª–µ–¥–Ω—è—è –æ—à–∏–±–∫–∞: {last_error}"
            print(error_msg)
            yield error_msg
            
        except Exception as e:
            error_msg = f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ streaming: {e}"
            print(error_msg)
            yield error_msg

    def batch_analyze(self, images: List[Tuple[np.ndarray, Optional[ImageType]]], 
                    context: str = "") -> List[AnalysisResult]:
        """–ü–∞–∫–µ—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫"""
        results = []
        print(f"–ù–∞—á–∏–Ω–∞–µ–º –ø–∞–∫–µ—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑ {len(images)} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π...")
        
        for i, (image_array, image_type) in enumerate(images):
            try:
                print(f"–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ {i+1}/{len(images)}")
                result = self.analyze_image(
                    image_array, 
                    image_type, 
                    f"{context} (–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ {i+1}/{len(images)})"
                )
                results.append(result)
                print(f"–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ {i+1} –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —É—Å–ø–µ—à–Ω–æ")
                
            except Exception as e:
                print(f"–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è {i+1}: {e}")
                # –°–æ–∑–¥–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å –æ—à–∏–±–∫–æ–π
                error_result = AnalysisResult(
                    image_type=image_type or ImageType.XRAY,
                    confidence=0.0,
                    structured_findings={"error": str(e)},
                    clinical_interpretation=f"–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è {i+1}: {str(e)}",
                    recommendations=["–û–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –≤—Ä–∞—á—É"],
                    urgent_flags=[f"–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è {i+1}"],
                    icd10_codes=[],
                    timestamp=datetime.datetime.now().isoformat(),
                    metadata={}
                )
                results.append(error_result)
        
        print(f"–ü–∞–∫–µ—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω. –£—Å–ø–µ—à–Ω–æ: {len([r for r in results if r.confidence > 0])}/{len(results)}")
        return results

    def generate_report(self, results: List[AnalysisResult], patient_data: Optional[Dict] = None) -> str:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–≥–æ –æ—Ç—á–µ—Ç–∞"""
        report_parts = []
        
        # –ó–∞–≥–æ–ª–æ–≤–æ–∫
        report_parts.append("=" * 80)
        report_parts.append("–ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï –ü–û –†–ï–ó–£–õ–¨–¢–ê–¢–ê–ú –ò–ò-–ê–ù–ê–õ–ò–ó–ê –ú–ï–î–ò–¶–ò–ù–°–ö–ò–• –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ô")
        report_parts.append("=" * 80)
        
        # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–∞—Ü–∏–µ–Ω—Ç–µ
        if patient_data:
            report_parts.append("–î–ê–ù–ù–´–ï –ü–ê–¶–ò–ï–ù–¢–ê:")
            report_parts.append(f"–§–ò–û: {patient_data.get('name', '–ù–µ —É–∫–∞–∑–∞–Ω–æ')}")
            report_parts.append(f"–í–æ–∑—Ä–∞—Å—Ç: {patient_data.get('age', '–ù–µ —É–∫–∞–∑–∞–Ω')}")
            report_parts.append(f"–ü–æ–ª: {patient_data.get('sex', '–ù–µ —É–∫–∞–∑–∞–Ω')}")
            report_parts.append(f"ID –ø–∞—Ü–∏–µ–Ω—Ç–∞: {patient_data.get('patient_id', '–ù–µ —É–∫–∞–∑–∞–Ω')}")
            report_parts.append("")
        
        # –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        total_images = len(results)
        successful_analyses = len([r for r in results if r.confidence > 0.5])
        urgent_cases = len([r for r in results if r.urgent_flags])
        
        report_parts.append("–û–ë–©–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø:")
        report_parts.append(f"–í—Å–µ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ: {total_images}")
        report_parts.append(f"–£—Å–ø–µ—à–Ω—ã—Ö –∞–Ω–∞–ª–∏–∑–æ–≤: {successful_analyses}")
        report_parts.append(f"–°–ª—É—á–∞–µ–≤, —Ç—Ä–µ–±—É—é—â–∏—Ö —Å—Ä–æ—á–Ω–æ–≥–æ –≤–Ω–∏–º–∞–Ω–∏—è: {urgent_cases}")
        report_parts.append("")
        
        # –ê–Ω–∞–ª–∏–∑ –∫–∞–∂–¥–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        for i, result in enumerate(results, 1):
            report_parts.append(f"–ò–°–°–õ–ï–î–û–í–ê–ù–ò–ï ‚Ññ{i}: {result.image_type.value.upper()}")
            report_parts.append("-" * 60)
            report_parts.append(f"–í—Ä–µ–º—è –∞–Ω–∞–ª–∏–∑–∞: {result.timestamp}")
            report_parts.append(f"–î–æ—Å—Ç–æ–≤–µ—Ä–Ω–æ—Å—Ç—å –∞–Ω–∞–ª–∏–∑–∞: {result.confidence:.1%}")
            
            findings = result.structured_findings
            
            # –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –æ—Ü–µ–Ω–∫–∞
            if "technical_assessment" in findings:
                tech = findings["technical_assessment"]
                report_parts.append("\n–¢–ï–•–ù–ò–ß–ï–°–ö–ê–Ø –û–¶–ï–ù–ö–ê:")
                report_parts.append(f"  –ö–∞—á–µ—Å—Ç–≤–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: {tech.get('quality', '–ù–µ –æ—Ü–µ–Ω–µ–Ω–æ')}")
                report_parts.append(f"  –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ: {tech.get('positioning', '–ù–µ –æ—Ü–µ–Ω–µ–Ω–æ')}")
                report_parts.append(f"  –≠–∫—Å–ø–æ–∑–∏—Ü–∏—è: {tech.get('exposure', '–ù–µ –æ—Ü–µ–Ω–µ–Ω–∞')}")
                
                if tech.get('artifacts'):
                    report_parts.append("  –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:")
                    for artifact in tech['artifacts']:
                        report_parts.append(f"    ‚Ä¢ {artifact}")
            
            # –ö–ª–∏–Ω–∏—á–µ—Å–∫–∏–µ –Ω–∞—Ö–æ–¥–∫–∏
            if "clinical_findings" in findings:
                clinical = findings["clinical_findings"]
                
                report_parts.append("\n–ö–õ–ò–ù–ò–ß–ï–°–ö–ò–ï –ù–ê–•–û–î–ö–ò:")
                
                # –ù–æ—Ä–º–∞–ª—å–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
                if clinical.get("normal_structures"):
                    report_parts.append("  –ù–æ—Ä–º–∞–ª—å–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã:")
                    for structure in clinical["normal_structures"]:
                        report_parts.append(f"    ‚Ä¢ {structure}")
                
                # –ü–∞—Ç–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
                if clinical.get("pathological_findings"):
                    report_parts.append("  –ü–ê–¢–û–õ–û–ì–ò–ß–ï–°–ö–ò–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø:")
                    for finding in clinical["pathological_findings"]:
                        report_parts.append(f"    ‚Ä¢ {finding.get('finding', '–ù–µ —É–∫–∞–∑–∞–Ω–æ')}")
                        report_parts.append(f"      –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è: {finding.get('location', '–ù–µ —É–∫–∞–∑–∞–Ω–∞')}")
                        report_parts.append(f"      –í—ã—Ä–∞–∂–µ–Ω–Ω–æ—Å—Ç—å: {finding.get('severity', '–ù–µ —É–∫–∞–∑–∞–Ω–∞')}")
                        report_parts.append(f"      –û–ø–∏—Å–∞–Ω–∏–µ: {finding.get('description', '–ù–µ —É–∫–∞–∑–∞–Ω–æ')}")
                        if finding.get('size'):
                            report_parts.append(f"      –†–∞–∑–º–µ—Ä—ã: {finding['size']}")
                        if finding.get('characteristics'):
                            report_parts.append(f"      –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏: {finding['characteristics']}")
                        report_parts.append("")
                else:
                    report_parts.append("  –ü–∞—Ç–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ –≤—ã—è–≤–ª–µ–Ω–æ")
                
                # –ò–∑–º–µ—Ä–µ–Ω–∏—è
                if clinical.get("measurements") and clinical["measurements"] != "–Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ":
                    report_parts.append(f"  –ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ—Ä–µ–Ω–∏—è: {clinical['measurements']}")
            
            # –î–∏–∞–≥–Ω–æ–∑
            if "diagnosis" in findings:
                diag = findings["diagnosis"]
                report_parts.append("\n–î–ò–ê–ì–ù–û–°–¢–ò–ß–ï–°–ö–û–ï –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï:")
                report_parts.append(f"  –û—Å–Ω–æ–≤–Ω–æ–π –¥–∏–∞–≥–Ω–æ–∑: {diag.get('primary_diagnosis', '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω')}")
                report_parts.append(f"  –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤ –¥–∏–∞–≥–Ω–æ–∑–µ: {diag.get('confidence_level', '–ù–µ —É–∫–∞–∑–∞–Ω–∞')}")
                
                if diag.get("differential_diagnosis"):
                    report_parts.append("  –î–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:")
                    for diff_diag in diag["differential_diagnosis"]:
                        report_parts.append(f"    ‚Ä¢ {diff_diag}")
                
                if diag.get("icd10_codes"):
                    codes = ", ".join(diag["icd10_codes"])
                    report_parts.append(f"  –ö–æ–¥—ã –ú–ö–ë-10: {codes}")
            
            # –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
            if "recommendations" in findings:
                rec = findings["recommendations"]
                report_parts.append("\n–†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:")
                
                if rec.get("urgent_actions"):
                    report_parts.append("  ‚ö†Ô∏è –°–†–û–ß–ù–´–ï –î–ï–ô–°–¢–í–ò–Ø:")
                    for action in rec["urgent_actions"]:
                        report_parts.append(f"    ‚Ä¢ {action}")
                
                if rec.get("follow_up"):
                    report_parts.append("  –ü–ª–∞–Ω –Ω–∞–±–ª—é–¥–µ–Ω–∏—è:")
                    for follow in rec["follow_up"]:
                        report_parts.append(f"    ‚Ä¢ {follow}")
                
                if rec.get("additional_studies"):
                    report_parts.append("  –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è:")
                    for study in rec["additional_studies"]:
                        report_parts.append(f"    ‚Ä¢ {study}")
                
                if rec.get("consultation"):
                    report_parts.append("  –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤:")
                    for consult in rec["consultation"]:
                        report_parts.append(f"    ‚Ä¢ {consult}")
                
                if rec.get("treatment"):
                    report_parts.append("  –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ª–µ—á–µ–Ω–∏—é:")
                    for treatment in rec["treatment"]:
                        report_parts.append(f"    ‚Ä¢ {treatment}")
            
            # –û—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–æ–≤
            if "risk_assessment" in findings:
                risk = findings["risk_assessment"]
                report_parts.append("\n–û–¶–ï–ù–ö–ê –†–ò–°–ö–û–í:")
                report_parts.append(f"  –£—Ä–æ–≤–µ–Ω—å —Å—Ä–æ—á–Ω–æ—Å—Ç–∏: {risk.get('urgency_level', '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω')}")
                report_parts.append(f"  –ü—Ä–æ–≥–Ω–æ–∑: {risk.get('prognosis', '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω')}")
                
                if risk.get("risk_factors"):
                    report_parts.append("  –§–∞–∫—Ç–æ—Ä—ã —Ä–∏—Å–∫–∞:")
                    for factor in risk["risk_factors"]:
                        report_parts.append(f"    ‚Ä¢ {factor}")
                
                if risk.get("complications"):
                    report_parts.append("  –í–æ–∑–º–æ–∂–Ω—ã–µ –æ—Å–ª–æ–∂–Ω–µ–Ω–∏—è:")
                    for complication in risk["complications"]:
                        report_parts.append(f"    ‚Ä¢ {complication}")
            
            report_parts.append("\n" + "=" * 60 + "\n")
        
        # –û–±—â–µ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ
        report_parts.append("–û–ë–©–ï–ï –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï:")
        
        if urgent_cases > 0:
            report_parts.append(f"‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –í—ã—è–≤–ª–µ–Ω–æ {urgent_cases} —Å–ª—É—á–∞–µ–≤, —Ç—Ä–µ–±—É—é—â–∏—Ö —Å—Ä–æ—á–Ω–æ–≥–æ –≤–Ω–∏–º–∞–Ω–∏—è!")
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–∏–ø–∞–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        image_types = {}
        for result in results:
            img_type = result.image_type.value
            if img_type not in image_types:
                image_types[img_type] = 0
            image_types[img_type] += 1
        
        if image_types:
            report_parts.append("\n–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–∏–ø–∞–º –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π:")
            for img_type, count in image_types.items():
                report_parts.append(f"  {img_type.upper()}: {count}")
        
        # –ú–µ—Ç–∞–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
        report_parts.append(f"\n–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –∞–Ω–∞–ª–∏–∑–∞: {datetime.datetime.now().strftime('%d.%m.%Y %H:%M:%S')}")
        report_parts.append("–ê–Ω–∞–ª–∏–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω –ò–ò-—Å–∏—Å—Ç–µ–º–æ–π Enhanced Medical AI Analyzer v2.0")
        report_parts.append("‚ö†Ô∏è –í–ê–ñ–ù–û: –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ —Ç—Ä–µ–±—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–π –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤—Ä–∞—á–æ–º-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º!")
        report_parts.append("–î–∞–Ω–Ω–æ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç —Å–ª—É–∂–∏—Ç—å –æ—Å–Ω–æ–≤–∞–Ω–∏–µ–º –¥–ª—è –ø–æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ–≥–æ –¥–∏–∞–≥–Ω–æ–∑–∞.")
        report_parts.append("=" * 80)
        
        return "\n".join(report_parts)

    def save_analysis_results(self, results: List[AnalysisResult], 
                            filename: Optional[str] = None) -> str:
        """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–∞ –≤ JSON —Ñ–∞–π–ª"""
        if filename is None:
            timestamp = datetime.datetime.now().strftime("%Y%m%d_%H%M%S")
            filename = f"medical_analysis_{timestamp}.json"
        
        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        save_data = {
            "analysis_metadata": {
                "timestamp": datetime.datetime.now().isoformat(),
                "analyzer_version": "Enhanced Medical AI Analyzer v2.0",
                "total_images": len(results),
                "successful_analyses": len([r for r in results if r.confidence > 0.5])
            },
            "results": []
        }
        
        for result in results:
            result_data = {
                "image_type": result.image_type.value,
                "confidence": result.confidence,
                "structured_findings": result.structured_findings,
                "recommendations": result.recommendations,
                "urgent_flags": result.urgent_flags,
                "icd10_codes": result.icd10_codes,
                "timestamp": result.timestamp,
                "metadata": result.metadata
            }
            save_data["results"].append(result_data)
        
        try:
            with open(filename, 'w', encoding='utf-8') as f:
                json.dump(save_data, f, ensure_ascii=False, indent=2)
            return filename
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–∞: {e}")
            return ""

    def load_analysis_results(self, filename: str) -> List[AnalysisResult]:
        """–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–∞"""
        try:
            with open(filename, 'r', encoding='utf-8') as f:
                data = json.load(f)
            
            results = []
            for result_data in data.get("results", []):
                result = AnalysisResult(
                    image_type=ImageType(result_data["image_type"]),
                    confidence=result_data["confidence"],
                    structured_findings=result_data["structured_findings"],
                    clinical_interpretation=json.dumps(result_data["structured_findings"], 
                                                     ensure_ascii=False, indent=2),
                    recommendations=result_data["recommendations"],
                    urgent_flags=result_data["urgent_flags"],
                    icd10_codes=result_data["icd10_codes"],
                    timestamp=result_data["timestamp"],
                    metadata=result_data["metadata"]
                )
                results.append(result)
            
            return results
            
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞: {e}")
            return []

    def validate_api_connection(self) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å API"""
        try:
            # –ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
            test_payload = {
                "model": self.models[0],
                "messages": [{"role": "user", "content": "test"}],
                "max_tokens": 10
            }
            
            response = requests.post(
                self.base_url,
                headers=self.headers,
                json=test_payload,
                timeout=30
            )
            
            return response.status_code == 200
            
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ API: {e}")
            return False

# –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
def create_analyzer(api_key: str) -> EnhancedMedicalAIAnalyzer:
    """–°–æ–∑–¥–∞–Ω–∏–µ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä–∞"""
    analyzer = EnhancedMedicalAIAnalyzer(api_key)
    
    print("–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å API...")
    if analyzer.validate_api_connection():
        print("‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å API —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ")
    else:
        print("‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å API. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ API –∫–ª—é—á –∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ")
    
    return analyzer

def analyze_single_image(analyzer: EnhancedMedicalAIAnalyzer, 
                        image_path: str, 
                        image_type: Optional[ImageType] = None,
                        context: str = "") -> AnalysisResult:
    """–ê–Ω–∞–ª–∏–∑ –æ–¥–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ —Ñ–∞–π–ª–∞"""
    try:
        # –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        image = Image.open(image_path)
        image_array = np.array(image)
        
        print(f"–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: {image_path}")
        print(f"–†–∞–∑–º–µ—Ä: {image_array.shape}")
        
        # –ê–Ω–∞–ª–∏–∑
        result = analyzer.analyze_image(image_array, image_type, context)
        
        return result
        
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–ª–∏ –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è {image_path}: {e}")
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å –æ—à–∏–±–∫–æ–π
        return AnalysisResult(
            image_type=image_type or ImageType.XRAY,
            confidence=0.0,
            structured_findings={"error": str(e)},
            clinical_interpretation=f"–û—à–∏–±–∫–∞: {str(e)}",
            recommendations=[],
            urgent_flags=["–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è"],
            icd10_codes=[],
            timestamp=datetime.datetime.now().isoformat(),
            metadata={}
        )

def analyze_multiple_images(analyzer: EnhancedMedicalAIAnalyzer,
                          image_paths: List[str],
                          image_types: Optional[List[ImageType]] = None,
                          context: str = "") -> List[AnalysisResult]:
    """–ê–Ω–∞–ª–∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π"""
    if image_types is None:
        image_types = [None] * len(image_paths)
    
    images_data = []
    for i, (path, img_type) in enumerate(zip(image_paths, image_types)):
        try:
            image = Image.open(path)
            image_array = np.array(image)
            images_data.append((image_array, img_type))
            print(f"–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ {i+1}: {path}")
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è {path}: {e}")
            # –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –∫–∞–∫ –∑–∞–≥–ª—É—à–∫—É
            images_data.append((np.zeros((100, 100), dtype=np.uint8), img_type))
    
    return analyzer.batch_analyze(images_data, context)

# –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
def example_usage():
    """–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –ø—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä–∞"""
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (–ø–æ–ª—É—á–∏—Ç–µ API –∫–ª—é—á –∏–∑ config –∏–ª–∏ secrets)
    try:
        from config import OPENROUTER_API_KEY
        API_KEY = OPENROUTER_API_KEY
    except ImportError:
        import streamlit as st
        try:
            API_KEY = st.secrets.get("api_keys", {}).get("OPENROUTER_API_KEY") or st.secrets.get("OPENROUTER_API_KEY")
        except:
            API_KEY = None
    
    if not API_KEY:
        print("‚ö†Ô∏è API –∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ OPENROUTER_API_KEY –≤ config.py –∏–ª–∏ .streamlit/secrets.toml")
        return
    
    analyzer = create_analyzer(API_KEY)
    
    # –ü—Ä–∏–º–µ—Ä 1: –ê–Ω–∞–ª–∏–∑ –æ–¥–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    print("\n" + "="*50)
    print("–ü–†–ò–ú–ï–† 1: –ê–Ω–∞–ª–∏–∑ —Ä–µ–Ω—Ç–≥–µ–Ω–æ–≥—Ä–∞–º–º—ã")
    print("="*50)
    
    try:
        # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –ø—É—Ç—å –∫ –≤–∞—à–µ–º—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é
        image_path = "chest_xray.jpg"
        result = analyze_single_image(
            analyzer, 
            image_path, 
            ImageType.XRAY,
            "–ü–∞—Ü–∏–µ–Ω—Ç 45 –ª–µ—Ç, –∂–∞–ª–æ–±—ã –Ω–∞ –∫–∞—à–µ–ª—å –∏ –æ–¥—ã—à–∫—É"
        )
        
        print(f"–¢–∏–ø –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: {result.image_type.value}")
        print(f"–î–æ—Å—Ç–æ–≤–µ—Ä–Ω–æ—Å—Ç—å: {result.confidence:.1%}")
        
        # –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Ö–æ–¥–∫–∏
        if result.structured_findings.get("diagnosis"):
            diagnosis = result.structured_findings["diagnosis"]
            print(f"–î–∏–∞–≥–Ω–æ–∑: {diagnosis.get('primary_diagnosis')}")
        
        # –°—Ä–æ—á–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
        if result.urgent_flags:
            print("‚ö†Ô∏è –°—Ä–æ—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:")
            for flag in result.urgent_flags:
                print(f"  ‚Ä¢ {flag}")
    
    except FileNotFoundError:
        print("–§–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–ª–∏ —É–∫–∞–∂–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—É—Ç—å.")
    
    # –ü—Ä–∏–º–µ—Ä 2: –ü–∞–∫–µ—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑
    print("\n" + "="*50)
    print("–ü–†–ò–ú–ï–† 2: –ü–∞–∫–µ—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑")
    print("="*50)
    
    # –°–ø–∏—Å–æ–∫ –ø—É—Ç–µ–π –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ)
    image_paths = [
        "ecg_sample.jpg",
        "chest_xray.jpg", 
        "brain_mri.jpg"
    ]
    
    image_types = [
        ImageType.ECG,
        ImageType.XRAY,
        ImageType.MRI
    ]
    
    try:
        results = analyze_multiple_images(
            analyzer,
            image_paths,
            image_types,
            "–ü–ª–∞–Ω–æ–≤–æ–µ –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞"
        )
        
        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞
        patient_data = {
            "name": "–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á",
            "age": 45,
            "sex": "–ú",
            "patient_id": "P001234"
        }
        
        report = analyzer.generate_report(results, patient_data)
        print(report)
        
        # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        filename = analyzer.save_analysis_results(results)
        if filename:
            print(f"\n–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ —Ñ–∞–π–ª: {filename}")
    
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –≤ –ø–∞–∫–µ—Ç–Ω–æ–º –∞–Ω–∞–ª–∏–∑–µ: {e}")
    
    # –ü—Ä–∏–º–µ—Ä 3: –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    print("\n" + "="*50)
    print("–ü–†–ò–ú–ï–† 3: –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞")
    print("="*50)
    
    try:
        # –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è —Ç–∏–ø–∞
        image = Image.open("unknown_medical_image.jpg")
        image_array = np.array(image)
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø
        detected_type, confidence = analyzer.detect_image_type(image_array)
        print(f"–û–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π —Ç–∏–ø: {detected_type.value}")
        print(f"–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è: {confidence:.2f}")
        
        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Å –∞–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–º —Ç–∏–ø–æ–º
        result = analyzer.analyze_image(image_array)
        print(f"–†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞ –ø–æ–ª—É—á–µ–Ω —Å —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å—é: {result.confidence:.1%}")
    
    except FileNotFoundError:
        print("–¢–µ—Å—Ç–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ")

def create_test_images():
    """–°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏"""
    try:
        from PIL import Image, ImageDraw
        import random
        
        # –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        import os
        if not os.path.exists("test_images"):
            os.makedirs("test_images")
        
        # –¢–µ—Å—Ç–æ–≤–æ–µ –≠–ö–ì (–¥–ª–∏–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–º–∏ –ø–∏–∫–∞–º–∏)
        ecg_img = Image.new('L', (800, 200), color=240)
        draw = ImageDraw.Draw(ecg_img)
        
        # –†–∏—Å—É–µ–º –±–∞–∑–æ–≤—É—é –ª–∏–Ω–∏—é –∏ QRS –∫–æ–º–ø–ª–µ–∫—Å—ã
        y_baseline = 100
        for x in range(0, 800, 80):
            # QRS –∫–æ–º–ø–ª–µ–∫—Å
            points = [(x, y_baseline), (x+10, y_baseline-30), (x+20, y_baseline+40), 
                     (x+30, y_baseline-50), (x+40, y_baseline)]
            draw.line(points, fill=0, width=2)
        
        ecg_img.save("test_images/test_ecg.jpg")
        
        # –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–Ω—Ç–≥–µ–Ω (–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å –≤—ã—Å–æ–∫–∏–º –∫–æ–Ω—Ç—Ä–∞—Å—Ç–æ–º)
        xray_img = Image.new('L', (400, 400), color=50)
        draw = ImageDraw.Draw(xray_img)
        
        # –†–∏—Å—É–µ–º "—Ä–µ–±—Ä–∞" –∏ "–ø–æ–∑–≤–æ–Ω–æ—á–Ω–∏–∫"
        for i in range(5):
            draw.rectangle([50, 50+i*60, 350, 55+i*60], fill=200)  # —Ä–µ–±—Ä–∞
        draw.rectangle([190, 50, 210, 350], fill=220)  # –ø–æ–∑–≤–æ–Ω–æ—á–Ω–∏–∫
        
        xray_img.save("test_images/test_xray.jpg")
        
        # –¢–µ—Å—Ç–æ–≤–æ–µ –£–ó–ò (—Ç–µ–º–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å —è—Ä–∫–∏–º–∏ –ø—è—Ç–Ω–∞–º–∏)
        us_img = Image.new('L', (300, 300), color=30)
        draw = ImageDraw.Draw(us_img)
        
        # –†–∏—Å—É–µ–º —ç—Ö–æ-—Å–∏–≥–Ω–∞–ª—ã
        for _ in range(20):
            x, y = random.randint(50, 250), random.randint(50, 250)
            draw.ellipse([x-5, y-5, x+5, y+5], fill=200)
        
        us_img.save("test_images/test_ultrasound.jpg")
        
        print("–¢–µ—Å—Ç–æ–≤—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ–∑–¥–∞–Ω—ã –≤ –ø–∞–ø–∫–µ test_images/")
        
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π: {e}")

if __name__ == "__main__":
    print("Enhanced Medical AI Analyzer v2.0")
    print("="*50)
    
    # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
    create_test_images()
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
    example_usage()
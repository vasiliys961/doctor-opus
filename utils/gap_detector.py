"""
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤—ã—è–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–µ–ª–æ–≤ –≤ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö –≤—ã–≤–æ–¥–∞—Ö –ò–ò
"""
import re
from typing import Dict, List, Any
from modules.medical_ai_analyzer import ImageType

class DiagnosticGapDetector:
    """–î–µ—Ç–µ–∫—Ç–æ—Ä –ø—Ä–æ–±–µ–ª–æ–≤ –≤ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–µ"""
    
    def __init__(self):
        # –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è
        self.required_fields = {
            ImageType.ECG: {
                'technical': ['—Å–∫–æ—Ä–æ—Å—Ç—å –ª–µ–Ω—Ç—ã', '–∫–∞–ª–∏–±—Ä–æ–≤–∫–∞', '–∫–∞—á–µ—Å—Ç–≤–æ'],
                'rhythm': ['—Ç–∏–ø —Ä–∏—Ç–º–∞', '—á—Å—Å', '—Ä–µ–≥—É–ª—è—Ä–Ω–æ—Å—Ç—å'],
                'intervals': ['pr –∏–Ω—Ç–µ—Ä–≤–∞–ª', 'qrs –∫–æ–º–ø–ª–µ–∫—Å', 'qt –∏–Ω—Ç–µ—Ä–≤–∞–ª'],
                'morphology': ['p –∑—É–±—Ü—ã', 'qrs –∫–æ–º–ø–ª–µ–∫—Å—ã', 't –∑—É–±—Ü—ã'],
                'pathology': ['st —Å–µ–≥–º–µ–Ω—Ç', '–±–ª–æ–∫–∞–¥—ã', '–∞—Ä–∏—Ç–º–∏–∏'],
                'conclusion': ['–¥–∏–∞–≥–Ω–æ–∑', '—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏', '–º–∫–±-10']
            },
            ImageType.XRAY: {
                'technical': ['–∫–∞—á–µ—Å—Ç–≤–æ', '—É–∫–ª–∞–¥–∫–∞', '—ç–∫—Å–ø–æ–∑–∏—Ü–∏—è'],
                'anatomy': ['–ª–µ–≥–æ—á–Ω—ã–µ –ø–æ–ª—è', '—Å—Ä–µ–¥–æ—Å—Ç–µ–Ω–∏–µ', '–¥–∏–∞—Ñ—Ä–∞–≥–º–∞', '–∫–æ—Å—Ç–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã'],
                'pathology': ['–æ—á–∞–≥–æ–≤—ã–µ —Ç–µ–Ω–∏', '–∏–Ω—Ñ–∏–ª—å—Ç—Ä–∞—Ç—ã', '–ø–ª–µ–≤—Ä–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è'],
                'conclusion': ['–¥–∏–∞–≥–Ω–æ–∑', '—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏', '–¥–æ–æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ']
            },
            ImageType.MRI: {
                'technical': ['–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å', '–∫–∞—á–µ—Å—Ç–≤–æ', '–∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã'],
                'anatomy': ['—Å–µ—Ä–æ–µ –≤–µ—â–µ—Å—Ç–≤–æ', '–±–µ–ª–æ–µ –≤–µ—â–µ—Å—Ç–≤–æ', '–∂–µ–ª—É–¥–æ—á–∫–∏', '—Å—Ç–≤–æ–ª –º–æ–∑–≥–∞'],
                'pathology': ['–æ—á–∞–≥–æ–≤—ã–µ –ø–æ—Ä–∞–∂–µ–Ω–∏—è', '–¥–∏—Ñ—Ñ—É–∑–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è', '–æ–±—ä–µ–º–Ω—ã–µ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è'],
                'conclusion': ['–¥–∏–∞–≥–Ω–æ–∑', '–¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –¥–∏–∞–≥–Ω–æ–∑', '—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏']
            },
            ImageType.CT: {
                'technical': ['—Ç–æ–ª—â–∏–Ω–∞ —Å—Ä–µ–∑–∞', '–∫–æ–Ω—Ç—Ä–∞—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ', '–∫–∞—á–µ—Å—Ç–≤–æ', '–∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã'],
                'anatomy': ['–ø–∞—Ä–µ–Ω—Ö–∏–º–∞—Ç–æ–∑–Ω—ã–µ –æ—Ä–≥–∞–Ω—ã', '—Å–æ—Å—É–¥–∏—Å—Ç—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã', '–ª–∏–º—Ñ–∞—Ç–∏—á–µ—Å–∫–∏–µ —É–∑–ª—ã', '–∫–æ—Å—Ç–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã'],
                'densitometry': ['hu –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏', '–¥–µ–Ω—Å–∏—Ç–æ–º–µ—Ç—Ä–∏—è', '—Ö–∞—Ä–∞–∫—Ç–µ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏–π'],
                'pathology': ['–ø–∞—Ç–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –Ω–∞—Ö–æ–¥–∫–∏', '–ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è', '—Ä–∞–∑–º–µ—Ä—ã', '—Å—Ç–∞–¥–∏—Ä–æ–≤–∞–Ω–∏–µ'],
                'conclusion': ['–¥–∏–∞–≥–Ω–æ–∑', 'tnm –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è', '—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏']
            },
            ImageType.ULTRASOUND: {
                'technical': ['–¥–∞—Ç—á–∏–∫', '—á–∞—Å—Ç–æ—Ç–∞', '–≥–ª—É–±–∏–Ω–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è', '–∫–∞—á–µ—Å—Ç–≤–æ'],
                'echogenicity': ['–∞–Ω—ç—Ö–æ–≥–µ–Ω–Ω—ã–µ –∑–æ–Ω—ã', '–≥–∏–ø–æ—ç—Ö–æ–≥–µ–Ω–Ω—ã–µ –æ–±–ª–∞—Å—Ç–∏', '–≥–∏–ø–µ—Ä—ç—Ö–æ–≥–µ–Ω–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã', '–Ω–µ–æ–¥–Ω–æ—Ä–æ–¥–Ω–æ—Å—Ç—å'],
                'anatomy': ['—Ä–∞–∑–º–µ—Ä—ã –æ—Ä–≥–∞–Ω–æ–≤', '–∫–æ–Ω—Ç—É—Ä—ã', '—Å—Ç—Ä—É–∫—Ç—É—Ä–∞', '–≤–∞—Å–∫—É–ª—è—Ä–∏–∑–∞—Ü–∏—è'],
                'pathology': ['–ø–∞—Ç–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è', '–æ–±—ä–µ–º–Ω—ã–µ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è', '–∂–∏–¥–∫–æ—Å—Ç—å', '–∫–∞–ª—å—Ü–∏–Ω–∞—Ç—ã'],
                'conclusion': ['–¥–∏–∞–≥–Ω–æ–∑', '—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏', '–¥–æ–æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ']
            },
            ImageType.DERMATOSCOPY: {
                'technical': ['–∫–∞—á–µ—Å—Ç–≤–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', '—É–≤–µ–ª–∏—á–µ–Ω–∏–µ', '–æ—Å–≤–µ—â–µ–Ω–∏–µ'],
                'abcde': ['–∞—Å–∏–º–º–µ—Ç—Ä–∏—è', '–≥—Ä–∞–Ω–∏—Ü—ã', '—Ü–≤–µ—Ç', '–¥–∏–∞–º–µ—Ç—Ä', '—ç–≤–æ–ª—é—Ü–∏—è'],
                'structures': ['–ø–∏–≥–º–µ–Ω—Ç–Ω–∞—è —Å–µ—Ç—å', '—Ç–æ—á–∫–∏ –∏ –≥–ª–æ–±—É–ª—ã', '–ø–æ–ª–æ—Å—ã –∏ –ª–∏–Ω–∏–∏', '—Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ä–µ–≥—Ä–µ—Å—Å–∏–∏', '—Å–æ—Å—É–¥–∏—Å—Ç–∞—è –∫–∞—Ä—Ç–∏–Ω–∞'],
                'risk': ['—Ä–∏—Å–∫ –º–µ–ª–∞–Ω–æ–º—ã', 'bi-rads', '—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –±–∏–æ–ø—Å–∏–∏'],
                'conclusion': ['–¥–∏–∞–≥–Ω–æ–∑', '—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏', '–¥–∞–ª—å–Ω–µ–π—à–µ–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ']
            }
        }
    
    def detect_gaps(self, response: str, image_type: ImageType) -> Dict[str, Any]:
        """
        –í—ã—è–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–µ–ª–æ–≤ –≤ –æ—Ç–≤–µ—Ç–µ
        
        Returns:
            –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –ø—Ä–æ–±–µ–ª–∞—Ö
        """
        response_lower = response.lower()
        required = self.required_fields.get(image_type, {})
        
        gaps = {
            'missing_categories': [],
            'missing_fields': [],
            'incomplete_sections': [],
            'completeness_percentage': 0.0,
            'critical_gaps': []
        }
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        total_fields = 0
        found_fields = 0
        
        for category, fields in required.items():
            category_found = 0
            category_missing = []
            
            for field in fields:
                total_fields += 1
                # –ü–æ–∏—Å–∫ –ø–æ–ª—è –≤ –æ—Ç–≤–µ—Ç–µ (—Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –Ω–∞–ø–∏—Å–∞–Ω–∏—è)
                field_variants = [
                    field,
                    field.replace(' ', ''),
                    field.replace('_', ' '),
                    field.split()[0] if ' ' in field else field
                ]
                
                found = any(variant in response_lower for variant in field_variants)
                
                if found:
                    found_fields += 1
                    category_found += 1
                else:
                    category_missing.append(field)
            
            # –ï—Å–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ –º–µ–Ω–µ–µ —á–µ–º –Ω–∞ 50%
            if category_found / len(fields) < 0.5:
                gaps['missing_categories'].append(category)
                gaps['incomplete_sections'].append({
                    'category': category,
                    'completeness': category_found / len(fields),
                    'missing': category_missing
                })
            
            # –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–µ–ª—ã
            if category in ['conclusion', 'pathology'] and category_found == 0:
                gaps['critical_gaps'].append(f"–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏—è: {category}")
        
        gaps['completeness_percentage'] = (found_fields / total_fields * 100) if total_fields > 0 else 0
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –¥–∏–∞–≥–Ω–æ–∑–∞
        if not re.search(r'–¥–∏–∞–≥–Ω–æ–∑|–∑–∞–∫–ª—é—á–µ–Ω–∏–µ|–≤—ã–≤–æ–¥', response_lower):
            gaps['critical_gaps'].append("–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –¥–∏–∞–≥–Ω–æ–∑ –∏–ª–∏ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ")
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
        if not re.search(r'—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü|–ø–ª–∞–Ω|–¥–∞–ª—å–Ω–µ–π—à', response_lower):
            gaps['critical_gaps'].append("–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏–ª–∏ –ø–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π")
        
        return gaps
    
    def generate_gap_report(self, gaps: Dict[str, Any]) -> str:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞ –æ –ø—Ä–æ–±–µ–ª–∞—Ö"""
        report_parts = []
        
        report_parts.append(f"üìä –ü–æ–ª–Ω–æ—Ç–∞ –æ—Ç–≤–µ—Ç–∞: {gaps['completeness_percentage']:.1f}%")
        
        if gaps['critical_gaps']:
            report_parts.append("\nüö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–ï–õ–´:")
            for gap in gaps['critical_gaps']:
                report_parts.append(f"  ‚Ä¢ {gap}")
        
        if gaps['missing_categories']:
            report_parts.append("\n‚ö†Ô∏è –ù–µ–ø–æ–ª–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã:")
            for category in gaps['missing_categories']:
                report_parts.append(f"  ‚Ä¢ {category}")
        
        if gaps['incomplete_sections']:
            report_parts.append("\nüìã –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è:")
            for section in gaps['incomplete_sections']:
                report_parts.append(f"  ‚Ä¢ {section['category']}: –∑–∞–ø–æ–ª–Ω–µ–Ω–æ –Ω–∞ {section['completeness']:.1%}")
                if section['missing']:
                    report_parts.append(f"    –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç: {', '.join(section['missing'][:3])}")
        
        return "\n".join(report_parts)

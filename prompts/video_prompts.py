"""
Специализированные промпты для анализа медицинских видео.
Загружаются лениво (только при необходимости) для оптимизации производительности.
"""
from prompts.common_parts import (
    COMMON_VIDEO_CONCLUSION,
    COMMON_VIDEO_MRI_CT_CONCLUSION,
    COMMON_VIDEO_ULTRASOUND_CONCLUSION,
    COMMON_VIDEO_TIMESTAMPS_REQUIREMENT,
    COMMON_FINDING_TEMPLATE
)

VIDEO_ANALYSIS_PROMPTS = {
    'fgds': """Проанализируй видео ФГДС (эзофагогастродуоденоскопии).

ЗАДАЧИ:
1. Определи исследованные отделы (пищевод, желудок, ДПК)
2. Оцени качество подготовки (остатки пищи, слизь)
3. Найди и опиши все патологические изменения с указанием timestamp

АНАЛИЗ ПО ОТДЕЛАМ:

ПИЩЕВОД:
- Слизистая оболочка (цвет, блеск, складки)
- Кардия (смыкание, рефлюкс)
- Признаки эзофагита (степень по LA: A, B, C, D)
- Варикозное расширение вен (степень)
- Новообразования, язвы, стриктуры

ЖЕЛУДОК:
- Слизистая (цвет: розовая/бледная/гиперемированная)
- Складки (выраженность, сглаженность)
- Перистальтика
- Гастрит (тип: эритематозный, эрозивный, атрофический)
- Эрозии/язвы (количество, размер, локализация, Forrest classification)
- Полипы (количество, размер, тип по Paris classification)
- Новообразования (размер, локализация, Borrmann type)

ДВЕНАДЦАТИПЕРСТНАЯ КИШКА:
- Луковица (деформация, язвы, рубцы)
- Постбульбарные отделы
- БДС (большой дуоденальный сосочек)

ФОРМАТ ОТВЕТА:
[MM:SS] - Отдел: Находка
Описание: детали (размер, цвет, форма)
Оценка: норма/патология
Рекомендации: биопсия/наблюдение/лечение

{COMMON_VIDEO_CONCLUSION}

{COMMON_VIDEO_TIMESTAMPS_REQUIREMENT}""",

    'colonoscopy': """Проанализируй видео колоноскопии.

ЗАДАЧИ:
1. Оцени качество подготовки кишки (Boston Bowel Preparation Scale: 0-9)
2. Определи глубину введения (до какого отдела дошли)
3. Найди все полипы и патологические изменения с timestamp
4. Оцени время выведения (withdrawal time >6 минут - стандарт качества)

КАЧЕСТВО ПОДГОТОВКИ (Boston Scale):
Правый отдел (слепая, восходящая): 0-3
Поперечная ободочная: 0-3
Левый отдел (нисходящая, сигма, прямая): 0-3
Итого: X/9 (отлично >7, хорошо 5-7, удовлетворительно 3-4, плохо <3)

АНАЛИЗ ПО ОТДЕЛАМ:

ПРЯМАЯ КИШКА:
- Слизистая (цвет, сосудистый рисунок)
- Геморрой (степень I-IV)
- Трещины, свищи

СИГМОВИДНАЯ КИШКА:
- Дивертикулы (количество, осложнения)
- Воспаление (сегментарный колит)

НИСХОДЯЩАЯ/ПОПЕРЕЧНАЯ/ВОСХОДЯЩАЯ ОБОДОЧНАЯ:
- Полипы (ОБЯЗАТЕЛЬНО указать):
  * Размер (мм)
  * Локализация (см от ануса или название отдела)
  * Морфология (Paris classification: Ip, Is, IIa, IIb, IIc, III)
  * Поверхность (гладкая/дольчатая)
  * Цвет
  * Kudo pit pattern (I-V)
- Новообразования (Borrmann type)
- Воспалительные изменения (эрозии, язвы, pseudopolyps)

СЛЕПАЯ КИШКА:
- Визуализация илеоцекального клапана (подтверждение полной колоноскопии)
- Устье аппендикса

ИЛЕОСКОПИЯ (если выполнена):
- Терминальный отдел подвздошной кишки

ФОРМАТ ОТВЕТА:
Подготовка: X/9 (Boston Scale)
Глубина: [до какого отдела]
Время выведения: X минут

НАХОДКИ:
[MM:SS] - [Отдел, см от ануса]: Полип/патология
Размер: X мм
Морфология: Paris [тип]
Тактика: удалён/биопсия/оставлен

РЕКОМЕНДАЦИИ:
1. Удалённые полипы → гистология
2. Срок следующей колоноскопии (зависит от находок):
   - Нет полипов: 10 лет
   - 1-2 аденомы <10мм: 5-10 лет
   - 3-9 аденом / ≥1 аденома ≥10мм: 3 года
   - ≥10 аденом: 1 год
3. Дополнительные исследования (КТ, МРТ, онкомаркеры)""",

    'echo': """Проанализируй видео ЭхоКГ.

ОПРЕДЕЛИ ПОЗИЦИЮ:
- Parasternal long-axis (PLAX)
- Parasternal short-axis (PSAX): base/mid/apex
- Apical 4-chamber (A4C)
- Apical 2-chamber (A2C)
- Apical long-axis (APLAX)
- Subcostal
- Suprasternal

АНАЛИЗ (в зависимости от позиции):

1. РАЗМЕРЫ КАМЕР:
ЛЖ (левый желудочек):
- КДР (конечный диастолический размер): норма 46-58мм
- КСР (конечный систолический размер): норма 30-40мм
- Толщина МЖП (межжелудочковая перегородка): норма 7-11мм
- Толщина задней стенки: норма 7-11мм

ЛП (левое предсердие): норма <40мм
ПЖ (правый желудочек): оценка размера и функции
ПП (правое предсердие)

2. СИСТОЛИЧЕСКАЯ ФУНКЦИЯ ЛЖ:
ФРАКЦИЯ ВЫБРОСА (EF%):
- Укажи моменты max диастолы [MM:SS] и max систолы [MM:SS]
- КДО (конечный диастолический объём): X мл
- КСО (конечный систолический объём): Y мл
- EF% = (КДО - КСО) / КДО × 100 = Z%

Интерпретация EF%:
- ≥55%: Норма (сохранена)
- 45-54%: Лёгкое снижение
- 35-44%: Умеренное снижение
- <35%: Значительное снижение (ХСН)

3. РЕГИОНАЛЬНАЯ СОКРАТИМОСТЬ (Wall Motion):
17-сегментная модель AHA:
Для каждого видимого сегмента:
Сегмент X: Normokinesis / Hypokinesis / Akinesis / Dyskinesis

WMSI (Wall Motion Score Index) = сумма баллов / кол-во сегментов
1=норма, 2=гипо, 3=акинез, 4=дискинез

Интерпретация WMSI:
- 1.0: Норма
- 1.1-1.5: Лёгкие нарушения
- 1.6-2.0: Умеренные нарушения (ишемия)
- >2.0: Выраженные нарушения (ИМ)

4. КЛАПАНЫ:
Митральный:
- Створки (подвижность, толщина, кальциноз)
- Регургитация (нет / minimal / mild / moderate / severe)
- Стеноз (площадь отверстия, градиент)

Аортальный:
- Створки (трёхстворчатый/двустворчатый, кальциноз)
- Регургитация, стеноз

Трикуспидальный, пульмональный

5. ПЕРИКАРД:
- Выпот (нет / minimal <10мм / small 10-20мм / moderate 20-30мм / large >30мм)
- Тампонада (признаки)

6. ДИАСТОЛИЧЕСКАЯ ФУНКЦИЯ (если Doppler):
- E/A ratio
- E/e' ratio
- Deceleration time

ФОРМАТ ОТВЕТА:
ПОЗИЦИЯ: [название]

РАЗМЕРЫ:
ЛЖ КДР/КСР: X/Y мм
МЖП/ЗСЛЖ: X/Y мм
ЛП: X мм

ФУНКЦИЯ ЛЖ:
EF%: X% ([интерпретация])
WMSI: X ([интерпретация])

КЛАПАНЫ:
[Для каждого клапана]

ПЕРИКАРД: [норма/выпот]

ЗАКЛЮЧЕНИЕ:
1. Краткое резюме (2-3 предложения)
2. Диагноз
3. Рекомендации (динамическое наблюдение / консультация кардиохирурга / etc)""",

    'abdominal_us': """Проанализируй видео УЗИ органов брюшной полости.

ИССЛЕДУЕМЫЕ ОРГАНЫ:

1. ПЕЧЕНЬ:
- Размеры (правая доля: норма <12-13см, левая доля <7см)
- Эхогенность (обычная / повышена / снижена)
- Эхоструктура (однородная / неоднородная)
- Контуры (ровные / неровные)
- Очаговые образования:
  * Локализация (сегмент по Куино)
  * Размер (мм)
  * Эхогенность (гипер/гипо/изо/анэхогенное)
  * Форма, контуры
  * Васкуляризация (если ЦДК)
- Воротная вена: диаметр (норма <13мм)
- Печёночные вены

2. ЖЕЛЧНЫЙ ПУЗЫРЬ:
- Размеры (длина <10см, ширина <4см)
- Толщина стенки (норма <3мм)
- Содержимое:
  * Конкременты (количество, размер, подвижность, акустическая тень)
  * Сладж, полипы (размер)
- Холедох (общий жёлчный проток): диаметр (норма <7мм)

3. ПОДЖЕЛУДОЧНАЯ ЖЕЛЕЗА:
- Размеры (головка <30мм, тело <25мм, хвост <30мм)
- Эхогенность, структура
- Контуры
- Вирсунгов проток (норма <2мм)
- Очаговые образования

4. СЕЛЕЗЁНКА:
- Размеры (длина <12см, толщина <5см)
- Эхоструктура
- Очаговые образования

5. ПОЧКИ (обе):
Правая/Левая:
- Размеры (длина 10-12см, ширина 5-6см, толщина паренхимы >15мм)
- Положение, подвижность
- Контуры (ровные/неровные)
- Паренхима (толщина, эхогенность, дифференциация КМС)
- ЧЛС (расширение, конкременты)
- Конкременты (размер, локализация, тень)
- Объёмные образования (киста: размер, категория по Bosniak)

6. МОЧЕВОЙ ПУЗЫРЬ:
- Содержимое (анэхогенное/взвесь)
- Стенка (толщина, контуры)
- Объём (остаточная моча)

7. СВОБОДНАЯ ЖИДКОСТЬ:
- Локализация (малый таз, подпечёночное пространство, периселезёночное)
- Объём (minimal / small / moderate / large)

8. ЛИМФОУЗЛЫ:
- Локализация (парааортальные, мезентериальные)
- Размер (норма <10мм по короткой оси)

ФОРМАТ ОТВЕТА:
[Timestamp] - ОРГАН: Находка
Размер: X мм/см
Характеристика: [детали]
Оценка: норма/патология

{COMMON_VIDEO_ULTRASOUND_CONCLUSION}
3. Категория (если образование): BIRADS/Bosniak/TIRADS""",

    'gynecology_us': """Проанализируй гинекологическое УЗИ-видео.

МЕТОД ИССЛЕДОВАНИЯ:
Определи: трансвагинальное (ТВ) / трансабдоминальное (ТА)

ОБЯЗАТЕЛЬНО УТОЧНИ:
- День менструального цикла (если репродуктивный возраст)
- Фаза цикла (фолликулярная / овуляция / лютеиновая)

1. МАТКА:
ПОЛОЖЕНИЕ: Anteversio / Retroversio / Lateroversio / Anteflexio / Retroflexio

РАЗМЕРЫ (норма репродуктивный возраст):
- Длина: 45-70 мм
- Ширина: 45-60 мм
- Передне-задний размер: 30-40 мм

КОНТУРЫ: Ровные / неровные / бугристые

МИОМЕТРИЙ:
- Эхогенность: обычная / повышена / снижена
- Эхоструктура: однородная / неоднородная
- Толщина стенок

МИОМАТОЗНЫЕ УЗЛЫ (если есть):
Для КАЖДОГО узла:
- Локализация: Субсерозный / Интрамуральный / Субмукозный / Шеечный
- Размер: X × Y × Z мм (FIGO classification)
- Количество узлов
- Структура: солидный / с дегенерацией / кальцинированный
- Деформация полости матки: да/нет

ЭНДОМЕТРИЙ:
- Толщина: X мм (норма зависит от фазы цикла)
- Эхоструктура: однородная / неоднородная
- Слойность: трёхслойный / однородный
- Полип эндометрия: размер, форма
- Гиперплазия эндометрия

2. ЯИЧНИКИ (ПРАВЫЙ И ЛЕВЫЙ):
РАЗМЕРЫ (норма репродуктивный возраст):
- Длина: 25-40 мм
- Ширина: 15-30 мм
- Толщина: 15-25 мм
- Объём: V = 0.523 × L × W × H (норма 4-10 см³)

СТРУКТУРА:
- Фолликулы: количество антральных фолликулов (AFC)
- Размер доминантного фолликула
- Жёлтое тело (в лютеиновую фазу)

ОБРАЗОВАНИЯ ЯИЧНИКА:
Для КАЖДОГО образования:
- Локализация: правый/левый яичник
- Размер: X × Y × Z мм
- Тип: Функциональная киста / Эндометриоидная / Дермоидная / Серозная / Муцинозная / Подозрение на злокачественность
- Оценка по O-RADS (1-5)

3. МАТОЧНЫЕ ТРУБЫ:
- Визуализация: не расширены (норма) / визуализируются
- Гидросальпинкс

4. СВОБОДНАЯ ЖИДКОСТЬ В МАЛОМ ТАЗУ:
- Наличие: нет / minimal / умеренное / большое количество
- Локализация: позади матки / вокруг яичников

ФОРМАТ ОТВЕТА:
МЕТОД: ТВ/ТА
ДЕНЬ ЦИКЛА: X день / менопауза

МАТКА:
Положение: [позиция]
Размеры: L×W×H мм
Миометрий: [описание]
Узлы: [если есть - подробно]
Эндометрий: X мм ([фаза цикла, норма/патология])

ПРАВЫЙ ЯИЧНИК:
Размеры: L×W×H мм, объём X см³
Фолликулы: AFC = X
Образования: [если есть - O-RADS]

ЛЕВЫЙ ЯИЧНИК:
[аналогично]

{COMMON_VIDEO_ULTRASOUND_CONCLUSION}""",

    'mri_brain': """Проанализируй видео/серию изображений МРТ головного мозга.

ОПРЕДЕЛИ ПОСЛЕДОВАТЕЛЬНОСТИ:
- T1-взвешенные (T1WI)
- T2-взвешенные (T2WI)
- FLAIR
- DWI (диффузионно-взвешенные)
- T1 с контрастом (Gd)
- SWI/GRE

СИСТЕМАТИЧЕСКИЙ АНАЛИЗ:

1. ЖЕЛУДОЧКОВАЯ СИСТЕМА:
- Размер: норма / расширены (гидроцефалия)
- Симметричность
- Перивентрикулярные изменения (Fazekas: 0-3)

2. ВЕЩЕСТВО МОЗГА:
- Белое вещество: очаги гиперинтенсивности на T2/FLAIR
- Серое вещество: кора, базальные ганглии, таламус

3. ОБЪЁМНЫЕ ОБРАЗОВАНИЯ:
{COMMON_FINDING_TEMPLATE}
- Сигнальные характеристики (T1, T2, FLAIR, DWI, T1+Gd) - только для МРТ
- Перифокальный отёк
- Масс-эффект

4. КОРТИКАЛЬНАЯ АТРОФИЯ:
- Степень: лёгкая / умеренная / выраженная

5. МОЗЖЕЧОК И СТВОЛ МОЗГА:
- Размер, симметрия
- Очаговые изменения

6. СОСУДЫ (если MR-ангиография):
- Артерии Виллизиева круга
- Аневризмы

ФОРМАТ ОТВЕТА:
ПОСЛЕДОВАТЕЛЬНОСТИ: [T1, T2, FLAIR, DWI, T1+Gd]

ЖЕЛУДОЧКОВАЯ СИСТЕМА: [описание]
ВЕЩЕСТВО МОЗГА: [описание]
ОБЪЁМНЫЕ ОБРАЗОВАНИЯ: [детальное описание каждого]
АТРОФИЯ: [степень]
СОСУДЫ: [описание]

{COMMON_VIDEO_MRI_CT_CONCLUSION}""",

    'mri_universal': """Проанализируй МРТ-исследование.

ВАЖНО: Автоматически определи исследуемую область и применяй соответствующие критерии оценки.

ШАГ 1: ИДЕНТИФИКАЦИЯ ОБЛАСТИ ИССЛЕДОВАНИЯ
Определи: Головной мозг / Позвоночник / Органы брюшной полости / Органы малого таза / Молочные железы / Суставы / Сердце / Почки / Мягкие ткани / Другое

ШАГ 2: ОПРЕДЕЛЕНИЕ ПОСЛЕДОВАТЕЛЬНОСТЕЙ
Укажи видимые МР-последовательности: T1WI / T2WI / FLAIR / STIR / DWI / T1+Gd / T2* / SWI / MRA / MRCP / DCE

ШАГ 3: СИСТЕМАТИЧЕСКОЕ ОПИСАНИЕ
3.1. АНАТОМИЧЕСКИЕ СТРУКТУРЫ: размеры, форма, контуры, положение
3.2. СИГНАЛЬНЫЕ ХАРАКТЕРИСТИКИ: T1, T2, однородность
3.3. ПАТОЛОГИЧЕСКИЕ ИЗМЕНЕНИЯ:
Для КАЖДОГО очага:
- Локализация
- Размер: X × Y × Z мм
- Количество: единичное / множественные
- Форма, контуры
- Сигнальные характеристики (T1, T2, DWI, T1+Gd)
- Внутренняя структура
- Окружающие ткани

ШАГ 4: ДИФФЕРЕНЦИАЛЬНЫЙ ДИАГНОЗ
ВАРИАНТ 1: [Диагноз] — вероятность X%
ВАРИАНТ 2: [Диагноз] — вероятность Y%

ШАГ 5: КЛАССИФИКАЦИЯ (если применимо)
- LI-RADS (печень)
- PI-RADS (предстательная железа)
- BI-RADS (молочные железы)
- Bosniak (почки)
- WHO Grade (глиомы)

ФОРМАТ ОТВЕТА:
ОБЛАСТЬ ИССЛЕДОВАНИЯ: [орган/система]
ПОСЛЕДОВАТЕЛЬНОСТИ: [перечислить]
ОПИСАНИЕ: [систематическое описание]
ПАТОЛОГИЧЕСКИЕ ИЗМЕНЕНИЯ: [детальное описание каждого очага]

ЗАКЛЮЧЕНИЕ:
1. МР-КАРТИНА: [основной диагноз]
2. ДИФФЕРЕНЦИАЛЬНЫЙ ДИАГНОЗ
3. КЛАССИФИКАЦИЯ (если применимо)
4. РЕКОМЕНДАЦИИ
5. СРОЧНОСТЬ""",

    'chest_ct': """Проанализируй КТ органов грудной клетки.

УКАЖИ ТИП ИССЛЕДОВАНИЯ:
- Нативное КТ (без контраста)
- КТ с внутривенным контрастированием
- КТ-ангиография лёгочных артерий (КТЛА)
- Высокоразрешающая КТ (ВРКТ / HRCT)

СИСТЕМАТИЧЕСКИЙ АНАЛИЗ:

1. ЛЁГОЧНАЯ ПАРЕНХИМА:
ОЦЕНКА ПО ДОЛЯМ И СЕГМЕНТАМ:
- Правое лёгкое: верхняя/средняя/нижняя доля
- Левое лёгкое: верхняя/нижняя доля

ОЧАГОВЫЕ ИЗМЕНЕНИЯ:
Для КАЖДОГО очага/узла:
- Локализация (лёгкое, доля, сегмент)
- Размер: X мм
- Плотность (HU): солидный / субсолидный / GGO
- Контуры: чёткие / нечёткие / спикулообразные
- Внутренняя структура: однородный / кавитация / кальцинаты
- Классификация: Fleischner Society / Lung-RADS

ДИФФУЗНЫЕ ИЗМЕНЕНИЯ:
- Матовое стекло (GGO)
- Консолидация
- Ретикулярные изменения
- Сотовое лёгкое
- Узловые изменения
- Буллы и кисты

2. ДЫХАТЕЛЬНЫЕ ПУТИ:
- Трахея: диаметр, смещение, стеноз
- Главные бронхи: проходимость, сужение
- Бронхоэктазы: тип, локализация

3. ПЛЕВРА:
- Плевральный выпот: локализация, объём, плотность
- Пневмоторакс: сторона, объём
- Утолщение плевры

4. СРЕДОСТЕНИЕ:
- Лимфоузлы: группы, размер (по короткой оси), структура
- Вилочковая железа
- Сердце и перикард
- Аорта: диаметр, аневризма, расслоение
- Лёгочная артерия (если КТЛА): ТЭЛА

5. КОСТНЫЙ КАРКАС:
- Рёбра: переломы, деструкция
- Грудина, ключицы
- Позвоночник (грудной отдел)

{COMMON_VIDEO_MRI_CT_CONCLUSION}
2. ДОПОЛНИТЕЛЬНЫЕ НАХОДКИ
3. СРАВНЕНИЕ С ПРЕДЫДУЩИМИ ИССЛЕДОВАНИЯМИ (если доступны)"""
}


def get_video_prompt(study_type: str) -> str:
    """
    Ленивая загрузка промпта для видео-анализа.
    Форматирует промпты с общими частями для устранения повторяемости.
    
    Args:
        study_type: Тип исследования ('fgds', 'colonoscopy', 'echo', etc.)
    
    Returns:
        Специализированный промпт или None, если тип не найден
    """
    prompt_template = VIDEO_ANALYSIS_PROMPTS.get(study_type)
    if not prompt_template:
        return None
    
    # Форматируем промпт с общими частями
    try:
        formatted_prompt = prompt_template.format(
            COMMON_VIDEO_CONCLUSION=COMMON_VIDEO_CONCLUSION,
            COMMON_VIDEO_MRI_CT_CONCLUSION=COMMON_VIDEO_MRI_CT_CONCLUSION,
            COMMON_VIDEO_ULTRASOUND_CONCLUSION=COMMON_VIDEO_ULTRASOUND_CONCLUSION,
            COMMON_VIDEO_TIMESTAMPS_REQUIREMENT=COMMON_VIDEO_TIMESTAMPS_REQUIREMENT,
            COMMON_FINDING_TEMPLATE=COMMON_FINDING_TEMPLATE
        )
        return formatted_prompt
    except KeyError:
        # Если в промпте нет общих частей, возвращаем как есть
        return prompt_template


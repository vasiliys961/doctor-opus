#!/bin/bash
# commit_refactoring_v3.sh - ะะพะผะผะธั ะธะทะผะตะฝะตะฝะธะน ัะตัะฐะบัะพัะธะฝะณะฐ ะฒะตััะธะธ 3.0

set -e  # ะััะฐะฝะพะฒะบะฐ ะฟัะธ ะพัะธะฑะบะต

echo "๐ฆ ะะพะผะผะธั ะธะทะผะตะฝะตะฝะธะน ัะตัะฐะบัะพัะธะฝะณะฐ v3.0..."
echo ""

# ะัะพะฒะตััะตะผ ััะพ ะผั ะฒ git ัะตะฟะพะทะธัะพัะธะธ
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    echo "โ ะัะธะฑะบะฐ: ะฝะต ะฒ git ัะตะฟะพะทะธัะพัะธะธ"
    echo "๐ก ะะฝะธัะธะฐะปะธะทะธััะนัะต git: git init"
    exit 1
fi

# ะัะพะฒะตััะตะผ ััะฐััั
echo "๐ ะัะพะฒะตัะบะฐ ััะฐัััะฐ git..."
STATUS=$(git status --porcelain)

if [ -z "$STATUS" ]; then
    echo "โ ะะฐะฑะพัะฐั ะดะธัะตะบัะพัะธั ัะธััะฐั - ะฝะตั ะธะทะผะตะฝะตะฝะธะน ะดะปั ะบะพะผะผะธัะฐ"
    exit 0
fi

echo "๐ ะะฑะฝะฐััะถะตะฝั ะธะทะผะตะฝะตะฝะธั:"
git status --short
echo ""

# ะะพะฑะฐะฒะปัะตะผ ะฒัะต ะธะทะผะตะฝะตะฝะธั
echo "๐ค ะะพะฑะฐะฒะปะตะฝะธะต ะฒัะตั ะธะทะผะตะฝะตะฝะธะน..."
git add -A

# ะกะพะทะดะฐะตะผ commit
TIMESTAMP=$(date +"%Y-%m-%d %H:%M:%S")
COMMIT_MSG="refactor: ะะตัะฐะบัะพัะธะฝะณ v3.0 - ะะฑัะฐะฑะพัะบะฐ ะพัะธะฑะพะบ ะะ ะธ ะทะฐะผะตะฝะฐ ะผะฐะณะธัะตัะบะธั ัะธัะตะป

โ ะะซะะะะะะะ:

1. ะะฑัะฐะฑะพัะบะฐ ะพัะธะฑะพะบ ะฒ database.py (8 ััะฝะบัะธะน)
   - ะะพะฑะฐะฒะปะตะฝ try-except ะดะปั ะฒัะตั ััะฝะบัะธะน ะะ
   - ะะพะณะธัะพะฒะฐะฝะธะต ะพัะธะฑะพะบ ะฒ sys.stderr
   - ะะพะทะฒัะฐั bool ััะฐัััะฐ ะดะปั ะฑะตะทะพะฟะฐัะฝะพะน ะพะฑัะฐะฑะพัะบะธ
   - ะคัะฝะบัะธะธ: init_database, save_medical_note, init_specialist_prompts_table,
     save_specialist_prompt, get_specialist_prompts, delete_specialist_prompt,
     init_feedback_table, init_db (utils/database.py)

2. ะะฐะผะตะฝะฐ ะผะฐะณะธัะตัะบะธั ัะธัะตะป Image.MAX_IMAGE_PIXELS
   - app.py: 500000000 โ PIL_MAX_IMAGE_PIXELS
   - page_modules/*.py (6 ัะฐะนะปะพะฒ): ecg, xray, mri, ct, ultrasound, dermatoscopy
   - ะัะฟะพะปัะทะพะฒะฐะฝะธะต ะบะพะฝััะฐะฝั ะธะท config/constants.py ั ะฑะตะทะพะฟะฐัะฝัะผ fallback

3. ะะฐะผะตะฝะฐ ะผะฐะณะธัะตัะบะธั ัะธัะตะป ะฒ advanced_ecg_processor.py (15+ ะบะพะฝััะฐะฝั)
   - ECG_DEFAULT_SAMPLING_RATE, BANDPASS_FILTER_*, POWERLINE_INTERFERENCE_FREQ
   - R_PEAK_*_RATIO, TRIANGULAR_INDEX_BIN_WIDTH_*
   - HR_*_THRESHOLD, RR_VARIATION_COEFFICIENT_*, HRV_NN50_THRESHOLD_SEC
   - ะัะต ะทะฝะฐัะตะฝะธั ัะตะฝััะฐะปะธะทะพะฒะฐะฝั ะฒ config/constants.py

๐ ะกะขะะขะะกะขะะะ:
- ะะฑัะฐะฑะพัะฐะฝะพ ััะฝะบัะธะน ะะ: 8
- ะะฐะผะตะฝะตะฝะพ ะผะฐะณะธัะตัะบะธั ัะธัะตะป: 15+
- ะะฑะฝะพะฒะปะตะฝะพ ัะฐะนะปะพะฒ: 8
- ะขะตััั: โ ะัะต ะฟัะพะนะดะตะฝั
- ะะฑัะฐัะฝะฐั ัะพะฒะผะตััะธะผะพััั: โ ะกะพััะฐะฝะตะฝะฐ

๐ ะะะะะฆะะะซ:
- ะะพะณะธะบะฐ ะฝะต ะธะทะผะตะฝะตะฝะฐ
- ะะตะทะพะฟะฐัะฝัะน ัะตัะฐะบัะพัะธะฝะณ
- ะะพััะตะฟะตะฝะฝัะต ัะปัััะตะฝะธั
- ะขะตััะธัะพะฒะฐะฝะธะต ะฟะพัะปะต ะบะฐะถะดะพะณะพ ัะฐะณะฐ

ะะฐัะฐ: $TIMESTAMP"

echo "๐พ ะกะพะทะดะฐะฝะธะต commit..."
git commit -m "$COMMIT_MSG"

# ะะพะปััะฐะตะผ commit hash
COMMIT_HASH=$(git rev-parse HEAD)
echo "โ Commit ัะพะทะดะฐะฝ: $COMMIT_HASH"

# ะกะพะทะดะฐะตะผ ัะตะณ ะดะปั ะฒะตััะธะธ
TAG_NAME="refactoring-v3.0"
echo "๐ท๏ธ  ะกะพะทะดะฐะฝะธะต ัะตะณะฐ: $TAG_NAME"
git tag -a "$TAG_NAME" -m "ะะตัะฐะบัะพัะธะฝะณ v3.0: ะะฑัะฐะฑะพัะบะฐ ะพัะธะฑะพะบ ะะ ะธ ะทะฐะผะตะฝะฐ ะผะฐะณะธัะตัะบะธั ัะธัะตะป

ะะตััะธั: 3.0
ะะฐัะฐ: $TIMESTAMP
Commit: $COMMIT_HASH

ะัะฝะพะฒะฝัะต ะธะทะผะตะฝะตะฝะธั:
- ะะฑัะฐะฑะพัะบะฐ ะพัะธะฑะพะบ ะฒ 8 ััะฝะบัะธัั ะะ
- ะะฐะผะตะฝะฐ ะผะฐะณะธัะตัะบะธั ัะธัะตะป ะฝะฐ ะบะพะฝััะฐะฝัั (15+)
- ะะฑะฝะพะฒะปะตะฝะพ 8 ัะฐะนะปะพะฒ
- ะัะต ัะตััั ะฟัะพะนะดะตะฝั" 2>/dev/null || {
    echo "โ๏ธ  ะขะตะณ ัะถะต ัััะตััะฒัะตั, ะพะฑะฝะพะฒะปะตะฝะธะต..."
    git tag -d "$TAG_NAME" 2>/dev/null || true
    git tag -a "$TAG_NAME" -m "ะะตัะฐะบัะพัะธะฝะณ v3.0: ะะฑัะฐะฑะพัะบะฐ ะพัะธะฑะพะบ ะะ ะธ ะทะฐะผะตะฝะฐ ะผะฐะณะธัะตัะบะธั ัะธัะตะป"
}

echo ""
echo "โ ะะพะผะผะธั ัะพะทะดะฐะฝ ััะฟะตัะฝะพ!"
echo ""
echo "๐ Commit: $COMMIT_HASH"
echo "๐ท๏ธ  Tag: $TAG_NAME"
echo ""
echo "๐ ะะปั ะฟัะพัะผะพััะฐ ะธะทะผะตะฝะตะฝะธะน:"
echo "   git show $COMMIT_HASH"
echo ""
echo "๐ ะะทะผะตะฝะตะฝะธั ะทะฐะบัะตะฟะปะตะฝั!"

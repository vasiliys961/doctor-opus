/**
 * Специфичные диагностические критерии для каждого типа медицинского изображения.
 * Основано на глубокой экспертизе из профессиональных модулей (diagnostic_prompts.py).
 * ПРЕДНАЗНАЧЕНО ДЛЯ ИСПОЛЬЗОВАНИЯ ПРОФЕССОРОМ КЛИНИЧЕСКОЙ МЕДИЦИНЫ.
 */

// === ОБЩИЕ ТРЕБОВАНИЯ К ФОРМАТУ (ПРОФЕССОР - ШАГ 2) ===
export const COMMON_FORMAT = `
Игнорируй требования о таблицах ссылок и логах веб‑поиска: ссылки и логи НЕ НУЖНЫ.
Не используй табличный формат. Все параметры описывай в виде структурированного текста.
ФОКУС НА ДИАГНОСТИКЕ: минимизируй описание нормы, концентрируйся на патологиях.
БУДЬ ЛАКОНИЧНЫМ: Сразу к синтезу и клиническим выводам.
Указывай только реально выявленные отклонения.
Всегда указывай ТОЧНУЮ локализацию патологии (какая структура, какая часть, сторона).
Используй международную медицинскую терминологию.

### СТАНДАРТ МЕДИЦИНСКИХ ШКАЛ (ОБЯЗАТЕЛЬНО):
Если применимо, рассчитай и укажи баллы по следующим шкалам:
- ЭКГ: CHA2DS2-VASc (риск инсульта), HAS-BLED (риск кровотечений).
- МАММОГРАФИЯ: Категория BI-RADS (0-6).
- КТ ЛЕГКИХ: Fleischner criteria / Lung-RADS.
- УЗИ ЩИТОВИДНОЙ ЖЕЛЕЗЫ: TI-RADS.
- ДЕРМАТОСКОПИЯ: Алгоритм ABCDE и оценка по шкале Ардженциано (CASH).
`;

// === СПЕЦИАЛИЗИРОВАННЫЕ КРИТЕРИИ ДЛЯ СПЕЦИАЛИСТОВ (ШАГ 1: ИЗВЛЕЧЕНИЕ) ===
// Эти данные используются Gemini Flash для максимально точного описания изображения в сжатом JSON
export const SPECIALIST_CRITERIA = {
  ecg: {
    title: 'ЭКГ (High-Precision Scan)',
    requirements: `
1. Ритм/ЧСС: Анализ P-QRS-T во всех отведениях.
2. Интервалы: Измерь PR, QRS, QT/QTc (мс).
3. Ось: Рассчитай ЭОС в градусах.
4. Ишемия: Проверь ST (элевация/депрессия) и зубец T по стенкам:
   - Нижняя (II, III, aVF)
   - Передняя (V1-V4)
   - Боковая (I, aVL, V5-V6)
`,
    pathologies: 'Инфаркт (локализация?), Блокады (степень?), Гипертрофия (Sokolow-Lyon), Аритмии.'
  },
  xray: {
    title: 'Рентгенография (ABCDE Pattern)',
    requirements: `
1. Airways: Трахея (смещение).
2. Breathing: Легочные поля (инфильтрация, прозрачность, рисунок).
3. Circulation: Силуэт сердца, ширина средостения.
4. Diaphragm: Синусы, контуры куполов.
5. Everything: Кости, мягкие ткани.
`,
    pathologies: 'Пневмония, Пневмоторакс (линия плевры?), Плевральный выпот, Отек легких, Переломы.'
  },
  ct: {
    title: 'КТ (Hounsfield Scale Analysis)',
    requirements: `
1. Плотность: Измерь HU всех подозрительных зон.
2. Морфология: Контуры (ровные/лучистые), структура (гомогенная/нет).
3. Сосуды: Проверь просвет на дефекты наполнения (тромбы).
4. Лимфоузлы: Короткая ось (мм).
`,
    pathologies: 'ТЭЛА (тромбы?), Кровоизлияния (HU?), Опухоли (инвазия?), Аппендицит/Холецистит.'
  },
  mri: {
    title: 'МРТ (Sequence Analysis)',
    requirements: `
1. Сигнал: Сравни T1, T2, FLAIR, DWI, ADC.
2. Масс-эффект: Смещение срединных структур (мм), перифокальный отек.
3. Диффузия: Ограничение (DWI/ADC) для поиска острого инсульта.
`,
    pathologies: 'Инсульт (острая стадия?), Демиелинизация (очаги?), Грыжи (компрессия?), Опухоли.'
  },
  ultrasound: {
    title: 'УЗИ (Echo-Structure Scan)',
    requirements: `
1. Эхогенность: Ан-, гипо-, изо-, гиперэхогенное.
2. ЦДК/Допплер: Васкуляризация и характер кровотока.
3. Структура: Однородность, четкость контуров, акустические тени.
`,
    pathologies: 'Конкременты (тень?), Кисты, Цирроз (край?), Стеатоз, Тиреоидит.'
  },
  dermatoscopy: {
    title: 'Дерматоскопия (ABCDE & CASH)',
    requirements: `
1. Пигментная сеть: Типичная/атипичная, обрывы.
2. Цвета и Структуры: Точки, глобулы, бело-синяя вуаль.
3. Сосуды: Древовидные, шпильки, коронарные.
`,
    pathologies: 'Меланома (асимметрия?), Базалиома, Кератоз.'
  },
  genetics: {
    title: 'Генетический анализ',
    requirements: `
1. Варианты: rsID, ген, генотип, нотация c. / p.
2. Базы: Сверка с ClinVar (Pathogenic/Benign).
`,
    pathologies: 'Фармакогенетика, Нутригеномика, Моногенные риски.'
  },
  mammography: {
    title: 'Маммография (BI-RADS Protocol)',
    requirements: `
1. Плотность: Тип ACR (A, B, C, D).
2. Образования: Форма, края (спикулярные?), плотность.
3. Кальцинаты: Плеоморфные, сгруппированные.
`,
    pathologies: 'BI-RADS 0-6, узловые образования, асимметрия.'
  },
  histology: {
    title: 'Гистология',
    requirements: `
1. Клетки: Атипия, митозы, ядерно-цитоплазматическое соотношение.
2. Архитектура: Инвазия, Grade (G1-G3).
`,
    pathologies: 'Злокачественность, стадия инвазии.'
  },
  retinal: {
    title: 'Офтальмоскопия (Vascular Scan)',
    requirements: `
1. ДЗН: Границы, экскавация.
2. Сосуды: Артерии/вены (А/В), симптомы Салюса-Гунна.
3. Макула: Рефлекс, друзы.
`,
    pathologies: 'Ретинопатия (геморрагии?), ВМД, Глаукома.'
  },
  universal: {
    title: 'Медицинская Визуализация',
    requirements: 'Проведи систематический анализ всех видимых структур и выяви отклонения.',
    pathologies: 'Все визуально определяемые патологии.'
  }
};

export type ImageType = keyof typeof SPECIALIST_CRITERIA;

/**
 * Генерирует супер-промпт для Gemini Flash (Шаг 1: Специалист)
 * Фокус на извлечении патологий в максимально сжатом JSON для экономии токенов на втором этапе.
 */
export function getDescriptionPrompt(imageType: ImageType): string {
  const criteria = SPECIALIST_CRITERIA[imageType] || SPECIALIST_CRITERIA.universal;
  
  return `
Ты — Vision-AI эксперт (роль: Специалист, профиль: ${criteria.title}).
Твоя задача: найти ПАТОЛОГИИ и выдать их в СЖАТОМ JSON для последующего анализа Профессором.

### АЛГОРИТМ ПОИСКА:
${criteria.requirements}

### ЧТО ИСКАТЬ (КЛЮЧЕВЫЕ ПАТОЛОГИИ):
${criteria.pathologies}

### ТРЕБОВАНИЯ К JSON (СЖАТЫЙ ФОРМАТ):
Верни ответ СТРОГО в формате JSON с короткими ключами (для экономии токенов):
{
  "mod": "${imageType}",
  "qual": 1-5, // качество снимка
  "urgent": ["список экстренных признаков или []"],
  "meas": {"параметр": "значение"}, // мм, мс, HU и т.д.
  "findings": [
    {
      "loc": "локализация",
      "sign": "признак (напр: гиперденсный очаг)",
      "desc": "детали (размер, края, структура)",
      "sev": 1-3 // 1-норма/легко, 2-внимание, 3-критично
    }
  ],
  "conf": 0.0-1.0
}

ВАЖНО: Игнорируй норму, если она не важна. Фокус на аномалиях. Будь предельно точен в цифрах.
`;
}

/**
 * Генерирует промпт для КЛИНИЧЕСКОЙ ДИРЕКТИВЫ (Шаг 2: Работа Профессора)
 * Фокус на синтезе данных из JSON, диагнозе и плане лечения.
 */
export function getDirectivePrompt(imageType: ImageType, userPrompt: string = ''): string {
  const criteria = SPECIALIST_CRITERIA[imageType] || SPECIALIST_CRITERIA.universal;

  return `
Ты — Профессор клинической медицины. Твоя задача: проанализировать технические данные (JSON) от Специалиста и сформировать финальную КЛИНИЧЕСКУЮ ДИРЕКТИВУ.

### СПРАВОЧНИК JSON (ДЛЯ РАСШИФРОВКИ):
- mod: модальность исследования
- qual: качество изображения (1-5)
- urgent: список экстренных признаков (если есть)
- meas: технические измерения (мм, мс, HU, углы и т.д.)
- findings: список обнаруженных изменений
  - loc: точная локализация
  - sign: визуальный признак (термин)
  - desc: детальное морфологическое описание
  - sev: степень тяжести/значимости (1-норма, 2-внимание, 3-критично)

### КОНТЕКСТ ИССЛЕДОВАНИЯ: ${criteria.title}

### ТВОИ ЗАДАЧИ:
1. Изучи JSON с находками.
2. Оцените клиническую значимость этих данных в контексте ${criteria.title}.
3. Сформируй пошаговый план (диагностика, терапия, мониторинг).

### ДОПОЛНИТЕЛЬНЫЙ ЗАПРОС:
${userPrompt || 'Сформируй полный клинический план.'}

${COMMON_FORMAT}

ВАЖНО: Твое решение должно основываться на доказательной медицине.
`;
}

// Fallback функции для обратной совместимости
export function getPrompt(imageType: ImageType, mode: 'fast' | 'optimized'): string {
  return mode === 'fast' ? getDescriptionPrompt(imageType) : getDirectivePrompt(imageType);
}

export function getFastAnalysisPrompt(imageType: ImageType): string {
  return getDirectivePrompt(imageType, 'Дай краткую, но точную директиву.');
}

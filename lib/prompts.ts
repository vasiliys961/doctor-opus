/**
 * Специфичные диагностические критерии для каждого типа медицинского изображения.
 * Основано на глубокой экспертизе из профессиональных модулей (diagnostic_prompts.py).
 * ПРЕДНАЗНАЧЕНО ДЛЯ ИСПОЛЬЗОВАНИЯ ПРОФЕССОРОМ КЛИНИЧЕСКОЙ МЕДИЦИНЫ.
 */

// === ОБЩИЕ ТРЕБОВАНИЯ К ФОРМАТУ (ПРОФЕССОР - ШАГ 2) ===
export const COMMON_FORMAT = `
Игнорируй требования о таблицах ссылок и логах веб‑поиска: ссылки и логи НЕ НУЖНЫ.
Не используй табличный формат. Все параметры описывай в виде структурированного текста.
ФОКУС НА ДИАГНОСТИКЕ: минимизируй описание нормы, концентрируйся на патологиях.
БУДЬ ЛАКОНИЧНЫМ: Сразу к синтезу и клиническим выводам.
Указывай только реально выявленные отклонения.
Всегда указывай ТОЧНУЮ локализацию патологии (какая структура, какая часть, сторона).
Используй международную медицинскую терминологию.

### СТАНДАРТ МЕДИЦИНСКИХ ШКАЛ (ОБЯЗАТЕЛЬНО):
Если применимо, рассчитай и укажи баллы по следующим шкалам:
- ЭКГ: CHA2DS2-VASc (риск инсульта), HAS-BLED (риск кровотечений).
- МАММОГРАФИЯ: Категория BI-RADS (0-6).
- КТ ЛЕГКИХ: Fleischner criteria / Lung-RADS.
- УЗИ ЩИТОВИДНОЙ ЖЕЛЕЗЫ: TI-RADS.
- ДЕРМАТОСКОПИЯ: Алгоритм ABCDE и оценка по шкале Ардженциано (CASH).
`;

// === СПЕЦИАЛИЗИРОВАННЫЕ КРИТЕРИИ ДЛЯ СПЕЦИАЛИСТОВ (ШАГ 1: ИЗВЛЕЧЕНИЕ) ===
// Эти данные используются Gemini Flash для максимально точного описания изображения в сжатом JSON
export const SPECIALIST_CRITERIA = {
  ecg: {
    title: 'ЭКГ (High-Precision Scan)',
    requirements: `
1. Ритм/ЧСС: Анализ P-QRS-T во всех отведениях.
2. Интервалы: Измерь PR, QRS, QT/QTc (мс).
3. Ось: Рассчитай ЭОС в градусах.
4. Ишемия: Проверь ST (элевация/депрессия) и зубец T по стенкам:
   - Нижняя (II, III, aVF)
   - Передняя (V1-V4)
   - Боковая (I, aVL, V5-V6)
`,
    pathologies: 'Инфаркт (локализация?), Блокады (степень?), Гипертрофия (Sokolow-Lyon), Аритмии.'
  },
  xray: {
    title: 'Рентгенография (ABCDE Pattern)',
    requirements: `
1. Airways: Трахея (смещение).
2. Breathing: Легочные поля (инфильтрация, прозрачность, рисунок).
3. Circulation: Силуэт сердца, ширина средостения.
4. Diaphragm: Синусы, контуры куполов.
5. Everything: Кости, мягкие ткани.
`,
    pathologies: 'Пневмония, Пневмоторакс (линия плевры?), Плевральный выпот, Отек легких, Переломы.'
  },
  ct: {
    title: 'КТ (Hounsfield Scale Analysis)',
    requirements: `
1. Плотность: Измерь HU всех подозрительных зон.
2. Морфология: Контуры (ровные/лучистые), структура (гомогенная/нет).
3. Сосуды: Проверь просвет на дефекты наполнения (тромбы).
4. Лимфоузлы: Короткая ось (мм).
`,
    pathologies: 'ТЭЛА (тромбы?), Кровоизлияния (HU?), Опухоли (инвазия?), Аппендицит/Холецистит.'
  },
  mri: {
    title: 'МРТ (Sequence Analysis)',
    requirements: `
1. Сигнал: Сравни T1, T2, FLAIR, DWI, ADC.
2. Масс-эффект: Смещение срединных структур (мм), перифокальный отек.
3. Диффузия: Ограничение (DWI/ADC) для поиска острого инсульта.
`,
    pathologies: 'Инсульт (острая стадия?), Демиелинизация (очаги?), Грыжи (компрессия?), Опухоли.'
  },
  ultrasound: {
    title: 'УЗИ (Echo-Structure Scan)',
    requirements: `
1. Эхогенность: Ан-, гипо-, изо-, гиперэхогенное.
2. ЦДК/Допплер: Васкуляризация и характер кровотока.
3. Структура: Однородность, четкость контуров, акустические тени.
`,
    pathologies: 'Конкременты (тень?), Кисты, Цирроз (край?), Стеатоз, Тиреоидит.'
  },
  dermatoscopy: {
    title: 'Дерматоскопия (ABCDE & CASH)',
    requirements: `
1. Пигментная сеть: Типичная/атипичная, обрывы.
2. Цвета и Структуры: Точки, глобулы, бело-синяя вуаль.
3. Сосуды: Древовидные, шпильки, коронарные.
`,
    pathologies: 'Меланома (асимметрия?), Базалиома, Кератоз.'
  },
  genetics: {
    title: 'Генетический анализ',
    requirements: `
1. Варианты: rsID, ген, генотип, нотация c. / p.
2. Базы: Сверка с ClinVar (Pathogenic/Benign).
`,
    pathologies: 'Фармакогенетика, Нутригеномика, Моногенные риски.'
  },
  mammography: {
    title: 'Маммография (BI-RADS Protocol)',
    requirements: `
1. Плотность: Тип ACR (A, B, C, D).
2. Образования: Форма, края (спикулярные?), плотность.
3. Кальцинаты: Плеоморфные, сгруппированные.
`,
    pathologies: 'BI-RADS 0-6, узловые образования, асимметрия.'
  },
  histology: {
    title: 'Гистология',
    requirements: `
1. Клетки: Атипия, митозы, ядерно-цитоплазматическое соотношение.
2. Архитектура: Инвазия, Grade (G1-G3).
`,
    pathologies: 'Злокачественность, стадия инвазии.'
  },
  retinal: {
    title: 'Офтальмоскопия (Vascular Scan)',
    requirements: `
1. ДЗН: Границы, экскавация.
2. Сосуды: Артерии/вены (А/В), симптомы Салюса-Гунна.
3. Макула: Рефлекс, друзы.
`,
    pathologies: 'Ретинопатия (геморрагии?), ВМД, Глаукома.'
  },
  universal: {
    title: 'Медицинская Визуализация',
    requirements: 'Проведи систематический анализ всех видимых структур и выяви отклонения.',
    pathologies: 'Все визуально определяемые патологии.'
  },
  cardiology_echo: {
    title: 'Эхокардиография (ЭхоКГ)',
    requirements: 'Оцените размеры камер, толщину стенок, фракцию выброса (EF), работу клапанов, наличие регургитации.',
    pathologies: 'Пороки сердца, кардиомиопатии, вегетации, выпот в перикарде.',
  },
  oncology_histology: {
    title: 'Онкоморфология',
    requirements: 'Оцените экспрессию маркеров, архитектуру ткани, границы резекции.',
    pathologies: 'Метастазы, специфические типы опухолей, края R0/R1.',
  },
  hematology_blood_morphology: {
    title: 'Морфология мазок крови',
    requirements: 'Оцените форму и размеры эритроцитов, лейкоцитарную формулу, наличие атипичных клеток.',
    pathologies: 'Бласты, анемии, тромбоцитопении, паразитарные инвазии.',
  },
  endocrinology_thyroid_ultrasound: {
    title: 'УЗИ щитовидной железы (TI-RADS)',
    requirements: 'Оцените объем долей, эхогенность, узловые образования по системе TI-RADS.',
    pathologies: 'Узловой зоб, тиреоидит, подозрение на рак щитовидной железы.',
  },
  neurology_mri_brain: {
    title: 'МРТ головного мозга (Нейровизуализация)',
    requirements: 'Оцените дифференциацию серого и белого вещества, состояние желудочков, базальных ганглиев.',
    pathologies: 'Острое нарушение мозгового кровообращения (ОНМК), демиелинизация (PC), глиомы.',
  },
  radiology_chest_ct: {
    title: 'КТ органов грудной клетки',
    requirements: 'Оцените состояние паренхимы легких, средостения, лимфоузлов.',
    pathologies: 'Очаги (nodules), эмфизема, интерстициальные изменения.',
  }
};

export type ImageType = keyof typeof SPECIALIST_CRITERIA;

export type Specialty = 
  | 'universal' 
  | 'cardiology' 
  | 'neurology' 
  | 'radiology' 
  | 'oncology' 
  | 'hematology' 
  | 'endocrinology' 
  | 'gynecology' 
  | 'rheumatology'
  | 'gastroenterology'
  | 'dermatology'
  | 'pediatrics';

/**
 * ПРОСТЫЕ КОНТЕКСТЫ ДЛЯ АНАЛИЗА ИЗОБРАЖЕНИЙ
 * Фокус на точности описания и клинической значимости без академического перегруза.
 */
export const SPECIALTY_CONTEXTS: Record<Specialty, string> = {
  universal: '',
  cardiology: `
### КАРДИОЛОГИЧЕСКИЙ КОНТЕКСТ:
- Приоритет: выявление ишемии, инфарктов, аритмий, признаков сердечной недостаточности.
- Используй стратификацию риска (CHA2DS2-VASc, HAS-BLED), если применимо.
`,
  neurology: `
### НЕВРОЛОГИЧЕСКИЙ КОНТЕКСТ:
- Для МРТ/КТ мозга: дифференциация острого инсульта, хронической ишемии, демиелинизации.
- Оценивай масс-эффект и дислокацию срединных структур.
`,
  radiology: `
### РЕНТГЕНОЛОГИЧЕСКИЙ КОНТЕКСТ:
- Отчет в RSNA style: морфология, плотность (HU), накопление контраста.
- Рекомендации для дальнейшего наблюдения (follow-up).
`,
  oncology: `
### ОНКОЛОГИЧЕСКИЙ КОНТЕКСТ:
- Поиск признаков злокачественности, стадирование по TNM.
- Оценивай границы образований и лимфаденопатию.
`,
  hematology: `
### ГЕМАТОЛОГИЧЕСКИЙ КОНТЕКСТ:
- Анализ мазков крови и костного мозга: бластные клетки, морфология всех ростков.
`,
  endocrinology: `
### ЭНДОКРИНОЛОГИЧЕСКИЙ КОНТЕКСТ:
- Оценивай объем желез, структуру, узлы по TI-RADS.
`,
  gynecology: `
### ГИНЕКОЛОГИЧЕСКИЙ КОНТЕКСТ:
- УЗИ/МРТ: эндометрий (фаза цикла), миомы, кисты яичников.
`,
  rheumatology: `
### РЕВМАТОЛОГИЧЕСКИЙ КОНТЕКСТ:
- Оценивай признаки синовита, эрозий, сужения суставных щелей.
`,
  gastroenterology: `
### ГАСТРОЭНТЕРОЛОГИЧЕСКИЙ КОНТЕКСТ:
- Анализ заболеваний ЖКТ и печени.
`,
  dermatology: `
### ДЕРМАТОЛОГИЧЕСКИЙ КОНТЕКСТ:
- Анализ кожных покровов и новообразований.
`,
  pediatrics: `
### ПЕДИАТРИЧЕСКИЙ КОНТЕКСТ:
- Анализ данных с учетом возрастных норм развития ребенка.
`
};

/**
 * КОНТЕКСТЫ ТИТАНОВ (ИСКЛЮЧИТЕЛЬНО ДЛЯ ИИ-КОНСУЛЬТАНТА)
 * Глубокая академическая база для текстовых консультаций.
 */
export const TITAN_CONTEXTS: Record<Specialty, string> = {
  universal: '',
  cardiology: `
### РОЛЬ: КАРДИОЛОГ (ШКОЛА ЮДЖИНА БРАУНВАЛЬДА)
Ты — эксперт мирового уровня. База: Braunwald's Heart Disease 12th Ed (2024) и ESC/ACC 2025.
- Гемодинамика, электрофизиология, стратификация риска внезапной смерти.
`,
  neurology: `
### РОЛЬ: НЕВРОЛОГ / НЕЙРОРАДИОЛОГ (ШКОЛА ЭНН ОСБОРН)
Ты — эксперт нейровизуализации. База: Osborn's Brain 3rd Ed (2024).
- Дифференциальный диагноз сосудистых катастроф и нейродегенерации.
`,
  radiology: `
### РОЛЬ: РЕНТГЕНОЛОГ (МЕТОДОЛОГИЯ БЕНДЖАМИНА ФЕЛСОНА)
Ты — врач-рентгенолог экспертного уровня. Используешь RSNA structured reporting.
`,
  oncology: `
### РОЛЬ: ОНКОЛОГ (ШКОЛА ВИНСЕНТА ДЕ ВИТА)
Ты — онколог экспертного уровня. База: DeVita's Oncology 12th Ed (2024) и NCCN 2025.
- Стадирование по TNM 9th Ed, ответ на терапию по RECIST 1.1.
`,
  hematology: `
### РОЛЬ: ГЕМАТОЛОГ (ШКОЛА МАКСВЕЛЛА ВИНТРОБА)
Ты — эксперт в области заболеваний крови. База: Wintrobe's Clinical Hematology 15th Ed (2024).
`,
  endocrinology: `
### РОЛЬ: АКАДЕМИК РАН
Ты — ведущий эксперт академического уровня. База: Williams Textbook of Endocrinology 15th Ed (2024), гайдлайны ATA 2025 и РАЭ 2024-2025.
- Тиреоидология (TIRADS), нейроэндокринология, надпочечники.
`,
  gynecology: `
### РОЛЬ: ГИНЕКОЛОГ (ШКОЛА УИЛЬЯМСА / НОВАКА)
Ты — эксперт в области репродуктивного здоровья. База: Williams Obstetrics 27th Ed (2024).
`,
  rheumatology: `
### РОЛЬ: РЕВМАТОЛОГ (ШКОЛА КЕЛЛИ / ФАЙРШТЕЙНА)
Ты — эксперт в системных заболеваниях соединительной ткани. База: Kelley's Rheumatology 12th Ed (2024).
`,
  gastroenterology: `
### РОЛЬ: ГАСТРОЭНТЕРОЛОГ (ШКОЛА СЛЕЙЗЕНДЖЕРА)
Ты — эксперт в заболеваниях ЖКТ и печени. База: Sleisenger & Fordtran's Gastrointestinal and Liver Disease 12th Ed (2024).
`,
  dermatology: `
### РОЛЬ: ДЕРМАТОЛОГ (ШКОЛА ТОМАСА ФИЦПАТРИКА)
Ты — эксперт в дерматологии. База: Fitzpatrick's Dermatology 10th Ed (2024).
`,
  pediatrics: `
### РОЛЬ: ПЕДИАТР (ШКОЛА УОЛДО НЕЛЬСОНА)
Ты — детский врач экспертного уровня. База: Nelson Textbook of Pediatrics 22nd Ed (2024).
`
};

/**
 * Генерирует супер-промпт для Gemini Flash (Шаг 1: Специалист)
 * Фокус на извлечении патологий в максимально сжатом JSON для экономии токенов на втором этапе.
 */
export function getDescriptionPrompt(imageType: ImageType): string {
  const criteria = SPECIALIST_CRITERIA[imageType] || SPECIALIST_CRITERIA.universal;
  
  return `
Ты — Vision-AI эксперт (роль: Специалист, профиль: ${criteria.title}).
Твоя задача: найти ПАТОЛОГИИ и выдать их в СЖАТОМ JSON для последующего анализа Профессором.

### АЛГОРИТМ ПОИСКА:
${criteria.requirements}

### ЧТО ИСКАТЬ (КЛЮЧЕВЫЕ ПАТОЛОГИИ):
${criteria.pathologies}

### ТРЕБОВАНИЯ К JSON (СЖАТЫЙ ФОРМАТ):
Верни ответ СТРОГО в формате JSON с короткими ключами (для экономии токенов):
{
  "mod": "${imageType}",
  "qual": 1-5, // качество снимка
  "urgent": ["список экстренных признаков или []"],
  "meas": {"параметр": "значение"}, // мм, мс, HU и т.д.
  "findings": [
    {
      "loc": "локализация",
      "sign": "признак (напр: гиперденсный очаг)",
      "desc": "детали (размер, края, структура)",
      "sev": 1-3 // 1-норма/легко, 2-внимание, 3-критично
    }
  ],
  "conf": 0.0-1.0
}

ВАЖНО: Игнорируй норму, если она не важна. Фокус на аномалиях. Будь предельно точен в цифрах.
`;
}

/**
 * Генерирует промпт для КЛИНИЧЕСКОЙ ДИРЕКТИВЫ (Шаг 2: Работа Профессора)
 * Фокус на синтезе данных из JSON, диагнозе и плане лечения.
 */
export function getDirectivePrompt(imageType: ImageType, userPrompt: string = '', specialty?: Specialty): string {
  const criteria = SPECIALIST_CRITERIA[imageType] || SPECIALIST_CRITERIA.universal;
  let prompt = `
Ты — Профессор клинической медицины. Твоя задача: проанализировать технические данные (JSON) от Специалиста и сформировать финальную КЛИНИЧЕСКУЮ ДИРЕКТИВУ.

### СПРАВОЧНИК JSON (ДЛЯ РАСШИФРОВКИ):
- mod: модальность исследования
- qual: качество изображения (1-5)
- urgent: список экстренных признаков (если есть)
- meas: технические измерения (мм, мс, HU, углы и т.д.)
- findings: список обнаруженных изменений
  - loc: точная локализация
  - sign: визуальный признак (термин)
  - desc: детальное морфологическое описание
  - sev: степень тяжести/значимости (1-норма, 2-внимание, 3-критично)

### КОНТЕКСТ ИССЛЕДОВАНИЯ: ${criteria.title}

### ТВОИ ЗАДАЧИ:
1. Изучи JSON с находками.
2. Оцените клиническую значимость этих данных в контексте ${criteria.title}.
3. Сформируй пошаговый план (диагностика, терапия, мониторинг).

### ДОПОЛНИТЕЛЬНЫЙ ЗАПРОС:
${userPrompt || 'Сформируй полный клинический план.'}
`;

  // Добавляем специализированный контекст (простой для анализа снимков)
  if (specialty && SPECIALTY_CONTEXTS[specialty]) {
    prompt += `\n${SPECIALTY_CONTEXTS[specialty]}`;
  }

  prompt += `\n${COMMON_FORMAT}\n\nВАЖНО: Твое решение должно основываться на доказательной медицине.`;

  return prompt;
}

/**
 * Псевдоним для getDirectivePrompt с поддержкой специализации
 */
export function getSpecializedPrompt(imageType: ImageType, specialty?: Specialty, userPrompt?: string): string {
  return getDirectivePrompt(imageType, userPrompt, specialty);
}

// Fallback функции для обратной совместимости
export function getPrompt(imageType: ImageType, mode: 'fast' | 'optimized', specialty?: Specialty): string {
  return mode === 'fast' ? getDescriptionPrompt(imageType) : getDirectivePrompt(imageType, '', specialty);
}

export function getFastAnalysisPrompt(imageType: ImageType, specialty?: Specialty): string {
  return getDirectivePrompt(imageType, 'Дай максимально краткий, но точный разбор основных патологий.', specialty);
}

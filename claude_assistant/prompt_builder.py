"""
Модуль для построения диагностических промптов
Вынесено из vision_client.py для уменьшения размера файла
"""

import logging
from typing import Optional

logger = logging.getLogger(__name__)


class PromptBuilder:
    """
    Класс для построения диагностических промптов
    
    КРИТИЧЕСКИ ВАЖНО: Логика выбора промптов НЕ ИЗМЕНЕНА!
    ТОЧНАЯ КОПИЯ логики из vision_client.py._select_diagnostic_prompt
    """
    
    # Константы ключевых слов для определения типа промпта
    ECG_KEYWORDS = ["экг", "ecg"]
    XRAY_KEYWORDS = ["рентген", "xray", "грудн"]
    MRI_KEYWORDS = ["мрт", "mri"]
    CT_KEYWORDS = ["кт", "ct", "компьютерн"]
    ULTRASOUND_KEYWORDS = ["узи", "ультразвук", "ultrasound"]
    
    @staticmethod
    def _add_user_prompt(medical_prompt: str, user_prompt: str) -> str:
        """
        Добавление пользовательского промпта к медицинскому промпту
        
        Args:
            medical_prompt: Базовый медицинский промпт
            user_prompt: Пользовательский промпт (дополнительные инструкции)
        
        Returns:
            str: Промпт с добавленными пользовательскими инструкциями
        """
        if user_prompt and user_prompt.strip():
            return f"{medical_prompt}\n\nДополнительные инструкции:\n{user_prompt}"
        return medical_prompt
    
    @staticmethod
    def select_diagnostic_prompt(
        system_prompt: str,
        prompt: str,
        prompt_lower: str,
        metadata: Optional[dict]
    ) -> str:
        """
        Выбор диагностического промпта - КРИТИЧЕСКИ ВАЖНАЯ ЛОГИКА!
        
        ТОЧНАЯ КОПИЯ логики из vision_client.py._select_diagnostic_prompt
        НЕ ИЗМЕНЯТЬ ЛОГИКУ ВЫБОРА ПРОМПТОВ!
        
        Args:
            system_prompt: Системный промпт профессора
            prompt: Пользовательский промпт
            prompt_lower: Промпт в нижнем регистре
            metadata: Метаданные запроса
        
        Returns:
            str: Полный диагностический промпт
        """
        # Специальный режим «только сканирование» (OCR/извлечение данных),
        # когда нам НЕ нужна клиническая директива и общий системный контекст.
        scan_only_mode = isinstance(metadata, dict) and metadata.get("task") in ("lab_ocr", "doc_ocr")
        
        if scan_only_mode:
            # Используем только специализированный промпт без system_prompt
            return prompt
        
        # ТОЧНАЯ КОПИЯ логики выбора промптов из claude_assistant.py
        # ЭКГ - КРИТИЧЕСКИ ВАЖНЫЙ ПРОМПТ!
        if any(kw in prompt_lower for kw in PromptBuilder.ECG_KEYWORDS):
            # Используем полный детальный промпт для максимальной точности диагностики
            try:
                from prompts.diagnostic_prompts import get_ecg_diagnostic_prompt
                # Специализированный промпт ЭКГ теперь НЕ включает system_prompt
                medical_prompt = get_ecg_diagnostic_prompt()
                logger.info("✅ [ECG PROMPT] Используется детальный промпт из diagnostic_prompts.py")
                return PromptBuilder._add_user_prompt(medical_prompt, prompt)
            except ImportError as e:
                logger.warning(f"⚠️ [ECG PROMPT] Модуль diagnostic_prompts недоступен: {e}, используем fallback")
            except Exception as e:
                logger.error(f"❌ [ECG PROMPT] Неожиданная ошибка при загрузке промпта: {e}", exc_info=True)
                # Fallback: детальный промпт с профессором
                # Профессор клинической медицины уже установлен через system role
                return f"""Ты — американский профессор клинической медицины (Board Certified) с экспертной компетенцией в области кардиологии и электрофизиологии. 
Твоя задача — выполнить полноценный экспертный анализ 12‑канальной ЭКГ (включая сложные аритмии и блокады)
и выдать результат в формате «Клиническая директива».

ВАЖНО: Все заключения формулируются от лица профессора клинической медицины (через system_prompt выше).

Игнорируй требования о таблицах ссылок и логах веб‑поиска: ссылки и логи НЕ НУЖНЫ в ответе.
Не используй табличный формат (строки/столбцы с «Параметр / Значение»); все параметры описывай в виде структурированного текста и списков.

ВАЖНО: Делай заключение КОМПАКТНЫМ. НЕ перечисляй отсутствующие патологии. Указывай только реально выявленные отклонения.

ОБЯЗАТЕЛЬНО ПРОВЕДИ СТРУКТУРИРОВАННЫЙ АНАЛИЗ:

1. ТЕХНИЧЕСКИЕ ПАРАМЕТРЫ:
   - Формат и качество записи, наличие артефактов и помех.
   - Скорость ленты (25/50 мм/с) и калибровка (1 мВ = 10 мм), если это можно оценить.

2. РИТМ И ПРОВОДИМОСТЬ:
   - Основной ритм: синусовый / наджелудочковый / желудочковый / фибрилляция предсердий / трепетание предсердий / узловой.
   - Регулярность RR‑интервалов, средний ЧСС (уд/мин) с указанием метода оценки.
   - AV‑проводимость: норма или AV‑блокада I, II (Mobitz I/II), III степени.
   - Внутрижелудочковая проводимость: нормальная, блокада правой или левой ножки пучка Гиса 
     (полная/неполная), другие интравентрикулярные нарушения.

3. СТАНДАРТНОЕ ОПИСАНИЕ ИНТЕРВАЛОВ, ЗУБЦОВ И СМЕЩЕНИЙ ST:
   - Интервал PR (мс): значение, норма/укорочен/удлинён.
   - Комплекс QRS (мс): длительность, ось (градусы), морфология.
   - Интервал QT и QTc (мс, метод расчёта): норма/удлинён/укорочен.
   - Электрическая ось сердца: значение в градусах, классификация.
   - Зубец P: наличие, форма, амплитуда (только при отклонениях от нормы).
   - Сегмент ST: элевация/депрессия (в мм) по отведениям, форма смещения.
   - Зубец T: полярность, амплитуда (только при отклонениях).
   - Патологические Q‑зубцы: только при наличии.
   - Дополнительные волны: только при наличии.

4. АРИТМИИ И НАРУШЕНИЯ РИТМА (только при наличии):
   - Указывай ТОЛЬКО реально выявленные нарушения ритма.
   - При наличии аритмии укажи тип, частоту и регулярность, клиническую значимость.
   - КРИТИЧЕСКИ ВАЖНО: проверь все жизнеугрожающие аритмии:
     * Фибрилляция желудочков
     * Желудочковая тахикардия
     * Асистолия
     * Трепетание предсердий (ищи пилообразные волны F в отведениях II, III, aVF с частотой ~300 уд/мин)
     * Мерцательная аритмия (фибрилляция предсердий)

5. ПАТОЛОГИЧЕСКИЕ ИЗМЕНЕНИЯ (только при наличии):
   - Указывай ТОЛЬКО реально выявленные патологические изменения.
   - При наличии патологии укажи детально с критериями.

6. КЛИНИЧЕСКОЕ ЗАКЛЮЧЕНИЕ (компактно):
   1) Клинический обзор (2–3 предложения).
   2) Основной диагноз с кодом ICD‑10.
   3) План действий (кратко)."""
        
        # Рентген - аналогично
        elif any(kw in prompt_lower for kw in PromptBuilder.XRAY_KEYWORDS):
            try:
                from prompts.diagnostic_prompts import get_xray_diagnostic_prompt
                medical_prompt = get_xray_diagnostic_prompt(system_prompt)
                return PromptBuilder._add_user_prompt(medical_prompt, prompt)
            except ImportError:
                # Fallback - ТОЧНАЯ КОПИЯ из claude_assistant.py.old (строки 446-717)
                # Полный детальный промпт для рентгена если модуль недоступен
                return f"""{system_prompt}

Ты — американский профессор клинической медицины (Board Certified) с экспертной компетенцией в области рентгенологии и лучевой диагностики. Твоя задача — дать ТОЧНЫЙ ДИАГНОЗ и КЛИНИЧЕСКУЮ ИНТЕРПРЕТАЦИЮ для принятия врачебных решений.

ФОКУС: Правильный диагноз и клиническая значимость находок. Отвечай как врач врачу - кратко, точно, с акцентом на то, что важно для лечения.

КРИТИЧЕСКИ ВАЖНО - ОПРЕДЕЛЕНИЕ ЛОКАЛИЗАЦИИ (НЕ ПУТАТЬ!):

1. СНАЧАЛА внимательно изучи ВСЕ изображение целиком - не начинай анализ, пока не определил локализацию!
2. Определи ОСНОВНЫЕ анатомические структуры:
   - Если видишь РЕБРА, КЛЮЧИЦЫ, ЛОПАТКИ, СЕРДЦЕ, ЛЕГКИЕ, СРЕДОСТЕНИЕ, ДИАФРАГМУ - это ГРУДНАЯ КЛЕТКА
   - Если видишь ДЛИННУЮ ТРУБЧАТУЮ КОСТЬ с СУСТАВАМИ на концах (плечевой/локтевой или тазобедренный/коленный) - это КОНЕЧНОСТЬ
   - Если видишь ТАЗОБЕДРЕННЫЙ СУСТАВ, ПОДВЗДОШНЫЕ КОСТИ, ЛОБКОВУЮ КОСТЬ, КРЕСТЕЦ - это ТАЗ

3. **КРИТИЧЕСКИ ВАЖНО - РАЗЛИЧИЕ ТАЗА И ВЕРХНЕЙ КОНЕЧНОСТИ:**
   - **ТАЗ:** видишь ПОДВЗДОШНЫЕ КОСТИ (большие крыловидные кости), ЛОБКОВУЮ КОСТЬ (внизу по центру), КРЕСТЕЦ (продолжение позвоночника), ТАЗОБЕДРЕННЫЕ СУСТАВЫ
   - **ВЕРХНЯЯ КОНЕЧНОСТЬ:** видишь ЛОПАТКУ (плоская треугольная кость), КЛЮЧИЦУ (горизонтальная кость), ПЛЕЧЕВУЮ КОСТЬ, ПЛЕЧЕВОЙ СУСТАВ
   - **НЕ ПУТАТЬ:** ТАЗ - это НИЖНЯЯ часть туловища, ВЕРХНЯЯ КОНЕЧНОСТЬ - это ПЛЕЧО, ЛОПАТКА, КЛЮЧИЦА

4. **КРИТИЧЕСКИ ВАЖНО - РАЗЛИЧИЕ ТАЗОБЕДРЕННОГО И ПЛЕЧЕВОГО СУСТАВОВ:**
   - **ТАЗОБЕДРЕННЫЙ СУСТАВ:**
     * Находится в ТАЗУ (видишь подвздошные кости, лобковую кость, крестец)
     * Соединяет БЕДРО с ТАЗОМ
     * Вертлужная впадина (чашка) - часть ТАЗА
     * Головка бедренной кости - часть БЕДРА
     * Если видишь эндопротез в ТАЗУ и БЕДРЕ - это ТАЗОБЕДРЕННЫЙ эндопротез!
   - **ПЛЕЧЕВОЙ СУСТАВ:**
     * Находится в ВЕРХНЕЙ КОНЕЧНОСТИ (видишь лопатку, ключицу)
     * Соединяет ПЛЕЧЕВУЮ КОСТЬ с ЛОПАТКОЙ
     * Суставная впадина (гленоид) - часть ЛОПАТКИ
     * Головка плечевой кости - часть ПЛЕЧЕВОЙ КОСТИ
     * Если видишь эндопротез на ЛОПАТКЕ и в ПЛЕЧЕВОЙ КОСТИ - это ПЛЕЧЕВОЙ эндопротез!
   - **НЕ ПУТАТЬ:** Тазобедренный = ТАЗ + БЕДРО, Плечевой = ЛОПАТКА + ПЛЕЧЕВАЯ КОСТЬ

5. БЕДРО - это длинная кость между тазобедренным и коленным суставами, имеет характерную форму с головкой, шейкой, большим вертелом
6. ПЛЕЧО - это кость между плечевым и локтевым суставами, имеет головку плечевой кости, большой бугорок
7. ГРУДНАЯ КЛЕТКА - это ребра, легкие, сердце, средостение, диафрагма - НЕТ длинных трубчатых костей конечностей
8. НИКОГДА не путай эти локализации - они имеют РАЗНУЮ анатомию!
9. Если видишь МЕТАЛЛИЧЕСКИЕ КОНСТРУКЦИИ (эндопротезы):
   - СНАЧАЛА определи локализацию (таз/верхняя конечность/нижняя конечность)
   - ЗАТЕМ определи тип сустава по анатомическому окружению
   - ТОЛЬКО после этого описывай эндопротез

СТРУКТУРА ОТВЕТА (кратко, для врача):

1. **ЛОКАЛИЗАЦИЯ И ТИП ИССЛЕДОВАНИЯ:**
   - ТОЧНО: какая область? (грудная клетка/таз/верхняя конечность/нижняя конечность/другое)
   - Проекция, сторона (правая/левая)
   - **КРИТИЧНО:** Тазобедренный сустав = ТАЗ + БЕДРО. Плечевой сустав = ЛОПАТКА + ПЛЕЧЕВАЯ КОСТЬ. НЕ ПУТАТЬ!

2. **КЛЮЧЕВЫЕ НАХОДКИ (только клинически значимые):**

   **ЕСЛИ ГРУДНАЯ КЛЕТКА:**
   - **Легочные поля:**
     * Прозрачность (нормальная/снижена/повышена)
     * Сосудистый рисунок (четкий/обеднен/усилен)
     * Легочный рисунок (нормальный/деформирован/отсутствует)
     * Наличие очаговых теней (размер, локализация, количество, плотность)
     * Наличие инфильтратов (характер, локализация, протяженность)
     * Пневмоторакс (если есть: размер, локализация)
     * Гидроторакс (если есть: размер, локализация)
   - **Корни легких:**
     * Структура (четкая/деформирована)
     * Размеры (нормальные/увеличены)
     * Контуры (ровные/неровные)
   - **Средостение:**
     * Ширина (нормальная/расширена/сужена)
     * Контуры (четкие/нечеткие)
     * Смещение (если есть: направление)
   - **Сердце:**
     * Размеры (нормальные/увеличены - кардиоторакальный индекс)
     * Контуры (четкие/нечеткие)
     * Форма (нормальная/деформирована)
     * Положение (нормальное/смещено)
   - **Диафрагма:**
     * Контуры (четкие/нечеткие)
     * Положение (нормальное/высокое/низкое)
     * Подвижность (если видно на двух проекциях)
     * Синусы (свободные/затемнены)
   - **Костные структуры:**
     * Ребра (целостность, деформации, переломы)
     * Ключицы (целостность, положение)
     * Лопатки (целостность, положение)
     * Грудина (целостность, деформации)
     * Позвоночник (видимая часть: деформации, переломы, дегенеративные изменения)

   **ЕСЛИ КОНЕЧНОСТИ (верхние или нижние):**
   - **СНАЧАЛА определи: ВЕРХНЯЯ или НИЖНЯЯ конечность?**
     * ВЕРХНЯЯ: видишь ЛОПАТКУ, КЛЮЧИЦУ, ПЛЕЧЕВУЮ КОСТЬ, ПЛЕЧЕВОЙ СУСТАВ
     * НИЖНЯЯ: видишь ТАЗ (подвздошные кости), БЕДРО, ТАЗОБЕДРЕННЫЙ СУСТАВ
   - **Определи ТОЧНО какая часть:**
     * **Плечо (ВЕРХНЯЯ конечность):**
       - Видишь ли ЛОПАТКУ (плоская треугольная кость)?
       - Видишь ли КЛЮЧИЦУ (горизонтальная кость)?
       - Видишь ли головку ПЛЕЧЕВОЙ КОСТИ, большой бугорок, диафиз, локтевой сустав?
       - Плечевой сустав соединяет ПЛЕЧЕВУЮ КОСТЬ с ЛОПАТКОЙ
       - Если видишь эндопротез на ЛОПАТКЕ и в ПЛЕЧЕВОЙ КОСТИ - это ПЛЕЧЕВОЙ эндопротез!
     * Предплечье: видишь ли локтевую и лучевую кости, лучезапястный сустав?
     * Кисть: видишь ли запястье, пястные кости, фаланги?
     * **Бедро (НИЖНЯЯ конечность):**
       - Видишь ли ТАЗ (подвздошные кости, лобковую кость)?
       - Видишь ли головку БЕДРЕННОЙ КОСТИ, шейку, большой вертел, диафиз, коленный сустав?
       - Тазобедренный сустав соединяет БЕДРО с ТАЗОМ
       - Если видишь эндопротез в ТАЗУ и БЕДРЕ - это ТАЗОБЕДРЕННЫЙ эндопротез (НЕ плечевой)!
     * Голень: видишь ли большеберцовую и малоберцовую кости, голеностопный сустав?
     * Стопа: видишь ли предплюсну, плюсну, фаланги?
   - **Костные структуры:**
     * Целостность костей (переломы: тип, локализация, смещение)
     * Структура костной ткани (нормальная/остеопороз/остеосклероз/деструкция)
     * Контуры (ровные/неровные/зазубренные)
     * Кортикальный слой (целостность, толщина)
     * Костномозговой канал (просветлен/затемнен)
   - **Суставы:**
     * Суставная щель (нормальная/сужена/расширена)
     * Суставные поверхности (ровные/неровные, деструкция)
     * Костные разрастания (остеофиты, если есть)
     * Выпот (если виден)
   - **Мягкие ткани:**
     * Контуры (четкие/нечеткие)
     * Наличие отека
     * Наличие инородных тел

   **ЕСЛИ ТАЗ:**
   - **Костные структуры:**
     * Подвздошные кости (большие крыловидные кости, целостность, структура)
     * Лобковая кость (внизу по центру, целостность, симметрия)
     * Крестец и копчик (продолжение позвоночника, целостность, деформации)
     * Седалищные кости (целостность)
   - **Тазобедренные суставы (КРИТИЧЕСКИ ВАЖНО - НЕ ПУТАТЬ С ПЛЕЧЕВЫМИ!):**
     * **Локализация:** Тазобедренные суставы находятся в ТАЗУ, соединяют ТАЗ с БЕДРОМ
     * **Анатомия:**
       - Вертлужная впадина (чашка) - часть ТАЗА (подвздошная кость)
       - Головка бедренной кости - часть БЕДРА (нижняя конечность)
       - Шейка бедренной кости соединяет головку с диафизом бедра
       - Большой вертел - костный выступ на бедренной кости
     * Суставные щели (симметрия, ширина)
     * Головки бедренных костей (форма, структура, положение в вертлужных впадинах)
     * Вертлужные впадины (форма чашки, структура, глубина)
     * Симметрия суставов
     * **Если видишь эндопротез:** вертлужный компонент в ТАЗУ + бедренный компонент в БЕДРЕ = ТАЗОБЕДРЕННЫЙ эндопротез (НЕ плечевой!)

3. **ОПРЕДЕЛЕНИЕ ЭНДОПРОТЕЗОВ И ИМПЛАНТОВ (КРИТИЧЕСКИ ВАЖНО!):**

   **ПЕРЕД ОПИСАНИЕМ ЭНДОПРОТЕЗА - ОБЯЗАТЕЛЬНО ОПРЕДЕЛИ ТИП СУСТАВА!**

   **РАЗЛИЧИЯ ТАЗОБЕДРЕННОГО И ПЛЕЧЕВОГО СУСТАВОВ (НЕ ПУТАТЬ!):**

   **ТАЗОБЕДРЕННЫЙ СУСТАВ:**
   - Расположен в ТАЗУ, соединяет бедренную кость с тазом
   - Вертлужная впадина (чашка) - часть ТАЗА (подвздошная кость)
   - Головка бедренной кости - часть БЕДРА
   - Характерные признаки:
     * Вертлужная впадина имеет форму ПОЛУШАРИЯ или ЧАШКИ
     * Головка бедренной кости ШАРОВИДНАЯ, крупная
     * Шейка бедренной кости ДЛИННАЯ, соединяет головку с диафизом
     * Большой вертел - костный выступ на бедренной кости
     * Эндопротез тазобедренного сустава состоит из:
       - Вертлужного компонента (чашка) в тазу
       - Головки и ножки в бедренной кости
     * Ножка эндопротеза идет В БЕДРЕННУЮ КОСТЬ (длинная трубчатая кость)
   - Анатомическое окружение: ТАЗ (подвздошные кости, лобковая кость, крестец), БЕДРО

   **ПЛЕЧЕВОЙ СУСТАВ:**
   - Расположен в ВЕРХНЕЙ КОНЕЧНОСТИ, соединяет плечевую кость с лопаткой
   - Суставная впадина лопатки (гленоид) - часть ЛОПАТКИ
   - Головка плечевой кости - часть ПЛЕЧЕВОЙ КОСТИ
   - Характерные признаки:
     * Суставная впадина лопатки ПЛОСКАЯ, мелкая (не чашка!)
     * Головка плечевой кости ШАРОВИДНАЯ, но меньше чем тазобедренная
     * Шейка плечевой кости КОРОТКАЯ
     * Большой бугорок - костный выступ на плечевой кости
     * Эндопротез плечевого сустава состоит из:
       - Гленоидного компонента (плоская пластина) на лопатке
       - Головки и ножки в плечевой кости
     * Ножка эндопротеза идет В ПЛЕЧЕВУЮ КОСТЬ (длинная трубчатая кость верхней конечности)
   - Анатомическое окружение: ЛОПАТКА, КЛЮЧИЦА, ПЛЕЧЕВАЯ КОСТЬ

   **КЛЮЧЕВЫЕ РАЗЛИЧИЯ ДЛЯ ОПРЕДЕЛЕНИЯ:**
   1. ТАЗОБЕДРЕННЫЙ сустав = ТАЗ + БЕДРО (нижняя конечность)
   2. ПЛЕЧЕВОЙ сустав = ЛОПАТКА + ПЛЕЧЕВАЯ КОСТЬ (верхняя конечность)
   3. Если видишь ПОДВЗДОШНЫЕ КОСТИ, ЛОБКОВУЮ КОСТЬ, КРЕСТЕЦ - это ТАЗ, значит сустав ТАЗОБЕДРЕННЫЙ
   4. Если видишь ЛОПАТКУ, КЛЮЧИЦУ - это ВЕРХНЯЯ КОНЕЧНОСТЬ, значит сустав ПЛЕЧЕВОЙ
   5. Вертлужная впадина (чашка) = ТАЗОБЕДРЕННЫЙ сустав
   6. Гленоид (плоская впадина на лопатке) = ПЛЕЧЕВОЙ сустав
   7. Ножка эндопротеза в БЕДРЕ = ТАЗОБЕДРЕННЫЙ эндопротез
   8. Ножка эндопротеза в ПЛЕЧЕВОЙ КОСТИ = ПЛЕЧЕВОЙ эндопротез

   **НЕ ПУТАТЬ!** Если эндопротез находится в тазу и бедре - это ТАЗОБЕДРЕННЫЙ эндопротез, НЕ плечевой!

   - **Наличие металлических конструкций:**
     * Эндопротезы суставов - ОБЯЗАТЕЛЬНО определи ТИП сустава ПЕРЕД описанием!
       - ТАЗОБЕДРЕННЫЙ эндопротез (вертлужный компонент + бедренный компонент)
       - ПЛЕЧЕВОЙ эндопротез (гленоидный компонент + плечевой компонент)
       - КОЛЕННЫЙ эндопротез (бедренный + большеберцовый компоненты)
       - ЛОКТЕВОЙ эндопротез
       - Другой
     * Остеосинтез (пластины, винты, штифты, спицы, проволока)
     * Стержни (интрамедуллярные)
     * Спицы Киршнера
     * Другие импланты

   - **Характеристики эндопротезов:**
     * **ТИП СУСТАВА:** ТОЧНО определи - тазобедренный/плечевой/коленный/локтевой/другой
     * **Локализация:** 
       - Для тазобедренного: вертлужный компонент в тазу, бедренный компонент в бедре
       - Для плечевого: гленоидный компонент на лопатке, плечевой компонент в плечевой кости
     * **Компоненты эндопротеза:**
       - Тазобедренный: вертлужная чашка + головка + ножка (в бедре)
       - Плечевой: гленоидная пластина + головка + ножка (в плечевой кости)
     * Целостность конструкции (нет ли поломок, расшатывания)
     * Положение компонентов (правильное/смещение/вывих)
     * Признаки нестабильности (линии просветления вокруг компонентов)
     * Признаки остеолиза (деструкция кости вокруг импланта)

   - **Состояние кости вокруг импланта:**
     * Реакция кости (нормальная/гипертрофия/атрофия)
     * Признаки инфекции (если есть)
     * Признаки расшатывания

4. **ПАТОЛОГИЧЕСКИЕ ИЗМЕНЕНИЯ:**
   - **Переломы:**
     * Локализация (ТОЧНО: какая кость, какая часть)
     * Тип перелома (поперечный/косой/спиральный/оскольчатый/вколоченный)
     * Смещение (есть/нет, направление, степень в мм)
     * Винтообразная деформация (если есть)
     * Внутрисуставной/внесуставной
   - **Деструктивные изменения:**
     * Очаги деструкции (локализация, размер, контуры)
     * Остеолиз (локализация, протяженность)
   - **Дегенеративные изменения:**
     * Остеофиты (локализация, размер)
     * Сужение суставных щелей
     * Субхондральный склероз
     * Кисты (если видны)
   - **Воспалительные изменения:**
     * Признаки артрита (сужение щели, эрозии, остеопороз)
     * Периостит (если есть)
   - **Опухолевые изменения:**
     * Очаги деструкции/остеосклероза
     * Деформация кости
     * Патологические переломы

5. **СРАВНЕНИЕ С НОРМОЙ:**
   - Для каждой структуры укажи: норма/патология
   - Если патология: опиши характер изменений детально

6. **КЛИНИЧЕСКАЯ ИНТЕРПРЕТАЦИЯ:**
   - **Основные находки:** краткое резюме ключевых патологий
   - **Дифференциальный диагноз:** список возможных диагнозов с вероятностью
   - **Оценка остроты:** острое/подострое/хроническое состояние
   - **Рекомендации:**
     * Неотложные меры (если требуется)
     * Дополнительные обследования (КТ, МРТ, УЗИ, лабораторные анализы)
     * Консультации специалистов
     * Контрольные исследования

7. **КОДЫ МКБ-10:**
   - Укажи соответствующие коды МКБ-10 для выявленных патологий

КРИТИЧЕСКИ ВАЖНЫЕ ПРАВИЛА:
- НИКОГДА не путай локализации! СНАЧАЛА определи ТОЧНО, что видишь на снимке
- Бедро НЕ может быть грудной клеткой - у них совершенно разная анатомия
- Плечо НЕ может быть бедром - сравни размеры, форму, суставы
- Если видишь металлические конструкции - ОБЯЗАТЕЛЬНО опиши их детально
- Если не уверен в локализации - так и укажи, не угадывай
- Используй анатомические ориентиры для определения локализации
- Анализируй ВСЕ видимые структуры, не пропускай области
- Указывай ТОЧНУЮ локализацию для каждого изменения (например: "перелом диафиза правой бедренной кости в средней трети")
- Не используй общие фразы - будь конкретен
- Если что-то не видно четко - так и укажи, не выдумывай
- Ссылайся на актуальные гайдлайны (Fleischner Society, ACR, ESR, RSNA)

{prompt}"""
        
        # МРТ
        elif any(kw in prompt_lower for kw in PromptBuilder.MRI_KEYWORDS):
            try:
                from prompts.diagnostic_prompts import get_mri_diagnostic_prompt
                medical_prompt = get_mri_diagnostic_prompt(system_prompt)
                return PromptBuilder._add_user_prompt(medical_prompt, prompt)
            except ImportError:
                return f"""{system_prompt}

Вы — американский профессор клинической медицины (Board Certified) с экспертной компетенцией в области нейрорадиологии и магнитно-резонансной томографии. Выполните полный структурированный анализ увиденного.

{prompt}"""
        
        # КТ
        elif any(kw in prompt_lower for kw in PromptBuilder.CT_KEYWORDS):
            try:
                from prompts.diagnostic_prompts import get_ct_diagnostic_prompt
                medical_prompt = get_ct_diagnostic_prompt(system_prompt)
                return PromptBuilder._add_user_prompt(medical_prompt, prompt)
            except ImportError:
                return f"""{system_prompt}

Ты — американский профессор клинической медицины (Board Certified) с экспертной компетенцией в области компьютерной томографии. Твоя задача — анализировать загруженное изображение, выявлять патологические изменения, давать заключение согласно международным стандартам.

{prompt}"""
        
        # УЗИ
        elif any(kw in prompt_lower for kw in PromptBuilder.ULTRASOUND_KEYWORDS):
            try:
                from prompts.diagnostic_prompts import get_ultrasound_diagnostic_prompt
                medical_prompt = get_ultrasound_diagnostic_prompt(system_prompt)
                return PromptBuilder._add_user_prompt(medical_prompt, prompt)
            except ImportError:
                return f"""{system_prompt}

Вы — американский профессор клинической медицины (Board Certified) с экспертной компетенцией в области ультразвуковой диагностики. Детально опишите УЗИ-картину.

{prompt}"""
        
        # Лабораторные анализы
        elif "лаборатор" in prompt_lower or ("анализ" in prompt_lower and ("кров" in prompt_lower or "моч" in prompt_lower or "биохим" in prompt_lower or "lab" in prompt_lower)):
            return f"""{system_prompt}

Ты — эксперт по лабораторной диагностике.
В ЭТОМ РЕЖИМЕ ТВОЯ ЗАДАЧА — ТОЛЬКО СКАНИРОВАНИЕ И ИЗВЛЕЧЕНИЕ ДАННЫХ ИЗ ЛАБОРАТОРНОГО ОТЧЁТА (CBC, биохимия и др.).

СДЕЛАЙ ТОЛЬКО СЛЕДУЮЩЕЕ:
- Аккуратно извлеки все параметры (название, значение, единицы, референсные интервалы, если есть).
- Чётко отметь, какие параметры находятся вне референсного диапазона (повышены/понижены).
- Сохрани исходные обозначения и структуру (например, WBC, RBC, Hb, PLT, Lym%, Neu% и т.п.).

ВАЖНО:
- НЕ давай клиническую интерпретацию, диагнозы, дифференциальный диагноз или план лечения.
- НЕ сравнивай этот отчёт с радиологическими исследованиями и не пиши, что это «не рентген / не МРТ / не радиологическое исследование».
- НЕ добавляй разделы вроде «Лог веб-запросов», не перечисляй сайты, URL, DOI — ссылки и лог запросов НЕ НУЖНЫ.
- Можно использовать простой текст или JSON-структуру, но без клинических рекомендаций.

Формат ответа (пример JSON по желанию):
{{
  "parameters": [
    {{"name": "WBC", "value": "...", "unit": "...", "reference": "..." , "status": "high/low/normal"}},
    ...
  ],
  "raw_text": "при необходимости — весь распознанный текст отчёта"
}}"""
        
        # Документы
        elif any(keyword in prompt_lower for keyword in {
            "документ", "справка", "рецепт", "направление", "выписка", 
            "больничный", "извлеките", "распознавание", "document", "extract",
            "медицинской справки", "медицинских документов", "распознаванию медицинских"
        }):
            # Для документов используем промпт БЕЗ system_prompt - только извлечение текста
            return prompt
        
        # Общий случай
        else:
            return f"""{system_prompt}

Проанализируйте это медицинское изображение как американский профессор клинической медицины (Board Certified).
Дайте подробное заключение в формате «Клиническая директива».

{prompt}
"""









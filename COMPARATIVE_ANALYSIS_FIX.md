# Исправление сравнительного анализа множественных изображений

## Проблема
Система не видела второе и последующие изображения при сравнительном анализе, так как отправлялось только первое изображение, а остальные передавались только в текстовом описании промпта.

## Решение

### 1. Добавлена поддержка множественных изображений в `lib/openrouter.ts`

Создана новая функция `analyzeMultipleImages()`:
- Принимает массив base64 изображений
- Формирует `content` массив с текстом и всеми изображениями
- Использует Claude API для анализа всех изображений одновременно
- Увеличен таймаут до 180 секунд для обработки множественных изображений
- Увеличен `max_tokens` до 6000 для детального сравнительного анализа

### 2. Добавлена streaming версия в `lib/openrouter-streaming.ts`

Создана функция `analyzeMultipleImagesStreaming()`:
- Поддержка потоковой передачи для множественных изображений
- Постепенное отображение результатов анализа
- Оптимизация пользовательского опыта

### 3. Обновлен API endpoint в `app/api/analyze/image/route.ts`

Добавлена поддержка сравнительного режима:
- Определение наличия дополнительных изображений (`additionalImage_0`, `additionalImage_1`, и т.д.)
- Конвертация всех изображений в base64
- Передача всех изображений в модель для анализа
- Логирование количества обрабатываемых изображений
- Поддержка как streaming, так и обычного режима

### 4. Исправлен фронтенд в `app/comparative/page.tsx`

Изменения в отправке данных:
- Первое изображение передается как `file`
- Остальные изображения передаются как `additionalImage_0`, `additionalImage_1`, и т.д.
- Изменен режим с `precise` на `comparative`
- Все изображения теперь фактически отправляются на сервер

## Технические детали

### Формат Claude API для множественных изображений

```typescript
const messages = [
  {
    role: 'user',
    content: [
      { type: 'text', text: 'Промпт' },
      { type: 'image_url', image_url: { url: 'data:image/png;base64,...' } },
      { type: 'image_url', image_url: { url: 'data:image/png;base64,...' } },
      // ... дополнительные изображения
    ]
  }
]
```

### Ограничения
- Claude API поддерживает до 20 изображений в одном запросе
- Рекомендуется использовать 2-4 изображения для оптимальной производительности
- Время анализа увеличивается пропорционально количеству изображений

## Использование

1. Откройте страницу **"Сравнительный анализ"**
2. Загрузите 2 или более изображений
3. Выберите режим сравнения (временной, по локализации, общий)
4. Добавьте описания и даты/локализации при необходимости
5. Выберите модель (Opus 4.5 или Sonnet 4.5)
6. Нажмите "Запустить сравнительный анализ"

Система теперь **видит и анализирует все загруженные изображения одновременно**, а не только первое!

## Преимущества нового подхода

✅ **Точность**: Модель видит все изображения одновременно  
✅ **Контекст**: Может напрямую сравнивать визуальные детали  
✅ **Качество**: Не полагается только на текстовые описания  
✅ **Streaming**: Постепенное отображение результатов  
✅ **Масштабируемость**: Поддержка любого количества изображений (до лимитов API)

## Дата обновления
27 декабря 2025





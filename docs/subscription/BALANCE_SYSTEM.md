# üí∞ –°–∏—Å—Ç–µ–º–∞ –±–∞–ª–∞–Ω—Å–∞ –∏ –ø–æ–¥–ø–∏—Å–∫–∏ ‚Äî —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –º–æ–¥–µ–ª—å

**–¶–µ–ª—å:** –§–æ—Ä–º–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≥–æ, –∫–∞–∫ —Å—á–∏—Ç–∞–µ—Ç—Å—è –∏ —Ö—Ä–∞–Ω–∏—Ç—Å—è –±–∞–ª–∞–Ω—Å, –∫–∞–∫ —Å–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –µ–¥–∏–Ω–∏—Ü—ã, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç —Ä–æ–ª–∏ –∏ —Ä–µ–∂–∏–º—ã.

---

## üìä –ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö

### SubscriptionState (dataclass)

–•—Ä–∞–Ω–∏—Ç—Å—è –≤ `st.session_state["subscription_state"]`:

```python
@dataclass
class SubscriptionState:
    balance: float = 0.0              # –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å –µ–¥–∏–Ω–∏—Ü
    total_used: float = 0.0            # –í—Å–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –∑–∞ —Å–µ—Å—Å–∏—é
    free_credits_used: float = 0.0     # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –∫—Ä–µ–¥–∏—Ç–æ–≤
    mode: str = APP_MODE               # –†–µ–∂–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (OFF/TEST/BETA/PRODUCTION)
    is_owner: bool = False             # –í–ª–∞–¥–µ–ª–µ—Ü (–∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç –ª–∏–º–∏—Ç—ã)
    is_vip: bool = False               # VIP-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–ø–æ–≤—ã—à–µ–Ω–Ω—ã–π –ª–∏–º–∏—Ç)
```

### –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (config.py)

```python
SUBSCRIPTION_ENABLED = False          # –ì–ª–æ–±–∞–ª—å–Ω—ã–π —Ñ–ª–∞–≥ –≤–∫–ª—é—á–µ–Ω–∏—è
APP_MODE = "OFF"                      # –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã
KILL_SWITCH_ENABLED = False           # –≠–∫—Å—Ç—Ä–µ–Ω–Ω–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ
OWNER_IDS = [...]                     # Email –≤–ª–∞–¥–µ–ª—å—Ü–∞
VIP_USER_IDS = [...]                  # Email –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö –≤—Ä–∞—á–µ–π
FREE_TRIAL_CREDITS = 100.0            # –°—Ç–∞—Ä—Ç–æ–≤—ã–π –±–∞–ª–∞–Ω—Å –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
BETA_MAX_FREE_USERS = 100             # –õ–∏–º–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ BETA
CREDIT_PACKAGES = {100: 200, ...}     # –ü–∞–∫–µ—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤ ‚Üí —Ü–µ–Ω–∞
```

---

## üî¢ –ü—Ä–∞–≤–∏–ª–∞ —Å–ø–∏—Å–∞–Ω–∏—è –µ–¥–∏–Ω–∏—Ü

### –°—Ç–æ–∏–º–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)

- **–û–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å** (–ò–ò-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç, —á–∞—Ç): `1.0` –µ–¥–∏–Ω–∏—Ü–∞
- **–ê–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è** (–≠–ö–ì, —Ä–µ–Ω—Ç–≥–µ–Ω, –ú–†–¢ –∏ —Ç.–¥.): `1.0` –µ–¥–∏–Ω–∏—Ü–∞
- **–ê–Ω–∞–ª–∏–∑ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö** (PDF, Excel): `1.0` –µ–¥–∏–Ω–∏—Ü–∞
- **–ê–Ω–∞–ª–∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞** (—Ä–µ—Ü–µ–ø—Ç, –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ): `1.0` –µ–¥–∏–Ω–∏—Ü–∞
- **–ì–µ–Ω–µ—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑**: `1.0` –µ–¥–∏–Ω–∏—Ü–∞
- **–í–∏–¥–µ–æ-–∞–Ω–∞–ª–∏–∑**: `2.0` –µ–¥–∏–Ω–∏—Ü—ã (—Ç—è–∂—ë–ª–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è)

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –≤ –∫–æ–¥–µ, –¥–æ–±–∞–≤–∏–≤ –ø–∞—Ä–∞–º–µ—Ç—Ä `cost` –≤ –≤—ã–∑–æ–≤—ã `deduct_balance(cost=X)`.

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Å–ø–∏—Å–∞–Ω–∏—è

1. –°–Ω–∞—á–∞–ª–∞ —Ç—Ä–∞—Ç—è—Ç—Å—è **–±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ —Ç–µ—Å—Ç–æ–≤—ã–µ** –∫—Ä–µ–¥–∏—Ç—ã (`free_credits_used`).
2. –ü–æ—Ç–æ–º ‚Äî **–ø–ª–∞—Ç–Ω—ã–µ –ø–∞–∫–µ—Ç—ã** (–æ–±—â–∏–π `balance`).
3. –ï—Å–ª–∏ `balance <= 0` ‚Üí –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏ (–∫—Ä–æ–º–µ OWNER).

---

## üë§ –†–æ–ª–∏ –∏ –¥–æ—Å—Ç—É–ø

### OWNER (–≤–ª–∞–¥–µ–ª–µ—Ü)

- **–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ:**
  - Email –∏–∑ —Å–ø–∏—Å–∫–∞ `OWNER_IDS` –≤ `config.py`, –ò–õ–ò
  - –ù–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞ `.dev_mode` –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞.
- **–ü—Ä–∞–≤–∞:**
  - –ù–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π –±–∞–ª–∞–Ω—Å (–≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π `1_000_000.0` –µ–¥–∏–Ω–∏—Ü).
  - –ò–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç –≤—Å–µ –ª–∏–º–∏—Ç—ã –∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏.
  - –ù–µ —Å–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –µ–¥–∏–Ω–∏—Ü—ã –∑–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏ (–ª–æ–≥–∏—Ä—É—é—Ç—Å—è, –Ω–æ –±–∞–ª–∞–Ω—Å –Ω–µ —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è).
  - –ò–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç `KILL_SWITCH_ENABLED`.

### VIP (–∏–∑–±—Ä–∞–Ω–Ω—ã–µ –≤—Ä–∞—á–∏)

- **–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ:** Email –∏–∑ —Å–ø–∏—Å–∫–∞ `VIP_USER_IDS` –≤ `config.py`.
- **–ü—Ä–∞–≤–∞:**
  - –°—Ç–∞—Ä—Ç–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: `10_000.0` –µ–¥–∏–Ω–∏—Ü.
  - –ü–æ–≤—ã—à–µ–Ω–Ω—ã–π –ª–∏–º–∏—Ç (–º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ).
  - –û–±—ã—á–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ —Å–ø–∏—Å–∞–Ω–∏—è.

### STANDARD_USER (–æ–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)

- **–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ:** Email –Ω–µ –≤ `OWNER_IDS` –∏ –Ω–µ –≤ `VIP_USER_IDS`.
- **–ü—Ä–∞–≤–∞:**
  - –í —Ä–µ–∂–∏–º–µ `TEST`/`BETA`: —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –±–∞–ª–∞–Ω—Å `FREE_TRIAL_CREDITS` (100.0 –µ–¥.).
  - –í —Ä–µ–∂–∏–º–µ `PRODUCTION`: —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –±–∞–ª–∞–Ω—Å `0.0` (–Ω—É–∂–Ω–æ –ø–æ–∫—É–ø–∞—Ç—å –ø–∞–∫–µ—Ç—ã).
  - –û–±—ã—á–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ —Å–ø–∏—Å–∞–Ω–∏—è.
  - –ë–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ `KILL_SWITCH_ENABLED = True`.

---

## üîÑ –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã

### –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (–ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)

```python
def init_subscription() -> SubscriptionState:
    # 1. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (OWNER / VIP / STANDARD)
    # 2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –±–∞–ª–∞–Ω—Å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–æ–ª–∏ –∏ —Ä–µ–∂–∏–º–∞
    # 3. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ st.session_state["subscription_state"]
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –æ–ø–µ—Ä–∞—Ü–∏–µ–π

```python
def can_afford_operation(cost: float = 1.0) -> bool:
    # 1. –ï—Å–ª–∏ SUBSCRIPTION_ENABLED = False ‚Üí –≤—Å–µ–≥–¥–∞ True
    # 2. –ï—Å–ª–∏ OWNER ‚Üí –≤—Å–µ–≥–¥–∞ True
    # 3. –ï—Å–ª–∏ KILL_SWITCH_ENABLED = True ‚Üí False (–∫—Ä–æ–º–µ OWNER)
    # 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: balance >= cost
```

### –°–ø–∏—Å–∞–Ω–∏–µ –ø–æ—Å–ª–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

```python
def deduct_balance(cost: float = 1.0) -> None:
    # 1. –ï—Å–ª–∏ SUBSCRIPTION_ENABLED = False ‚Üí –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
    # 2. –ï—Å–ª–∏ OWNER ‚Üí –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
    # 3. –ò–Ω–∞—á–µ: balance -= cost, total_used += cost
```

---

## üíæ –•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

### –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (–≤—Ä–µ–º–µ–Ω–Ω–∞—è)

- **–ë–∞–ª–∞–Ω—Å —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ `st.session_state`** ‚Üí **–≤—Ä–µ–º–µ–Ω–Ω—ã–π, —Ç–æ–ª—å–∫–æ –Ω–∞ —Å–µ—Å—Å–∏—é**.
- –ü—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –±–∞–ª–∞–Ω—Å —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –∫ —Å—Ç–∞—Ä—Ç–æ–≤–æ–º—É –∑–Ω–∞—á–µ–Ω–∏—é.

### –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ (–±—É–¥—É—â–µ–µ)

–ù—É–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ **—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î**:

```python
# –¢–∞–±–ª–∏—Ü–∞ subscription_balances
CREATE TABLE subscription_balances (
    user_email TEXT PRIMARY KEY,
    balance REAL DEFAULT 0.0,
    total_used REAL DEFAULT 0.0,
    free_credits_used REAL DEFAULT 0.0,
    is_owner BOOLEAN DEFAULT FALSE,
    is_vip BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

–¢–æ–≥–¥–∞ –±–∞–ª–∞–Ω—Å –±—É–¥–µ—Ç **–ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–º** –º–µ–∂–¥—É —Å–µ—Å—Å–∏—è–º–∏.

---

## üéØ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∞–Ω–∞–ª–∏–∑–∞

### –ü—Ä–∏–º–µ—Ä (—Å—Ç—Ä–∞–Ω–∏—Ü–∞ –≠–ö–ì)

```python
from utils.subscription_manager import can_afford_operation, deduct_balance, get_balance

if st.button("‚ö° –ë—ã—Å—Ç—Ä—ã–π –∞–Ω–∞–ª–∏–∑"):
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞
    if not can_afford_operation(cost=1.0):
        st.error("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ. –ü–æ–ø–æ–ª–Ω–∏—Ç–µ —Å—á–µ—Ç.")
        st.stop()
    
    # –í—ã–ø–æ–ª–Ω—è–µ–º –∞–Ω–∞–ª–∏–∑
    result = perform_ecg_analysis()
    
    # –°–ø–∏—Å—ã–≤–∞–µ–º —Å—Ä–µ–¥—Å—Ç–≤–∞ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–ø–µ—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞)
    if result:
        deduct_balance(cost=1.0)
        st.info(f"üí∞ –°–ø–∏—Å–∞–Ω–æ: 1 –µ–¥. –û—Å—Ç–∞—Ç–æ–∫: {get_balance():.1f} –µ–¥.")
```

### –°—Ç—Ä–∞–Ω–∏—Ü—ã, –≥–¥–µ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É

- `page_modules/ecg_page.py`
- `page_modules/xray_page.py`
- `page_modules/mri_page.py`
- `page_modules/ct_page.py`
- `page_modules/ultrasound_page.py`
- `page_modules/dermatoscopy_page.py`
- `page_modules/lab_page.py`
- `page_modules/video_page.py`
- `page_modules/document_page.py`
- `page_modules/genetic_page.py`
- `page_modules/universal_image_analysis_page.py`
- `page_modules/ai_chat_page.py`

---

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –æ–ø–µ—Ä–∞—Ü–∏–π

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏:

1. –í –∫–æ–¥–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –Ω–∞–π—Ç–∏ –≤—ã–∑–æ–≤ `deduct_balance()`.
2. –ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä `cost`:

```python
# –î–ª—è –≤–∏–¥–µ–æ-–∞–Ω–∞–ª–∏–∑–∞ (—Ç—è–∂—ë–ª–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è)
deduct_balance(cost=2.0)

# –î–ª—è –æ–±—ã—á–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
deduct_balance(cost=1.0)
```

---

## üìù –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ `total_used` –∏ `free_credits_used` –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.

–í –±—É–¥—É—â–µ–º –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:
- –î–µ—Ç–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏ –≤ –ë–î (–∫–∞–∫–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è, –∫–æ–≥–¥–∞, —Å–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏–ª–∞).
- –û—Ç—á—ë—Ç—ã –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞.

---

**–ì–æ—Ç–æ–≤–æ!** –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –º–æ–¥–µ–ª—å –æ–ø–∏—Å–∞–Ω–∞. üìö


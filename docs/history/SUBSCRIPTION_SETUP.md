# üíé –°–∏—Å—Ç–µ–º–∞ –±–∞–ª–∞–Ω—Å–∞ –∏ –ø–æ–¥–ø–∏—Å–∫–∏ - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏

## üìã –ß—Ç–æ —Å–æ–∑–¥–∞–Ω–æ

–°–æ–∑–¥–∞–Ω–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–æ–º –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ –≤ –µ–¥–∏–Ω–∏—Ü–∞—Ö:

### –§–∞–π–ª—ã:
- ‚úÖ `lib/subscription-manager.ts` - —è–¥—Ä–æ —Å–∏—Å—Ç–µ–º—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–æ–º
- ‚úÖ `app/subscription/page.tsx` - —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –≤—ã–±–æ—Ä–∞ –ø–∞–∫–µ—Ç–æ–≤
- ‚úÖ `app/balance/page.tsx` - —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –±–∞–ª–∞–Ω—Å–∞ –∏ –∏—Å—Ç–æ—Ä–∏–∏ –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ `components/BalanceWidget.tsx` - –≤–∏–¥–∂–µ—Ç –±–∞–ª–∞–Ω—Å–∞ (–≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É)
- ‚úÖ `.env.local.example` - –ø—Ä–∏–º–µ—Ä –Ω–∞—Å—Ç—Ä–æ–µ–∫

### –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
- üîí **–ë–µ–∑–æ–ø–∞—Å–Ω–æ**: –ü–æ–ª–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏—è, –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥
- üõ°Ô∏è **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**: Try-catch –≤–µ–∑–¥–µ, –Ω–µ –ª–æ–º–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
- üíæ **localStorage**: –î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
- üîÑ **–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ**: –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞

---

## üöÄ –ö–∞–∫ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—É

### –®–∞–≥ 1: –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env.local`

–°–∫–æ–ø–∏—Ä—É–π—Ç–µ `.env.local.example` –≤ `.env.local` –∏ –∏–∑–º–µ–Ω–∏—Ç–µ:

```bash
# –í–∫–ª—é—á–∞–µ–º —Å–∏—Å—Ç–µ–º—É –ø–æ–¥–ø–∏—Å–∫–∏
NEXT_PUBLIC_SUBSCRIPTION_ENABLED=true

# –ö—É—Ä—Å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ (1 USD = 100 –µ–¥–∏–Ω–∏—Ü)
NEXT_PUBLIC_USD_TO_CREDITS=100
```

### –®–∞–≥ 2: –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä

```bash
npm run dev
```

### –®–∞–≥ 3: –û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã

- **–í—ã–±–æ—Ä –ø–∞–∫–µ—Ç–∞**: http://localhost:3000/subscription
- **–ë–∞–ª–∞–Ω—Å –∏ –∏—Å—Ç–æ—Ä–∏—è**: http://localhost:3000/balance

---

## üíé –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞–∫–µ—Ç–æ–≤

–í —Ñ–∞–π–ª–µ `lib/subscription-manager.ts` –∏–∑–º–µ–Ω–∏—Ç–µ –ø–∞–∫–µ—Ç—ã:

```typescript
export const SUBSCRIPTION_PACKAGES = {
  starter: { 
    name: '–°—Ç–∞—Ä—Ç–æ–≤—ã–π', 
    credits: 100,      // –µ–¥–∏–Ω–∏—Ü –≤ –ø–∞–∫–µ—Ç–µ
    priceRub: 500,     // —Ü–µ–Ω–∞ –≤ —Ä—É–±–ª—è—Ö
    bonusPercent: 0    // –±–µ–∑ –±–æ–Ω—É—Å–∞
  },
  basic: { 
    name: '–ë–∞–∑–æ–≤—ã–π', 
    credits: 500,      // –µ–¥–∏–Ω–∏—Ü
    priceRub: 1000,    // —Ä—É–±–ª–µ–π (1 –µ–¥. = 2 ‚ÇΩ)
    bonusPercent: 10   // +10% –±–æ–Ω—É—Å = 550 –µ–¥–∏–Ω–∏—Ü
  },
  // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–∞–∫–µ—Ç—ã
}
```

---

## üß™ –ö–∞–∫ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

### 1. –ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø–∞–∫–µ—Ç–∞

```javascript
// –í –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ (F12)
import { initializeBalance } from '@/lib/subscription-manager'

// –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–∞–∫–µ—Ç "–ë–∞–∑–æ–≤—ã–π"
initializeBalance('basic')
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞

```javascript
import { getBalance } from '@/lib/subscription-manager'

const balance = getBalance()
console.log('–ë–∞–ª–∞–Ω—Å:', balance)
```

### 3. –¢–µ—Å—Ç–æ–≤–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ

```javascript
import { deductBalance } from '@/lib/subscription-manager'

const result = deductBalance({
  section: 'ecg',
  sectionName: '–≠–ö–ì',
  model: 'anthropic/claude-opus-4.5',
  inputTokens: 1000,
  outputTokens: 2500,
  operation: '–¢–µ—Å—Ç–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑ –≠–ö–ì'
})

console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç:', result)
```

### 4. –û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö (–¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞)

```javascript
import { clearBalance } from '@/lib/subscription-manager'

clearBalance()
```

---

## üîó –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∞–Ω–∞–ª–∏–∑–∞

–ß—Ç–æ–±—ã —Å–ø–∏—Å—ã–≤–∞—Ç—å –±–∞–ª–∞–Ω—Å –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ, –¥–æ–±–∞–≤—å—Ç–µ –≤ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, `app/ecg/page.tsx`):

```typescript
import { deductBalance } from '@/lib/subscription-manager'

// –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
const handleAnalysisComplete = (result: string, model: string) => {
  // –û—Å–Ω–æ–≤–Ω–∞—è —Ä–∞–±–æ—Ç–∞
  setResult(result)
  
  // –°–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ä–∞–±–æ—Ç—É)
  try {
    const outputTokens = Math.ceil(result.length / 1.3)
    const inputTokens = Math.ceil((prompt.length + 500) / 1.3)
    
    const deductResult = deductBalance({
      section: 'ecg',
      sectionName: '–≠–ö–ì',
      model: model,
      inputTokens: inputTokens,
      outputTokens: outputTokens,
      operation: '–ê–Ω–∞–ª–∏–∑ –≠–ö–ì'
    })
    
    if (!deductResult.success && deductResult.message) {
      // –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ, –Ω–æ –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
      alert(`‚ö†Ô∏è ${deductResult.message}`)
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —Å–ø–∏—Å–∞–Ω–∏—è:', error)
    // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
  }
}
```

---

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫—É—Ä—Å–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏

–í `.env.local` –∏–∑–º–µ–Ω–∏—Ç–µ –∫—É—Ä—Å:

```bash
# –ü—Ä–∏–º–µ—Ä—ã:
NEXT_PUBLIC_USD_TO_CREDITS=100  # 1 USD = 100 –µ–¥–∏–Ω–∏—Ü (–¥–æ—Ä–æ–≥–æ)
NEXT_PUBLIC_USD_TO_CREDITS=50   # 1 USD = 50 –µ–¥–∏–Ω–∏—Ü (–¥–µ—à–µ–≤–ª–µ)
NEXT_PUBLIC_USD_TO_CREDITS=200  # 1 USD = 200 –µ–¥–∏–Ω–∏—Ü (–¥–æ—Ä–æ–∂–µ)
```

**–ü—Ä–∏–º–µ—Ä —Ä–∞—Å—á–µ—Ç–∞:**
- Opus 4.5 –∞–Ω–∞–ª–∏–∑ –≠–ö–ì —Å—Ç–æ–∏—Ç ~$0.20 USD
- –ü—Ä–∏ –∫—É—Ä—Å–µ 100: —ç—Ç–æ –±—É–¥–µ—Ç —Å—Ç–æ–∏—Ç—å 20 –µ–¥–∏–Ω–∏—Ü
- –ü—Ä–∏ –∫—É—Ä—Å–µ 50: —ç—Ç–æ –±—É–¥–µ—Ç —Å—Ç–æ–∏—Ç—å 10 –µ–¥–∏–Ω–∏—Ü
- –ü—Ä–∏ –∫—É—Ä—Å–µ 200: —ç—Ç–æ –±—É–¥–µ—Ç —Å—Ç–æ–∏—Ç—å 40 –µ–¥–∏–Ω–∏—Ü

---

## üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### ‚úÖ –ß—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ:
- –°–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–∞
- –ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö –Ω–µ –ª–æ–º–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
- –ï—Å–ª–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∞ - –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —Ä–∞–±–æ—Ç—É
- –í—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ localStorage (–Ω–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)

### ‚ö†Ô∏è –ß—Ç–æ –ù–ï –¥–µ–ª–∞–µ—Ç —Å–∏—Å—Ç–µ–º–∞:
- ‚ùå –ù–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–∏ –Ω—É–ª–µ–≤–æ–º –±–∞–ª–∞–Ω—Å–µ
- ‚ùå –ù–µ –∏–∑–º–µ–Ω—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥
- ‚ùå –ù–µ —Ç—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ API
- ‚ùå –ù–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —Ä–∞–±–æ—Ç—É –ø—Ä–∏ –≤—ã–∫–ª—é—á–µ–Ω–∏–∏

### üîí –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
1. –¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ —Å–Ω–∞—á–∞–ª–∞ —Å `SUBSCRIPTION_ENABLED=false`
2. –ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –¥–ª—è –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Ä–∞–∑–¥–µ–ª–æ–≤
3. –î–æ–±–∞–≤—å—Ç–µ —Å–∏—Å—Ç–µ–º—É –æ–ø–ª–∞—Ç—ã —á–µ—Ä–µ–∑ –ø–ª–∞—Ç–µ–∂–Ω—ã–π —à–ª—é–∑
4. –•—Ä–∞–Ω–∏—Ç–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö (–¥–ª—è production)

---

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –≤ localStorage

### `userSubscriptionBalance`:
```json
{
  "initialCredits": 550,
  "currentCredits": 530,
  "totalSpent": 20,
  "packageName": "–ë–∞–∑–æ–≤—ã–π",
  "packagePriceRub": 1000,
  "purchaseDate": "2025-12-27T10:00:00.000Z",
  "expiryDate": null
}
```

### `userTransactions`:
```json
[
  {
    "id": "txn_1735300800000_abc123",
    "date": "2025-12-27T10:05:00.000Z",
    "section": "ecg",
    "sectionName": "–≠–ö–ì",
    "model": "anthropic/claude-opus-4.5",
    "inputTokens": 1000,
    "outputTokens": 2500,
    "costUsd": 0.20,
    "costCredits": 20,
    "operation": "–ê–Ω–∞–ª–∏–∑ –≠–ö–ì"
  }
]
```

---

## üîÑ –û—Ç–∫–ª—é—á–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã

–ß—Ç–æ–±—ã –æ—Ç–∫–ª—é—á–∏—Ç—å —Å–∏—Å—Ç–µ–º—É:

```bash
# –í .env.local
NEXT_PUBLIC_SUBSCRIPTION_ENABLED=false
```

–í—Å–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞–∫ —Ä–∞–Ω—å—à–µ, –≤–∏–¥–∂–µ—Ç –∏—Å—á–µ–∑–Ω–µ—Ç, —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–æ–∫–∞–∂—É—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏.

---

## üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ —Å–∏—Å—Ç–µ–º—É –ª–æ–∫–∞–ª—å–Ω–æ
2. ‚úÖ –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–∞–∫–µ—Ç—ã –ø–æ–¥ —Å–≤–æ–∏ —Ü–µ–Ω—ã
3. ‚úÖ –î–æ–±–∞–≤—å—Ç–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é –≤ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∞–Ω–∞–ª–∏–∑–∞
4. üîú –ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–π—Ç–µ –ø–ª–∞—Ç–µ–∂–Ω—ã–π —à–ª—é–∑ (–ÆKassa, Stripe, –∏ —Ç.–¥.)
5. üîú –ü–µ—Ä–µ–Ω–µ—Å–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö (PostgreSQL/MySQL)
6. üîú –î–æ–±–∞–≤—å—Ç–µ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è

---

## üí° –ö–æ–Ω—Ç–∞–∫—Ç—ã

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –≤–æ–ø—Ä–æ—Å–æ–≤ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∫–æ–¥—É –∏–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –≤ —Ñ–∞–π–ª–∞—Ö.

**–°–æ–∑–¥–∞–Ω–æ:** 27 –¥–µ–∫–∞–±—Ä—è 2025  
**–í–µ—Ä—Å–∏—è:** 1.0.0 (BETA)






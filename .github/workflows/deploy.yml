name: Deploy to Timeweb VPS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        script: |
          cd /home/doctor-opus
          
          echo "üì• –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å GitHub..."
          git pull origin main
          
          echo "üöÄ –°–±–æ—Ä–∫–∞ –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ Docker Compose..."
          docker compose up -d --build
          
          echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (30 —Å–µ–∫)..."
          sleep 30
          
          echo "üîÑ –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î..."
          # –ú–∏–≥—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ API —Å —Å–µ–∫—Ä–µ—Ç–æ–º –∏–∑ .env
          MIGRATION_SECRET=$(grep -oP 'MIGRATION_SECRET=\K.*' .env 2>/dev/null || echo "")
          if [ -n "$MIGRATION_SECRET" ]; then
            RESULT=$(curl -s -X POST http://localhost:3000/api/admin/migrate \
              -H "Content-Type: application/json" \
              -d "{\"secret\": \"$MIGRATION_SECRET\"}" || echo '{"error":"curl failed"}')
            echo "–ú–∏–≥—Ä–∞—Ü–∏—è: $RESULT"
          else
            echo "‚ö†Ô∏è MIGRATION_SECRET –Ω–µ –∑–∞–¥–∞–Ω –≤ .env, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏—é"
          fi
          
          echo "‚úÖ –î–µ–ø–ª–æ–π v3.41.0 –∑–∞–≤–µ—Ä—à–µ–Ω!"

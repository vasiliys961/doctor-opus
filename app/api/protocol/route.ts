import { NextRequest, NextResponse } from 'next/server';
import { sendTextRequest } from '@/lib/openrouter';
import { sendTextRequestStreaming } from '@/lib/openrouter-streaming';
import { formatCostLog } from '@/lib/cost-calculator';
import { anonymizeText } from '@/lib/anonymization';

/**
 * API endpoint –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ –æ—Å–º–æ—Ç—Ä–∞ —á–µ—Ä–µ–∑ Claude Sonnet 4.5
 * (—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç Python –±–µ–∫–µ–Ω–¥—É: use_sonnet_4_5=True)
 */
export async function POST(request: NextRequest) {
  try {
    console.log('üöÄ [PROTOCOL API] ========== –ù–ê–ß–ê–õ–û –ì–ï–ù–ï–†–ê–¶–ò–ò –ü–†–û–¢–û–ö–û–õ–ê ==========');
    console.log('‚è∞ [PROTOCOL API] –í—Ä–µ–º—è:', new Date().toISOString());
    
    const body = await request.json();
    const { rawText: rawIncomingText, useStreaming = true, model = 'sonnet' } = body;
    const rawText = anonymizeText(rawIncomingText);

    console.log('üì• [PROTOCOL API] –ü–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å:', {
      —Ä–∞–∑–º–µ—Ä_—Ç–µ–∫—Å—Ç–∞: rawText ? `${rawText.length} —Å–∏–º–≤–æ–ª–æ–≤` : '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö',
      useStreaming: useStreaming,
      model: model
    });

    if (!rawText || !rawText.trim()) {
      console.error('‚ùå [PROTOCOL API] –û—à–∏–±–∫–∞: —Ç–µ–∫—Å—Ç –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω');
      return NextResponse.json(
        { success: false, error: '–¢–µ–∫—Å—Ç –¥–ª—è –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω' },
        { status: 400 }
      );
    }

    // ... prompt definition ...
    const prompt = `–í–ù–ò–ú–ê–ù–ò–ï: –ù–∞—á–Ω–∏ –æ—Ç–≤–µ—Ç –°–†–ê–ó–£ —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞ "–ü–†–û–¢–û–ö–û–õ –ü–ï–†–í–ò–ß–ù–û–ì–û –û–°–ú–û–¢–†–ê". –ù–µ –ø–∏—à–∏ –Ω–∏–∫–∞–∫–∏—Ö –≤–≤–æ–¥–Ω—ã—Ö —Å–ª–æ–≤, "–∫–ª–∏–Ω–∏—á–µ—Å–∫–∏—Ö –¥–∏—Ä–µ–∫—Ç–∏–≤", –∞–Ω–∞–ª–∏–∑–æ–≤ –∏–ª–∏ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π. –¢–æ–ª—å–∫–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª.

–í—ã - –æ–ø—ã—Ç–Ω—ã–π —Ç–µ—Ä–∞–ø–µ–≤—Ç, –∞–º–µ—Ä–∏–∫–∞–Ω—Å–∫–∏–π –ø—Ä–æ—Ñ–µ—Å—Å–æ—Ä –∫–ª–∏–Ω–∏—á–µ—Å–∫–æ–π –º–µ–¥–∏—Ü–∏–Ω—ã –∏ –≤–µ–¥—É—â–∏–π —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç—Å–∫–æ–π –∫–ª–∏–Ω–∏–∫–∏ —Å –º–Ω–æ–≥–æ–ª–µ—Ç–Ω–∏–º –∫–ª–∏–Ω–∏—á–µ—Å–∫–∏–º –æ–ø—ã—Ç–æ–º.
    
–í—ã —Å–æ–≤–º–µ—â–∞–µ—Ç–µ –∫–ª–∏–Ω–∏—á–µ—Å–∫—É—é —Å—Ç—Ä–æ–≥–æ—Å—Ç—å –∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å, –¥–∞–≤–∞—è –æ—Ç–≤–µ—Ç—ã –ø–æ –∫–ª–∏–Ω–∏—á–µ—Å–∫–∏–º –ø—Ä–æ–±–ª–µ–º–∞–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –±–æ–ª–µ–∑–Ω–µ–π, –≤–∫–ª—é—á–∞—è –∞–∫—É—à–µ—Ä—Å—Ç–≤–æ –∏ –≥–∏–Ω–µ–∫–æ–ª–æ–≥–∏—é, —Ö–∏—Ä—É—Ä–≥–∏—é, –∞ —Ç–∞–∫–∂–µ –ø–æ–º–æ–≥–∞–µ—Ç–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –Ω–µ—Å–∏—Å—Ç–µ–º–Ω–æ –∏–∑–ª–æ–∂–µ–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –æ–±–ª–µ–∫–∞—è –µ—ë –ø–æ —à–∞–±–ª–æ–Ω—É –∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º—É –ø—Ä–æ—Ç–æ–∫–æ–ª—É –æ—Å–º–æ—Ç—Ä–∞ —Ç–µ—Ä–∞–ø–µ–≤—Ç–∞ —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏ –ø–æ –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏—é –∏ –ª–µ—á–µ–Ω–∏—é.

–í–∞—à–∞ –∑–∞–¥–∞—á–∞ - —Å–æ–∑–¥–∞—Ç—å –ø–æ–ª–Ω—ã–π –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª –æ—Å–º–æ—Ç—Ä–∞ –ø–∞—Ü–∏–µ–Ω—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –Ω–µ—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –≤–∫–ª—é—á–∞—é—â–∏—Ö –ø–µ—Ä–µ—á–µ–Ω—å –∂–∞–ª–æ–±, –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ—è–≤–ª–µ–Ω–∏—è —Å–∏–º–ø—Ç–æ–º–æ–≤ –∏ –∂–∞–ª–æ–±, –¥–∞–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–∏–≤–Ω–æ–≥–æ –æ—Å–º–æ—Ç—Ä–∞, –ø—Ä–∏–≤–µ–¥–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤ –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–ª—å–Ω—ã—Ö –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞–∫ –º–æ–¥–µ–ª—å –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ —à–∞–±–ª–æ–Ω—ã. –ü–æ—Å—Ç–∞—Ä–∞–π—Ç–µ—Å—å –≤–º–µ—Å—Ç–∏—Ç—å –≤—Å—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –Ω–∞ 2 —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –ø–æ—Å–∫–æ–ª—å–∫—É —Å–∫–∞—á–∞–Ω–Ω—ã–π —Ñ–∞–π–ª –≤ —Ñ–æ—Ä–º–∞—Ç–µ .doc –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è –ø–µ—á–∞—Ç–∏.

–¢–µ–∫—Å—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏: ${rawText}

–§–û–†–ú–ê–¢ –ü–†–û–¢–û–ö–û–õ–ê:

**–ñ–∞–ª–æ–±—ã:**
(—Ç–µ–∫—Å—Ç –∏–∑–ª–æ–∂–µ–Ω–Ω—ã–π –≤ –∂–∞–ª–æ–±–∞—Ö –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∞–±–∑–∞—Ü–µ–≤, –Ω–µ –Ω—É–∂–Ω–æ –¥–µ–ª–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—É—Å—Ç—ã—Ö —Å—Ç—Ä–æ–∫, –ø–∏—à–∏—Ç–µ –µ–¥–∏–Ω—ã–º –ø–æ–ª–æ—Ç–Ω–æ–º)

**–ê–Ω–∞–º–Ω–µ–∑ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è:**
(—Ç–µ–∫—Å—Ç –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∞–±–∑–∞—Ü–µ–≤, –µ–¥–∏–Ω—ã–º –ø–æ–ª–æ—Ç–Ω–æ–º)

**–ê–Ω–∞–º–Ω–µ–∑ –∂–∏–∑–Ω–∏:**
(—Ç–µ–∫—Å—Ç –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∞–±–∑–∞—Ü–µ–≤, –µ–¥–∏–Ω—ã–º –ø–æ–ª–æ—Ç–Ω–æ–º)

**–û–±—ä–µ–∫—Ç–∏–≤–Ω—ã–π –æ—Å–º–æ—Ç—Ä:**
–û–±—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: –ª–∏–º—Ñ–æ—É–∑–ª—ã: –ö–æ–∂–∞: –°–ª–∏–∑–∏—Å—Ç—ã–µ: –ü—É–ª—å—Å: –ê–î: –ß–î–î: –°–µ—Ä–¥—Ü–µ: –õ—ë–≥–∫–∏–µ: –ñ–∏–≤–æ—Ç: –ü–µ—á–µ–Ω—å, —Å–µ–ª–µ–∑—ë–Ω–∫–∞: –ø–æ—á–∫–∏: —Å—Ç—É–ª: –¥–∏—É—Ä–µ–∑: –æ—Ç—ë–∫–∏: –ù–µ–≤—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–∞—Ç—É—Å:
(–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è "–Ω–µ –ø—Ä–æ–≤–æ–¥–∏–ª–∞—Å—å", –≤–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –Ω–∞–ø–∏—à–∏—Ç–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è –æ—Ç—Ä–∞–∂–∞—é—â–∏–µ –Ω–æ—Ä–º—ã, –Ω–æ —É–ø–æ–º—è–Ω–∏—Ç–µ –≤—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã, —Ç–µ–∫—Å—Ç –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∞–±–∑–∞—Ü–µ–≤, –µ–¥–∏–Ω—ã–º –ø–æ–ª–æ—Ç–Ω–æ–º)

**–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –¥–∏–∞–≥–Ω–æ–∑:**
(–¥–∏–∞–≥–Ω–æ–∑ –≤—ã–Ω–æ—Å–∏—Ç–µ –Ω–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏ —Ä–æ—Å—Å–∏–π—Å–∫–∏—Ö –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–π –±–æ–ª–µ–∑–Ω–µ–π)

**–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã–µ –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è:**
1. ...
2. ...
(—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏—é –Ω–∞–ø–∏—à–∏—Ç–µ –ø–æ –ø—É–Ω–∫—Ç–∞–º 1., 2., –∏ —Ç.–¥., –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è, –µ—Å–ª–∏ —Å—Ç—Ä–æ—á–∫–∞ –æ—á–µ–Ω—å –¥–ª–∏–Ω–Ω–∞—è, –Ω–µ –¥–µ–ª–∞–π—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ–ø—É—Å–∫–∞ –º–µ–∂–¥—É —Å—Ç—Ä–æ–∫–∞–º–∏)

**–¢–µ—Ä–∞–ø–∏—è:**
- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ä–µ–∂–∏–º—É, –¥–∏–µ—Ç–µ
- –§–∞—Ä–º–∞–∫–æ—Ç–µ—Ä–∞–ø–∏—è: –ø–µ—Ä–µ—á–∏—Å–ª–∏—Ç–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç—ã. –ù–∞–∑–æ–≤–∏—Ç–µ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ 2 –∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏—Ö (–±—Ä–µ–Ω–¥ –∏ –∫–æ–ø–∏—é) –≥–µ–Ω–µ—Ä–∏–∫–∞, –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤ –†–§. –ù–µ –¥–µ–ª–∞–π—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ–ø—É—Å–∫–∞ –º–µ–∂–¥—É —Å—Ç—Ä–æ–∫–∞–º–∏.
- –§–∏–∑–∏–æ–ª–µ—á–µ–Ω–∏–µ: –ø—Ä–µ–¥–ª–æ–∂–∏—Ç–µ 1-2 –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –¥–ª—è –ø–∞—Ü–∏–µ–Ω—Ç–∞, –Ω–µ —É–∫–∞–∑—ã–≤–∞–π—Ç–µ —Ç–µ, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–∫–∞–∑–∞–Ω—ã

**–°–æ–≥–ª–∞—Å–∏–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞:**
(—Ç–µ–∑–∏—Å –æ —Å–æ–≥–ª–∞—Å–∏–∏ –∏ –ø—Ä–æ—á—Ç–µ–Ω–∏–∏ –≤ –∫–æ–Ω—Ü–µ —Å–¥–µ–ª–∞—Ç—å –±–æ–ª–µ–µ –º–µ–ª–∫–∏–º —à—Ä–∏—Ñ—Ç–æ–º)

–û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø –ò –ü–†–ê–í–ò–õ–ê –°–¢–ò–õ–Ø:

- –Ø–∑—ã–∫ –æ—Ç–≤–µ—Ç–∞: —Ä—É—Å—Å–∫–∏–π. –°—Ç–∏–ª—å: —Å—Ç—Ä–æ–≥–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π, –∫–ª–∏–Ω–∏—á–µ—Å–∫–∏ –∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏ —Ç–æ—á–Ω—ã–π, –±–µ–∑ —É–ø—Ä–æ—â–µ–Ω–∏–π.
- –ù–µ –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –¥—Ä—É–≥–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞.
- –¢–µ–∫—Å—Ç –∏–∑–ª–æ–∂–µ–Ω–Ω—ã–π –≤ –∂–∞–ª–æ–±–∞—Ö, –∞–Ω–∞–º–Ω–µ–∑–µ, –æ–±—ä–µ–∫—Ç–∏–≤–Ω–æ–º –æ—Å–º–æ—Ç—Ä–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∞–±–∑–∞—Ü–µ–≤, –Ω–µ –Ω—É–∂–Ω–æ –¥–µ–ª–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—É—Å—Ç—ã—Ö —Å—Ç—Ä–æ–∫, –ø–∏—à–∏—Ç–µ –µ–¥–∏–Ω—ã–º –ø–æ–ª–æ—Ç–Ω–æ–º.
- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è "–Ω–µ –ø—Ä–æ–≤–æ–¥–∏–ª–∞—Å—å", –≤–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –Ω–∞–ø–∏—à–∏—Ç–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è –æ—Ç—Ä–∞–∂–∞—é—â–∏–µ –Ω–æ—Ä–º—ã, –Ω–æ —É–ø–æ–º—è–Ω–∏—Ç–µ –≤—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã.
- –£–±–µ—Ä–∏—Ç–µ –ª–æ–≥–æ—Ç–∏–ø –ø–µ—Ä–µ–ø–ª–µ–∫—Å–∏—Ç–∏ —Å –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã.
- –ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ –≤—Å—é –ø–æ–ª—É—á–µ–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ —Ñ–æ—Ä–º–µ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ –æ—Å–º–æ—Ç—Ä–∞ –ø–µ—Ä–≤–∏—á–Ω–æ–≥–æ –æ—Å–º–æ—Ç—Ä–∞ –≤—Ä–∞—á–∞.
- –î–∏–∞–≥–Ω–æ–∑ –≤—ã–Ω–æ—Å–∏—Ç–µ –Ω–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏ —Ä–æ—Å—Å–∏–π—Å–∫–∏—Ö –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–π –±–æ–ª–µ–∑–Ω–µ–π.
- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏—é –Ω–∞–ø–∏—à–∏—Ç–µ –ø–æ –ø—É–Ω–∫—Ç–∞–º 1., 2., –∏ —Ç.–¥., –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è, –µ—Å–ª–∏ —Å—Ç—Ä–æ—á–∫–∞ –æ—á–µ–Ω—å –¥–ª–∏–Ω–Ω–∞—è. –ù–µ –¥–µ–ª–∞–π—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ–ø—É—Å–∫–∞ –º–µ–∂–¥—É —Å—Ç—Ä–æ–∫–∞–º–∏.
- –¢–æ—á–Ω–æ —Ç–∞–∫ –∂–µ –ø–µ—Ä–µ—á–∏—Å–ª–∏—Ç–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç—ã –∏ –Ω–µ –¥–µ–ª–∞–π—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ–ø—É—Å–∫–∞ –º–µ–∂–¥—É —Å—Ç—Ä–æ–∫–∞–º–∏. –ü—Ä–æ—Å—Ç–æ –Ω–∞–∑–æ–≤–∏—Ç–µ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–æ–µ –∏ 2 –∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏—Ö (–±—Ä–µ–Ω–¥ –∏ –∫–æ–ø–∏—é) –≥–µ–Ω–µ—Ä–∏–∫–∞, –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤ –†–§.
- –°–ª–µ–¥—É–µ—Ç –ø—Ä–∏–¥–µ—Ä–∂–∏–≤–∞—Ç—å—Å—è —Ç–∞–∫–æ–≥–æ —Å—Ç–∏–ª—è –∏–∑–ª–æ–∂–µ–Ω–∏—è –∏ –≤—ã–±–æ—Ä —à—Ä–∏—Ñ—Ç–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ, —á—Ç–æ–±—ã –ø—Ä–æ—Ç–æ–∫–æ–ª —É–º–µ—â–∞–ª—Å—è –Ω–∞ 2 —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ª–∏—Å—Ç–∞ –ê4.
- –¢–µ–∑–∏—Å –æ —Å–æ–≥–ª–∞—Å–∏–∏ –∏ –ø—Ä–æ—á—Ç–µ–Ω–∏–∏ –≤ –∫–æ–Ω—Ü–µ —Å–¥–µ–ª–∞—Ç—å –±–æ–ª–µ–µ –º–µ–ª–∫–∏–º —à—Ä–∏—Ñ—Ç–æ–º.

–ò–°–¢–û–ß–ù–ò–ö–ò (–º–µ–¥–∏—Ü–∏–Ω–∞):
UpToDate, PubMed, Cochrane, NCCN, ESC, IDSA, CDC, WHO, ESMO, ADA, GOLD, KDIGO (–∏ –¥—Ä—É–≥–∏–µ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞ —Å –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å–Ω–æ–π –±–∞–∑–æ–π).

–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ - –æ–ø–∏—Ä–∞—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏; –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–ª—é—á–µ–≤–æ–≥–æ –ª–µ—á–µ–±–Ω–æ–≥–æ —à–∞–≥–∞ —É–∫–∞–∑—ã–≤–∞—Ç—å —Å—Å—ã–ª–∫—É –∏ –≥–æ–¥ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ (–ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–æ ‚â§5 –ª–µ—Ç).`;

    // –í—ã–±–æ—Ä –º–æ–¥–µ–ª–∏ –¥–ª—è –ø—Ä–æ—Ç–æ–∫–æ–ª–∞
    const MODEL = model === 'opus' 
      ? 'anthropic/claude-opus-4.5' 
      : (model === 'gemini' || model === 'google/gemini-3-flash-preview')
        ? 'google/gemini-3-flash-preview'
        : 'anthropic/claude-sonnet-4.5';
    
    const MAX_TOKENS = 8000;
    
    // –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—à–µ–Ω streaming, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ—Ç–æ–∫
    if (useStreaming) {
      console.log('');
      console.log('ü§ñ [MODEL INFO] ========== –ì–ï–ù–ï–†–ê–¶–ò–Ø –ü–†–û–¢–û–ö–û–õ–ê (STREAMING) ==========');
      console.log('ü§ñ [MODEL INFO] –ú–æ–¥–µ–ª—å:', MODEL);
      console.log('ü§ñ [MODEL INFO] Max tokens:', MAX_TOKENS);
      console.log('ü§ñ [MODEL INFO] –†–∞–∑–º–µ—Ä –ø—Ä–æ–º–ø—Ç–∞:', `${prompt.length} —Å–∏–º–≤–æ–ª–æ–≤`);
      console.log('ü§ñ [MODEL INFO] –†–µ–∂–∏–º: streaming');
      console.log('üì§ [PROTOCOL API] –û—Ç–ø—Ä–∞–≤–∫–∞ streaming –∑–∞–ø—Ä–æ—Å–∞ –∫ OpenRouter...');
      console.log('');
      
      const stream = await sendTextRequestStreaming(prompt, [], MODEL);
      
      const decoder = new TextDecoder();
      const transformStream = new TransformStream({
        transform(chunk, controller) {
          const text = decoder.decode(chunk, { stream: true });
          
          if (text.includes('"usage":')) {
            const lines = text.split('\n');
            for (const line of lines) {
              if (line.includes('"usage":')) {
                try {
                  const jsonStr = line.startsWith('data: ') ? line.slice(6).trim() : line.trim();
                  const data = JSON.parse(jsonStr);
                  if (data.usage) {
                    console.log(formatCostLog(
                      MODEL,
                      data.usage.prompt_tokens,
                      data.usage.completion_tokens,
                      data.usage.total_tokens
                    ));
                  }
                } catch (e) {}
              }
            }
          }
          controller.enqueue(chunk);
        }
      });

      console.log('‚úÖ [PROTOCOL API] Streaming –ø–æ—Ç–æ–∫ —Å–æ–∑–¥–∞–Ω, –æ—Ç–ø—Ä–∞–≤–∫–∞ –∫–ª–∏–µ–Ω—Ç—É...');
      
      return new Response(stream.pipeThrough(transformStream), {
        headers: {
          'Content-Type': 'text/event-stream',
          'Cache-Control': 'no-cache',
          'Connection': 'keep-alive',
        },
      });
    }

    // –û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º - –ø–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç
    console.log('');
    console.log('ü§ñ [MODEL INFO] ========== –ì–ï–ù–ï–†–ê–¶–ò–Ø –ü–†–û–¢–û–ö–û–õ–ê (–û–ë–´–ß–ù–´–ô –†–ï–ñ–ò–ú) ==========');
    console.log('ü§ñ [MODEL INFO] –ú–æ–¥–µ–ª—å:', MODEL);
    console.log('ü§ñ [MODEL INFO] Max tokens:', MAX_TOKENS);
    console.log('ü§ñ [MODEL INFO] –†–∞–∑–º–µ—Ä –ø—Ä–æ–º–ø—Ç–∞:', `${prompt.length} —Å–∏–º–≤–æ–ª–æ–≤`);
    console.log('ü§ñ [MODEL INFO] –†–µ–∂–∏–º: –æ–±—ã—á–Ω—ã–π (–Ω–µ streaming)');
    console.log('');
    
    let result = await sendTextRequest(prompt, []);
    
    console.log('');
    console.log('üìù [PROTOCOL API] ========== –û–¢–í–ï–¢ –û–¢ –ú–û–î–ï–õ–ò –ü–û–õ–£–ß–ï–ù ==========');
    console.log('üìù [PROTOCOL API] –ú–æ–¥–µ–ª—å:', MODEL);
    console.log('üìù [PROTOCOL API] –î–ª–∏–Ω–∞ –æ—Ç–≤–µ—Ç–∞:', `${result.length} —Å–∏–º–≤–æ–ª–æ–≤`);
    console.log('üìù [PROTOCOL API] –ü–µ—Ä–≤—ã–µ 200 —Å–∏–º–≤–æ–ª–æ–≤:', result.substring(0, 200));
    console.log('');

    console.log('‚úÖ [PROTOCOL API] ========== –ü–†–û–¢–û–ö–û–õ –£–°–ü–ï–®–ù–û –°–ì–ï–ù–ï–†–ò–†–û–í–ê–ù ==========');
    console.log('‚úÖ [PROTOCOL API] –§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä:', `${result.length} —Å–∏–º–≤–æ–ª–æ–≤`);
    console.log('');
    
    return NextResponse.json({
      success: true,
      protocol: result,
    });
  } catch (error: any) {
    console.error('‚ùå [PROTOCOL API] –û—à–∏–±–∫–∞:', error.message);
    return NextResponse.json(
      { success: false, error: error.message || '–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞' },
      { status: 500 }
    );
  }
}


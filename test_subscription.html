<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –ø–æ–¥–ø–∏—Å–∫–∏</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 900px;
      margin: 50px auto;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .container {
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1 {
      color: #333;
      margin-bottom: 10px;
    }
    .subtitle {
      color: #666;
      margin-bottom: 30px;
    }
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      margin: 5px;
      transition: transform 0.2s;
    }
    button:hover {
      transform: translateY(-2px);
    }
    button.danger {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    .section {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 12px;
      margin: 20px 0;
    }
    .result {
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      border-left: 4px solid #667eea;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 400px;
      overflow-y: auto;
    }
    .success {
      color: #10b981;
      font-weight: bold;
    }
    .error {
      color: #ef4444;
      font-weight: bold;
    }
    .info {
      color: #3b82f6;
    }
    pre {
      margin: 0;
      white-space: pre-wrap;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    .stat-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      border: 2px solid #e5e7eb;
    }
    .stat-value {
      font-size: 32px;
      font-weight: bold;
      color: #667eea;
    }
    .stat-label {
      color: #6b7280;
      font-size: 14px;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –ø–æ–¥–ø–∏—Å–∫–∏</h1>
    <p class="subtitle">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã –±–∞–ª–∞–Ω—Å–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã</p>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div id="stats" class="stats"></div>

    <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–æ–º -->
    <div class="section">
      <h3>üíé –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–æ–º</h3>
      <button onclick="activatePackage('trial')">–ü—Ä–æ–±–Ω—ã–π (250 –µ–¥, 500‚ÇΩ)</button>
      <button onclick="activatePackage('basic')">–ë–∞–∑–æ–≤—ã–π (500 –µ–¥, 1 000‚ÇΩ)</button>
      <button onclick="activatePackage('pro')">–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π (1 250 –µ–¥, 2 500‚ÇΩ)</button>
      <button class="danger" onclick="clearData()">–û—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
    </div>

    <!-- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∞–Ω–∏—è -->
    <div class="section">
      <h3>üí∏ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∞–Ω–∏—è</h3>
      <button onclick="testDeduct('gemini', 'fast')">Gemini Flash (–ë—ã—Å—Ç—Ä—ã–π)</button>
      <button onclick="testDeduct('opus', 'precise')">Opus 4.5 (–¢–æ—á–Ω—ã–π)</button>
      <button onclick="testDeduct('gpt4o', 'balanced')">GPT-4o (–ë–∞–ª–∞–Ω—Å–Ω—ã–π)</button>
      <button onclick="testDeduct('sonnet', 'precise')">Sonnet 4.5 (–¢–æ—á–Ω—ã–π)</button>
    </div>

    <!-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö -->
    <div class="section">
      <h3>üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö</h3>
      <button onclick="checkBalance()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å</button>
      <button onclick="checkTransactions()">–ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</button>
      <button onclick="estimateCosts()">–û—Ü–µ–Ω–∫–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏</button>
      <button onclick="checkLocalStorage()">–í—Å–µ –¥–∞–Ω–Ω—ã–µ localStorage</button>
    </div>

    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç -->
    <div id="result" class="result" style="display: none;"></div>
  </div>

  <script>
    // –°–∏–º—É–ª—è—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –æ –º–æ–¥–µ–ª—è—Ö –∏ —Ü–µ–Ω–∞—Ö
    const modelPricing = {
      'gemini': {
        model: 'google/gemini-2.0-flash-exp:free',
        inputPrice: 0,
        outputPrice: 0,
        avgInput: 500,
        avgOutput: 1000
      },
      'opus': {
        model: 'anthropic/claude-opus-4.5',
        inputPrice: 15 / 1_000_000,
        outputPrice: 75 / 1_000_000,
        avgInput: 1000,
        avgOutput: 2500
      },
      'gpt4o': {
        model: 'openai/gpt-4o',
        inputPrice: 2.5 / 1_000_000,
        outputPrice: 10 / 1_000_000,
        avgInput: 800,
        avgOutput: 2000
      },
      'sonnet': {
        model: 'anthropic/claude-sonnet-4.5',
        inputPrice: 3 / 1_000_000,
        outputPrice: 15 / 1_000_000,
        avgInput: 1000,
        avgOutput: 2500
      }
    };

    const USD_TO_CREDITS = 100;

    function log(message, type = 'info') {
      const result = document.getElementById('result');
      result.style.display = 'block';
      const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
      const time = new Date().toLocaleTimeString('ru-RU');
      result.innerHTML += `<div class="${className}">[${time}] ${message}</div>`;
      result.scrollTop = result.scrollHeight;
      updateStats();
    }

    function clearLog() {
      const result = document.getElementById('result');
      result.innerHTML = '';
      result.style.display = 'none';
    }

    function updateStats() {
      const balance = JSON.parse(localStorage.getItem('userSubscriptionBalance') || 'null');
      const transactions = JSON.parse(localStorage.getItem('userTransactions') || '[]');
      
      const statsHtml = balance ? `
        <div class="stat-card">
          <div class="stat-value">${balance.currentCredits.toLocaleString('ru-RU')}</div>
          <div class="stat-label">–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å (–µ–¥.)</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${balance.initialCredits.toLocaleString('ru-RU')}</div>
          <div class="stat-label">–ù–∞—á–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${balance.totalSpent.toLocaleString('ru-RU')}</div>
          <div class="stat-label">–ü–æ—Ç—Ä–∞—á–µ–Ω–æ –≤—Å–µ–≥–æ</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${transactions.length}</div>
          <div class="stat-label">–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</div>
        </div>
      ` : '<div class="stat-card" style="grid-column: 1/-1; text-align: center;"><p style="color: #6b7280;">–ë–∞–ª–∞–Ω—Å –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω. –í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–∫–µ—Ç –≤—ã—à–µ.</p></div>';
      
      document.getElementById('stats').innerHTML = statsHtml;
    }

    function activatePackage(packageKey) {
      clearLog();
      const packages = {
        trial: { name: '–ü—Ä–æ–±–Ω—ã–π', credits: 250, priceRub: 500 },
        basic: { name: '–ë–∞–∑–æ–≤—ã–π', credits: 500, priceRub: 1000 },
        pro: { name: '–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π', credits: 1250, priceRub: 2500 }
      };
      
      const pkg = packages[packageKey];
      
      // –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–∫—É–ø–∫–∞ - –¥–æ–±–∞–≤–ª—è–µ–º –∫ —Ç–µ–∫—É—â–µ–º—É –±–∞–ª–∞–Ω—Å—É
      const existingBalance = JSON.parse(localStorage.getItem('userSubscriptionBalance') || 'null');
      const currentCredits = existingBalance ? existingBalance.currentCredits : 0;
      const newTotalCredits = currentCredits + pkg.credits;
      
      const balance = {
        initialCredits: newTotalCredits,
        currentCredits: newTotalCredits,
        totalSpent: existingBalance ? existingBalance.totalSpent : 0,
        packageName: pkg.name,
        packagePriceRub: pkg.priceRub,
        purchaseDate: new Date().toISOString(),
        expiryDate: null
      };
      
      localStorage.setItem('userSubscriptionBalance', JSON.stringify(balance));
      
      if (existingBalance) {
        log(`‚úÖ –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ: +${pkg.credits} –µ–¥. –ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: ${newTotalCredits} –µ–¥.`, 'success');
      } else {
        log(`‚úÖ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –ø–∞–∫–µ—Ç "${pkg.name}": ${pkg.credits} –µ–¥–∏–Ω–∏—Ü –∑–∞ ${pkg.priceRub.toLocaleString('ru-RU')} ‚ÇΩ`, 'success');
      }
      
      updateStats();
    }

    function testDeduct(modelKey, mode) {
      clearLog();
      const balance = JSON.parse(localStorage.getItem('userSubscriptionBalance') || 'null');
      
      if (!balance) {
        log('‚ùå –ë–∞–ª–∞–Ω—Å –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω! –í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–∫–µ—Ç —Å–Ω–∞—á–∞–ª–∞.', 'error');
        return;
      }
      
      const pricing = modelPricing[modelKey];
      const inputTokens = pricing.avgInput;
      const outputTokens = pricing.avgOutput;
      const costUsd = (inputTokens * pricing.inputPrice) + (outputTokens * pricing.outputPrice);
      const costCredits = Math.ceil(costUsd * USD_TO_CREDITS);
      
      log(`üîÑ –ü–æ–ø—ã—Ç–∫–∞ —Å–ø–∏—Å–∞–Ω–∏—è –¥–ª—è –º–æ–¥–µ–ª–∏: ${pricing.model}`);
      log(`üìä –¢–æ–∫–µ–Ω—ã: ${inputTokens} –≤—Ö / ${outputTokens} –≤—ã—Ö`);
      log(`üíµ –°—Ç–æ–∏–º–æ—Å—Ç—å: $${costUsd.toFixed(4)} USD = ${costCredits} –µ–¥.`);
      
      if (balance.currentCredits < costCredits) {
        log(`‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –µ–¥–∏–Ω–∏—Ü! –ù—É–∂–Ω–æ: ${costCredits}, –¥–æ—Å—Ç—É–ø–Ω–æ: ${balance.currentCredits}`, 'error');
        return;
      }
      
      balance.currentCredits -= costCredits;
      balance.totalSpent += costCredits;
      localStorage.setItem('userSubscriptionBalance', JSON.stringify(balance));
      
      const transaction = {
        id: `txn_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
        date: new Date().toISOString(),
        section: 'test',
        sectionName: '–¢–µ—Å—Ç',
        model: pricing.model,
        inputTokens: inputTokens,
        outputTokens: outputTokens,
        costUsd: costUsd,
        costCredits: costCredits,
        operation: `–¢–µ—Å—Ç–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑ (${mode})`
      };
      
      const transactions = JSON.parse(localStorage.getItem('userTransactions') || '[]');
      transactions.push(transaction);
      localStorage.setItem('userTransactions', JSON.stringify(transactions));
      
      log(`‚úÖ –°–ø–∏—Å–∞–Ω–æ ${costCredits} –µ–¥. –û—Å—Ç–∞—Ç–æ–∫: ${balance.currentCredits} –µ–¥.`, 'success');
      updateStats();
    }

    function checkBalance() {
      clearLog();
      const balance = JSON.parse(localStorage.getItem('userSubscriptionBalance') || 'null');
      
      if (!balance) {
        log('‚ÑπÔ∏è –ë–∞–ª–∞–Ω—Å –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω');
        return;
      }
      
      log('üí∞ –¢–ï–ö–£–©–ò–ô –ë–ê–õ–ê–ù–°:');
      log(`  –ü–∞–∫–µ—Ç: ${balance.packageName} (${balance.packagePriceRub} ‚ÇΩ)`);
      log(`  –ù–∞—á–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å: ${balance.initialCredits} –µ–¥.`);
      log(`  –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: ${balance.currentCredits} –µ–¥.`);
      log(`  –ü–æ—Ç—Ä–∞—á–µ–Ω–æ: ${balance.totalSpent} –µ–¥.`);
      log(`  –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: ${((balance.totalSpent / balance.initialCredits) * 100).toFixed(1)}%`);
      log(`  –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω: ${new Date(balance.purchaseDate).toLocaleString('ru-RU')}`);
    }

    function checkTransactions() {
      clearLog();
      const transactions = JSON.parse(localStorage.getItem('userTransactions') || '[]');
      
      if (transactions.length === 0) {
        log('‚ÑπÔ∏è –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø–æ–∫–∞ –Ω–µ—Ç');
        return;
      }
      
      log(`üìú –ò–°–¢–û–†–ò–Ø –¢–†–ê–ù–ó–ê–ö–¶–ò–ô (${transactions.length}):`, 'success');
      transactions.slice(-10).reverse().forEach((txn, idx) => {
        log(`\n[${transactions.length - idx}] ${new Date(txn.date).toLocaleTimeString('ru-RU')}`);
        log(`  ${txn.sectionName}: ${txn.operation}`);
        log(`  –ú–æ–¥–µ–ª—å: ${txn.model.split('/').pop()}`);
        log(`  –¢–æ–∫–µ–Ω—ã: ${(txn.inputTokens + txn.outputTokens).toLocaleString('ru-RU')} (${txn.inputTokens}+${txn.outputTokens})`);
        log(`  –°—Ç–æ–∏–º–æ—Å—Ç—å: -${txn.costCredits} –µ–¥. ($${txn.costUsd.toFixed(4)})`);
      });
    }

    function estimateCosts() {
      clearLog();
      log('üìä –û–¶–ï–ù–ö–ê –°–¢–û–ò–ú–û–°–¢–ò –û–ü–ï–†–ê–¶–ò–ô:', 'success');
      
      Object.entries(modelPricing).forEach(([key, pricing]) => {
        const costUsd = (pricing.avgInput * pricing.inputPrice) + (pricing.avgOutput * pricing.outputPrice);
        const costCredits = Math.ceil(costUsd * USD_TO_CREDITS);
        
        log(`\n${pricing.model.split('/').pop()}:`);
        log(`  –°—Ä–µ–¥–Ω–∏–µ —Ç–æ–∫–µ–Ω—ã: ${pricing.avgInput} –≤—Ö / ${pricing.avgOutput} –≤—ã—Ö`);
        log(`  –°—Ç–æ–∏–º–æ—Å—Ç—å: ${costCredits} –µ–¥. ($${costUsd.toFixed(4)} USD)`);
      });
    }

    function checkLocalStorage() {
      clearLog();
      log('üíæ –í–°–ï –î–ê–ù–ù–´–ï –í LOCALSTORAGE:', 'success');
      
      const balance = localStorage.getItem('userSubscriptionBalance');
      const transactions = localStorage.getItem('userTransactions');
      
      if (balance) {
        log('\nüì¶ userSubscriptionBalance:');
        log(`<pre>${JSON.stringify(JSON.parse(balance), null, 2)}</pre>`);
      }
      
      if (transactions) {
        const txns = JSON.parse(transactions);
        log(`\nüì¶ userTransactions (${txns.length} –∑–∞–ø–∏—Å–µ–π):`);
        log(`<pre>${JSON.stringify(txns.slice(-3), null, 2)}</pre>`);
        if (txns.length > 3) {
          log(`... –∏ –µ—â—ë ${txns.length - 3} —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π`);
        }
      }
      
      if (!balance && !transactions) {
        log('‚ÑπÔ∏è –î–∞–Ω–Ω—ã—Ö –ø–æ–∫–∞ –Ω–µ—Ç');
      }
    }

    function clearData() {
      if (confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –±–∞–ª–∞–Ω—Å–∞ –∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π?')) {
        localStorage.removeItem('userSubscriptionBalance');
        localStorage.removeItem('userTransactions');
        clearLog();
        log('üóëÔ∏è –í—Å–µ –¥–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã', 'success');
        updateStats();
      }
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    updateStats();
  </script>
</body>
</html>

